\NeedsTeXFormat{LaTeX2e}
\documentclass[11pt]{woarticle}
\usepackage{amsmath}

\definecolor{commentcol}{rgb}{0.0, 0.2, 0.2}
% \newcommand{\cmnt}[1]{{ \small\color{commentcol}#1}}
\newcommand{\cmnt}[1]{\iffalse #1 \fi}

\newcommand{\marge}[1]{\marginline{\small #1}}

% theorems etc:
\theoremstyle{break}
%\theoremheaderfont{\scshape}
\theorembodyfont{\upshape}
\definecolor{gray}{rgb}{0.7,0.7,0.7}
\renewcommand*\FrameCommand{{\color{gray}\vrule width 4pt \hspace{10pt}}}
\newframedtheorem{theorem}{Theorem}[section]
\newframedtheorem{lemma}[theorem]{Lemma}
\newframedtheorem{corollary}[theorem]{Corollary}
\newframedtheorem{definition}[theorem]{Definition}
\newtheorem{rem}[theorem]{Remark}
\theoremstyle{nonumberplain}
\theorembodyfont{\small}
\theoremheaderfont{\normalfont\scshape}
\theoremindent0.5cm
\theoremseparator{}
%\newtheorem{proof}{Proof}
%\newenvironment{proof}%
%{\begin{list}{}%
%         {\setlength{\leftmargin}{0mm}}%
%         \item[]\small%
%}
%{\end{list}}

% abbreviations:
\newcommand{\df}{\ensuremath{\,=_{\text{\emph{df}}}\,}}
\newcommand{\M}{M}
\newcommand{\Q}[1]{\mathsf{#1}}
\newcommand{\s}[1]{\ensuremath{\mathsf{#1}}}
\newcommand{\SAT}{\Vdash}
\newcommand{\SATP}{\Vvdash}
\newcommand{\Img}{\triangleright}
\newcommand{\1}{\;\,|\;\,}
\renewcommand{\iff}{\quad\text{iff}\quad}
\newcommand{\at}[1]{#1\hspace{-2pt}:}
\newcommand{\home}{\mathsf{c}}
\newcommand{\centre}{\ensuremath{{w_\mathsf{c}}}}
\newcommand{\verum}{\top}
\newcommand{\falsum}{\bot}
\newcommand{\actually}{\ensuremath{\text{\normalfont\scshape ACT}}}
\newcommand{\trans}[1]{(#1)^c}
\newcommand{\var}{\emph{Var}}
\newcommand{\fvar}{\emph{Varf}}
\newcommand{\id}{\!\eqcirc\!}
% \newcommand{\free}[1]{#1^{\textsf{\tiny $\Box$}}}
\newcommand{\free}[1]{\Box(#1)}
\newcommand{\sub}[3][]{\ensuremath{[#2\,/{\scriptscriptstyle \!\!_{#1}\,}\, #3]}}
\renewcommand{\t}[1]{\ensuremath{\langle #1  \makebox[.2ex]{}\rangle}}
\renewcommand{\vec}[1]{\ensuremath{\underline{#1}}}
\newcommand{\T}[1]{\ensuremath{(\mathrm{ #1})}}
\newcommand{\itemT}[1]{\item[\T{#1}]}
\newcommand{\twocol}[2]{%
  \begin{minipage}[t]{0.48\linewidth}
    #1
  \end{minipage}
  \hspace{0.04\linewidth}
  \begin{minipage}[t]{0.48\linewidth}
    #2
  \end{minipage}
}

\begin{document}

\title{Generalising Kripke Semantics for Quantified\\[2mm]
  Modal Logics%
  \thanks{%
    These notes were mostly written in 2009--2012, and polished in 2022.
  }%
}

\author{Wolfgang Schwarz%
}

\date{}

\maketitle

\begin{flushright}

\emph{We turn now to what is arguably one of the least well behaved\\
modal languages ever proposed: first-order modal logic.}

\cite{blackburn07modal}

\end{flushright}

\tableofcontents

\section{Introduction}\label{sec:intro}

Modal logic has outgrown its philosophical origins. What used to be the logic of
possibility and necessity has become topic-neutral, with applications ranging
from the validation of computer programs to the study of mathematical proofs.

Along the way, modal \emph{predicate} logic has lost its role as the centre of
investigation, to the point that it is hardly mentioned in many textbooks.
Indeed, propositional modal logic itself has emerged as a fragment of
first-order predicate logic, with the domain of ``worlds'' playing the role of
``individuals''. As emphasized in \cite{blackburn01modal}, the distinctive
character of modal logic is not its subject matter, but its \emph{perspective}.
Statements of modal logic describe relational structures from the inside
perspective of a particular node. Modal predicate logic emerges as a somewhat
cumbersome hybrid, combining an internal perspective on one class of objects
(the domain of the modal operators) with an external perspective on a possibly
different class of objects (the domain of quantification).

Nevertheless, this hybrid perspective is useful and natural for many
applications. When reasoning about time, for example, it is natural to take a
perspective that is internal to the structure of times (so that what is true at
one point may be false at another), but external to the structure of sticks and
stones and people existing at the various times.

Standard Kripke semantics assumes that each ``world'' $w$ is associated with a
domain of ``individuals'' $D_{w}$ that somehow exist relative to this world.
Formulas like $\exists x \Diamond Fx$ that mix the two kind of quantification
have a straightforward interpretation: $\exists x\Diamond Fx$ is true at $w$ iff
the individual domain of $w$ contains an object that satisfies $Fx$ at some
world accessible from $w$.

\cmnt{%
  
  While conceptually simple, and possibly adequate for certain applications,
  this approach has some limitations. For example, it makes identity and
  distinctness non-contingent. If the domain of $w$ contains two individuals $x$
  and $y$, then there can be no other point from the perspective of which these
  two individuals are identical:
  $\forall x\forall y(x\!\not=\!y \then \Box x\!\not=\!y)$ is valid. For some
  applications, this is not desirable.

  Kripke semantics also has some purely formal limitation. A major strength of
  Kripke semantics in propositional modal logic is that many interesting logics
  are characterised by some class of Kripke frames. This changes when
  quantifiers are added. For example, all systems in between S4.3 and S5 then
  become incomplete (see \cite{ghilardi91incompleteness}).

} %

David Lewis \citey{ct} once proposed an alternative to Kripke semantics that
promises to overcome these limitations. Lewis's key idea was that modal
operators simultaneously shift the modal point of evaluation and the reference
of singular terms. Informally, $\exists x \Diamond Fx$ is true at $w$ iff the
domain of $w$ contains an individual for which there is a \emph{counterpart} at
some accessible point $w'$ that satisfies $Fx$.

Lewis also swapped the traditional, hybrid perspective of Kripke semantics for a
thoroughly internal perspective, where statements are evaluated not relative to
worlds, but relative to individuals at worlds (see esp.\
\cite[230-235]{plurality}). As a consequences, the `necessity of existence',
$\Box \exists y(x\!=\!y)$, comes out valid, while basic distribution principles
such as $\Box (A \land B) \then \Box A$ become invalid (as noted e.g.\ in
\cite{hazen79counterpart} and \cite{woollaston94counterpart}).

Lewis's internalist semantics has been further developed by Silvio Ghilardi,
Giancarlo Meloni, and Giovanna Corsi, who have shown that it has many useful and
interesting properties (see \cite{ghilardi88modal},
\cite{ghilardi91philosophical}, \cite{ghilardi01substitution}
\cite{corsi02counterpart}, \cite[591--616]{brauener07first}). However, it goes
against the traditional conception of modal predicate logic.

In this essay, I will investigate a semantics that combines the hybrid
perspective of classical Kripke semantics with the idea that individuals are
tracked across worlds by a counterpart relation. Since I will not assume that
the domain of individuals at different worlds are distinct, Kripke semantics
emerges as the special case where counterparthood is identity. As we will see,
allowing for counterpart relations other than identity results in a fairly
simple and intuitive framework that overcomes several shortcomings of standard
Kripke semantics.%
\footnote{%
  My proposal is inspired by \cite{kutz00kripke}, which in turn is inspired by
  \cite{skvortsov93maximal}. (\cite{kracht02semantics} summarizes the main
  results of \cite{kutz00kripke} in English.) Some of the key results announced
  in \cite{kutz00kripke} and \cite{kracht02semantics} are incorrect; these
  problems will be repaired. I will also offer a model theory for negative free
  logics without outer domains, and for languages with individual constants and
  object-language substitution operators. To incorporate individual constants,
  Kracht and Kutz \citey{kracht05semantics} switch from counterpart semantics to
  what Schurz \citey{schurz11combinations} calls \emph{worldline semantics},
  where quantifiers range over functions from worlds to individuals; see also
  \cite{kracht07logically}.%
} %

\cmnt{%
  The basic idea of counterpart semantics can also be motivated more abstractly,
  by the fact that it takes into account cross-world relations between
  individuals. Consider a temporal application, where the ``worlds'' are moments
  in time. An individual at one time may be an ancestor, or a cause, or an
  inspiration of an individual at a later time. Such relations connecting
  individuals from different worlds are nowhere to be found in a Kripke model.
  In counterpart semantics, they can be represented as counterpart relations.%
} %


\section{Counterpart models}\label{sec:models}

We want to reason about some ``worlds'', each of which is associated with some
``individuals'' that are assumed to exist at the relevant world, so that
$\Diamond \exists x Fx$ is true at a world iff there is some accessible world at
which there is an individual satisfying $Fx$.

A familiar choice point in Kripke semantics is whether we want to allow
different individuals to exist at different worlds. This question won't be
important in counterpart semantics. But we face an analogous question: whether
every individual at some world should have a counterpart at every other world
(or at every accessible world).

If we allows for individuals without counterparts at accessible worlds, the next
question is what can be said about things that don't exist. The alternatives are
well-known from free logic. One option is that if $x$ doesn't exist at $w$, then
every atomic predication $Fx$ is false at $w$. This is known as a
\emph{negative} semantics. Alternatively, one may hold that non-existence is no
bar to satisfying predicates, so that $Fx$ may be true at some worlds where $x$
doesn't exist and false at others. The extension of $F$ at a world must
therefore be specified not only for things that exist at that world, but also
for things that don't exist. This is known as a \emph{positive} semantics. Both
approaches have their applications, so I will explore them in tandem.%
\footnote{%
  There are also \emph{non-valent} options on which atomic predications with
  empty terms are neither true nor false. The account I will develop is easy to
  adapt to this approach; see \cite{schwarz12how}.%
} %

In positive models, terms are never genuinely empty. Worlds are associated with
an \emph{inner domain} of individuals existing at that world, and an \emph{outer
  domain} of individuals which, although they don't exist, may still fall in the
extension of atomic predicates. Every individual at any world will have at least
one counterpart at every accessible world, if only in the outer domain.

In negative models, we want to do without the somewhat ghostly outer domains.
When we shift the point of evaluation to a world where the value of $x$ has no
counterpart, the term becomes empty, and we stipulate that $Fx$ is always false.

\cmnt{%
  $\Diamond Fx$ will then also be false. For suppose $\Diamond Fx$ could be true
  while $\Diamond Fy$ is false, although $x$ and $y$ are both empty. We would
  then have to introduce outer domains after all, so that the referent of $x$
  has an $F$-counterpart while the referent of $y$ does not.

  Our single-domain counterpart models therefore validate the following
  principles that are not derivable from standard axioms and rules of negative
  free logic combined with those of the basic modal logic K: \label{NAfirst}
  \begin{semantics}
    \itemT{NA} $\neg Ex \then \Box \neg Ex$, \itemT{TE}
    $x\!=\!y \then \Box(Ex \then Ey)$.
  \end{semantics}
  Here $Ex$ abbreviates $\exists y(x\!=\!y)$. \T{NA} reflects the fact that
  non-existent objects don't have any counterparts. \T{TE} says that if $x$ is
  identical to $y$, and $x$ has a counterpart at some accessible world, then $y$
  also has a counterpart at that world. If we had outer domains, an individual
  could have some existing and some non-existing counterparts at a world, which
  would render \T{TE} false.
} %

A further question in counterpart-theoretic accounts is whether we want to allow
for what Allen Hazen calls ``internal relations'' (see
\cite[328--330]{hazen79counterpart}, \cite[232f.]{plurality}). Suppose Dee and
Dum are siblings, and consider a possible world that embeds two copies of the
actual world, a ``left'' copy and a ``right'' copy. We may want to say that this
world contains two counterparts of Dee and two of Dum, and that Dee and Dum are
necessarily siblings, even though not all counterparts of Dee and Dum at the
Left-Right world are siblings of one another.

To model this sort of situations, we need to allow for different ways of
locating the individuals from one world at another world. Formally, we will have
multiple counterpart relations. One relation will link Dee and Dum to their
counterparts in the left copy, another to their counterparts in the right copy.
$\Box Gab$ will be true iff, \emph{on every counterpart relation}, all
counterparts of $a$ are $G$-related to all counterparts of $b$.%
\footnote{\label{fn-multicr}%
  \cite{hazen79counterpart} introduces models with multiple counterpart
  relations, but stipulates that each relation is actually an injective
  function, in order to validate the necessity of identity and to get a
  traditional logic for `actually'. Multiple counterpart relations are also used
  in \cite{kutz00kripke} and \cite{kracht02semantics}. It turns out that the
  introduction of multiple counterpart relations makes little difference to the
  base logic. In particular, the logic of all positive or negative counterpart
  models is exactly the same either way. However, multiple counterpart relations
  will help in the construction of canonical models for stronger logics in
  section \ref{sec:canonical-models}, where we will run into a form of Hazen's ``problem of
  internal relations''.%
} %

Let's define the two kinds of models. As usual, a model combines an abstract
frame or structure with an interpretation of our language on that structure. The
relevant structures are defined as follows.

\begin{definition}[Counterpart structure]\label{!CS}
  A \emph{counterpart structure} is a quintuple $\Fr{S} = \t{W,R,U,D,K}$,
  consisting of
  \begin{compactenum}
  \item a non-empty set $W$ (of ``points'' or ``worlds''),
  \item a binary (``accessibility'') relation $R$ on $W$,
  \item a (``outer domain'') function $U$ that assigns to each
    $w \!\in\! W$ a set $U_w$,
  \item a (``inner domain'') function $D$ that assigns to each
    $w \!\in\! W$ a set $D_w \subseteq U_w$, and
  \item a (``counterpart-inducing'') function $K$ that assigns to each
    pair of points $\t{w,w'} \in R$ a non-empty set $K_{w,w'}$ of
    (``counterpart'') relations $C \subseteq U_w \times U_{w'}$.
  \end{compactenum}

  $\Fr{S}$ is \emph{positive} if (i) all outer domains $U_{w}$ are non-empty and
  (ii) all counterpart relations are total, in the sense that if
  $C \in K_{w,w'}$, then for each $d \in U_w$ there is a $d'\in U_{w'}$ with
  $dCd'$.

  $\Fr{S}$ is \emph{negative} (or \emph{single-domain}) if $D=U$. 
\end{definition}

\cmnt{%
  Note that in single-domain models it can happen that $wRw'$ but no individual
  in $U_w$ has any counterpart at $w'$ (perhaps because $U_w$ is empty). There
  will still be exactly one counterpart relation $C \in K_{w,w'}$, namely the
  empty relation containing no ordered pairs at all.%
} %

At first, the ``counterpart-inducing function'' with its associated many
counterpart relations may look unfamiliar. Think of this as constructed from a
Lewisian counterpart relation in two steps. First, we drop Lewis's requirement
of disjoint domains, so that an individual can occur in the domain of many or
all worlds. It is then not enough to just specify which individuals are
counterparts of other individuals. For example, $d$ at $w$ might have $d'$ as
its only counterpart at $w'$, and it might have $d''$ as its only counterpart at
$w''$, even though $d'$ also exists at $w''$. Now is $d'$ a counterpart of $d$?
In effect, counterparthood turns into a four-place relation between one
individual at one world and another (or the same) individual at another (or the
same) world. It proves convenient to represent this by associating each pair of
worlds with a ``local'' counterpart relation between the individuals in the
associated domains. In the second step, these local counterpart relation give
way to sets of relations in order to allow for internal relations.

The following terminology might help to make all this look more familiar. I will
say that in a given model, \emph{$d'$ at $w'$ is a counterpart of $d$ at $w$}
iff there is a $C \in K_{w,w'}$ such that $dCd'$. Similarly, a pair of
individuals \emph{$\t{d_1',d_2'}$ at $w'$ is a counterpart of $\t{d_1,d_2}$ at
  $w$} iff there is a $C \in K_{w,w'}$ such that $d_1Cd_1'$ and $d_2Cd_2'$. And
so on for larger sequences. (Note that an identity pair $\t{d,d}$ at $w$ has
$\t{d_1',d_2'}$ at $w'$ as counterpart iff there is a $C \in K_{w,w'}$ such that
$d$ is $C$-related to both $d_1'$ and $d_2'$.) As we will see, the
interpretation of modal formulas can be spelled out directly in terms of this
``counterpart relation'' between sequences rather than the function $K_{w,w'}$
on which it is officially based.

That counterparthood should be extended to sequences is suggested in
\cite{lewis83psct} and \cite{plurality}, in response to the problem of internal
relations. In the present framework, counterparthood between sequences is a
derivative notion. This has the advantage that it immediately rules out some
otherwise problematic possibilities. For example, it can never happen that a
pair $\t{d_1,d_2}$ at $w$ has $\t{d_1',d_2'}$ at $w'$ as counterpart although by
itself, $d_1$ at $w$ does not have $d_1'$ at $w'$ as counterpart. Similarly, it
can never happen that $\t{d_1,d_2}$ at $w$ has $\t{d_1',d_2'}$ at $w'$ as
counterpart while $\t{d_2,d_1}$ at $w$ does not have $\t{d_2',d_1'}$ at $w'$ as
counterpart. We also don't have to worry about ``gappy'' sequences that arise
when some things fail to have counterparts. And we automatically get a sensible
answer to the question which sequences, in general, matter for the evaluation of
a modal formula $\Box A$ at a world: should we consider only individuals denoted
by terms in $\Box A$? In what order should the individuals be listed: in order
of appearance in $\Box A$? Should we include repetitions if a term occurs more
than once in $A$? And so on.

\cmnt{%
  A new possibility arising from multiple counterpart relations is that in
  negative models, we could have one relation linking $d$ to $d'$ and another
  relation linking $d$ to no counterpart at all. In positive models, $d$ could
  be linked to an ``inner'' individual by one relation and to an ``outer''
  individual by another. Arguably, this should be allowed. For example, it might
  be that some George counterparts are childless. Relative to this choice of
  George counterpart, `Elizabeth' is empty, while it is non-empty relative to
  other choices of George counterpart.
} %

Next, we define interpretations of the language of quantified modal logic on
counterpart structures. To this end, we first have to say what that language is.

\begin{definition}[The standard language of QML]\label{!L}
  We assume that there is a denumerable set \emph{Var} of variables, a non-empty
  set \emph{Pred} of predicates, each associated with an arity. Formulas of the
  language \Sc{L} are generated by the rule
  \[
    Px_1\ldots x_n \1 x\!=\!y \1 \neg A \1 (A \then B) \1 \forall x A \1 \Box A,
  \]
  where $P$ is a predicate with arity $n$, and $x,y,x_1,\ldots,x_{n}$ are
  variables.
\end{definition}

Notational conventions:\label{conventions} I will use `$x$', `$y$', `$z$', `$v$'
(sometimes with indices or dashes) for members of $\emph{Var}$, and `$F$',
`$G$', `$P$' for members of $\emph{Pred}$ with arity 1, 2 and $n$, respectively.
Formulas involving `$\land$', `$\lor$', `$\leftrightarrow$', `$\exists$' and
`$\Diamond$' are defined by the usual metalinguistic abbreviations. The order of
precedence among connectives is $\neg, \land, \lor, \then$; association is to
the right. For any variable $x$, `$Ex$' abbreviates `$\exists y(y\!=\!x)$',
where $y$ is the alphabetically first variable other than $x$.
`$A_1 \land\ldots\land A_n$' stands for `$A_1$' if $n=1$, or for
`$(A_1 \land\ldots\land A_{n-1}) \land A_n$' if $n>1$, or for an arbitrary
tautology $\verum$ (say, `$x\!=\!x \then x\!=\!x$') if $n=0$. For any expression
or set of expressions $A$, $\var(A)$ is the set of variables in (members of)
$A$, and $\fvar(A)$ is the set of variables with free occurrences in (members
of) $A$.

Individual constants are not explicitly mentioned in definition \ref{!L}.
We can simulate individual constants by free variables.

\begin{definition}[Predicate interpretation]\label{!INT}
  Let $\Fr{S} = \t{W,R,U,D,K}$ be a counterpart structure. A \emph{predicate
    interpretation} $I$ \emph{for} $\Sc{L}$ \emph{on} $\Fr{S}$ is a function $I$
  that assigns to each world $w \in W$ a function $I_w$ such that
  \begin{compactenum}
    \item[(i)] for every non-logical predicate $P$ of $\Sc{L}$ with arity $n$,
    $I_w(P) \subseteq U_w^n$, and
  \item[(ii)] $I_w(=) = \{ \t{d,d} : d \in U_w \}$.
  \end{compactenum}
\end{definition}
\noindent%
(For zero-ary predicates $P$, clause (i) says that $I_w(P) \subseteq U_w^0$. For
any $U_w$, there is exactly one ``zero-tuple'' in $U_w^0$, which we may identify
with the empty set. So $U_w^0$ has exactly two subsets, the empty set
$\emptyset = 0$ and the unit set of the empty set $\{ \emptyset \} = 1$. It is
convenient to think of these as truth-values.)

\begin{definition}[Counterpart model]\label{!MOD}
  A \emph{counterpart model} $\Fr{M}$ consists of a counterpart structure
  $\Fr{S}$ together with a predicate interpretation $I$ for $\Sc{L}$ on
  $\Fr{S}$.

  We call $\Fr{M}$ \emph{positive} or \emph{negative} in accordance with whether
  $\Fr{S}$ is positive or negative.  
\end{definition}

% \begin{definition}[Assignment]\label{!ASSIGNMENT}
%   A \emph{variable assignment on} a structure $\Fr{S}$ is a function $V$ that
%   assigns to each world $w$ from $\Fr{S}$ a (total) function $V_w$ from
%   $\emph{Var}$ into $U_{w}$.
%   % In negative models, $V_{w}$ can be partial.
% \end{definition}

\begin{definition}[Assignment]\label{!ASSIGNMENT}
  A \emph{(variable) assignment on} a set $S$ is a possibly partial function $g$
  from $\emph{Var}$ into $S$.
\end{definition}

\begin{definition}[Variant]\label{!VARIANT}
  A variable assignment $g'$ is an \emph{$x$-variant of an assignment $g$ on a
    set $S$} if $g(x) \in S$ and $g'(y) = g(y)$ for all variables $y$ other than
  $x$.
\end{definition}

When modal operators shift the point of evaluation to another world, variables
denote counterparts of the things they originally denoted. Let's introduce an
operation that shifts the value of variables to the counterparts of their
original value.

\begin{definition}[Image]\label{!IMG}
  Let $\Fr{S} = \t{W,R,U,D,K}$ be a counterpart structure, $w,w'$ two worlds in
  $W$, and $g,g'$ assignments on $U_{w},U_{w'}$ respectively. We say that $g'$
  \emph{at $w$'} is an \emph{image of} $g$ \emph{at} $w$ (for short,
  $w,g \Img w',g'$) iff there is a $C \in K_{w,w'}$ such that for every variable
  $x$, if $g(x)$ is $C$-related to some element of $U_{w'}$ then $g(x) C g'(x)$,
  otherwise $g'(x)$ is undefined.
\end{definition}

In positive models, $g(x)$ is always $C$-related to some element of $U_{w'}$,
for any $C \in K_{w,w'}$.

\cmnt{%
  Remember that even if no member of $U_w$ has any counterpart at $w'$,
  $K_{w,w'}$ isn't empty: it still contains the empty set. Consequently, there
  will still be a $w'$-image of $V$ at $w$, namely the ``empty'' interpretation
  $V'$ with $V'_{w'}(x)$ undefined for all $x$. This is important e.g.\ for the
  interpretation of $\Box \neg Fx$ or $\Box p$.%
} %

Since modal operators shift the point of evaluation from one world to another
along the accessibility relation, it never matters what counterparts an
individual at one world has at another world unless that other world is
accessible. This is why I officially stipulated in definition \ref{!CS} that
counterparthood is only defined between accessible worlds.

As a consequence, $w,g \Img w',g'$ entails $wRw'$: if $w'$ is not accessible
from $w$ then there is no $C \in K_{w,w'}$. \label{Rredundant} In the semantics
of the box (coming up below), we therefore don't need to mention the
accessibility relation $R$.

% We could technically remove $R$ from our structures $\t{W,R,U,D,K}$, since it
% can be recovered from $K$: $\t{w,w'}\in R$ iff $\t{w,w'} \in Dom(K)$. In
% positive models, we also have $wRw'$ iff there are $d\in U_{w}, d'\in U_{w'}$
% such that for some $C \in K_{w,w'}$, $dCd'$. (In negative models, all
% individuals at $w$ may fail to have counterparts even at accessible worlds
% $w'$; there may even be no individuals at all in $U_w$. In either case,
% $K_{w,w'}$ will be the empty set, but it will still be defined.)

% Remember that even if no member of $U_w$ has any counterpart at $w'$,
% $K_{w,w'}$ isn't empty: it still contains the empty set. Consequently, there
% will still be a $w'$-image of $V$ at $w$, namely the ``empty'' interpretation
% $V'$ with $V'_{w'}(x)$ undefined for all $x$. This is important e.g.\ for the
% interpretation of $\Box \neg Fx$ or $\Box p$.%

\begin{definition}[Satisfaction]{\label{!SAT}}
  Let $\Fr{M} = \t{W,R,U,D,K,I}$ be a counterpart model, $w$ a member of $W$, and
  $g$ a variable assignment on $U_{w}$. Then we define, for any predicate $P$, variables $x_{1},\ldots,x_{n}$, and $\Sc{L}$-formulas $A,B$,
  \begin{semantics}
    \item[$\Fr{M},w,g \models Px_1\ldots x_n$] iff
    $\t{g(x_1),\ldots,g(x_n)} \in I_w(P)$.
    \item[$\Fr{M},w,g \models \neg A$] iff $\Fr{M},w,g \not\models A$.
    \item[$\Fr{M},w,g \models A \then B$] iff $\Fr{M},w,g \not\models A$ or $\Fr{M},w,g \models B$.
    \item[$\Fr{M},w,g \models \forall x A$] iff $\Fr{M},w,g' \models A$ for all
    $x$-variants $g'$ of $g$ on $D_w$.
    \item[$\Fr{M},w,g \models \Box A$] iff $\Fr{M},w',g' \SAT A$ for all
    $w',g'$ such that $w,g \Img w',g'$.
  \end{semantics}
\end{definition}

\cmnt{%
  Intuitively, the clause for the box means that if $A(x)$ is a formula in which only $x$
  occurs freely, then in positive models, $\Box A(x)$ is true at $w$ iff all
  counterparts of $g(x)$ at all accessible worlds satisfy $A(x)$, i.e.\ iff
  $A(x)$ is true at all accessible worlds under all assignments of counterparts
  of $g(x)$ to `$x$'. $\Box A(x,y)$ is true at $w$ iff all counterparts of the
  pair $\t{g(x),g(y)}$ at all accessible worlds satisfy $A(x,y)$. And so on.
  In negative models, if $g(x)$ has no counterpart at some accessible world
  $w'$ relative to some counterpart relation between $w$ and $w'$, the truth of
  $\Box A(x)$ at $w$ requires that $A(x)$ is also true at $w'$ under an
  interpretation that leaves `$x$' empty.%
} %

\cmnt{%
  I should perhaps mention that we are developing an ``extensional'' semantics,
  in which the semantic contribution of a name is exhausted by its referent. Our
  aim is not to model Lumpl=Goliath intuitions, where we would have
  $a=b \land \Diamond Fa \land \neg \Diamond Fb$. We can, of course, assume that
  the individuals that are the referents of names have a modal profile: they can
  be ``worms'', as in \cite{schwarz2014counterpart}. But we'll then read `=' as
  identity between worms, not as coincidence. We could also allow for different
  types of counterpart relation, for different sorts, perhaps.%
} %

Validity is truth at all points of evaluation under all interpretations:

\begin{definition}[Validity]{\label{!VALIDITY}}
  A set of $\Sc{L}$-formulas $\Gamma$ is \emph{positively valid} in a set
  $\Sigma$ of counterpart structures if $\Fr{S},I,w,g \models A$ for all
  $A \in \Gamma$, all $\Fr{S} = \t{W,R,U,D,K} \in \Sigma$, all interpretations
  $I$ on $\Fr{S}$, all worlds $w\in W$ and all total assignments $g$ on $U_{w}$.

  $\Gamma$ is \emph{negatively valid} in $\Sigma$ if $\Fr{S},I,w,g \models A$
  for all $A \in \Gamma$, all $\Fr{S} = \t{W,R,U,D,K} \in \Sigma$, all
  interpretations $I$ on $\Fr{S}$, all worlds $w\in W$ and all partial
  assignments $g$ on $U_{w}$.
\end{definition}

\cmnt{%
  In dual-domain structures, we could also introduce \emph{outer} quantifiers
  that range over members of $U_w$ instead of $D_w$.

  We might also assume that the outer domains is constant across worlds, and/or
  that it is the union of all inner domains, making the outer quantifiers
  ``possibilist''. In classical Kripke semantics, constant domains simplify the
  model theory considerably. In counterpart semantics, the identity of
  individuals across worlds plays no special role, wherefore not much is gained
  (from a purely formal point of view) by assuming that the (outer) domains are
  constant and/or that they are the union of the inner domains.

} %

\cmnt{%
  \begin{definition}[(Semantic) Consequence]\label{semcons}
    Let $\mathbb{C}$ be a set of models or structures. A formula $A$ is a
    \emph{(local) consequence} of a set of formulas $\Gamma$ \emph{in}
    $\mathbb{C}$ iff for all worlds $w$ in all models in $\mathbb{C}$, whenever
    all members of $\Gamma$ are true at $w$, then so is $A$. Two formulas $A$
    and $B$ are \emph{(locally) equivalent in} $\mathbb{C}$ iff they are
    consequences of one another in $\mathbb{C}$.
  \end{definition}
} %

In definition \ref{!SAT2}, the ``image'' relation $\Img$ between
world-assignment pairs $w,g$ plays the role of the accessibility relation in
standard Kripke semantics. This suggests that we could take the $\Img$ relation
as primitive, as some authors do. I have decided against this, for two reasons.

First, it would blur the distinction between the abstract structures in which
$\Sc{L}$ is interpreted and the interpretation itself. Variable assignments
belong to the interpretation of $\Sc{L}$. They don't represent an independent
aspect of a scenario in which $\Sc{L}$-formulas are interpreted.

One could get around this by replacing the variable assignments $g$ in the
semantics by infinite sequences of individuals $\t{d_{1},d_{2},\ldots}$, with
the understanding that the first individual $d_{1}$ is the value of the
alphabetically first variable, and so on. A second problem would still remain:
we would have to put the same kinds of constraints on the $\Img$ relation that
we want to put on counterpart relations between sequences, and these constraints
are easier to understand if the $\Img$ relation is derived from $R$ and
$K$. \label{p:tarski-semantics}

\begin{lemma}[Locality lemma]\label{locality}
  Let $A$ be an $\Sc{L}$-formula, $w$ a world in a counterpart model $\Fr{M}$,
  and $g, g'$ assignments on $U_{w}$ such that $g(x) = g'(x)$ for every variable
  $x$ that is free in $A$. Then
  \[
  \Fr{M},w,g \SAT A \text{ iff } \Fr{M},w,g' \SAT A.
  \]
\end{lemma}

\begin{proof}
  by induction on $A$. 
  FIXME
  \begin{enumerate}
  \item For atomic formulas, the claim is guaranteed directly by
    definition \ref{!SAT}.
  \item $A$ is $\neg B$.\; $w,V \SAT \neg B$ iff $w,V \not\SAT B$ by
    definition \ref{!SAT}, iff $w,V' \not\SAT B$ by induction
    hypothesis, iff $w,V' \SAT \neg B$ by definition \ref{!SAT}.
  \item $A$ is $B \then C$.\; $w,V \SAT B \then C$ iff $w,V \not\SAT
    B$ or $w,V \SAT C$ by definition \ref{!SAT}, iff $w,V' \not\SAT B$
    or $w,V' \SAT C$ by induction hypothesis, iff $w,V' \SAT B \then
    C$ by definition \ref{!SAT}.
  \item $A$ is $\forall x B$.\; By definition \ref{!SAT}, $w,V \SAT
    \forall x B$ iff $w,V^* \SAT B$ for all existential $x$-variants
    $V^*$ of $V$ on $w$. Each such $x$-variant $V^*$ agrees at $w$
    with the $x$-variant ${V'}^*$ of $V'$ on $w$ such that ${V'}^*(x)
    = V^*(x)$ on all variables in $B$. Conversely, each existential
    $x$-variant ${V'}^*$ of $V'$ on $w$ agrees at $w$ with the
    $x$-variant $V^*$ of $V$ on $w$ with $V^*(x) = {V'}^*(x)$ on all
    variables in $B$. So by induction hypothesis, $w,V^* \SAT B$ for
    all existential $x$-variants $V^*$ of $V$ on $w$ iff $w,{V'}^*
    \SAT B$ for all existential $x$-variants ${V'}^*$ of $V'$ on $w$,
    iff $w,V' \SAT \forall x B$ by definition \ref{!SAT}.
  \item $A$ is $\Box B$.\; By definition \ref{!SAT}, $w,V \SAT \Box B$
    iff $w',V^* \SAT B$ for all $w',V^*$ such that $wRw'$ and $V_w\Img
    V^*_{w'}$, where $V_w\Img V^*_{w'}$ means that there is a $C \in
    K_{w,w'}$ such that for every variable $x$, either
    $V_w(x)CV_{w'}^*(x)$ or $V_w(x)$ has no $C$-counterpart at $w'$
    and $V_{w'}^*(x)$ is undefined. Since $V_w(x) = V_w'(x)$ for all
    variables $x$, each $w'$-image of $V$ at $w$ agrees with some
    $w'$-image of $V'$ on all variables in $B$ and vice versa. So by
    induction hypothesis, $w',V^* \SAT B$ for all $w',V^*$ such that
    $wRw'$ and $V_w \Img V^*_{w'}$ iff $w',{V'}^* \SAT B$ for all
    $w',{V'}^*$ such that $wRw'$ and $V_w \Img {V'}^*_{w'}$, iff $w,V'
    \SAT \Box B$ by definition \ref{!SAT}. \qed
  \end{enumerate}
\end{proof}

Negative models can be ``simulated'' by positive models, in the following sense.
Starting with any negative model $\Fr{M}^{-}$, we can create a corresponding
positive model $\Fr{M}^{+}$ by adding a ``null individual'' $o$ to the outer
domain $U_w$ of every world $w$ that doesn't satisfy any predicates.

\begin{definition}[Positive transpose]{\label{!TRANSPOSE}}
  The \emph{positive transpose} $\Fr{M}^+$ of a counterpart model
  $\Fr{M} = \t{W,R,U,D,K,I}$ is the model $\t{W,R,U^+,D,K^+,I}$ with $U^+$,
  $K^+$, and $I^{+}$ constructed as follows.

  Let $o$ be an arbitrary individual (say, the smallest ordinal) not in
  $\bigcup_w D_w$. For all $w\in W$, $U^+_w = U_w \cup \{ o \}$.

  For all $\t{w,w'}\in R$, $K^+_{w,w'}$ is the set of relations
  $C^+ \subseteq U^+_w\times U^+_{w'}$ such that for some $C \in K_{w,w'}$,
  $C^+ = C \cup \{ \t{d,o} : d\in U^+_{w}$ and there is no $d'\in U_{w'}$ with
  $dCd'$ $\}$.%
  \cmnt{%
    (So in particular, $C^+$ contains $\t{o,o}$.)%
  } %
\end{definition}

\begin{lemma}[Truth-preservation under transposes]{\label{transpose}}
  If $\Fr{M}^{+}$ is the positive transpose of a counterpart model $\Fr{M}$,
  then for any world $w$ in $\Fr{M}$, any assignment $g$ on $U_{w}$, and any
  formula $A$ of $\Sc{L}$,
  \[
  \Fr{M},w,g \SAT A \text{ iff } \Fr{M}^{+},w,g \SAT A.
  \]
\end{lemma}
\begin{proof}
  FIXME
  by induction on $A$.
  \begin{enumerate}
  \item $A$ is $Px_1\ldots x_n$. By definition \ref{!SAT}, $w,V
    \SAT_{\Fr{S}} Px_1\ldots x_n$ iff $\t{V_w(x_1),\ldots,V_w(x_n)}
    \in V_w(P)$. If all $V_w(x_i)$ are defined, then $V_w^+(x_i) =
    V_w(x_i)$ and $V_w^+(P) = V_w(P)$ by definition \ref{!TRANSPOSE},
    and so $\t{V_w(x_1),\ldots,V_w(x_n)} \in V_w(P)$ iff
    $\t{V_w^+(x_1),\ldots,V_w^+(x_n)} \in V_w^+(P)$, i.e.\ iff $w,V^+
    \SAT_{\Fr{S}^+} Px_1\ldots x_n$. If some $V_w(x_i)$ is undefined,
    then $\t{V_w(x_1),\ldots,V_w(x_n)}$ is undefined and not in
    $V_w(P)$; so $w,V \not\SAT_{\Fr{S}} Px_1\ldots x_n$. Moreover, in
    this case $V^+_w(x_i) = o$ and since $V_w(P) = V_w^+(P)$ never
    contains any tuples involving $o$,
    $\t{V_w^+(x_1),\ldots,V_w^+(x_n)} \not\in V_w^+(P)$. So either
    way, $w,V \not\SAT_{\Fr{S}} Px_1\ldots x_n$ iff $w,V^+
    \SAT_{\Fr{S}^+} Px_1\ldots x_n$.
  \item $A$ is $\neg B$.\; $w,V \SAT_{\Fr{S}} \neg B$ iff $w,V
    \not\SAT_{\Fr{S}} B$ by definition \ref{!SAT}, iff $w,V^+
    \not\SAT_{\Fr{S}^+} B$ by induction hypothesis, iff $w,V^+
    \SAT_{\Fr{S}^+} \neg B$ by definition \ref{!SAT}.
  \item $A$ is $B \then C$.\; $w,V \SAT_{\Fr{S}} B \then C$ iff $w,V
    \not\SAT_{\Fr{S}} B$ or $w,V \SAT_{\Fr{S}} C$ by definition
    \ref{!SAT}, iff $w,V^+ \not\SAT_{\Fr{S}^+} B$ or $w,V^+
    \SAT_{\Fr{S}^+} C$ by induction hypothesis, iff $w,V^+
    \SAT_{\Fr{S}^+} B \then C$ by definition \ref{!SAT}.
  \item $A$ is $\forall x B$.\; By definition \ref{!SAT}, $w,V
    \SAT_{\Fr{S}} \forall x B$ iff $w,V' \SAT_{\Fr{S}} B$ for all
    existential $x$-variants $V'$ of $V$ on $w$. These $x$-variants
    $V'$ of $V$ correspond one-one to the $x$-variants ${V^+}'$ of
    $V^+$ with ${V^+}'_w(x) = V'_w(x)$. Moreover, for each such pair
    $V', {V^+}'$, $\t{\Fr{S}^+,{V^+}'}$ is the positive transpose of
    $\t{\Fr{S},V'}$. By induction hypothesis, $w,V' \SAT_{\Fr{S}} B$
    iff $w,{V^+}' \SAT_{\Fr{S}^+} B$. And so $w,V \SAT_{\Fr{S}}
    \forall x B$ iff $w,{V^+}' \SAT_{\Fr{S}^+} B$ for all existential
    $x$-variants ${V^+}'$ of $V^+$ on $w$, iff $w,V^+ \SAT_{\Fr{S}^+}
    \forall x B$ by definition \ref{!SAT}.

  \item $A$ is $\Box B$.\; Assume $w,V \SAT_{\Fr{S}} \Box B$. By
    definition \ref{!SAT}, this means that $w',V' \SAT_{\Fr{S}} B$ for
    all $w',V'$ with $wRw'$ and $V_w\Img V'_{w'}$. We need to show
    that $w',{V^+}' \SAT_{\Fr{S}^+} B$ for all $w',{V^+}'$ with $wRw'$
    and $V^+_w\Img {V^+}'_{w'}$. So let $w',{V^+}'$ be such that
    $wRw'$ and $V^+_w \Img {V^+}'_{w'}$. Since $V^+$ is a total
    interpretation and $\Fr{S}^+$ a total structure, this means that
    for every variable $x$ there is a $C^+ \in K^+_{w,w'}$ with
    $V_w^+(x)C^+{V^+}'_{w'}(x)$. Let $V'$ be the interpretation on
    $\Fr{S}$ that coincides with ${V^+}'$ except that $V'_w(x)$ is
    undefined for every world $w\in W$ and variable $x$ for which
    ${V^+}'_w(x) = o$. Let $C = \{ \t{d,d'} \in C : d \not=o \text{
      and } d'\not=o \}$. Now assume there are $d,d'$ with $V_w(x)=d$
    and $dCd'$. Then $V^+_w(x) = d$ and $dC^+d'$ and thus
    ${V^+}'_{w'}(x) \not= o$, for $\t{d,o} \in C^+$ only if there is
    no $d'$ with $\t{d,d'} \in C$. So $V'_{w'}(x) = {V^+}'_{w'}(x)$,
    and $V_w(x)CV'_{w'}(x)$. On the other hand, assume there are no
    $d,d'$ with $V_w(x)=d$ and $dCd'$, either because $V_w(x)$ is
    undefined or because $V_w(x)=d$ and the only $d'$ with $\t{d,d'}
    \in C^+$ is $o$. Either way, then ${V^+}'_{w'}(x) = o$, and so
    $V'_{w'}(x)$ is undefined. So for all variables $x$, if there are
    $d,d'$ with $V_w(x)=d$ and $dCd'$ then $V_w(x)CV'_{w'}(x)$,
    otherwise $V'_{w'}(x)$ is undefined. Since $C \in K_{w,w'}$ by
    construction of $K^+$ (definition \ref{!TRANSPOSE}), this means
    that $V_w \Img V'_{w'}$. But ${V^+}'$ is the positive transpose of
    $V'$. So we've shown that whenever $V^+_w \Img {V^+}'_{w'}$, then
    there is a $V'$ such that ${V^+}'$ is the positive transpose of
    $V'$ and $V_w \Img V'_{w'}$. We know that $w',V' \SAT_{\Fr{S}}
    B$. So by induction hypothesis, $w',{V^+}' \SAT_{\Fr{S}^+}
    B$. That is, for each $w',{V^+}'$ with $wRw'$ and $V^+_w \Img
    {V^+}'_{w'}$, $w',{V^+}' \SAT_{\Fr{S}^+} B$. By definition
    \ref{!SAT}, this means that $w, V^+ \SAT_{\Fr{S}^+} \Box B$.

    In the other direction, assume $w, V^+ \SAT_{\Fr{S}^+} \Box
    B$. That is, $w',{V^+}' \SAT_{\Fr{S}^+} B$ for each $w',{V^+}'$
    with $wRw'$ and $V^+_w \Img {V^+}'_{w'}$. We have to show that
    $w',V' \SAT_{\Fr{S}} B$ for all $w',V'$ with $wRw'$ and $V_w\Img
    V'_{w'}$. So let $w',V'$ be such that $wRw'$ and $V_w\Img
    V'_{w'}$. The latter means that there is a $C \in K_{w,w'}$ such
    that for every variable $x$, either $V_w(x)CV_{w'}'(x)$ or
    $V_w(x)$ has no $C$-counterpart at $w'$ and $V_{w'}'(x)$ is
    undefined. Let ${V'}^+$ be the positive transform of $V'$.  Let
    $C^+ = C \cup \{ \t{d,o} : d\in U^+_{w}$ and there is no $d'\in
    U_{w'}$ with $dCd'$ $\}$. By definition \ref{!TRANSPOSE}, $C^+ \in
    K^+_{w,w'}$. For any variable $x$, if $V_w(x)CV_{w'}'(x)$, then
    both $V_w(x)$ and $V_{w'}'(x)$ are defined and thus $V_w^+(x) =
    V_w(x)$ and ${V'}^+_{w'}(x) = V'_{w'}(x)$ by definition
    \ref{!TRANSPOSE}; moreover, then $V_w^+(x)C^+{V'}^+_{w'}(x)$ since
    $C \subseteq C^+$. On the other hand, if $V_w(x)$ has no
    $C$-counterpart at $w'$, so that $V'_{w'}(x)$ is undefined, then
    by construction of $C^+$ and $V_w^+$, $V_w^+(x)$ (which equals
    $V_w(x)$ if $V_w(x)$ is defined, else $o$) has $o$ as
    $C^+$-counterpart at $w'$; and ${V'}^+_{w'}(x)=o$; so again
    $V_w^+(x)C^+{V'}^+_{w'}(x)$. So for every variable $x$, there is a
    $C^+ \in K^+_{w,w'}$ with $V_w^+(x)C^+{V'}^+_{w'}(x)$, and so
    $V^+_w \Img {V'}^+_{w'}$. Now we know that $w',{V^+}'
    \SAT_{\Fr{S}^+} B$ for all $w',{V^+}'$ with $wRw'$ and $V^+_w \Img
    {V^+}'_{w'}$. Hence $w',{V'}^+ \SAT_{\Fr{S}^+} B$. By induction
    hypothesis, $w',V' \SAT_{\Fr{S}} B$. So we've shown that whenever
    $wRw'$ and $V_w \Img V'_{w'}$, then $w',V' \SAT_{\Fr{S}} B$. By
    definition \ref{!SAT}, this means that $w,V \SAT_{\Fr{S}} \Box
    B$. \qed
  \end{enumerate}
\end{proof}

(This shows that if a sentence is invalid on a negative structure then it is
invalid on its positive transpose. It does not follow that if a sentence is
valid on a negative structure then it is valid on its positive transpose:
validity on the positive transpose would mean truth at all points under all
interpretations of the predicates, including interpretations that make $o$
satisfy some predicates.)

\section{Substitution}\label{sec:substitution}

An odd feature of counterpart semantics, as defined in the previous section, is
that it invalidates some classical principles of substitution, such as the
``necessity of identity'', as formalised by
\begin{equation}\tag{NI}\label{NI}
  x\!=\!y \then (\Box x\!=\!x \then \Box x\!=\!y).
\end{equation}

Informally, if $x$ and $y$ denote the same individual, then $\Box x\!=\!x$ says
that at all accessible worlds, all counterparts of this individual are
self-identical, but $\Box x\!=\!y$ says that all counterpart of the individual
are identical \emph{to one another}.

\cmnt{%
  In the pair
  \begin{gather}
    x\!=\!y \then \Box Gxy \then \Box Gyy;\\
    x\!=\!y \then \Diamond Gxy \then \Diamond Gyy,\label{ex.ll-diamond}
  \end{gather}
  only the first sentence is valid. As Lewis \citey{lewis83psct} observed, in
  counterpart semantics modal operators effectively function as unselective
  binders of all variables in their scope.

  Informally, suppose $x$ and $y$ pick out the same individual $d$ at $w$, and
  this individual has two counterparts $d_{1}$ and $d_{2}$ at the only accessible
  world $w'$. When the point of evaluation is shifted from $w$ to $w'$, the
  semantic value of every variable shifts to a counterpart of its previous value.
  $\Box A$ says that $A$ is true at all accessible worlds under all such shifts.
  Thus $\Box Gxx$ is true at $w$ iff at $w'$, $d_{1}$ is $G$-related to itself
  \emph{and} $d_{2}$ is $G$-related to itself. $\Box Gxy$ requires, in addition,
  that $d_{1}$ and $d_{2}$ are $G$-related to one another. Conversely,
  $\Diamond G xy$ is true at $w$ iff there is a $G$-instance in
  $\{ d_{1}, d_{2} \}$. $\Diamond Gxy$ requires, more specifically, that either
  $d_{1}Gd_{1}$ or $d_{2}Gd_{2}$. We might say that the substituted variable $y$
  in \eqref{ex.ll-diamond} gets captured by the other occurrence of $y$ in the
  scope of the diamond.
} %

People sometimes complain that \eqref{NI} should be valid because it is an
instance of ``Leibniz's Law'', the schema
\begin{equation*}
  x\!=\!y \then (A \then [y/x]A).
\end{equation*}
But if $[y/x]A$ is the formula $A$ with some or all free occurrences of $x$
replaced by $y$, then this ``Law'' is invalid even in classical first-order
logic, as the following counterexample illustrates:
\begin{equation}\label{ex.ll}
  x\!=\!y \then (\exists y(x\!\not=\!y) \then \exists y(y\!\not=\!y)).
\end{equation}

In the substitution of $y$ for $x$ in $\exists y(x\!\not=\!y)$, the variable $y$
gets ``captured'' by the quantifier $\exists y$. A similar kind of capturing
happens in \eqref{NI}, on its counterpart-theoretic interpretation. In
counterpart semantics, modal operators effectively function as unselective
binders of all variables in their scope, as Lewis \citey{lewis83psct} observed.

There are three common ways to prevent unwanted capturing of substituted terms
in classical first-order logic.

The first restricts substitution principles like Leibniz' Law to individual
constants. In counterpart semantics, this wouldn't help. We don't officially
have individual constants, but if we had, then their referent would plausibly be
shifted by modal operators, just like the referent of individual variables. In
other words, modal operators are unselective binders of all \emph{singular
  terms} in their scope, not just of variables.

A second way to prevent unwanted instances of substitution principle in
classical first-order logic is to redefine the substitution operation $[y/x]$ so
that $[y/x]A$ renames all bound occurrences of $y$ in $A$ before $x$ is replaced
by $y$. We will see in section \ref{sec:substitution} that this approach also
doesn't work in counterpart semantics -- as one might already guess given the
fact that the box binds \emph{every} variable.

A third option allows restricts substitution principles like Leibniz' Law to
cases where the substituted variable doesn't get captured:
\begin{equation}\label{LL}\tag{LL}
  x\!=\!y \then (A \then [y/x]A), \text{ provided $y$ is free for $x$ in $A$}.
\end{equation}
In classical first-order logic, a variable $y$ is \emph{free (to be substituted)
  for $x$ in $A$} iff no free occurrence of $x$ in $A$ lies in the scope of a
quantifier that binds $y$. We are going to adopt this third response, but with a
different definition of `free for'.

Given that the box binds all free variables in its scope, $y$ always ends up
bound in $[y/x]A$. But modal contexts are not totally opaque. If $x$ and $y$
pick out the same individual $d$ then $\Box Fx$ and $\Box Fy$ are both true iff
(roughly) all counterparts of $d$ at all worlds are $F$. Problems only arise if
a modal operator contains both $x$ and $y$ in its scope, and $d$ has multiple
counterparts at some world. Informally, $\Box Gxy$ says that (at every
accessible world), every $d$-counterpart is $G$-related to every
$d$-counterpart. By contrast, $\Box Gxx$ and $\Box Gyy$ only say that every
$d$-counterpart is $G$-related to itself. As a result, $\Box Gxy \to \Box Gyy$
and $\Box Gxy \to \Box Gxx$ (and $\Diamond Gxx \to \Diamond Gxy$) are true, but
their converse is false.

It is hard to directly state conditions under which replacing \emph{some or all}
free occurrences of co-referring variables $x$ by $y$ is guaranteed to preserve
truth. We can simplify the task by only considering ``complete'' substitutions,
in which \emph{all} free occurrences of $x$ are replaced by $y$.

\begin{definition}[Substitution]\label{!SUBSTITUTION}
  If $A$ is any expression and $y$ and $x$ are variables, then $[y/x]A$ is the
  expression $A$ with all free occurrences of $x$ replaced by $y$.
\end{definition}

A complete substitution of a $y$ for $x$ in $A$ can never increase the number of
distinct variables in $A$. Very loosely speaking, if $x$ and $y$ co-refer then
$\Box A(x,y)$ is a stronger claim than $\Box A(y,y)$. Substituting $y$ for $x$
thus preserves truth. But $\neg \Box A(x,y)$ is weaker than $\neg\Box A(y,y)$.
So here we can't substitute $y$ for $x$.

The following restriction on substitution principles turns out to do the job.

\begin{definition}[Modal separation and modal freedom]\label{!MF}
  Let $A$ be a formula and $x,y$ variables.
  
  $y$ is \emph{quantificationally free (to be substituted) for $x$ in $A$} if no free
  occurrence of $x$ in $A$ lies in the scope of some occurrence of $\forall y$.

  $x$ and $y$ are \emph{modally separated in $A$} if no occurrence of $\Box$ in
  $A$ has free occurrences of both $x$ and $y$ in its scope.

  \cmnt{(It is allowed that $x$ and $y$ both occur freely in the scope
    of a modal operator in $A$, as long as at least one of them is
    bound from outside that operator, as in $A = \forall x \Box
    Gxy$.)}

  $y$ is \emph{(modally) free (to be substituted) for $x$ in $A$} if (i) $y$ is
  quantificationally free for $x$ in $A$ and (ii) \emph{either} $x$ and $y$ are modally
  separated in $A$ \emph{or} $A$ has the form $\Box B$ and $y$ is modally free
  for $x$ in $B$.

  [FIXME:CHECK: do I need to allow that $x$ is free for $x$ itself? at the moment I don't, but I used to have a special clause for this.]
\end{definition}

For example, $x$ and $y$ are modally separated in $\Box Fx \then \Diamond Fy$
and in $\forall x \Box Gxy$. $y$ is modally free for $x$ in $\Box x\!=\!y$ and
$\Box\Box \neg Gxy$, but not in $\Box\Diamond \neg Gxy$. Correspondingly,
\begin{gather*}
  x\!=\!y \then (\Box x\!=\!y \then \Box y\!=\!y) \text{ and}\\
  x\!=\!y \then (\Box\Box \neg Gxy \then \Box\Box \neg Gyy) \text{ and}\\
  x\!=\!y \then (\Box\Box \neg \exists x Gxy \then \Box\Box \neg \exists z Gyz)
\end{gather*}
are valid, but
\begin{equation*}
  x\!=\!y \then (\Box\Diamond \neg Gxy \then \Box\Diamond \neg Gyy)
\end{equation*}
is invalid.

\cmnt{%
  The first example is a tautological variant of Kutz's
  $x\!=\!y \then \Diamond x\!=\!x \then \Diamond x\!=\!y$.%
}

\cmnt{
  A natural first shot might be:
  \begin{quote}
    $x\!=\!y \then A \then [y/x]A$, provided $y$ and $x$ do not both
    occur in the scope of a diamond in $A$.
  \end{quote}
  But diamonds come in many disguises. E.g. $\Diamond \neg Fxy$ can
  also be expressed as $\neg(\verum \then \Box Gxy)$, or as $\Box Gxy
  \then \falsum$. (Our substitution system handles that correctly:
  $x\!=\!y \then (\Box Gxy \then \falsum) \Rightarrow \t{y:x}(\Box Gxy
  \then \falsum) \Rightarrow (\t{y:x}\Box Gxy \then \t{y:x}\falsum)
  \Rightarrow \neg \t{y:x}\Box Gxy \text{ [by propcal]} \Rightarrow
  \t{y:x}\neg\Box Gxy \Rightarrow \t{y:x}\Diamond \neg Gxy$.)
}

[\textbf{TODO:} Is there a more perspicuous constraint we could use? What do
Ghilardi and Shehtman etc. say?]


In classical first-order logic, one can prove that if $y$ is
(quantificationally) free for $x$ in $A$ then
\[
  g^{[y/x]} \models A \text{ iff } g \models [y/x]A,
\]
where $g^{[y/x]}$ is the assignment that maps $x$ to $g(y)$. This is often
called the ``substitution lemma''. In counterpart semantics, the situation is a
little more complicated.

\begin{definition}[Assignments under substitution]\label{!GSUB}
  If $g$ is a variable assignment on some domain $U_{w}$, and $x,y$ are
  variables, then $g^{[y/x]}$ is the $x$-variant of $g$ on $U_{w}$ with
  $g'(x) = g(y)$.
\end{definition}

We can prove the substitution lemma under the condition of modal separation and
quantificational freedom:

\begin{lemma}[Separation lemma]\label{rsl}
  Let $A$ be an $\Sc{L}$-formula, $\Fr{M} = \t{W,R,U,D,K,I}$ a counterpart
  model, $w$ a world in $W$, and $g$ an assignment on $U_{w}$. Then
  \[
    \Fr{M},w,g^{[y/x]} \SAT A \text{ iff } \Fr{M},w,g \SAT [y/x]A,
  \]
  provided that $y$ is quantificationally free for $x$ in $A$ and $x$ and $y$
  are modally separated in $A$.
\end{lemma}

\begin{proof}
  FIXME
  If $y$ and $x$ are the same variable, then $g^{[y/x]}$ is $g$, and $[y/x]A$ is
  $A$; and so $\Fr{M}, w, g^{[y/x]} \SAT A$ iff $\Fr{M}, w,g \SAT [y/x]A$, under
  any condition. Assume then that $y$ and $x$ are different variables.

  The proof is by induction on $A$. I use `$y$ is \emph{safe for $x$ in $S$}' as
  shorthand for `$y$ is quantificationally free for $x$ in $S$ and $x$ and $y$
  are modally separated in $S$'.

  \begin{enumerate}

    \item $A$ is $Px_{1}\ldots x_{n}$. Since $g^{[y/x]}(x_{i}) = g([y/x]x_{i})$
          for any variable $x_{i}$, we have
          $\Fr{M},w,g^{[y/x]} \SAT P x_1\ldots x_n$ iff
          $\Fr{M},w,g \SAT [y/x]P x_1\ldots x_n$ under any condition.
          
    \item $A$ is $\neg B$.\; Assume $y$ is safe for $x$ in $A$. Then $y$ is also
          safe for $x$ in $B$. By definition \ref{!SAT},
          $\Fr{M},w,g^{[y/x]} \SAT \neg B$ iff $\Fr{M},w,g^{[y/x]} \not\SAT B$.
          By induction hypothesis, $\Fr{M},w,g^{[y/x]} \not\SAT B$ iff
          $\Fr{M},w,g \not\SAT [y/x]B$. And $\Fr{M},w,g \not\SAT [y/x]B$ iff
          $\Fr{M},w,g \SAT [y/x]\neg B$, by definition \ref{!SAT} and the fact
          that $[y/x]\neg B$ = $\neg [y/x]B$. So
          $\Fr{M},w,g^{[y/x]} \SAT \neg B$ iff $\Fr{M},w,g \SAT [y/x]\neg B$.

    \item $A$ is $B \then C$.\; Parallel to the previous case.

    \item $A$ is $\forall z B$.\; We need to distinguish three cases.

          First, $z = x$. In this case, there are no free occurrences of $x$ in
          $A$. So $[y/x]A = A$. Also, by the locality lemma (lemma
          \ref{locality}), the truth-value of $A$ does not depend on the value
          of $x$. Thus $\Fr{M},w,g^{[y/x]} \SAT A$ iff $\Fr{M},w,g \SAT A$ iff
          $\Fr{M},w,g \SAT [y/x]A$.

          Second, $z = y$. In this case, the assumption that $y$ is
          quantificationally free for $x$ in $A$ entails that there are again no
          free occurrences of $x$ in $A$, and the same reasoning applies.

          Finally, assume $z \not\in \{x,y\}$. Assume also that $y$ is safe for
          $x$ in $A$, and therefore in $B$. By definition \ref{!SAT},
          $\Fr{M},w,g^{[y/x]} \SAT forall z B$ iff $\Fr{M},w,g^{[y/x]\prime} \SAT B$
          for every $z$-variant $g^{[y/x]\prime}$ of $g^{[y/x]}$ on $D_{w}$. Let
          $g^{[y/x][z\to d]}$ be the $z$-variant of $g^{[y/x]}$ on $D_{w}$ that maps
          $z$ to $d$, where $d$ is some element of $D_{w}$. By definition
          \ref{!SAT}, $\Fr{M},w,g^{[y/x]} \SAT forall z B$ iff
          $\Fr{M},w,g^{[y/x][z\to d]} \SAT B$ for every $d\in D_{w}$. Since
          $z \not= x$, $g^{[y/x][z\to d]}$ is $g^{[z\to d][y/x]}$.
          So $\Fr{M},w,g^{[y/x]} \SAT forall z B$ iff
          $\Fr{M},w,g^{[z\to d][y/x]} \SAT B$ for every $d\in D_{w}$. By induction hypothesis,
          $\Fr{M},w,g^{[z\to d][y/x]} \SAT B$ iff
          $\Fr{M},w,g^{[z\to d]} \SAT [y/x]B$.
          So $\Fr{M},w,g^{[y/x]} \SAT forall z B$ iff
          $\Fr{M},w,g^{[z\to d]} \SAT [y/x]B$ for every $d\in D_{w}$, iff
          $\Fr{M},w,g \SAT [y/x]\forall z B$ by definition \ref{!SAT}.


          % For any assignment $g$ and individual $d$, let $g^{[x\to d]}$ be the
          % $x$-variant of $g$ that maps $x$ to $d$. With this notation,
          % definition \ref{!SAT} says that $\Fr{M},w,g^{[y/x]} \SAT forall z B$
          % iff $\Fr{M},w,g^{[y/x][z\to d]} \SAT B$ for all $d \in D_{w}$, and
          % that $\Fr{M},w,g \SAT [y/x]forall z B$ iff
          % $\Fr{M},w,g^{[[y/x]z\to d]} \SAT [y/x]B$ for all $d \in D_{w}$. We
          % have to show that $\Fr{M},w,g^{[y/x][z\to d]} \SAT B$ for all
          % $d \in D_{w}$ iff $\Fr{M},w,g^{[[y/x]z\to d]} \SAT [y/x]B$ for all
          % $d \in D_{w}$. We will show, more strongly, that for any
          % $d \in D_{w}$,
          % \[
          %   \Fr{M},w,g^{[y/x][z\to d]} \SAT B \text{ iff } \Fr{M},w,g^{[[y/x]z\to d]} \SAT [y/x]B.
          % \]

          % For the case where $z=y$, we have to show that $\Fr{M},w,g^{[y/x][y\to d]} \SAT B$
          % iff $\Fr{M},w,g^{[y\to d]} \SAT [y/x]B$. By induction hypothesis,
          % $\Fr{M},w,g^{[y\to d]} \SAT [y/x]B$ iff
          % $\Fr{M},w,g^{[y\to d][y/x]} \SAT B$ iff
          % $\Fr{M},w,g^{[y\to d][x \to d]} \SAT B$. Since $y$ is 
          % quantificationally separated in $A$, $x$ is not free in $B$. By lemma
          % \ref{!LOCALITY}, it follows that
          % $\Fr{M},w,g^{[y\to d][x \to d]} \SAT B$ iff
          % $\Fr{M},w,g^{[y/x][y\to d]} \SAT B$ (because $g^{[y\to d][x \to d]}$
          % and $g^{[y/x][y\to d]}$ differ at most in the value they assign to $x$).
          % We distinguish three cases.


          % If $z=x$, then $g^{[y/x][z\to d]} = g^{[y/x][x\to d]} = g^{[x \to d]}$
          % % and $g^{[z\to d][y/x]} = g^{[x\to d][y/x]} = g^{[y/x]}$
          % and $g^{[[y/x]z\to d]} = g^{[[y/x]x\to d]} = g^{[y \to d]}$. So we
          % have to show that $\Fr{M},w,g^{[x\to d]} \SAT B$ iff
          % $\Fr{M},w,g^{[y\to d]} \SAT [y/x]B$. By induction hypothesis
          % $\Fr{M},w,g^{[y\to d]} \SAT [y/x]B$ iff
          % $\Fr{M},w,g^{[y\to d][y/x]} \SAT B$. Note that
          % $g^{[y\to d][y/x]} = g^{[y\to d][x \to d]}$. Since $y$ is quantificationally free for $x$ in $A$, nd $y$ are
          % quantificationally separated in $A$, $y$ is not free in $B$. By lemma
          % \ref{!LOCALITY}, it follows that
          % $\Fr{M},w,g^{[y\to d][x\to d]} \SAT B$ iff
          % $\Fr{M},w,g^{[x\to d]} \SAT B$.


  % \item $A$ is $\t{y_2:z} B$.\; This case is similar to the previous
  %   one.  Assume first that $[y/x]\t{y_2:z} B$ is $\t{[y/x]y_2:[y/x]z}
  %   [y/x]B$, i.e. (by definition \ref{!SUB}) neither $z=y$ and $x \in
  %   \fvar(B)$ nor $z=x$ and $y \in \fvar(B)$. By definition
  %   \ref{!SAT}, $\Fr{M},w,g \SAT \t{[y/x]y_2: [y/x]z}[y/x]B$ iff $\Fr{M},w,g' \SAT
  %   [y/x]B$, where $g'$ is the $[y/x]z$-variant of $g$ on $w$ with
  %   $g'_w([y/x]z) = g_w([y/x]y_2)$. Since a proviso of (i) or (ii)
  %   applies to $A$ and therefore a proviso of (i) applies to $B$, by
  %   induction hypothesis, $\Fr{M},w,g' \SAT [y/x]B$ iff $\Fr{M},w,g^{\prime [y/x]}
  %   \SAT B$.

  %   Let $g^*$ be the $z$-variant of $g^{[y/x]}$ on $w$ with $g^*_w(z)
  %   = g_w([y/x]y_2)$. If $z \not\in \{x,y\}$, then $g^*_w(x) =
  %   g^*_w(y) = g_w(y)$ and $g^*(z) = g_w([y/x]y_2)$. Moreover,
  %   $g^{\prime[y/x]}_w(x) = g^{\prime[y/x]}_w(y) = g_w(y)$ and
  %   $g^{\prime[y/x]}_w(z) = g^{\prime[y/x]}_w([y/x]z) =
  %   g_w([y/x]y_2)$. So $g^{\prime[y/x]}$ and $g^*$ agree about all
  %   variables at $w$. Alternatively, if $z=x$, and thus $y\not\in
  %   \fvar(B)$, then $g^{\prime[y/x]}_w(x) = g_w([y/x]y_2) =
  %   g^*_w(x)$. Similarly, if $z=y$, and thus $x\not\in \fvar(B)$, then
  %   $g^{\prime[y/x]}_w(y) = g_w([y/x]y_2) = g^*_w(y)$. Either way,
  %   $g^{\prime[y/x]}$ and $g^*$ agree at $w$ about all free variables
  %   in $B$. By the coincidence lemma \ref{coincidence}, $\Fr{M},w,g^{\prime
  %     [y/x]} \SAT B$ iff $\Fr{M},w,g^* \SAT B$, iff $\Fr{M},w,g^{[y/x]} \SAT
  %   \t{[y/x]y_2: z} B$ by definition \ref{!SAT}.

    \item $A$ is $\Box B$.\; Assume $y$ is safe for $x$ in $A$, and therefore in
          $B$. This means that either $x$ or $y$ has no free occurrence in $A$.

          If $x$ has no free occurrence in $A$ then $[y/x]A = A$ and
          $\Fr{M},w,g^{[y/x]} \SAT A$ iff $\Fr{M},w,g \SAT A$ iff
          $\Fr{M},w,g \SAT [y/x]A$ by the locality lemma.

          Assume that $y$ has no free occurrence in $A$. By definition
          \ref{!SAT}, $\Fr{M},w,g^{[y/x]} \SAT \Box B$ iff
          $w',g^{[y/x]\prime} \SAT B$ for all $w',g^{[y/x]\prime}$ with
          $w,g^{[y/x]} \Img w',g^{[y/x]\prime}$.

          FIXME Consider any $w'$-image $g^{[y/x]\prime}$ of $g^{[y/x]}$ at
          $w$; i.e.\ for some counterpart relation $C\in K_{w,w'}$ and all
          variables $z$, $g^{[y/x]\prime}_{w'}(z)$ is a $C$-counterpart of
          $g^{[y/x]}_w$ (or undefined if there is none). Let $g^*$ be like
          $g^{[y/x]\prime}$ except that $g^*_{w'}(y) = g^{[y/x]\prime}_{w'}(x)$.
          Let $g'$ be like $g^*$ except that $g'_{w'}(x)$ is some
          $C$-counterpart of $g_w(x)$, or undefined if there is none. Then
          $g_w \Img g'_{w'}$. (In particular,
          $g'_{w'}(y) = g^*_{w'}(y) = g^{[y/x]\prime}(x)$ is some
          $C$-counterpart of $g^{[y/x]}_w(x) = g_w(y)$, or undefined if there is
          none.) So by \eqref{rsl2}, $w', g^{\prime[y/x]} \SAT B$. But
          $g^{\prime[y/x]} = g^*$ (since $g^*_{w'}(x) = g^*_{w'}(y)$). So
          $w',g^* \SAT B$. And since $y \not\in \var(B)$ and $g^*$ is a
          $y$-variant of $g^{[y/x]\prime}$ on $w'$, by the coincidence lemma
          \ref{coincidence}, $w',g^* \SAT B$ iff $w',g^{[y/x]\prime} \SAT B$.
          \qed

          
    (i). By definition \ref{!SAT}, $\Fr{M},w,g^{[y/x]} \SAT \Box B$ iff
    $w',g^{[y/x]\prime} \SAT B$ for all $w',g^{[y/x]\prime}$ with
    $wRw'$ and $g^{[y/x]}_w \Img g^{[y/x]\prime}_{w'}$. On the other hand,
    $\Fr{M},w,g \SAT [y/x]\Box B$ iff $\Fr{M},w,g \SAT \Box [y/x]B$ (by definition
    \ref{!SUB}), iff $w',g' \SAT [y/x]B$ for all $w',g'$ with $wRw'$
    and $g_w \Img g'_{w'}$. Since the provisos of (i) carry over from
    $\Box B$ to $B$, by induction hypothesis, $w',g^{\prime [y/x]}
    \SAT B$ iff $w',g' \SAT [y/x]B$. So we have to show that
    \begin{equation}\tag{1}\label{rsl1}
      w',g^{[y/x]\prime} \SAT B \text{ for all $w',g^{[y/x]\prime}$ such that
        $wRw'$ and $g^{[y/x]}_w \Img g^{[y/x]\prime}_{w'}$}
    \end{equation}
    iff
    \begin{equation}\tag{2}\label{rsl2}
      w',g^{\prime[y/x]} \SAT B \text{ for all $w',g'$ such that $wRw'$ and
        $g_w \Img g'_{w'}$.}
    \end{equation}
    
    \eqref{rsl1} implies \eqref{rsl2} because every interpretation
    $g^{\prime[y/x]}$ with $g_w \Img g'_{w'}$ is also an
    interpretation $g^{[y/x]\prime}$ with $g^{[y/x]}_w \Img
    g^{[y/x]\prime}_{w'}$. The converse, however, may fail: both
    $g^{\prime[y/x]}_{w'}$ and $g^{[y/x]\prime}_{w'}$ assign to $x$
    and $y$ some counterpart of $g_w(y)$ (if there is any). But while
    $g^{\prime[y/x]}_{w'}$ assigns \emph{the same} counterpart to $x$
    and $y$, $g^{[y/x]\prime}_{w'}$ may choose different counterparts
    for $x$ and $y$ relative to the same counterpart relation.

    If there is no counterpart relation relative to which $g_w(y)$ has
    multiple counterparts, then this cannot happen. Thus under proviso
    (b), each $g^{[y/x]\prime}$ with $g^{[y/x]}_w \Img
    g^{[y/x]\prime}_{w'}$ is also a $g^{\prime[y/x]}$ with $g'_w \Img
    g^{\prime[y/x]}_{w'}$, and so \eqref{rsl2} implies \eqref{rsl1}. \qed

  \end{enumerate}
\end{proof}

If we weaken the condition to modal freedom, we only get one direction of the
lemma:

\begin{lemma}[Restricted substitution lemma]\label{rsl}
  Let $A$ be an $\Sc{L}$-formula, $\Fr{M} = \t{W,R,U,D,K,I}$ a counterpart
  model, $w$ a world in $W$, and $g$ an assignment on $U_{w}$. If $y$ is (modally)
  free for $x$ in $A$, then
  \[
    \text{if } \Fr{M},w,g^{[y/x]} \SAT A \text{ then }\Fr{M},w,g \SAT [y/x]A.
  \]
\end{lemma}

\begin{proof}
  FIXME
  
  As in the proof of the previous lemma, we can assume that $x$ and $y$ are
  different variables. The proof is by induction on $A$, but we don't have to go
  through all cases separately.

  Assume $A$ is not of the form $\Box B$, and that $y$ is modally free for $x$
  in $A$. By definition of modal freedom, it follows that $y$ is
  quantificationally free for $x$ in $A$ and $x$ and $y$ are modally separated
  in $A$. The target claim then follows by the separation lemma.

  Assume $A$ has the form $\Box B$.

    (ii). Assume $\Fr{M},w,g^{[y/x]} \SAT \Box B$. By definition \ref{!SAT},
    then $w',g^{[y/x]\prime} \SAT B$ for all $w',g^{[y/x]\prime}$ with
    $wRw'$ and $g^{[y/x]}_w \Img g^{[y/x]\prime}_{w'}$. As before,
    every interpretation $g^{\prime[y/x]}$ with $g_w \Img g'_{w'}$ is
    also an interpretation $g^{[y/x]\prime}$ with $g^{[y/x]}_w \Img
    g^{[y/x]\prime}_{w'}$. So $w',g^{\prime[y/x]} \SAT B$ for all
    $w',g^{\prime[y/x]}$ with $wRw'$ and $g_w \Img g'_{w'}$.
    
    If $y$ is modally free for $x$ in $\Box B$, then $y$ is modally
    free for $x$ in $B$. Then by induction hypothesis, $w',g' \SAT
    [y/x]B$ \emph{if} $w',g^{\prime [y/x]} \SAT B$. So $w',g' \SAT
    [y/x]B$ for all $w',g'$ with $wRw'$ and $g_w \Img g'_{w'}$. By
    definition \ref{!SAT}, this means that $\Fr{M},w,g \SAT \Box [y/x]B$, and
    so $\Fr{M},w,g \SAT [y/x] \Box B$ by definition \ref{!SUB}. \qed
    
\end{proof}

The converse of is not true. For example, $\Fr{M},w,g \SAT [y/x] \Box x\!=\!y$
does not imply $\Fr{M},w,g^{[y/x]} \SAT \Box x\!=\!y$. But the present direction
is enough for substitution principles like Leibniz' Law or Universal
Instantiation. Loosely speaking, these principles allow substituting $y$ for $x$
under conditions that ensure that the LHS of lemma \ref{rsl} is satisfied.

For future reference, we may note that the problem of modal capturing only
arises if individuals can have multiple counterparts relative to the same
counterpart relation.

\begin{lemma}[Functional substitution lemma]\label{functional-substition-lemma}
  Let $A$ be an $\Sc{L}$-formula, $\Fr{M} = \t{W,R,U,D,K,I}$ a counterpart
  model, $w$ a world in $W$, and $g$ an assignment on $U_{w}$. Then
  \[
    \Fr{M},w,g^{[y/x]} \SAT A \text{ iff } \Fr{M},w,g \SAT [y/x]A,
  \]
  provided that $y$ is quantificationally free for $x$ in $A$ and all
  counterpart relations $C$ in $K$ are \emph{functional}, meaning that if
  $d_{1}Cd_{2}$ then there is no $d_{3} \not= d_{2}$ for which $d_{1}C d_{2}$.
\end{lemma}

\cmnt{%
  The proviso could be weakened to ``it is not the case that a relevant
  counterpart of $g(y)$ has multiple counterparts at any world \emph{reachable}
  from $w$'', where reachability is the transitive closure of accessibility.
  Only considering worlds accessible from $w$ is not enough: if $y$ has only one
  counterpart at all $w'$. but two counterparts at some $w''$, then
  $\t{y:x}\Diamond\Diamond x\!\not=\!y$ is true, but
  $[y/x]\Diamond\Diamond x\!\not=\!y = \Diamond\Diamond y\!\not=\!y$ is false.
}%

\begin{proof}
  FIXME
  
  As in the proof of the previous lemma, we can assume that $x$ and $y$ are
  different variables. The proof is by induction on $A$. All cases except the one for $\Box A$ are parallel to those in the proof of the previous lemma.

  Assume $A$ has the form $\Box B$.

    (i). By definition \ref{!SAT}, $\Fr{M},w,g^{[y/x]} \SAT \Box B$ iff
    $w',g^{[y/x]\prime} \SAT B$ for all $w',g^{[y/x]\prime}$ with
    $wRw'$ and $g^{[y/x]}_w \Img g^{[y/x]\prime}_{w'}$. On the other hand,
    $\Fr{M},w,g \SAT [y/x]\Box B$ iff $\Fr{M},w,g \SAT \Box [y/x]B$ (by definition
    \ref{!SUB}), iff $w',g' \SAT [y/x]B$ for all $w',g'$ with $wRw'$
    and $g_w \Img g'_{w'}$. Since the provisos of (i) carry over from
    $\Box B$ to $B$, by induction hypothesis, $w',g^{\prime [y/x]}
    \SAT B$ iff $w',g' \SAT [y/x]B$. So we have to show that
    \begin{equation}\tag{1}\label{rsl1}
      w',g^{[y/x]\prime} \SAT B \text{ for all $w',g^{[y/x]\prime}$ such that
        $wRw'$ and $g^{[y/x]}_w \Img g^{[y/x]\prime}_{w'}$}
    \end{equation}
    iff
    \begin{equation}\tag{2}\label{rsl2}
      w',g^{\prime[y/x]} \SAT B \text{ for all $w',g'$ such that $wRw'$ and
        $g_w \Img g'_{w'}$.}
    \end{equation}
    
    \eqref{rsl1} implies \eqref{rsl2} because every interpretation
    $g^{\prime[y/x]}$ with $g_w \Img g'_{w'}$ is also an
    interpretation $g^{[y/x]\prime}$ with $g^{[y/x]}_w \Img
    g^{[y/x]\prime}_{w'}$. The converse, however, may fail: both
    $g^{\prime[y/x]}_{w'}$ and $g^{[y/x]\prime}_{w'}$ assign to $x$
    and $y$ some counterpart of $g_w(y)$ (if there is any). But while
    $g^{\prime[y/x]}_{w'}$ assigns \emph{the same} counterpart to $x$
    and $y$, $g^{[y/x]\prime}_{w'}$ may choose different counterparts
    for $x$ and $y$ relative to the same counterpart relation.

    If there is no counterpart relation relative to which $g_w(y)$ has
    multiple counterparts, then this cannot happen. Thus under proviso
    (b), each $g^{[y/x]\prime}$ with $g^{[y/x]}_w \Img
    g^{[y/x]\prime}_{w'}$ is also a $g^{\prime[y/x]}$ with $g'_w \Img
    g^{\prime[y/x]}_{w'}$, and so \eqref{rsl2} implies \eqref{rsl1}. \qed
\end{proof}

It will be useful to have a notion of substitution that applies to several
variables at once. 

\begin{definition}[Substitution]\label{!SUBS}
  A \emph{substitution} is a total function $\sigma: \emph{Var} \to \emph{Var}$.
  If $\sigma$ is injective, it is called a \emph{transformation}. We write
  $[y_1,\ldots,y_n/x_1,\ldots,x_n]$ for the substitution that maps $x_1$ to
  $y_1$, \ldots, $x_n$ to $y_n$, and every other variable to itself.%
  \cmnt{%
    (So $[y_1,\ldots,y_n/x_1,\ldots,x_n]$ is only meaningful (and non-redundant)
    if the $x_1,\ldots,x_n$ are pairwise distinct.)%
  }

  For any expression $A$, $\sigma(A)$ is the expression that results from $A$ by
  simultaneously replacing every free variable $x$ by $\sigma(x)$. I will
  sometimes write $\sigma A$ or $A^\sigma$ instead of $\sigma(A)$.

  If $\Gamma$ is a set of formulas, then $\sigma(\Gamma)$ or $\Gamma^\sigma$ is
  $\{ C^\tau : C \in \Gamma \}$.

\end{definition}

Here is the corresponding generalisation of $g^{[y/x]}$.

\begin{definition}[Assignments under substitution]
  If $g$ is an assignment and $\sigma$ a substitution, then $g^\sigma$ is the
  assignment that maps every variable $x$ to $g(\sigma(x))$.
\end{definition}

Substitutions can be composed. If $\sigma$ and $\tau$ are substitutions, then
$\tau \cdot \sigma$ is the substitution that maps each variable $x$ to
$\tau(\sigma(x))$. Observe that composition appears to behave differently in
superscripts of formulas than in superscripts of assignments: for formulas
$A$,
\begin{gather*}
  (A^\sigma)^\tau = \tau(\sigma(A)) = A^{\tau \cdot \sigma},
\end{gather*}
but for assignments $g$,
\begin{gather*}
  (g^\sigma)^\tau = Vg^{\sigma \cdot \tau}.
\end{gather*}
That's because
$(g^\sigma)^\tau(x) = g^\sigma(\tau(x)) = g(\sigma(\tau(x))) = g(\sigma\cdot\tau(x)) = g^{\sigma\cdot\tau}(x)$.

Definition \ref{!SUBS} draws attention to the class of injective substitutions,
or transformations. These will play a prominent role in canonical models.

A transformation never substitutes two distinct variables by the same variable.
For instance, the identity substitution $[x/x]$ or the swapping operation
$[x,y/y,x]$ are transformations.

For transformations $\tau$, it proves convenient to define $\tau(A)$ as a
replacement of \emph{all} variables $x$ -- free and bound -- in $A$ by
$\tau(x)$. This operation makes capturing impossible. For the free variable $y$
in $\forall x A(y)$ to be captured by $\forall x$ after substitution, $x$ and
$y$ have to be replaced by the same variable. Modal capturing also becomes
impossible, as the following lemma shows.

FIXME: I shouldn't use different definitions of $\sigma(A)$ depending on whether
$\sigma$ is injective or not. But if I always allow substituting bound
variables, then my definition of $[y/x]A$ is different from how everyone else
defines it, and we need to strengthen quantificational freedom to avoid renaming
$x$ in $\forall x Gxy$ to $y$. I then can't easily compare my logics to the
standard logics. So I should probably not allow substituting bound variables for
transformations, and make the Transformation Lemma subject to the condition that
$y$ is quantificationally free for $x$ in $A$. Need to check how this affects
the canonical model stuff.

\begin{lemma}[Transformation Lemma]\label{transl}
  For any world $w$ in any model $\Fr{M}$, any variable assignment $g$ on
  $U_{w}$, any formula $A$ and transformation $\tau$,
  $\Fr{M},w,g^\tau \models A$ iff $\Fr{M},w,g \models A^\tau$.
\end{lemma}

\begin{proof}
  FIXME
  by induction on $A$.


  Let's look at the clause for the box. To show:
  $\Fr{M},w,g^\tau \models \Box B$ iff $\Fr{M},w,g \models \Box B^\tau$.

  Assume $\Fr{M},w,g \not\SAT \Box B^\tau$. Then $w',g' \not\SAT B^\tau$ for
  some $w',g'$ with $w,g \Img w',g'$. This means that there is a counterpart
  relation $C\in K_{w,w'}$ such that for all variables $x$, $g'(x)$ is some
  $C$-counterpart of $g(x)$ (or undefined if $g'(x)$ has no $C$-counterpart). By induction hypothesis,
  $w',{g'}^\tau \not\SAT B$. For any variable $x$,
  ${g'}^\tau(x) = g'(x^\tau)$ and $g^\tau(x) = g(x^\tau)$. So
  ${g'}^\tau(x)$ is a $C$-counterpart of $g^\tau(x)$ (or undefined if ${g}^{\tau}(x)$ has no $C$-counterpart). So $w,g^{\tau} \Img w',{g'}^\tau$. Hence
  $w',{g'}^\tau \not\SAT B$ for some $w',{g'}^\tau$ with $w,g^{\tau} \Img w',{g'}^\tau$.
  So $\Fr{M},w,g^\tau \not\SAT \Box B$.

  In the other direction, assume $\Fr{M},w,g^\tau \not\SAT \Box B$. Then
  $w',g^* \not\SAT B$ for some $w',g^*$ with $w,g^{\tau} \Img w',g^*$. This
  means that there is a counterpart relation $C\in K_{w,w'}$ such that for all
  variables $x$, $g^*(x)$ is some $C$-counterpart at $w'$ of $g^\tau(x)$ (if
  any, else undefined). Let $g'$ be such that for all variables $x$,
  $g'(x^\tau) = g^*(x)$, and for all $x \not\in \text{Ran}(\tau)$, $g'(x)$ is an
  arbitrary $C$-counterpart of $g(x)$, or undefined if there is none.
  Then
  $w,g \Img w',g'$. Moreover, $g^*$ is $g^{\prime \tau}$. By induction
  hypothesis, $w',g' \not\SAT B^\tau$. So $w',g' \not\SAT B^\tau$ for some
  $w',g'$ with $w,g\Img w',g'$. So $\Fr{M},w,g \not\SAT (\Box B)^\tau$.
  
  \begin{enumerate}
  \item $A = Px_1\ldots x_n$. $\Fr{M},w,V^\tau \SAT Px_1\ldots x_n$ iff
    $\t{V^\tau_w(x_1),\ldots,V^\tau_w(x_n)} \in V^\tau_w(P)$, iff
    $\t{V_w(x_1^\tau),\ldots,V_w(x_n^\tau)} \in V_w(P)$, iff $\Fr{M},w,V
    \SAT (Px_1\ldots x_n)^\tau$.
  \item $A = \neg B$. $\Fr{M},w,V^\tau \SAT \neg B$ iff $\Fr{M},w,V^\tau
    \not\SAT B$, iff $\Fr{M},w,V \not\SAT B^\tau$ by induction hypothesis,
    iff $\Fr{M},w,V \SAT (\neg B)^\tau$.
  \item $A = B\then C$. $\Fr{M},w,V^\tau \SAT B \then C$ iff
    $\Fr{M},w,V^\tau \not\SAT B$ or $\Fr{M},w,V^\tau \SAT C$, iff
    $\Fr{M},w,V \not\SAT B^\tau$ or $\Fr{M},w,V\SAT C^\tau$ by
    induction hypothesis, iff $\Fr{M},w,V \SAT (B\then C)^\tau$.

  \item $A = \t{y:x} B$.\; By definition \ref{!SATG}, $\Fr{M},w,V^\tau \SAT
    \t{y:x} B$ iff $\Fr{M},w,(V^\tau)^{[y/x]} \SAT B$. Now
    $(V^\tau)^{[y/x]}_w(x) = V^\tau_w(y) = V_w(y^\tau) =
    V^{[y^\tau/x^\tau]}_w(x^\tau) =
    (V^{[y^\tau/x^\tau]})^\tau_w(x)$. And for any variable $z \not=
    x$, $(V^\tau)^{[y/x]}_w(z) = V^\tau_w(z) = V_w(z^\tau) =
    V^{[y^\tau/x^\tau]}_w(z^\tau)$ (because $z^\tau \not= x^\tau$, by
    injectivity of $\tau$) $ = (V^{[y^\tau/x^\tau]})^\tau_w(z)$. So
    $(V^\tau)^{[y/x]}$ coincides with $(V^{[y^\tau/x^\tau]})^\tau$ at
    $w$. By the locality lemma \ref{locality}, $\Fr{M},w,(V^\tau)^{[y/x]}
    \SAT B$ iff $\Fr{M},w, (V^{[y^\tau/x^\tau]})^\tau \SAT B$. By induction
    hypothesis, the latter holds iff $\Fr{M},w,V^{[y^\tau/x^\tau]} \SAT
    B^\tau$, iff $\Fr{M},w,V \SAT \t{y^\tau:x^\tau}B^\tau$ by definition
    \ref{!SATG}, iff $\Fr{M},w,V \SAT (\t{y:x}B)^\tau$ by definition
    \ref{!SUBS}.

  \item $A = \forall x B$. Assume $\Fr{M},w,V^\tau \not\SAT \forall x
    B$. Then $\Fr{M},w,{V^*} \not\SAT B$ for some existential $x$-variant
    $V^*$ of $V^\tau$ on $w$. Let $V'$ be the (existential)
    $x^\tau$-variant of $V$ on $w$ with $V'_{w}(x^\tau) =
    V^*_{w}(x)$. Then ${V'}^\tau_w(x) = V^*_w(x)$, and for any
    variable $z \not= x$, ${V'}^\tau_w(z) = V'_w(z^\tau) =
    V_w(z^\tau)$ (because $z^\tau \not= x^\tau$, by injectivity of
    $\tau$) $ = V^\tau_w(z) = V^*_w(z)$. So ${V'}^\tau$ coincides with
    $V^*$ on $w$, and by locality (lemma \ref{locality}), $\Fr{M},w,V^{\prime
      \tau} \not\SAT B$. By induction hypothesis, then $\Fr{M},w,V' \not\SAT
    B^\tau$. So there is an existential $x^\tau$-variant $V'$ of $V$
    on $w$ such that $\Fr{M},w,V' \not\SAT B^\tau$. By definition \ref{!SAT},
    this means that $\Fr{M},w,V \not\SAT \forall x^\tau B^\tau$, and hence
    $\Fr{M},w,V \not\SAT (\forall x B)^\tau$ by definition \ref{!SUBS}.

    In the other direction, assume $\Fr{M},w,V \not\SAT (\forall x B)^\tau$,
    and thus $\Fr{M},w,V \not\SAT \forall x^\tau B^\tau$. Then $\Fr{M},w,V' \not\SAT
    B^\tau$ for some existential $x^\tau$-variant $V'$ of $V$ on $w$,
    and by induction hypothesis $\Fr{M},w,{V'}^\tau \not\SAT B$. Let $V^*$ be
    the (existential) $x$-variant of $V^\tau$ on $w$ with $V^*_{w}(x)
    = V'_{w}(x^\tau)$. Then $V^*_w(x) = V^{\prime \tau}_w(x)$, and for
    any variable $z \not= x$, $V^*_w(z) = V^\tau_w(z) = V_w(z^\tau) =
    V'_w(z^\tau)$ (because $z^\tau \not= x^\tau$, by injectivity of
    $\tau$) $ = V^{\prime \tau}_w(z)$. So $V^*$ coincides with
    ${V'}^\tau$ on $w$, and by locality (lemma \ref{locality}), $\Fr{M},w,V^*
    \not\SAT B$. So there is an existential $x$-variant ${V^*}$ of
    $V^\tau$ on $w$ such that $\Fr{M},w,V^* \not\SAT B$. By definition
    \ref{!SAT}, this means that $\Fr{M},w,V^\tau \not\SAT \forall x B$.

  \item $A = \Box B$. Assume $\Fr{M},w,V \not\SAT \Box B^\tau$. Then $w',V'
    \not\SAT B^\tau$ for some $w',V'$ with $wRw'$ and $V'$ a $w'$
    image of $V$ at $w$. This means that there is a counterpart
    relation $C\in K_{w,w'}$ such that for all variables $x$,
    $V'_{w'}(x)$ is some $C$-counterpart at $w'$ of $V_w(x)$ at $w$
    (if any, else undefined). By induction hypothesis, $w',{V'}^\tau
    \not\SAT B$. Since for all $x$, ${V'}^\tau_{w'}(x) =
    V'_{w'}(x^\tau)$ and $V^\tau_{w}(x) = V_{w}(x^\tau)$, it follows
    that ${V'}^\tau_{w'}(x)$ is a $C$-counterpart of $V^\tau_w(x)$ (if
    any, else undefined). So ${V'}^\tau$ is a $w'$-image of $V^\tau$
    at $w$. Hence $w',{V'}^\tau \not\SAT B$ for some $w',{V'}^\tau$
    with $wRw'$ and ${V'}^\tau$ a $w'$-image of ${V^\tau}$ at $w$. So
    $\Fr{M},w,V^\tau \not\SAT \Box B$.

    In the other direction, assume $\Fr{M},w,V^\tau \not\SAT \Box B$. Then
    $w',V^* \not\SAT B$ for some $w',V^*$ with $wRw'$ and $V^*$ a $w'$
    image of $V^\tau$ at $w$. This means that there is a counterpart
    relation $C\in K_{w,w'}$ such that for all variables $x$,
    $V^*_{w'}(x)$ is some $C$-counterpart at $w'$ of $V^\tau_w(x)$ at
    $w$ (if any, else undefined). Let $V'$ be like $V$ except that for
    all variables $x$, $V'_{w'}(x^\tau) = V^*_{w'}(x)$, and for all $x
    \not\in \text{Ran}(\tau)$, $V'_{w'}(x)$ is an arbitrary
    $C$-counterpart of $V_{w}(x)$, or undefined if there is
    none. $V'$ is a $w'$ image of $V$ at $w$. Moreover, $V^*$ is
    $V^{\prime \tau}$. By induction hypothesis, $w',V' \not\SAT
    B^\tau$. So $w',V' \not\SAT B^\tau$ for some $w',V'$ with $wRw'$
    and $V'$ a $w'$ image of $V$ at $w$. So $\Fr{M},w,V \not\SAT (\Box
    B)^\tau$. \qed

    \cmnt{
      Here I use the fact that $V^\tau$ modifies $V$ relative to all
      worlds.
    }

  \end{enumerate}
\end{proof}

\section{Logics}\label{sec:logics}

I now want to describe the minimal logics that are characterised by the
semantics from section \ref{sec:models}. Following tradition, a \emph{logic} (or
\emph{system}) in this context is simply a set of formulas, and I will describe
such sets by recursive clauses corresponding to the axioms and rules of a
Hilbert-style calculus.

Recall that we have two kinds of models: positive models with two domains, and
negative models with a single domain. Accordingly we have two minimal logics.

The logic of all positive models is essentially the combination of standard
positive free logic with the propositional modal logic K. The only place to be
careful is with substitution principles like Leibniz' Law, which have to be
restricted as explained in the previous section. (If we add the unrestricted
principles, we get logics for functional structures.)

Standard (non-modal) positive free logic can be defined as the smallest set of
formulas $L$ that contains
\begin{semantics}
  \itemT{Taut} all propositional tautologies,
\end{semantics}
as well as all instances of
\begin{semantics}
  \itemT{UD} $\forall x A \then (\forall x (A \then B) \then \forall x B)$,
  \itemT{VQ} $A \then \forall x A$, provided $x$ is not free in $A$,
  \itemT{FUI} $\forall x A \then (Ey \then [y/x]A)$, provided $y$ is quantificationally free for $x$ in $A$,
  \itemT{\forall Ex} $\forall x Ex$,
  \itemT{=\!R} $x=x$,
  \itemT{LL} $x\!=\!y \then A \then [y/x]A$, provided $y$ is quantificationally free for $x$ in $A$,
\end{semantics}
and that is closed under modus ponens, universal generalisation, and
variable substitution:
\begin{semantics}
  \itemT{MP} if $\vdash_L A$ and $\vdash_L A \then B$, then $\vdash_L B$,
  \itemT{UG} if $\vdash_L A$, then $\vdash_L \forall x A$,
  \itemT{Sub} if $\vdash_L A$, then $\vdash_L [y/x]A$, provided $y$ is quantificationally free for $x$ in $A$.
\end{semantics}
Here, as always, $\vdash_L A$ means $A \in L$.%
\footnote{%
  \cite{fitting98first} use $\forall x A \leftrightarrow A$ in place of (VQ),
  which precludes empty inner domains (as \cite[38]{kutz00kripke} points out).
  Neither the positive nor the negative semantics I have presented validates the claim
  that something exists. If we ruled out empty inner domains in positive or
  negative models, $\exists x Ex$ would be needed as extra axiom.%
} %

In the logic of counterpart structures, \T{LL}, \T{FUI} and \T{Sub} are
restricted to cases where $y$ is modally free for $x$ in $A$:
\begin{semantics}
  \itemT{FUI^*} $\forall x A \then (Ey \then [y/x]A)$, provided $y$ is modally free for $x$ in $A$,
  \itemT{LL^*} $x\!=\!y \then A \then [y/x]A$, provided $y$ is modally free for $x$ in $A$,
  \itemT{Sub^*} if $\vdash_L A$, then $\vdash_L [y/x]A$, provided $y$ is modally free for $x$ in $A$.
\end{semantics}
In addition, we have the modal schema
\begin{semantics}
  \itemT{K} $\Box A \then (\Box (A \then B) \then \Box B)$
\end{semantics}
and closure under necessitation,
\begin{semantics}
  \itemT{Nec} if $\vdash_L A$, then $\vdash_L \Box A$.
\end{semantics}

\begin{definition}[Minimal positive (quantified modal) logic]\label{!P}
  The \emph{minimal (positive) quantified modal logic} \s{P} is the
  smallest set $L \subseteq \Sc{L}$ that contains all $\Sc{L}$-instances of
  \T{Taut}, \T{UD}, \T{VQ}, \T{FUI^*}, \T{\forall Ex}, \T{=\!R}, \T{LL^*},
  \T{K}, and that is closed under \T{MP}, \T{UG}, \T{Nec} and \T{Sub^*}.
\end{definition}

FIXME: I should use a better naming convention. Maybe \s{PQK} or \s{PK},
analogousely \s{NQK} or \s{NK}?

We shall also be interested in stronger logics adequate for various classes of
counterpart structures. As a first stab, I will adopt the following definition.

\begin{definition}[Positive logics]\label{!Ps}
  A \emph{positive quantified modal logic} is a set $L \supseteq \s{P}$ that
  is closed under \T{MP}, \T{UG}, \T{Nec} and \T{Sub^*}.
\end{definition}

As it stands, definition \ref{!Ps} allows for ``logics'' in which (say) $F_1x$
is a theorem but not $F_2x$. This clashes with the idea that logical truths
should be independent of the interpretation of non-logical terms. A more
adequate definition would add a second-order closure condition to the effect
that, roughly, whenever $\vdash_L A$ then $\vdash_L [B/Px_1\ldots x_n]A$, where
$[B/Px_1\ldots x_n]A$ is $A$ with all occurrences of the atomic formula
$Px_1\ldots x_n$ replaced by (the arbitrary formula) $B$.
Making this precise requires some care, especially once we look at negative
logics where $Fx \then Ex$ is valid, but $\neg Fx \then Ex$ is not. Definition
\ref{!Ps} will do as long as we start off with a class of counterpart
structures and look for a corresponding positive logic; that logic will always
satisfy definition \ref{!Ps}.

The first-order closure condition \T{Sub^*} excludes logics in which, for
example, $Fx$ is a theorem but not $Fy$. To see why \T{Sub^*} needs the proviso
('$y$ is modally free for $x$ in $A$'), note that we could otherwise move from
the \T{FUI^*} instance $\vdash_{L} \forall x \Diamond Gxy \then \Diamond Gzy$ to
$\vdash_{L} \forall x \Diamond Gx \then \Diamond Gyy$, which is invalid as long
as individuals can have multiple counterparts.

TODO: mention \cite{bauer2002consequence}.

You may wonder whether \T{Sub^*} is really needed in definition \ref{!P}, given
that the axioms are stated as schemas: doesn't this mean that every substitution
instance of an axiom is itself an axiom, and isn't this property of closure
under substitution preserved by \T{MP}, \T{UG} and \T{Nec}? Not quite. For
example,
\begin{equation}\label{sub-ill1}
  v\!=\!y \then (v\!=\!z \then y\!=\!x)
\end{equation}
is an instance of \T{LL^*}, and
\begin{equation}\label{sub-ill2}
  x\!=\!y \then (x\!=\!x \then y\!=\!x)
\end{equation}
follows from \eqref{sub-ill1} by \T{Sub^*}, but \eqref{sub-ill2} is not itself
an instance of \T{LL^*}. Of course it is possible to axiomatise \s{P} without
\T{Sub^*}, and nothing really hangs on it. I have chosen the above
axiomatisation just because I find it comparatively intuitive and convenient for
the purposes of this paper.%
\cmnt{%
  (For example, it frees me from having to prove that \s{P} is a positive logic
  in the sense of definition \ref{!Ps}.)%
} %

\cmnt{
  Closure under first-order substitution may seem redundant for logics
  given by axiom schemas. The condition is still non-empty for
  extensions of the logic, e.g. by a further axiom $Fy$. Moreover, I
  don't think it actually is redundant. E.g. with (Sub), we can infer
  $\vdash x\!=\!y \then Gxx \then Gxy$ from the (LL) instance $\vdash
  v\!=\!y \then Gxv \then Gxy$, but the former isn't itself an (LL)
  instance. In classical logic, (Sub) is given by (UG) and (UI): we
  can go from $\vdash A$ to $\forall x A$ to $[y/x]A$. However, in
  free logics, the last step is restricted to existing $y$.

  The restriction that $y$ is m.f. in $A$ is there to prevent e.g. the
  move from $\vdash v\!=\!y \then \Box x\!=\!v \then \Box x\!=\!y$ to
  $\vdash x\!=\!y \then \Box x\!=\!x \then \Box x\!=\!y$.
  
  We don't have closure under second-order substitution. E.g. negative
  free logic is not closed under substitution of complex formulas for
  atomic predicates because $Fx \then Ex$ is valid, but $\neg Fx \then
  Ex$ is not.
} 



\begin{theorem}[Soundness of \s{P}]\label{soundness-P}
  Every member of \s{P} is valid in every positive counterpart model.
\end{theorem}

\begin{proof}
  We show that all \s{P} axioms are valid in every positive model, and that
  validity is closed under \T{MP}, \T{UG}, \T{Nec} and \T{Sub^*}.

  FIXME
  \begin{enumerate}

    \item \T{Taut}.\; Propositional tautologies are valid in every model by the
          standard satisfaction rules for the connectives.

    \item \T{UD}.\; Assume $w,V \SAT \forall x(A \then B)$ and
          $w,V \SAT \forall x A$ in some model. By definition \ref{!SAT}, then
          $w,V'\SAT A \then B$ and $w,V'\SAT A$ for every existential
          $x$-variant $V'$ of $V$ on $w$, and so $w,V'\SAT B$ for every such
          $V'$. Hence $w,V \SAT \forall x B$.

    \item \T{VQ}.\; Suppose $w,V \not\SAT A \then \forall x A$ in some model.
          Then $w,V \SAT A$ and $w,V \not\SAT \forall x A$. If $x$ is not free
          in $A$, then by the coincidence lemma \ref{coincidence}, $w,V' \SAT A$
          for every $x$-variant $V'$ of $V$ on $D_w$; so $w,V \SAT \forall x A$.
          Contradiction. So if $x$ is not free in $A$, then
          $A \then \forall x A$ is valid in every model.

    \item \T{FUI^*}.\; Assume $w,V \SAT \forall x A$ and $w,V \SAT Ey$ in some
          model. By definition \ref{!SAT}, then $w,V' \SAT A$ for all
          existential $x$-variants $V'$ of $V$ on $w$. So in particular,
          $w,V^{[y:x]} \SAT A$. If $y$ is modally free for $x$ in $A$, then by
          lemma \ref{rsl}, $w,V \SAT [y/x]A$.

    \item \T{\forall Ex}.\; By definition \ref{!SAT}, $w,V \SAT \forall x Ex$
          iff $w,V'\SAT Ex$ for all existential $x$-variants $V'$ of $V$ on $w$,
          iff for all existential $x$-variants $V'$ of $V$ on $w$ there is an
          existential $y$-variant $V''$ of $V'$ on $w$ such that
          $w,V'' \SAT x\!=\!y$. But this is always the case: for any $V'$, let
          $V''$ be $V'^{[x/y]}$.

    \item \T{=\!R}.\; By definition \ref{!INT},
          $V_w(=) = \{ \t{d,d} : d \in U_w \}$, and by definition \ref{!INT},
          $V_w(x) \in U_w$ in every positive model. So $w,V \SAT x\!=\!x$ in
          every such model, by definition \ref{!SAT}.

    \item \T{LL^*}.\; Assume $w,V \SAT x\!=\!y$, $w,V \SAT A$, and $y$ is
          modally free for $x$ in $A$. Since $V_w(x) = V_w(y)$, $V$ coincides
          with $V^{[y/x]}$ at $w$. So $w,V^{[y/x]} \SAT A$ by the coincidence
          lemma \ref{coincidence}. By lemma \ref{rsl}, $w,V^{[y/x]} \SAT A$ only
          if $w,V \SAT [y/x]A$. So $w,V \SAT [y/x]A$.

    \item \T{K}.\; Assume $w,V \SAT \Box (A\then B)$ and $w,V \SAT \Box A$. Then
          $w',V' \SAT A \then B$ and $w',V' \SAT A$ for every $w',V'$ such that
          $wRw'$ and $V'$ is a $w'$-image of $V$ at $w$. Then $w',V'\SAT B$ for
          any such $w',V'$, and so $w,V\SAT \Box B$.

    \item \T{MP}.\; Assume $w,V \SAT A\then B$ and $w,V \SAT A$ in some model.
          By definition \ref{!SAT}, then $w,V \SAT B$ as well. So for any world
          $w$ in any model, \T{MP} preserves truth at $w$.

    \item \T{UG}.\; Assume $w,V \not\SAT \forall x A$ in some model $\Fr{M}$.
          Then $w, V' \not\SAT A$ for some existential $x$-variant $V'$ of $V$
          on $w$. So $A$ is invalid in a model like $\Fr{M}$ but with $V'$ as
          the interpretation function in place of $V$. Hence if $A$ is valid in
          all positive models, then so is $\forall x A$.

    \item \T{Nec}.\; Assume $w,V \not\SAT_{\Fr{M}} \Box A$ in some model
          $\Fr{M}$. Then $w',V' \not\SAT A$ for some $w'$ with $wRw'$ and $V'$
          some $w'$-image of $V$ at $w$. Let $\Fr{M^*}$ be like $\Fr{M}$ except
          with $V'$ in place of $V$. $\Fr{M^*}$ is a positive model. Since $A$
          is not valid in $\Fr{M^*}$, it follows contrapositively that whenever
          $A$ is valid in all positive models, then so is $\Box A$.

    \item \T{Sub^*}.\; Assume $w,V \not\SAT [y/x] A$ in some model
          $\t{\Fr{S},V}$, and $y$ is modally free for $x$ in $A$. By lemma
          \ref{rsl}, then $w, V^{[y/x]} \not\SAT A$. So $A$ is invalid in the
          model $\t{\Fr{S}, V^{[y/x]}}$. Hence if $A$ is valid in all positive
          models, then so is $[y/x]A$. \qed

  \end{enumerate}

\end{proof}

\cmnt{%
  It would be nice to prove something stronger here: that for every
  set of counterpart structures, the set of formulas valid in that set
  is a logic that extends \s{P}; cf.\
  \cite[80]{gabbay09quantification}. Perhaps this should go in the
  Correspondence section.%
} %


Let's move on to negative logics. Standard negative free logic
replaces \T{=\!R} and \T{\forall Ex} by
\begin{semantics}
  \itemT{\forall\!=\!R} $\forall x(x\!=\!x)$, 
  \itemT{Neg} $Px_1\ldots x_n \then Ex_1 \land \ldots \land Ex_n$.
\end{semantics}
In the logic of all negative counterpart structures, however, we need two further axioms:
\begin{semantics}
  \itemT{NA} $\neg Ex \then \Box \neg Ex$,
  \itemT{TE} $x\!=\!y \then \Box(Ex \then Ey)$.
\end{semantics}
Here $Ex$ abbreviates $\exists y(x\!=\!y)$.
\cmnt{%
  TE could be proved from $y\!=\!y$, but $y\!=\!y$ is not valid in
  negative logics. It could also be proved from $\Box(x\!=\!x \then
  x\!=\!x)$ by Leibniz' Law, if that would licence substituting the last
  two $x$ occurrences by $y$.
} %

In negative counterpart models, a term $x$ can go empty, in the sense that
$g(x)$ is undefined. \T{NA} reflects the fact that when then shift the point of
evaluation to another world, $g(x)$ will still be undefined: non-existent
objects don't have any counterparts.

\T{TE} says that if $x$ is identical to $y$, and $x$ has a counterpart at some
accessible world, then $y$ also has a counterpart at that world.%
\cmnt{%
  If we had outer domains, an individual could have some existing and some
  non-existing counterparts at a world, which would render \T{TE} false.
  (Some $w'$-image $V'$ of $V$ at $w$ then assigns the non-existing individual
  to $y$ and the existing individual to $x$, rendering $Ex \then Ey$ false at
  $w'$ under $V'$, wherefore $\Box (Ex \then Ey)$ is false at $w$ under $V$.)%
} %

\cmnt{%
  In a sense, \T{NA} rules out terms for individuals that only exist at other
  worlds: if $x$ is empty, then it remains empty whatever world we look at. So
  we can't say much about non-existent objects. This maybe considered
  problematic for some applications, e.g. in temporal logic, where we might want
  actually empty names to take on a referent at other worlds. One way around
  this is to use dual-domain counterpart models for negative logics, where one
  can distinguish between non-existent individuals.

  It's worth thinking about what exactly we want here. Intuitively, we can use
  names for things that exist only at other times or worlds: ``Albert Einstein
  was friends with Kurt G\"odel'' is true, while ``Adolf Hitler was friends with
  Kurt G\"odel'' is false. But if we can name past objects, we can arguably also
  quantify over them. What would such quantifiers range over in counterpart
  semantics? Formally, they would be possibilist quantifiers, ranging over the
  total domain.

  Another motivation for dual domains comes from sentences like
  \begin{quote}
    It might have been the case that Mount Everest doesn't exist while some
    other mountain exists which, despite not co-existing with Mount Everest,
    \emph{could} have co-existed with Mount Everest,
  \end{quote}
  \[
    \Diamond (\neg \exists y(y\!=\!e) \land \exists x \Diamond (\exists y(y\!=\!x) \land \exists y(y\!=\!e))),
  \]
  which seems to require that we can locate a Mount Everest counterpart at a
  world twice removed from actuality, although there is no counterpart at the
  intermediate world. Intuitively, the Everest counterpart here should be
  \emph{once} removed from the actual Everest. Perhaps we are running into
  expressive limitations of (single-indexed) QML here. In
  \cite{schwarz2014counterpart}, I outline a single-domain negative semantics that
  attempts to take into account the present worries. It differs in various ways
  from the semantics considered here, e.g.\ by taking into account multiple
  counterpart relations and hybrid operators.

} %

We can, of course, offer counterpart models for negative modal predicate logics
without \T{NA} and \T{TE}. These are dual-domain models in which the extension
of all predicates, including identity, is restricted to the inner domain. \T{NA}
then requires that individuals which only figure in the outer domain of a world
never have counterparts in the inner domain of another world. \T{TE} requires
that if an individual in the inner domain of a world has a counterpart in the
inner domain of another world, then all its counterparts at that world are in
the inner domain. The two requirements are obviously independent and
non-trivial. Hence the axioms \T{NA} and \T{TE} are independent of one another
and of the standard principles of basic negative free logic combined with K.

\cmnt{%
  (To verify what I say in this paragraph, I need to prove that all axioms of NK
  are valid in my dual domain models with the proposed restriction.)%
} %
\cmnt{%
  (It is important to develop a negative model theory where we have absolute
  non-existence of individuals at other worlds. For this is what creates the
  deviant logic in Lewis's semantics and why Ghilardi et al move to typed
  languages. I want to show that the counterpart approach works even if we let
  things go really out of existence.)%
} %

\cmnt{%
  One might think that \T{TE} is invalid for single-domain structures with
  multiple counterpart relations. For now an individual $V_w(x)$ can have an
  existing counterpart relative to one counterpart relation and no counterpart
  at all relative to another. But \T{TE}, $x\!=\!y \then \Box(Ex \then Ey)$, is
  still valid. That's because $w,V \SAT \Box(Ex \then Ey)$ means that for all
  worlds $w'$ and counterpart relations $C$ linking $w$ and $w'$, $Ex \then Ey$
  is true at $w'$ under every interpretation $V'$ that assigns to all variables
  one of their $C$-counterparts (or nothing if there is none). If $Ex$ is true
  relative to some such $V'$ at some $w'$, then so is $Ey$. The point is that
  we're not allowed to use different counterpart relations to evaluate different
  variables within a formula.%
}%

\cmnt{%
  (In negative dual-domain semantics, \T{NA} and \T{TE} are invalid while the
  other axioms of \s{N} are valid. Negative dual-domain models are like positive
  models except that all predicates, including identity, are restricted to the
  inner domain. Thus \T{NA} is false at $w$ if some individual in the outer
  domain of $w$ has a counterpart in the inner domain of some accessible world.
  \T{TE} is false at $w$ if $V_w(x) \in D_w$ has both an existing and a
  non-existing counterpart at some accessible world $w'$; then some $w'$-image
  $V'$ of $V$ at $w$ assigns the non-existing individual to $y$ and the existing
  individual to $x$, rendering $Ex \then Ey$ false at $w'$ under $V'$, wherefore
  $\Box (Ex \then Ey)$ is false at $w$ under $V$.)
} %

\T{NA} should not be confused with the claim that no individual exists at an
accessible world that isn't a counterpart of something at the present world.
This is rather expressed by the Barcan Formula,
%
\begin{equation}\tag{BF}\label{BF}
  \forall x \Box A \then \Box \forall x A,
\end{equation}
%
which is not valid in the class of negative models. For example, if
$W = \{w,w'\}$, $wRw'$, $D_w = \emptyset$ and $D_{w'} = \{ 0 \}$, then
$w,V \SAT \forall x \Box x\!\not=\!x$, but
$w,V \not\SAT \Box \forall x\; x\!\not=\!x$.

\begin{definition}[Minimal (strongly) negative (quantified modal) logic]\label{!N}
  The \emph{minimal (strongly) negative (quantified modal) logic} \s{N} in
  $\Sc{L}$ is the smallest set $L \subseteq \Sc{L}$ that contains all
  $\Sc{L}$-instances of \T{Taut}, \T{UD}, \T{VQ}, \T{FUI^*}, \T{Neg}, \T{LL^*},
  \T{\forall\!=\!R}, \T{K}, \T{NA}, \T{TE}, and that is closed under \T{MP},
  \T{UG}, \T{Nec} and \T{Sub^*}.
\end{definition}

\begin{definition}[Negative logics]\label{!Ns}
  A \emph{negative (quantified modal) logic} in $\Sc{L}$ is a an extension
  $L \supseteq \s{N}$ of the minimal negative logic \s{N} in \Sc{L} such that
  $L$ is closed under \T{MP}, \T{UG}, \T{Nec} and \T{Sub^*}.
\end{definition}

\begin{theorem}[Soundness of \s{N}]\label{soundness-N}
  Every member of \s{N} is valid in every negative counterpart model.
\end{theorem}

\begin{proof}
  FIXME
  
  We show that all \s{N} axioms are valid in every negative model, and
  that validity is closed under \T{MP}, \T{UG}, \T{Nec} and \T{Sub^*}.
  The proofs for \T{Taut}, \T{UD}, \T{VQ}, \T{FUI^*}, \T{LL^*}, \T{K},
  \T{MP}, \T{UG}, \T{Nec} and \T{Sub^*} are just as in theorem
  \ref{soundness-P}. The remaining cases are

  \begin{enumerate}

  \item \T{Neg}.\; Assume $w,V \SAT Px_1\ldots x_n$ in some model. By
    definition \ref{!INT}, $V_w(P) \subseteq U_w^n$, and by definition
    \ref{!MOD}, $U_w = D_w$ in negative models. So $V_w(P) \subseteq
    D_w^n$. By definition \ref{!SAT}, $w,V \SAT Px_1\ldots x_n$
    therefore entails that $V_w(x_i) \in D_w$ for all $x_i \in
    x_1,\ldots,x_n$, and that $w,V \SAT Ex_i$ for all such $x_i$.

  \item \T{\forall\!=\!R}.\; $w,V \SAT \forall x(x\!=\!x)$ iff $w,V' \SAT
    x\!=\!x$ for all existential $x$-variants $V'$ of $V$ on $w$. This
    is always the case, since by definition \ref{!INT} and
    \ref{!INT}, $V_w(=) = \{ \t{d,d} : d \in D_w \}$ in negative
    models.

  \item \T{NA}.\; Assume $w,V \SAT \neg Ex$. By definition \ref{!SAT},
    this means that $V_w(x) \not\in D_w$, and therefore that $V_w(x)$
    is undefined if the model is negative. But if $V_w(x)$ is
    undefined, then there is no world $w'$, individual $d$ and
    counterpart relation $C\in K_{w,w'}$ such that
    $\t{V_w(x),w}C\t{d,w'}$. By definitions \ref{!SAT} and \ref{!IMG},
    it follows that there is no world $w'$ and interpretation $V'$
    with $wRw'$ and $V_w \Img V'_{w'}$ such that $w',V' \SAT Ex$. So
    then $w,V \SAT \Box \neg Ex$ by definition \ref{!SAT}. Thus $w,V
    \SAT \neg Ex \then \Box \neg Ex$.

  \item \T{TE}.\; Assume $w,V \SAT x\!=\!y$. Then $V_w(x) = V_w(y)$ by
    definitions \ref{!INT} and \ref{!SAT}. Let $w',V'$ be such that
    $wRw'$ and $V_w \Img V'_{w'}$, and $w',V' \SAT Ex$. By definition
    \ref{!SAT}, the latter means that $V'_{w'}(x)$ is some member of
    $D_w$. Moreover, $V_w \Img V'_{w'}$ means that there is a $C\in
    K_{w,w'}$ such that this $V'_{w'}(x) \in D_w$ is a $C$-counterpart
    of $V_w(x)$. It follows that $V_w(y) = V_w(x)$ has at least one
    $C$-counterpart at $w'$, so $V'_{w'}(y)$ must be some such
    counterpart, which can only be in $D_w$. So $w',V' \SAT Ey$.  So
    if $w,V \SAT x\!=\!y$, then $w,V \SAT \Box (Ex \then Ey)$, by
    definition \ref{!SAT}, and so $w,V \SAT x\!=\!y \then \Box (Ex
    \then Ey)$. \qed


  \end{enumerate}

\end{proof}


In the remainder of this section, I will prove a few properties derivable from
the above axiomatisation. (Some of these will be needed later in the
completeness proof.) To this end, let $L$ be an arbitrary positive or negative
quantified modal logic.

\begin{lemma}[Closure under propositional consequence]\label{pc}
  For all $\Sc{L}$-formulas $A_1,\ldots,A_n,B$,
  \begin{semantics}
    \itemT{PC} if $\vdash_L A_1, \ldots, \vdash_L A_n$, and $B$ is a
    propositional consequence of $A_1,\ldots,A_n$, then $\vdash_L B$.
  \end{semantics}
\end{lemma}
\begin{proof}
  If $B$ is a propositional consequence of $A_1,\ldots,A_n$, then $A_1
  \then (\ldots \then(A_n \then B) \ldots )$ is a tautology. So by
  \T{Taut}, $\vdash_L A_1 \then (\ldots \then(A_n \then B) \ldots
  )$. If $\vdash_L A_1, \ldots, \vdash_L A_n$, then by $n$
  applications of \T{MP}, $\vdash_L B$. \qed
\end{proof}
When giving proofs, I will usually omit reference to \T{PC}.

\begin{lemma}[Redundant axioms]\label{redax}
  For any \Sc{L}-formulas $A$ and variables $x$,
  \begin{semantics}
    \itemT{\forall Ex} $\vdash_L \forall x Ex$,
    \itemT{\forall\!=\!R} $\vdash_L \forall x(x\!=\!x)$.
  \end{semantics}
\end{lemma}
\begin{proof}
  If $L$ is positive, then \T{\forall Ex} is an axiom. In \s{N}, we
  have $\vdash_L x\!=\!x \then Ex$ by \T{Neg}; so by \T{UG} and
  \T{UD}, $\vdash_L \forall x (x\!=\!x) \then \forall x Ex$. Since
  $\vdash_L \forall x (x\!=\!x)$ by \T{=\!R}, $\vdash_L \forall x Ex$.

  If $L$ is negative, then \T{\forall\!=\!R} is an axiom. In \s{P}, we
  have $\vdash_L x\!=\!x$ by \T{=\!R}, and so \T{\forall\!=\!R} by
  \T{UG}. \qed
\end{proof}

\begin{lemma}[Existence and Self-Identity]\label{idex}
  If $L$ is \emph{negative}, then for any \Sc{L}-variable $x$,
  \begin{semantics}
    \itemT{EI} $\vdash_L Ex \leftrightarrow x\!=\!x$;
  \end{semantics}
\end{lemma}
\begin{proof}
  By \T{FUI^*}, $\vdash_L \forall x(x\!=\!x) \then (Ex \then
  x\!=\!x)$. By \T{\forall\!=\!R}, $\vdash_L \forall x(x\!=\!x)$. So
  $\vdash_L Ex \then x\!=\!x$. Conversely, $x\!=\!x \then Ex$ by
  \T{Neg}. \qed
\end{proof}

\begin{lemma}[Symmetry and transitivity of identity]\label{symtrans}
  For any \Sc{L}-variables $x,y,z$,
  \begin{semantics}
    \itemT{=\!S} $\vdash_L x\!=\!y \then y\!=\!x$;
    \itemT{=\!T} $\vdash_L x\!=\!y \then y\!=\!z \then x\!=\!z$.
  \end{semantics}
\end{lemma}  

\begin{proof}
  For \T{=S}, let $v$ be some variable $\not\in \{x,y\}$. Then
  \begin{alignat*}{2}
    1.\quad&\vdash_{L} v\!=\!y \then (v\!=\!x \then y\!=\!x). &\quad& \text{\T{LL^*}}\\
    2.\quad& \vdash_{L} x\!=\!y \then (x\!=\!x \then y\!=\!x). && \text{(1, \T{Sub^*})}\\
    3.\quad& \vdash_{L} x\!=\!y \then x\!=\!x. 
        && \text{(\T{=\!R}, or \T{Neg} and \T{\forall\!=\!R})}\\
    4.\quad& \vdash_{L} x\!=\!y \then y\!=\!x. && \text{(2, 3)}
  \end{alignat*}

  For \T{=T},
  \begin{alignat*}{2}
    1.\quad& \vdash_{L} x\!=\!y \then y\!=\!x. &\quad& \text{\T{=\!S}}\\
    2.\quad& \vdash_{L} y\!=\!x \then (y\!=\!z \then x\!=\!z). && \text{\T{LL^*}}\\
    3.\quad& \vdash_{L} x\!=\!y \then (y\!=\!z \then x\!=\!z). && \text{(1, 2)}
  \end{alignat*}
  \qed
\end{proof}

\begin{lemma}[Syntactic alpha-conversion]\label{alphasyn}
  If $A,A'$ are $\Sc{L}$-formulas, and $A'$ is an alphabetic variant of
  $A$, then
  \begin{semantics}
    \itemT{AC} $\vdash_{L} A \leftrightarrow A'$.
  \end{semantics}
\end{lemma}
An \emph{alphabetic variant} of a formula $A$ is a formula $A'$ that results from $A$ by renaming bound variables.

\begin{proof} by induction on $A$.
  \begin{enumerate}
  \item $A$ is atomic.\; Then $A=A'$ and $A \leftrightarrow A'$ is a
    propositional tautology.
  \item $A$ is $\neg B$.\; Then $A'$ is $\neg B'$, where $B'$ is an
    alphabetic variant of $A'$. By induction hypothesis, $\vdash_{L} B
    \leftrightarrow B'$. So by \T{PC}, $\vdash_{L} \neg B
    \leftrightarrow \neg B'$.
  \item $A$ is $B \then C$.\; Then $A'$ is $B' \then C'$, where
    $B',C'$ are alphabetic variants of $B,C$, respectively. By
    induction hypothesis, $\vdash_{L} B \leftrightarrow B'$ and
    $\vdash_{L} C \leftrightarrow C'$. So by \T{PC}, $\vdash_{L} (B
    \then C) \leftrightarrow (B' \then C')$.
  \item $A$ is $\forall x B$.\; Then $A'$ is either $\forall x B'$ or
    $\forall z [z/x]B'$, where $B'$ is an alphabetic variant of $B$
    and $z\not\in \var(B')$. Assume first that $A'$ is $\forall x
    B'$. By induction hypothesis, $\vdash_{L} B \leftrightarrow
    B'$. So by \T{UG} and \T{UD}, $\vdash_{L} \forall x B
    \leftrightarrow \forall x B'$.

    Alternatively, assume $B$ is $\forall z [z/x]B'$ and $z\not\in
    \var(B')$. Since $B'$ differs from $B$ at most in renaming bound
    variables, if $z$ were free in $B$, then $z \in \var(B')$. So $z$
    is not free in $B$. Then
    \begin{alignat*}{2}
      1.\quad&\vdash_{L} B \leftrightarrow B' &\quad&\text{(induction hypothesis)}\\
      2.\quad&\vdash_{L} [z/x]B \leftrightarrow [z/x]B' 
        &&\text{(1, \T{Sub^*})}\\
      3.\quad&\vdash_{L} \forall x B \then Ez \then [z/x]B &&\text{\T{FUI^*}}\\
      4.\quad&\vdash_{L} \forall x B \then Ez \then [z/x]B'&&\text{(2, 3)}\\
      5.\quad&\vdash_{L} \forall z \forall x B \then \forall z Ez \then \forall z [z/x]B'
        &&\text{(4, \T{UG}, \T{UD})}\\
      6.\quad&\vdash_{L} \forall z Ez &&\text{\T{\forall Ex}}\\
      7.\quad&\vdash_{L} \forall z \forall x B \then \forall z [z/x]B' &&\text{(5, 6)}\\
      8.\quad&\vdash_{L} \forall x B \then \forall z \forall x B 
        &&\text{(\T{VQ}, $z$ not free in $B$)}\\
      9.\quad&\vdash_{L} \forall x B \then \forall z [z/x]B'. &&\text{(7, 8)}
    \end{alignat*}
    Conversely,
    \begin{alignat*}{2}
      10.\quad&\vdash_{L} \forall z [z/x]B' \then Ex \then [x/z][z/x]B' 
         &\quad&\text{\T{FUI^*}}\\
      11.\quad&\vdash_{L} \forall z [z/x]B' \then Ex \then B 
         &&\text{(1, 10, $z\not\in \var(B')$)}\\
      12.\quad&\vdash_L \forall x \forall z [z/x]B' \then \forall x B 
         &&\text{(11, \T{UG}, \T{UD}, \T{\forall Ex})}\\
      13.\quad&\vdash_L \forall z [z/x]B' \then \forall x \forall z [z/x]B' 
         &&\text{\T{VQ}}\\
      14.\quad&\vdash_{L} \forall z [z/x]B' \then \forall x B &&\text{(12, 13)}
    \end{alignat*}

  \item $A$ is $\Box B$.\; Then $A'$ is $\Box B'$, where $B'$ is an
    alphabetic variant of $B$. By induction hypothesis, $\vdash_{L} B
    \leftrightarrow B'$. Then by \T{Nec}, $\vdash_{L} \Box(B
    \leftrightarrow B')$, and by \T{K} and \T{PC}, $\vdash_{L} \Box B
    \leftrightarrow \Box B'$. \qed
  \end{enumerate}
\end{proof}

\begin{lemma}[Closure under transformations]\label{subtrans}
  For any $\Sc{L}$-formula $A$ and transformation $\tau$ on $\Sc{L}$,
  \begin{semantics}
    \itemT{Sub^\tau} $\vdash_L A$ iff $\vdash_L A^\tau$.
  \end{semantics}
\end{lemma}

\begin{proof}
  Assume $\vdash_{L} A$. Let $x_1,\ldots,x_n$ be the variables in
  $A$. If $n=0$, then $A = A^\tau$ and the result is trivial. If
  $n=1$, then $A^\tau$ is $[x_1^\tau/x_1]A$, and $x_1^\tau$ is either
  $x_1$ itself or does not occur in $A$. In the first case,
  $[x_1^\tau/x_1]A = A$ and the result is again trivial. In the second
  case, $x_1^\tau$ is modally free for $x_1$ in $A$, and thus
  $\vdash_L [x_1^\tau/x_1]A$ by \T{Sub^*}.

  Assume then that $n > 1$. Note first that $A^\tau =
  [x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$,
  where $v_2,\ldots,v_n$ are distinct variables not in $A$ or
  $A^\tau$. This is easily shown by induction on the subformulas $B$
  of $A$ (ordered by complexity). To keep things short, let $\Sigma$
  abbreviate
  $[x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]$.
  \begin{enumerate}
  \item If $B$ is $Px_j\ldots x_k$, then $x_j,\ldots, x_k$ are
    variables from $x_1,\ldots,x_n$, and $\Sigma B = Px_j^\tau\ldots
    x_k^\tau = B^\tau$, by definitions \ref{!SUB} and \ref{!SUBS}. 
  \item If $B$ is $\neg C$, then by induction hypothesis, $\Sigma C =
    C^\tau$, and hence $\neg \Sigma C = \neg C^\tau$. But
    $\Sigma \neg C$ is $\neg \Sigma C$ by definition \ref{!SUB}, and
    $(\neg C)^\tau$ is $\neg C^\tau$ by definition \ref{!SUBS}.
  \item The case for $C \then D$ is analogous.
  \item If $B$ is $\forall z C$, then by induction hypothesis, $\Sigma
    C = C^\tau$. Since $\tau$ is injective, $\Sigma \forall z C$ is
    $\forall \Sigma z \Sigma C$ by definition \ref{!SUB}, and
    $(\forall z C)^\tau$ is $\forall z^\tau C^\tau$ by definition
    \ref{!SUBS}. Moreover, since $z$ is one of $x_1,\ldots,x_n$,
    $\Sigma z = z^\tau$.%
    \cmnt{%
      (Here things would get a lot more complicated if we had defined
      substitution differently, so that $[y/x]\forall x Fx \not=
      \forall y Fy$.)%
    } %
  \item If $B$ is $\Box C$, then by induction hypothesis, $\Sigma C$
    is $C^\tau$, and hence $\Box \Sigma C$ is $\Box C^\tau$. But
    $\Sigma \Box C$ is $\Box \Sigma C$ by definition \ref{!SUB}, and
    $(\Box C)^\tau$ is $\Box C^\tau$ by definition \ref{!SUBS}.
  \end{enumerate}

  Now we show that $L$ contains all ``segments'' of
  $[x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$,
  beginning with the rightmost substitution, $[v_n/x_n]A$.  Since
  $v_n$ is modally free for $x_n$ in $A$, by \T{Sub^*}, $\vdash_{L}
  [v_n/x_n]A$. Likewise, for each $1 < i < n$, $v_i$ is modally free
  for $x_i$ in $[v_{i+1}/x_{i+1}]\ldots [v_n/x_n]A$. So $\vdash_{L}
  [v_2/x_2]\ldots[v_n/x_n]A$.

  With respect to $[x_1^\tau/x_1]$, we distinguish three cases. First,
  if $x_1 = x_1^\tau$, then $\vdash_L
  [x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$, because
  $[x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$ is
  $[v_2/x_2]\ldots[v_n/x_n]A$. Second, if $x_1 \not= x_1^\tau$ and
  $x_1^\tau \not\in \var(A)$, then $x_1^\tau \not\in
  \var([v_2/x_2]\ldots[v_n/x_n]A)$, since the $v_1,\ldots,v_n$ are not
  in $\var(A)$ or $\var(A^\tau)$\cmnt{ (in particular, thus no new
    variables are introduced in $[v_2/x_2]\ldots[v_n/x_n]A$)}. So
  $x_1^\tau$ is modally free for $x_1$ in $[v_2/x_2]\ldots[v_n/x_n]A$,
  and by \T{Sub^*}, $\vdash_L
  [x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$. Third, if $x_1 \not=
  x_1^\tau$ and $x_1^\tau \in \var(A)$, then $x_1^\tau$ must be one of
  $x_2,\ldots,x_n$. Then again $x_1^\tau \not\in
  \var([v_2/x_2]\ldots[v_n/x_n]A)$, and so $\vdash_L
  [x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$ by \T{Sub^*}.

  Next, $x_2^\tau$ is modally free for $v_2$ in
  $[x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$, because $\tau$ is
  injective and hence $x_2^\tau \not= x_1^\tau$, so $x_2^\tau$ does
  not occur in $[x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$. Hence
  $\vdash_{L} [x_2^\tau/v_2] [x_1^\tau/x_1]\linebreak[1] [v_2/x_2]
  \ldots[v_n/x_n]A$. By the same reasoning, for each $2 < i \leq n$,
  $x_i^\tau$ is modally free for $v_i$ in
  $[x_{i-1}^\tau/v_{i-1}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$.
  So $\vdash_{L}
  [x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots
  \linebreak[1] [v_n/x_n]A$, i.e. $\vdash_L A^\tau$.

  This proves the left-to-right direction of \T{Sub^\tau}. The other
  direction immediately follows. Let $x_1^\tau,\ldots,x_n^\tau$ be the
  variables in $A^\tau$, and let $\sigma$ be an arbitrary
  transformation that maps each $x_i^\tau$ back to $x_i$ (i.e., to
  $(x_i^\tau)^{\tau^{-1}}$). By the left-to-right direction of
  \T{Sub^\tau}, $\vdash_L A^\tau$ entails $\vdash_L (A^\tau)^\sigma$,
  and $(A^\tau)^\sigma$ is simply $A$. \qed
\end{proof}

\cmnt{

  In a similar way, one can probably prove closure under generalised
  substitutions, provided all the $\var(A)^\sigma$ are somehow modally
  free for the variables in $\var(A)$. Lemma \ref{alphasyn} should come
  in handy then.

}

\begin{lemma}[Leibniz' Law with partial substitution]
  FIXME
  Let $A$ be a formula of $\Sc{L}$, and $x,y$ variables of
  $\Sc{L}$. Let $[y//x]A$ be $A$ with \emph{one or more} free occurrences
  of $x$ replaced by $y$.
  \begin{semantics}
    \itemT{LL^*_p} $\vdash_L x\!=\!y \then A \then [y//x]A$, provided
    the following conditions are satisfied.
    \begin{compactenum}
      \item[(i)] $y$ is quantificationally free for $x$ in $A$.
      \item[(ii)] Either $y$ is modally free for $x$ in $A$, or $[y//x]A$ does
      not replace any occurrence of $x$ in the scope of a modal operator in $A$
      that also contains $y$.
      \item[(iii)] In the scope of any modal operator in $A$, $[y//x]A$ either
      replaces all or no occurrences of $x$ by $y$.
    \end{compactenum}
  \end{semantics}
\end{lemma}
\begin{proof}
  FIXME
  Let $v \not= y$ be a variable not in $\var(A)$, and let $[v//x]A$ be
  like $[y//x]A$ except that all new occurrences of $y$ are replaced
  by $v$: if $[y//x]A$ satisfies (i)--(iii), then so does $[y//x]A$
  with all new occurrences of $y$ replaced by $v$. Moreover, in the
  resulting formula $[v//x]A$ all occurrences of $v$ are free and free
  for $y$, by clause (i); so $[y/v][v//x]A = [y//x]A$ by definition
  \ref{!SUB}. By \T{LL^*},
  \begin{equation}\tag{1}\label{ll1}
    \vdash_L v\!=\!y \then [v//x]A \then [y/v][v//x]A,
  \end{equation}
  provided that $y$ is modally free for $v$ in $[v//x]A$, i.e.\
  provided that either $y$ is modally free for $x$ in $A$, or
  $[v//x]A$ (and thus $[y//x]A$) does not replace any occurrence of
  $x$ in the scope of a modal operator in $A$ that also contains $y$.%
  \cmnt{ %
    (The first clause is not redundant because $A$ can be a box
    formula that contains $x$ and $y$; in this case it is OK to
    replace $x$.)%
  } %
  This is guaranteed by condition (ii). Since $[y/v][v//x]A$ is
  $[y//x]A$, \eqref{ll1} can be shortened to
  \begin{equation}\tag{2}\label{ll2}
    \vdash_L v\!=\!y \then [v//x]A \then [y//x]A.
  \end{equation}
  By \T{Sub^*}, it follows that
  \begin{equation}\tag{3}\label{ll3}
    \vdash_L [x/v](v\!=\!y \then [v//x]A \then [y//x]A),
  \end{equation}
  provided that $x$ is modally free for $v$ in $v\!=\!y \then [v//x]A
  \then [y//x]A$. Since this isn't a formula of the form $\Box B$, $x$
  is modally free for $v$ here iff no free occurrences of $x$ and $v$
  lie in the scope of the same modal operator in $[v//x]A$. So
  whenever $[v//x]A$ (and thus $[y//x]A$) replaces some occurrences of
  $x$ in the scope of a modal operator in $A$, then it must replace
  all occurrences of $x$ in the scope of that operator. %
  \cmnt{%
    (It is not enough that $x$ is modally free for $v$ in $[v//x]A$:
    consider $x\!=\!y \then \Box x\!=\!x \then \Box x\!=\!y$, which
    the application of \T{Sub^*} would derive from $x\!=\!v \then \Box
    x\!=\!v \then \Box x\!=\!y$.)%
  } %
  This is guaranteed by condition (iii). By definition \ref{!SUB},
  \eqref{ll3} can be simplified to
  \begin{equation}\tag{4}
    \vdash_L x\!=\!y \then A \then [y//x]A. 
  \end{equation}
  \qed
\end{proof}

\cmnt{%
  There are other ways to define partial substitution, more along the
  lines of definition \ref{!SUB}. But we have to be careful. For
  example, we would need to ensure that $[y//x]\forall x Fx$ is not
  $\forall x Fy$ or $\forall y Fx$. To this end, we could stipulate
  that $[y//x]$ replaced either all or no variables in the scope of
  any quantifier binding $x$ -- paralleling clause (iii). Care is also
  required if we want to retain the existence of $[v//x]A$ with
  $[y/v][v//x]A = [y//x]A$. For example, simply following a partial
  version of definition \ref{!SUB} would allow $\forall z Fx$ as an
  instance of $[y//x]\forall y Fx$. The corresponding formula
  $[v//x]\forall y Fx$ would then have to be $\forall z Fv$, which is
  not licensed by the definition of partial substitution; rather,
  $[v//x]\forall y Fx$ should be either $\forall y Fv$ or $\forall y
  Fx$, and so $[y/v][v//x]\forall y Fx$ is either $\forall z Fy$ or
  $\forall y Fx$ -- we don't get $\forall z Fx$. 
} %

FIXME
I will never actually use \T{LL^*_p}. I mention it only because Leibniz' Law is
often stated for partial substitutions, and you may have wondered what that
would look like in our systems. Now you know. We could indeed have used
\T{LL^*_p} as basic axiom instead of \T{LL^*}; \T{LL^*} would then be derivable,
because every formula $A$ has an alphabetic variant $A'$ such that $[y/x]A$ is
an instance of $[y//x]A'$ that satisfies (i)--(iii) iff $y$ is modally free for
$x$ in $A$, and because \T{LL^*} is not used in the proof of lemma
\ref{alphasyn}. %
\cmnt{%
  FIXME
  If there is no clash of bound variables, $A'=A$ and $[y/x]A$ is simply an
  instance of $[y//x]A$ replacing all rather than only some occurrences of $x$.
  Clause (iii) is trivial in this case, and clause (ii) reduces to $y$ being
  modally free for $x$ in $A$. If variables clash, $[y/x]A$ is not an instance
  of $[y//x]A$. For example, $[y/x]\forall y Fx$ is $\forall v Fy$, while the
  only $[y//x]A$ is $\forall y Fx$, by clause (i). Here $A'$ is $\forall v Fx$.
  By lemma \ref{alphasyn}, $\vdash_L A \leftrightarrow A'$. So
  $\vdash_L A \land x\!=\!y \then [y/x]A$ iff
  $\vdash_L A' \land x\!=\!y \then [y/x]A$. If $[y/x]A$ is an instance of
  $[y//x]A'$, the latter is validated by \T{LL_p^*}. In the example, $[y/x]A$ is
  $[y/x]\forall y Fx = \forall v Fy$, and $[y//x]A'$ is
  $[y//x]\forall v Fx = \forall v Fx$ or $\forall v Fy$. In the case of
  $A = \forall x Fx$, where $[y/x]A = \forall y Fy$, $A'$ is $\forall y Fy$ as
  well.%
} %
I have chosen \T{LL^*} as basic due to its greater simplicity.%
\footnote{%
  Kutz's system uses the following version of \T{LL^*_p}
  (\cite[43]{kutz00kripke}):
  \begin{semantics}
    \itemT{LL^{K}_p} $\vdash x\!=\!y \then A \then [y//x]A$, provided
    that
    \begin{compactenum}
    \item[(i)] $y$ is quantificationally free for $x$ in $A$,
    \item[(ii)] $y$ is not free in the scope of a modal operator in
      $A$, and
    \item[(iii)] in the scope of any modal operator in $A$, $[y//x]A$
      either replaces all or no occurrences of $x$ by $y$.
    \end{compactenum}
  \end{semantics}
  Evidently, this is a lot more restrictive than \T{LL^*_p}. For
  example, \T{LL^*_p} validates
  \begin{gather*}
    \vdash x\!=\!y \then \Box Gxy \then \Box Gyy \text{\quad and}\\
    \vdash x\!=\!y \then (Fx \lor \Diamond Gxy) \then (Fy \lor \Diamond Gxy),
  \end{gather*}
  which can't be derived in Kutz's system (which is therefore incomplete).
} %

\begin{lemma}[Leibniz' Law with sequences]
  For any \Sc{L}-formula $A$ and variables
  $x_1,\ldots,x_n,y_1,\ldots,y_n$ such that the $x_1,\ldots,x_n$ are
  pairwise distinct,
  \begin{semantics}
    \itemT{LL^*_n} $\vdash_L x_1\!=\!y_1 \land \ldots \land
    x_n\!=\!y_n \then A \then [y_1,\ldots,y_n/x_1,\ldots,x_n]A$,
    provided each $y_i$ is modally free for $x_i$ in
    $[y_1,\ldots,y_{i-1}/x_1,\ldots,x_{n-1}]A$.
  \end{semantics}
\end{lemma}

For $i=1$, the proviso is meant to say that $y_1$ is modally free for $x_1$ in
$A$.

\cmnt{

  To explain the proviso, consider
  \[
  x\!=\!y \land z\!=\!y \then \Diamond x\!\not=\!z \then
  [y,y/x,z]\Diamond x\!\not=\!z \equiv \Diamond y\!\not=\!y.
  \]
  We don't want this to be valid, although $y$ is free for $x$, and
  $y$ is free for $z$, in $\Diamond x\!\not=\!z$. So it's not enough
  that each $y_i$ is free for the corresponding $x_i$. The proviso
  above requires that $y$ is free for $x$ in $\Diamond x\!\not=\!z$
  and $y$ is free for $z$ in $[y/x]\Diamond x\!\not=\!z \equiv
  \Diamond y\!\not=\!z$, which it isn't.

  It is a bit odd that the proviso introduces an order into the $x_i$
  and $y_i$, although order matters neither in conjunction
  $x_1\!=\!y_1 \land x_2\!=\!y_2 \land \ldots$ nor in polyadic
  substitution $[y_1,y_2,\ldots/x_1,x_2,\ldots]$. What if we identify
  $z\!=\!y$ with $x_1\!=\!y_1$ and $x\!=\!y$ with $x_2\!=\!y_2$ in the
  example? The proviso then requires that $y$ is free for $z$ in
  $\Diamond x\!\not=\!z$ and that $y$ is free for $x$ in
  $[y/z]\Diamond x\!\not=\!z \equiv \Diamond x\!\not=\!y$. Is it
  always true that if the proviso fails on some ordering of variables,
  then it fails on all? If so, shouldn't there be an ordering-free
  statement of the proviso?

}

\begin{proof} By induction on $n$. For $n=1$, \T{LL^*_n} is
  FIXME:CHECK
  
  \T{LL^*}. Assume then that $n > 1$ and that each $y_i$ in
  $y_1,\ldots,y_n$ is modally free for $x_i$ in
  $[y_1,\ldots,y_{i-1}/x_1,\ldots,x_{n-1}]A$. Let $z$ be some variable
  not in $A$, $x_1,\ldots,x_n$, $y_1,\ldots,y_n$. So $z$ is modally
  free for $x_n$ in $A$. By \T{LL^*},
  \begin{equation}\tag{1}
    \vdash_L x_n\!=\!z \then A \then [z/x_n]A.
  \end{equation}
  By induction hypothesis,
  \begin{equation}\tag{2}
    \vdash_L x_1\!=\!y_1 \land \ldots
    \land x_{n-1}\!=\!y_{n-1} \then [z/x_n]A \then [y_1,\ldots,y_{n-1} /
    x_1,\ldots,x_{n-1}][z/x_n]A.
  \end{equation}
  By assumption, $y_n$ is modally free for $x_n$ in
  $[y_1,\ldots,y_{n-1}/x_1,\ldots,x_{n-1}]A$. Then $y_n$ is also
  modally free for $z$ in $[y_1,\ldots,y_{n-1} /
  x_1,\ldots,x_{n-1}][z/x_n]A$. So by \T{LL^*},
  \begin{multline}\tag{3}
    \vdash_L z\!=\!y_n \then [y_1,\ldots,y_{n-1} /
    x_1,\ldots,x_{n-1}][z/x_n]A \then \\
    [y_n/z][y_1,\ldots,y_{n-1} / x_1,\ldots,x_{n-1}][z/x_n]A.
  \end{multline}
  But $[y_n/z][y_1,\ldots,y_{n-1} / x_1,\ldots,x_{n-1}][z/x_n]A$ is
  $[y_1,\ldots,y_n/x_1,\ldots,x_n]A$. Combining (1)--(3), we therefore
  have
  \begin{equation}\tag{4}
    \vdash_L x_1\!=\!y_1 \land \ldots \land x_{n-1}\!=\!y_{n-1} 
    \then x_n\!=\!z \land z\!=\!y_n \then A \then [y_1,\ldots,y_n /
    x_1,\ldots,x_n]A.
  \end{equation}
  So by \T{Sub^*},
  \begin{equation}\tag{5}
    \vdash_L x_1\!=\!y_1 \land \ldots \land x_{n-1}\!=\!y_{n-1} 
    \then x_n\!=\!x_n \land x_n\!=\!y_n \then A \then [y_1,\ldots,y_n /
    x_1,\ldots,x_n]A.
  \end{equation}
  Since $\vdash_L x_n\!=\!y_n \then x_n\!=\!x_n$ (by either \T{=\!R} or
  \T{Neg} and \T{\forall\!=\!R}), it follows that
  \begin{equation}\tag{6}
    \vdash_L x_1\!=\!y_1 \land \ldots \land x_{n}\!=\!y_{n} 
    \then A \then [y_1,\ldots,y_n / x_1,\ldots,x_n]A.
  \end{equation}
  \qed
\end{proof}

\begin{lemma}[Cross-substitution]
  For any \Sc{L}-formula $A$ and variables $x,y$,
  \begin{semantics}
    \itemT{CS} $\vdash_L x\!=\!y \then \Box A \then \Box(y\!=\!z \then
    [z/x]A)$, provided $z$ is not free in $A$.
  \end{semantics}
  More generally, for any variables $x_1,\ldots,x_n,y_1,\ldots,y_n$
  such that the $x_1,\ldots,x_n$ are pairwise distinct,
  \begin{semantics}
    \itemT{CS_n} $\vdash_L x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n
    \then \Box A \then \Box(y_1\!=\!z_1 \land \ldots \land y_n\!=\!z_n
    \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A)$, provided none of
    $z_1,\ldots,z_n$ is free in $A$.
  \end{semantics}
\end{lemma}

\begin{proof}
  FIXME:CHECK
  For \T{CS}, assume $z$ is not free in $A$. Then
  \begin{alignat*}{2}
    1.\quad & \vdash_L x\!=\!z \then A \then [z/x]A. &\quad& 
              \text{\T{LL^*}}\\
    2.\quad & \vdash_L A \then (x\!=\!z \then [z/x]A). && \text{(1)}\\
    3.\quad & \vdash_L \Box A \then \Box (x\!=\!z \then [z/x]A). && \text{(2, \T{Nec}, \T{K})}\\
    4.\quad & \vdash_L x\!=\!y \then \Box (x\!=\!z \then [z/x]A) \then 
              \Box (y\!=\!z \then [z/x]A). && \text{\T{LL^*}}\\
    5.\quad & \vdash_L x\!=\!y \then \Box A \then \Box (y\!=\!z \then [z/x]A). && \text{(3, 4)}
  \end{alignat*}
  Step 4 is justified by the fact that $x$ is not free in $[z/x]A$ and
  so $x$ and $y$ are modally separated in $x\!=\!z \then [z/x]A$.

  The proof for \T{CS_n} is analogous. Assume none of $z_1,\ldots,z_n$
  is free in $A$. Then
  \begin{alignat*}{2}
    1.\quad & \vdash_L x_1\!=\!z_1 \land \ldots \land x_n\!=\!z_n \then
    A \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A. &\quad& \text{\T{LL_n^*}}\\
    2.\quad & \vdash_L A \then (x_1\!=\!z_1\land\ldots\land x_n\!=\!z_n
    \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A). && \text{(1)}\\
    3.\quad & \vdash_L \Box A \then \Box (x_1\!=\!z_1 \land\ldots\land
    x_n\!=\!z_n \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A). 
    && \text{(2, \T{Nec}, \T{K})}\\
    4.\quad & \vdash_L x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \then &&\\[-0.2ex]
     &\quad\quad \Box (x_1\!=\!z_1 \land\ldots\land x_n\!=\!z_n \then
     [z_1,\ldots,z_n/x_1,\ldots,x_n]A) \then &&\\[-0.2ex]
     &\quad\quad \Box (y_1\!=\!z_1\land\ldots\land y_n\!=\!z_n \then 
     [z_1,\ldots,z_n/x_1,\ldots,x_n]A). && \text{\T{LL^*_n}}\\
    5.\quad & \vdash_L x_1\!=\!y_1 \land\ldots\land x_n\!=\!y_n \then 
    \Box A \then &&\\[-0.2ex]
     &\quad\quad \Box (x_1\!=\!z_1 \land\ldots\land
     x_n\!=\!z_n \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A). && \text{(3, 4)}
  \end{alignat*}
  Step 4 is justified by the fact that none of $x_1,\ldots,x_n$ is
  free in $[z_1,\ldots,z_n/x_1,\ldots,x_n]A$, and each $y_i$ is
  modally free for $x_i$ in
  $[y_1,\ldots,y_{i-1}/x_1,\ldots,x_{i-1}]\Box(x_1\!=\!z_1 \land
  \ldots\land x_n\!=\!z_n \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A)$,
  i.e.\ in $\Box(y_1\!=\!z_1 \land \ldots\land y_{i-1}\!=\!z_{i-1}
  \land x_i\!=\!z_i \land \ldots\land x_n\!=\!z_n \then
  [z_1,\ldots,z_n/x_1,\ldots,x_n]A)$, because $x_i$ and $y_i$ are
  modally separated in $y_1\!=\!z_1 \land \ldots\land y_{i-1}\!=\!z_{i-1}
  \land x_i\!=\!z_i \land \ldots\land x_n\!=\!z_n \then
  [z_1,\ldots,z_n/x_1,\ldots,x_n]A$. \qed
\end{proof}

\begin{lemma}[Substitution-free Universal Instantiation]
  For any \Sc{L}-formula $A$ and variables $x,y$, 
  \begin{semantics}
    \itemT{FUI^{**}} $\vdash_L \forall x A \then (Ey \then \exists
    x(x\!=\!y \land A))$.
  \end{semantics}
\end{lemma}

\begin{proof}
  FIXME:CHECK
  Let $z$ be a variable not in $\var(A),x,y$.
  \begin{alignat*}{2}
    1.\quad & \vdash_L z\!=\!y \then Ey \then Ez &\quad& \text{\T{LL^*}}\\
    2.\quad & \vdash_L \forall x A \then Ez \then [z/x]A
    && \text{(\T{FUI^*}, $z \not\in \var(A)$)}\\
    3.\quad & \vdash_L \forall x A \land Ey \then z\!=\!y \then [z/x]A
    && \text{(1, 2)}\\
    4.\quad & \vdash_L \forall x (x\!=\!z \then \neg A) \then Ez
    \then (z\!=\!z \then [z/x]\neg A) && \text{(\T{FUI^*}, $z \not\in \var(A)$)}\\
    5.\quad & \vdash_L Ez \then z\!=\!z
    && \text{(\T{=\!R}, or \T{\forall\!=\!R}, \T{FUI^*})}\\
    6.\quad & \vdash_L \forall x (x\!=\!z \then \neg A) \then Ez \then
    [z/x]\neg A
    && \text{(4, 5)}\\
    7.\quad & \vdash_L Ez \then [z/x]A \then \exists x(x\!=\!z \land
    A)
    && \text{(6)}\\
    8.\quad & \vdash_L \forall x A \land Ey \then z\!=\!y
    \then \exists x(x\!=\!z \land A) && \text{(1, 3, 7)}\\
    9.\quad & \vdash_L z\!=\!y \then \exists x(x\!=\!z \land A) \then
    \exists x(x\!=\!y \land A) && \text{(\T{LL^*}, $z \not\in \var(A)$)}\\
    10.\quad & \vdash_L \forall x A \land Ey \then z\!=\!y \then
    \exists x(x\!=\!y \land A) && \text{(8, 9)}\\
    11.\quad & \vdash_L \forall z(\forall x A \land Ey) \then \forall
    z (z\!=\!y \then \exists x(x\!=\!y \land A))
    && \text{(10, \T{UG}, \T{UD})}\\
    12.\quad & \vdash_L \forall x A \land Ey \then \forall
    z (z\!=\!y \then \exists x(x\!=\!y \land A)) && \text{(11, \T{VQ})}\\
    13.\quad & \vdash_L \forall z (z\!=\!y \then \exists x(x\!=\!y \land A)) 
    \then y\!=\!y \then \exists x(x\!=\!y \land A)
    && \text{(\T{FUI^*}, $z \not\in \var(A)$)}\\
    14.\quad & \vdash_L Ey \then y\!=\!y 
    && \text{(\T{=\!R}, or \T{\forall\!=\!R}, \T{FUI^*})}\\
    15.\quad & \vdash_L \forall z (z\!=\!y \then \exists x(x\!=\!y \land A))
    \then Ey \then \exists x(x\!=\!y \land A) && \text{(13, 14)}\\
    16.\quad & \vdash_L \forall x A \then Ey \then \exists x(x\!=\!y \land A) 
    && \text{(12, 15)}
  \end{alignat*}
  \qed

\end{proof}

\T{FUI^{*}} can also be derived from \T{FUI^{**}}, so we could just as well have
used \T{FUI^{**}} as basic axiom instead of \T{FUI^*}.

\cmnt{
  \begin{proof}    
    \begin{alignat*}{2}
      1.\quad & \vdash_L x\!=\!y \then A \then [y/x]A 
      &\quad& \text{ (LL, given $y$ is m.f. in $A$)}.\\
      2.\quad & \vdash_L \neg[y/x]A \then x\!=\!y \then \neg A 
      && \text{ (1, PC)}.\\
      3.\quad & \vdash_L \forall x(\neg[y/x]A \then x\!=\!y \then \neg A)
      && \text{ (2, UG)}.\\
      4.\quad & \vdash_L \forall x(\neg[y/x]A) \then \forall x(x\!=\!y \then \neg A)
      && \text{ (3, UD)}.\\
      5.\quad & \vdash_L \neg[y/x]A \then \forall x(\neg[y/x]A)
      && \text{ (VQ)}.\\
      6.\quad & \vdash_L \neg[y/x]A \then \forall x(x\!=\!y \then \neg A)
      && \text{ (4, 5, PC)}.\\
      7.\quad & \vdash_L \exists x(x\!=\!y \land A) \then [y/x]A
      && \text{ (6, PC)}.\\
      8.\quad & \vdash_L \forall x A \then Ey \then \exists x(y\!=\!x \land A)
      && \text{ (FUI*)}.\\
      9.\quad & \vdash_L \forall x A \then Ey \then [y/x] A && \text{(7,8)}.
    \end{alignat*}
    \qed
  \end{proof}  
}



\section{Object-language substitution}\label{sec:substitution-logics}

FIXME: This whole section.

We had to give weird restrictions on substitution principles. This is because
modal operators are \emph{slightly opaque}: even if $x=y$, $\Box Gxy$ and
$\Box Gxx$ say different things. Informally, $\Box Gxy$ says that all
counterparts of $x$ (and therefore of $y$) are $G$-related to one another, while
$\Box Gxx$ merely says that all counterparts of $x$ are $G$-related to
themselves.

If an individual has multiple counterparts at a certain world, and the point of
evaluation shifts to this world, we may think of the corresponding terms as
becoming ``ambiguous'', denoting all the counterparts at the same time. To
verify $\Box \phi(x)$, we require that $\phi(x)$ is true at all accessible
worlds under all ``disambiguations''. In principle, we could allow for ``mixed
disambiguations'' under which different occurrences of $x$ can pick out
different counterparts. On this interpretation $x\!=\!y \land \Box Gxy$ and
$x\!=\!y \land \Box Gxx$ would be equivalent. $\Box x\!=\!x$ and
$\Box (Fx \lor \neg Fx)$ would become invalid (even in positive models). I have
assumed ``uniform disambiguations'' mainly because it simplifies the semantics.
Mixed disambiguations can't be represented by a classical assignment function.
We would have to allow for the possibility that $g(x)$ is a \emph{set} of
individuals.

The present issue might remind you of the old observation that a sentence like
`Brutus killed himself' can be understood either as an application of a
\emph{monadic} predicate `killing himself' to the subject Brutus, or as an
application of the binary `killing' to Brutus and Brutus. Peter Geach once
suggested a syntactic mechanism for distinguishing these readings, by
introducing an operator $\t{z:x,y}$ that turns a binary expression into a unary
expression: while $Gxy$ is satisfied by pairs of individuals, $\t{z:x,y}Gxy$ is
satisfied by a single individual. The operator $\t{z:x,y}$, which might be read
`$z$ is an $x$ and a $y$ such that' acts as a quantifier that binds both $x$ and
$y$.

A similar trick can be used in our modal context. On our uniform reading,
$\Box x\!=\!x$ says that all counterparts of $x$ are self-identical at all
accessible worlds. To say that at all accessible worlds (and under all
counterpart relations), all $x$ counterparts are identical to all $x$
counterparts we could instead say $\t{x:y,z}\Box y\!=\!z$. The effect of
$\t{x:y,z}$ is to introduce two variables $y$ and $z$ that co-refer with $x$. By
using distinct but co-refering variables in a modal context, we can express
relations between possibly distinct counterparts; by using the same variable, we
make sure that the same counterpart must be assigned to every occurrence.

With $\t{x:y,z}\Box y\!=\!z$, we actually end up with \emph{three} co-referring
variables: $y$ and $z$ are made to co-refer with $x$, but we also have $x$
itself. The job can also be done with $\t{x:y}\Box x\!=\!y$ -- read: `$x$ is a
$y$ such that \ldots'.%
\cmnt{(See Lowe and Geach.)}

This operator is a close cousins of lambda abstraction and application,
as introduced to modal logic in \cite{stalnaker68abstraction}. Lambda
abstraction converts a formula $A$ into a predicate $(\lambda x.A)$, which can
then be applied to a singular term $y$ to form a new formula $(\lambda x.A)y$.
Semantically, $(\lambda x.A)y$ is true under an interpretation $V$ at a world
$w$ iff $A$ is true under the $x$-variant $V'$ of $V$ on $w$ with
$V'_{w}(y)=V_w(x)$. So $(\lambda x.A)y$ is another way of writing $\t{y:x}A$.

Lambda abstraction is useful to ensure transparency. FIXME expand.

To avoid accidental ``capturing'' of $y$ in the consequent of
\eqref{ex.ui-diamond}, we can use the Geach quantifier:
\begin{gather}
  \forall x \Diamond Gxy \then \t{y:x}\Diamond Gxy \tag{\ref{ex.ui-diamond}$'$}\\
  x\!=\!y \then \Diamond Gxy \then \t{y:x}\Diamond Gxy \tag{\ref{ex.ll-diamond}$'$}
\end{gather}
The Geach quantifier $\t{y:x}$ functions as an \emph{object-language
  substitution operator}.

In some contexts, it may be useful to add this operator to our language.

\begin{definition}[Languages of QML with substitution]\label{langs}
  A \emph{language of quantified modal logic with substitution} is the standard
  language of quantified modal logic (definition \ref{!L}) with an added
  construct $\t{\; : }$ and the rule that whenever $x,y$ are variables and $A$
  is a formula, then $\t{y:x}A$ is a formula.
\end{definition}

As for the semantics: just as $\forall x A$ is true relative to an
interpretation $V$ iff $A$ is true relative to all $x$-variants of $V$
(on the relevant domain), $\t{y:x}A$ is true relative to $V$ iff $A$
is true relative to the $x$-variant of $V$ that maps $x$ to $V(y)$. In
our modal framework:

\begin{definition}[Semantics for the substitution operator]\label{!SATG}
  \begin{semantics}
  \item[$w,V \SAT \t{y:x}A$] iff $w,V' \SAT A$, where $V'$ is the
    $x$-variant of $V$ on $w$ with $V'_w(x) = V_w(y)$.
  \end{semantics}
\end{definition}
\noindent%
Note that $V'$ need not be an \emph{existential} $x$-variant of $V$ on
$w$. 

The locality lemma \ref{locality} is easily adjusted to languages with
substitution. Here is the only new step in the induction:
\begin{enumerate}
\item[] $A$ is $\t{y:x}B$.\; $w,V \SAT \t{y:x}B$ iff $w,V^* \SAT
  B$ where $V^*$ is the $x$-variant of $V$ on $w$ with $V^*_w(x) =
  V_w(y)$. Let ${V'}^{*}$ be the $x$-variant of $V'$ on $w$ with
  ${V'}^*_w(x) = V'_w(y)$. Then $V^*$ and ${V'}^*$ agree at $w$ on
  all variables in $B$, so by induction hypothesis, $w,V^* \SAT B$
  iff ${V'}^*,w \SAT B$. And this holds iff $w,V' \SAT \t{y:x}B$ by
  the semantics of $\t{y:x}$. \qed
\end{enumerate}

\cmnt{
  If we were to restrict the $x$-variant to $D_w$, we'd get something
  like this.
  \begin{quote}
    \textbf{Definition: inner substitution}
    \begin{semantics}
    \item[$w,V \SAT \t{y | x}A$] iff $V(y) \in D_w$ and $w,V' \SAT A$,
      where $V'$ is the (existential) $x$-variant of $V$ on $w$ with
      $V'_w(x) = V_w(y)$.
    \end{semantics}
  \end{quote}
  Unlike $\t{y:x}A$, $\t{y | x}A$ is easily definable, as $\exists
  z(y\!=\!z \land A)$.

  Inner substitution does not in general satisfy the substitution
  lemma. It does so only relative to worlds and interpretations that
  verify $Ey$ for all variables $y$. If $\neg Ey$, then $[y/x]A$ comes
  out false, whether $A$ is $Fx$ or $\neg Fx$ or $\Box (p\then p)$. In
  this respect, $\t{y | x}A$ functions more like a lambda expression
  $(\lambda x.A)(y)$.

  The question is whether the use of $[y/x]$ in (FUI) and (LL) really
  requires a proper substitution operator, or whether we could just
  use $\t{y | x}$ instead. For instance, (FUI) would then become
  \[
  \forall x A \then Ey \then \exists z(y\!=\!z \land A).
  \]
  This seems harmless, because the antecedent $Ey$ guarantees anyway
  that $y$ exists. Things more difficult for (LL).

  In local classical systems, we do have $Ey$ as a theorem. So the
  substitution lemma holds with $\t{y | x}$ for initial
  interpretations $V$, but not for ``counterfactual'' images
  $V'$. Nevertheless, the relevant versions of (UI) and (LL) remain
  sound. $\Box(FUI)$ is also sound. $\Box (LL)$ is sound only on
  negative interpretations. Otherwise $\Box x=y$ and $\Box \neg Fx$
  can be true and $\Box\exists x(x=y \land \neg Fx)$ false if $V(x)$
  and $V(y)$ have the same unique counterpart at all worlds, all of
  which are $\neg F$, and some of which don't exist. OTOH, $\Box
  (\forall LL)$ still holds.
 
  Many Substitution Principles involving modal operators fail with
  inner substitution. In particular, we lose ``Continuity'' for
  counterfactual interpretations $V$: $[y/x]\Box \neg Fx$ doesn't
  imply that $y$ exists at all worlds, but $\Box[y/x]\neg Fx$
  does. Indeed, (Cont) turns into
  \begin{equation*}
    \exists y(y\!=\!x \land \Box A) \then \Box\exists y(y\!=\!x \land A),\\
  \end{equation*}
  which entails the necessity of existence by using a tautology for
  $A$.

  (Note BTW that the existential suggestion as it stands won't work
  for $\t{x:x}$, which \emph{should} be a redundant operator,
  certainly we don't want $\t{x:x}A$ to be $\exists x(x\!=\!x \land
  A)$, i.e. $\exists x A$. It also needs to be fixed for
  sequences. E.g. $\t{x,y:y,x}A$ shouldn't be $\exists x\exists
  y(x\!=\!y \land y\!=\!x \land A)$, nor $\exists x(x\!=\!y \land
  \ldots)$. The problem is that the variables on the right of the
  column need to be bound without capturing any variables on the
  left. So if the RHS variables $\vec{y}$ occur on the left, I need to
  first rename $\vec{y}$ to some new variables $\vec{y'}$. (See below
  on polyadic substitution quantifiers. The fix mentioned there can also be
  applied to $\t{x:x}$, where it yields $\t{x:z}\t{z:x}$.))

  When we go through the canonical model section with $\t{y|x}$ in
  place of $\t{y:x}$, we run into trouble. Consider the crucial clause
  $A = \Box B$ of the truth lemma. From RTL, we want to show that if
  $\Box B \in w$, then $w,V \SAT \Box B$. The proof below goes like this.

  Assume $w,V \not\SAT \Box B$. So $w',V' \not\SAT B$ for some $w',V'$
  such that $wRw'$ and $V'$ is such that for all variables $y$, if
  there is a $z \in V_w(y)$ with $z^\tau\!=\!z^\tau \in w'$, then
  there is a $z \in V_w(y)$ with $z^\tau \in V'_{w'}(y)$, else
  $V'_{w'}(y)$ is undefined.

  Let $*$ be a substitution that maps each variable $y$ in $B$ for
  which there is a $z \in V_w(y)$ with $z^\tau \in V'_{w'}(y)$ to some
  such $z\in V_w(y)$ with $z^\tau \in V'_{w'}(z)$, and that maps every
  other variable to itself. So if $y \in \var(B)$ and $V'_{w'}(y)$ is
  defined, then $(*y)^\tau \in V'_{w'}(y)$, and so $V'_{w'}(y) =
  [(*y)^\tau]_{w'} = V^{\tau\cdot *}_{w'}(y)$. If $V'_{w'}(y)$ is
  undefined, then $V^{\tau\cdot *}_{w'}(y) = V^{\tau}_{w'}(y)$ is
  undefined, as otherwise $V^{\tau}_{w'}(y) = [y^\tau]_{w'} \not=
  \emptyset$ and $y^\tau\!=\!y^\tau \in w'$. So $V'$ and $V^{\tau\cdot
    *}$ agree at $w'$ on all variables in $B$. By the coincidence
  lemma, $w',V^{\tau\cdot *} \not\SAT B$.

  Suppose for reductio that $\Box B \in w$. Let $y_1,\ldots,y_n$ be
  the variables $y$ in $B$ with $(*y)^\tau \in V'_{w'}(y)$. For each
  such $y$, $*y \in V_w(y)$, and so $y\!=\!*y \in w$. By \T{LL^g}, FIXME
  which generalises \T{LL^s} for sequences, $\t{*y_1,\ldots,*y_n :
    y_1,\ldots, y_n}\Box B \in w$. By \T{S\Box},
  $\Box\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n} B \in w$. So by
  construction of $R$, $(\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n}
  B)^\tau \in w'$. By induction hypothesis, then $w', V \SAT
  (\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n} B)^\tau$, and by the
  transformation lemma \ref{transl}, $w', V^\tau \SAT
  \t{*y_1,\ldots,*y_n : y_1,\ldots, y_n} B$. And then $w', V^{\tau
    \cdot [*y_1,\ldots,*y_n / y_1,\ldots, y_n]} \SAT B$ by lemma
  \ref{seq}. But $[*y_1,\ldots,*y_n : y_1,\ldots, y_n]$ is
  $*$. \cmnt{(If $(*y)^\tau \not\in V'_{w'}(y)$, then $V'_{w'}(y)$ is
    undefined, and there is no $z \in V_w(y)$ with $z^\tau \in
    V'_{w'}(y)$, so then $*y = y$.)} So $w',V^{\tau\cdot *} \SAT
  B$. Contradiction.

  With inner substitution, this doesn't work. Here, too, we want
  $y\!=\!x \land \Box \neg Gxy \Rightarrow \t{y:x} \Box \neg Gxy
  \Rightarrow \Box \neg Gyy$, without $\Box Ey$. But we don't want
  $y\!=\!x \land \Box \Diamond \neg Gxy \Rightarrow \Box \Diamond \neg
  Gyy$.  (Or, for $\t{y:x}\Box B$ formulas: we want $\forall x \Box
  \neg Gxy \Rightarrow \t{y:x}\Box \neg Gxy \Rightarrow \Box \neg
  Gyy$, without $\Box Ey$.) We'd need some further axiom to go from
  $\t{y:x}\Box \neg Gxy$ to $\Box \neg Gyy$, but not from $\t{y:x}\Box
  \Diamond \neg Gxy$ to $\Box \Diamond \neg Gyy$.

  And what about the last step, in which substitution semantics is
  applied even though some of the $y^*$ may not even be self-identical
  at $w$ under $V^\tau$, let alone be in $V^\tau_w(E)$?
  
}

Substitution operators turn out to have significant expressive power. As
\cite{kuhn80quantifiers}\label{kuhn} shows (in effect), if a language has
substitution operators, it no longer needs variables or individual constants in
its atomic formulas: instead of $Fx$, we can simply say $F$, with the convention
that the implicit variable is always $x$ (for binary predicates, the first
variable is $x$, the second $y$, etc.); $Fy$ turns into $\t{y:x}F$, $Gyz$ into
$\t{y:x}\t{z:y}G$. Similarly, $\forall x Fx$ can be replaced by $\forall F$, and
$\forall y Gxy$ by $\forall \t{y:z}\t{x:y}\t{z:x} G$.%
\cmnt{%
  $\t{y:z}\t{x:y}\t{z:x}$ is the swapping operator $\t{x,y:y,x}$.
  $\forall y Gxy$ is equivalent to $\t{x,y:y,x} \forall x Gyx$. Directly,
  $\forall y Gxy$ is true at a sequence $abc\ldots$ iff $Gxy$ is true at
  $ab'c\ldots$ for all $b'$. Moreover, $Gxy$ is true at $ab'c$ iff
  $\t{x,y:y,x}Gxy$ is true at $b'ac\ldots$.%
} %
So we also don't need different quantifiers for different variables. In this
essay, I will not exploit the full power of substitution operators -- mainly for
the sake of familiarity. Our languages with substitution operators will still
have ordinary formulas $Px_1\ldots x_n$ and quantifiers $\forall x, \forall y$,
etc.

There are distinctions one can draw with $\t{y:x}$ that cannot be drawn without
it. For example, the substitution quantifier allows us to say that an individual
$y$ has multiple counterparts at some accessible world (under the same
counterpart relation): $\t{y:x}\Diamond y\!\not=\!x$. This can't be expressed
without the operator -- at least not in positive models.

It is clear that $\Diamond y\!\not=\!y$ is not an adequate translation of
$\t{y:x}\Diamond x\!\not=\!y$. Before substituting $y$ for $x$ in
$\Diamond x\!\not=\!y$, we would have to make $x$ free for $y$ by renaming the
modally bound occurrence of $y$. However, the diamond, unlike the quantifier
$\forall y$, binds $y$ in such a way that the domain over which it ranges (the
counterparts of $y$'s original referent) depends on the previous reference of
$y$. So we can't just replace $y$ by some other variable $z$, translating
$\t{y:x}\Diamond x\!\not=\!y$ as $\Diamond y\!\not=\!z$. This only works if $z$
happens to corefer with $y$. Since we can't presuppose that there is always
another name available for any given individual, we would somehow have to
introduce a name $z$ that corefers with $y$. For instance, if we could transform
$\Diamond x\!\not=\!y$ into $\exists z(y\!=\!z \land \Diamond x\!\not=\!z)$, the
variable $x$ would have become free for $y$ in the scope of the diamond, so we
could translate $\t{y:x}\Diamond x\!\not=\!y$ as
$\exists z(y\!=\!z \land \Diamond x\!\not=\!y)$. The problem is that the
quantifier $\exists$ ranges only over existing objects, while $\t{y:x}$ bears no
such restriction. In positive models, $V_w(y)$ can have multiple counterparts
even if it lies outside $D_w$, so that
$\exists z(y\!=\!z \land \Diamond x\!\not=\!y)$ is false.%
\cmnt{%
  It wouldn't help to use $\forall z(y\!=\!z \then A)$ instead, because that
  would translate \emph{any} statement $\t{y:x}A$ into something true in this
  scenario, even $\t{y:x}(P \land \neg P)$.%
} %
(One would need an ``outer quantifier'' in place of $\exists$.)

This, incidentally, shows that there is no way of defining a substitution
operator $[y/x]A$ that satisfies the unrestricted ``substitution lemma''
\begin{equation*}
  \Fr{M},g \models [y/x]A \text{ iff } \Fr{M},g^{[y/x]} \SAT A.
\end{equation*}

Here is the full proof in more detail.

\begin{theorem}[Undefinability of substitution]\label{non-elim}
  There is no operation $\Phi$ on formulas $A$ such that for any world $w$ in a
  counterpart models $\Fr{M}$ and assignment $g$ on $U_{w}$,
  $\Fr{M},w,g \SAT \Phi(A)$ iff $\Fr{M},w,g^{[y/x]} \SAT A$.
\end{theorem}
\begin{proof}
  FIXME
  Let $\Fr{M}_1 = \t{\Fr{S}_1,V}$ be a positive counterpart model with
  $W = \{w\}$, $R = \{ \t{w,w} \}$, $U_w = \{ x,y,y^* \}$, $D_w = \{ x
  \}$, $K_{w,w} = \{ \{ \t{d,d} : d \in U_w \} \}, V_w(y) = y$,
  $V_w(z) = x$ for every variable $z \not= y$, and $V_w(P) =
  \emptyset$ for all non-logical predicates $P$. Let $\Fr{M}_2 =
  \t{\Fr{S}_2,V}$ be like $\Fr{M}_1$ except that $y^*$ is also a
  counterpart of $y$, i.e. $K_{w,w'} = \{\{ \t{x,x}, \t{y,y},
  \t{y^*,y^*}, \t{y,y^*} \} \}$. Then $w,V^{[y/x]} \SAT_{\Fr{S}_2}
  \Diamond y\!\not=\!x$, but $w,V^{[y/x]} \not\SAT_{\Fr{S}_1} \Diamond
  y\!\not=\!x$.
 
  On the other hand, every $\Sc{L}$-sentence has the same truth-value
  at $w$ under $V$ in both models. We prove this by showing that for
  every $\Sc{L}$-sentence $A$, $w,V \SAT_{\Fr{S}_1} A$ iff $w,V
  \SAT_{\Fr{S}_2} A$ iff $w,V^* \SAT_{\Fr{S}_2} A$, where $V^*$ is the
  $y$-variant of $V$ on $w$ with $V^*_w(y)=V_w(y^*)$.

  \begin{enumerate}

  \item $A$ is $Px_1\ldots x_n$.\; It is clear that $w,V
    \SAT_{\Fr{S}_1} Px_1\ldots x_n$ iff $w,V \SAT_{\Fr{S}_2}
    Px_1\ldots x_n$ because counterpart relations do not figure
    in the evaluation of atomic formulas. Moreover, for non-logical
    $P$, $w,V \not\SAT_{\Fr{S}_2} Px_1\ldots x_n$ and $w,V^*
    \not\SAT_{\Fr{S}_2} Px_1\ldots x_n$, because $V_w(P) = V^*_w(P) =
    \emptyset$. For the identity predicate, observe that $w,V
    \not\SAT_{\Fr{S}_2} u\!=\!v$ iff exactly one of $u,v$ is $y$,
    since $V_w(z) = x$ for all terms $z \not= y$. For the same reason,
    $w,V^* \not\SAT_{\Fr{S}_2} u\!=\!v$ iff exactly one of $u,v$ is
    $y$. So $w,V \SAT_{\Fr{S}_2} u\!=\!v$ iff $w,V^* \SAT_{\Fr{S}_2}
    u\!=\!v$.
    
  \item $A$ is $\neg B$.\; $w,V \SAT_{\Fr{S}_1} \neg B$ iff $w,V
    \not\SAT_{\Fr{S}_1} B$ by definition \ref{!SAT}, iff $w,V
    \not\SAT_{\Fr{S}_2} B$ by induction hypothesis, iff $w,V
    \SAT_{\Fr{S}_2} \neg B$ by definition \ref{!SAT}. Moreover, $w,V
    \not\SAT_{\Fr{S}_2} B$ iff $w,V^* \not\SAT_{\Fr{S}_2} B$ by
    induction hypothesis, iff $w,V^* \SAT_{\Fr{S}_2} \neg B$ by
    definition \ref{!SAT}.

  \item $A$ is $B \then C$.\; $w,V \SAT_{\Fr{S}_1} B \then C$ iff $w,V
    \not\SAT_{\Fr{S}_1} B$ or $w,V \SAT_{\Fr{S}_1} C$ by definition
    \ref{!SAT}, iff $w,V \not\SAT_{\Fr{S}_2} B$ or $w,V
    \SAT_{\Fr{S}_2} C$ by induction hypothesis, iff $w,V
    \SAT_{\Fr{S}_2} B \then C$ by definition \ref{!SAT}. Moreover,
    $w,V \not\SAT_{\Fr{S}_2} B$ or $w,V \SAT_{\Fr{S}_2} C$, iff $w,V^*
    \not\SAT_{\Fr{S}_2} B$ or $w,V^* \SAT_{\Fr{S}_2} C$ by induction
    hypothesis, iff $w,V^* \SAT_{\Fr{S}_2} B \then C$ by definition
    \ref{!SAT}.
        
  \item $A$ is $\forall z B$.\; Let $v$ be a variable not in $\var(B)
    \cup \{ y \}$. By lemma \ref{alpha}, $w,V \SAT_{\Fr{S}_1} \forall
    z B$ iff $w,V \SAT_{\Fr{S}_1} \forall v [v/z]B$. By definition
    \ref{!SAT}, $w,V \SAT_{\Fr{S}_1} \forall v [v/z]B$ iff $w,V'
    \SAT_{\Fr{S}_1} [v/z]B$ for all existential $v$-variants $V'$ of
    $V$ on $w$. As $D_w = \{ x\}$ and $V(v)=x$, the only such
    $v$-variant is $V$ itself. So $w,V \SAT_{\Fr{S}_1} \forall z B$
    iff $w,V \SAT_{\Fr{S}_1} [v/z]B$. \cmnt{(Without the detour
      through $v$, the bound variable $z$ could have been $y$, in
      which case $V$ itself would not be the relevant $z$-variant
      $V'$.)} By the same reasoning, $w,V \SAT_{\Fr{S}_2} \forall z B$
    iff $w,V \SAT_{\Fr{S}_2} [v/z]B$. But by induction hypothesis,
    $w,V \SAT_{\Fr{S}_1} [v/z]B$ iff $w,V \SAT_{\Fr{S}_2} [v/z]B$. So
    $w,V \SAT_{\Fr{S}_1} \forall z B$ iff $w,V \SAT_{\Fr{S}_2}
    \forall z B$.  Moreover, by induction hypothesis, $w,V
    \SAT_{\Fr{S}_2} [v/z]B$ iff $w,V^* \SAT_{\Fr{S}_2} [v/z]B$, iff
    $w,V^* \SAT_{\Fr{S}_2} \forall v[v/z] B$ because $V^*$ is the only
    existential $v$-variant of $V^*$ on $w$, iff $w,V^* \SAT_{\Fr{S}_2}
    \forall z B$ by lemma \ref{alpha}.

  \item $A$ is $\Box B$.\; In both structures, the only world
    accessible from $w$ is $w$ itself. Also in $\Fr{S}_1$, $V$ is the
    only $w$-image of $V$ at $w$. So by definition \ref{!SAT}, $w,V
    \SAT_{\Fr{S}_1} \Box B$ iff $w,V \SAT_{\Fr{S}_1} B$. In
    $\Fr{S}_2$, there are two $w$-images of $V$ at $w$: $V$ and
    $V^*$. So $w,V \SAT_{\Fr{S}_2} \Box B$ iff both $w,V
    \SAT_{\Fr{S}_2} B$ and $w,V^* \SAT_{\Fr{S}_2} B$. By induction
    hypothesis, $w,V \SAT_{\Fr{S}_1} B$ iff both $w,V \SAT_{\Fr{S}_2}
    B$ and $w,V^* \SAT_{\Fr{S}_2} B$. So $w,V \SAT_{\Fr{S}_1} \Box B$
    iff $w,V \SAT_{\Fr{S}_2} \Box B$.  Moreover, in $\Fr{S}_2$, $V^*$
    is the only $w$-image of $V^*$ at $w$. So $w,V^* \SAT_{\Fr{S}_2}
    \Box B$ iff $w,V^* \SAT_{\Fr{S}_2} B$. By induction hypothesis,
    $w,V^* \SAT_{\Fr{S}_2} B$ iff $w,V \SAT_{\Fr{S}_2} B$. So $w,V^*
    \SAT_{\Fr{S}_2} \Box B$ iff both $w,V^* \SAT_{\Fr{S}_2} B$ and
    $w,V \SAT_{\Fr{S}_2} B$, which as we just saw holds iff $w,V
    \SAT_{\Fr{S}_2} \Box B$. \qed
  \end{enumerate}
\end{proof}

(In negative models, $\t{y:x}A$ can be translated into
$\exists x(x\!=\!y \land A) \lor (\neg Ey \land [y/x]A)$, which still has the
downside of being very impractical, since the result of the substitution has
much greater syntactic complexity than the original sentence.)

\cmnt{

  The proof of lemma \ref{non-elim} assumes positive semantics ($U
  \not= D$). In negative semantics, $V_w(y)$ can be undefined, but
  then it remains undefined under any image of $V$ at $w$; so there
  can't be a non-existing individual with multiple
  counterparts. Moreover, if $V_w(y)$ does not have multiple
  counterparts at any world, then by lemma \ref{rsl} we can simply
  define $\t{y:x}A$ as $[y/x]A$. So the only case to take care of is
  that of an individual in $D_w$ having multiple counterparts. But
  then we can say $\exists x(x\!=\!y \land \Diamond x\!\not=\!y)$ for
  $\t{y:x}\Diamond x\!\not=\!y$.

  To provide for all cases simultaneously, we might translate
  $\t{y:x}A$ into \cmnt{$(Ey \land \exists x(x\!=\!y \land A)) \lor
    (\neg Ey \land [y/x]A)$ = } $\exists x(x\!=\!y \land A) \lor (\neg
  Ey \land [y/x]A)$.

  \begin{alignat*}{2}
    & w,V \SAT \exists x(x\!=\!y \land A) \lor (\neg Ey \land [y/x]A) &&\\
    \text{iff}\quad & w,V \SAT \exists x(x\!=\!y \land A) \text{ or }
    w,V \SAT \neg Ey \land [y/x]A &&\\
    \text{iff}\quad & w,V' \SAT x\!=\!y \land A \text{ for some $V'$
      with $V'_w(x) \in D_w$}\\[-0.4ex]
    & \text{or } V_w(y) \not\in D_w \text{ and } w,V \SAT [y/x]A &&\\
    \text{iff}\quad & w,V' \SAT A \text{ for some $V'$ with $V'_w(x) =
      V_w(y)\in D_w$}\\[-0.4ex]
    & \text{or } V_w(y) \not\in D_w \text{ and } w,V \SAT [y/x]A&&\\
    \text{iff}\quad & w,V^{[y/x]} \SAT A\text{ and } V_w(y) \in D_w\\[-0.4ex]
    & \text{or } V_w(y) \not\in D_w \text{ and } w,V \SAT [y/x]A&&\\
    \text{iff}\quad & w,V^{[y/x]} \SAT A\text{ and } V_w(y) \in D_w\\[-0.4ex]
    & \text{or } V_w(y) \not\in D_w \text{ and } w,V^{[y/x]} \SAT A
    &\quad&
    \text{(by lemma \ref{rsl})}\\
    \text{iff}\quad & w,V^{[y/x]} \SAT A &&
  \end{alignat*}
  Lemma \ref{rsl} applies at the penultimate step because $V_w(y)
  \not\in D_w$ entails in negative models that it is not the case that
  $V_w(y)$ has multiple counterparts at any world.

  This definition of substitution is negative logics has the downside
  that $\t{y:x}A$ is of significantly higher syntactic complexity than
  $A$. Nevertheless, we could use it in principles like (LL*) and
  (FUI*). I don't know whether the logics would thereby be complete:
  my proof of the canonical model lemma (lemma \ref{ml}) requires that
  $\t{y:x}A$ is of lower complexity than $\forall x A$.

  Among the less obvious ideas for defining $\t{y:x}$ consider
  recursive definitions like
  \begin{align*}
    \t{y:x}Fx &= \exists x(y\!=\!x \land Fx)\\
    \t{y:x}\neg A &= \neg \t{y:x}A\\
    \t{y:x}(A \then B) &= \t{y:x}A \then \t{y:x}B\\
    \t{y:x}\forall z A &= \forall z'\t{y:x}[z'/z]A\\
    \t{y:x}\Box A &= \exists x(y\!=\!x \land \Box A).
  \end{align*}
  Note that this sneakily breaks the link from Continuity to NE. Cont
  becomes
  \[
  \exists x(x\!=\!y \land \Box A) \then \Box\t{y:x}A.
  \]
  What this further amounts to depends on $A$. E.g. for $A = \neg
  \falsum$, the RHS becomes $\Box\neg \exists x(x\!=\!y \land
  \falsum)$, which is just right. There is, however, still the problem
  that $\t{y:x}\Box \neg Fx$ entails $Ey$, which it doesn't on the
  primitive reading.

  One might also always drive out the substitution to the front, so that
  \begin{align*}
    \Box\t{y:x}A &= \exists x(y\!=\!x \land \Box A).
  \end{align*}
  But then inverse Continuity would also be valid. And how do we
  handle $\Diamond\exists y \t{y:x}\Diamond Gxy$? Could we drive
  substitution out to wherever the variables(s??) were introduced?
  FWIW, we could also let $\t{y:x}A$ be $[y/x]A$ whenever $y$ does not
  occur modalised in $A$.

}

What is the logic for languages with object-language substitution?

We first have to lay down some axioms governing the substitution operator. An
obvious suggestion would be the lambda-conversion principle
\[
   \t{y:x}A \leftrightarrow [y/x]A,
\]
which would allow us to move back and forth between e.g. $\t{y:x}Fx$
and $Fy$. But we've seen in lemma \ref{rsl} that if things can have
multiple counterparts, then these transitions are sound only under
certain conditions: the move from $\t{y:x}A$ to $[y/x]A$ requires that
$y$ is modally free for $x$ in $A$, the other direction requires that
$y$ and $x$ are modally separated in $A$. So we have the following
somewhat more complex principles:

\begin{semantics}
  \itemT{SC1} $\t{y:x}A \leftrightarrow [y/x]A$, provided $y$ and $x$
  are modally separated in $A$.
  \itemT{SC2} $\t{y:x}A \then [y/x]A$, provided $y$ is modally free for
  $x$ in $A$.
\end{semantics}

But now we need further principles telling us how $\t{y:x}$ behaves
when $y$ is not modally free for $x$. For example, $\t{y:x}\neg A$
should always entail $\neg \t{y:x} A$, even if $y$ is not modally free
for $x$ in $A$. More generally, the substitution operator commutes
with every non-modal operator as long as there is no clash of bound
variables:
\begin{semantics}
  \itemT{S\neg} $\t{y:x}\neg A \leftrightarrow \neg\t{y:x}A$,
  \itemT{S\!\then} $\t{y:x}(A \then B) \leftrightarrow (\t{y:x}A \then \t{y:x}B)$,
  \itemT{S\forall} $\t{y:x}\forall z A \leftrightarrow \forall z \t{y:x} A$, 
     provided $z \not\in \{x,y\}$,
  \itemT{SS1} $\t{y:x}\t{y_2:z}A \leftrightarrow \t{y_2:z}\t{y:x}A$,
     provided $z \not\in \{x,y\}$ and $y_2\not=x$.
\end{semantics}


\cmnt{

  Consider the different ways for $x,y,z$ in \T{S\forall} to not be
  distinct:
  \begin{compactenum}
  \item $x=y=z$.\; $\t{x:x}\forall x A$ \emph{is} equivalent to
    $\forall x \t{x:x}A$: they both say the same as $\forall x A$. We
    don't need to allow for this instance here because it is provable
    from $\t{x:x}A \leftrightarrow A$ (\T{SE1} below) via $\forall x
    \t{x:x}A \leftrightarrow \forall x A$ (\T{UG}, \T{UD}) and
    $\forall x A \leftrightarrow \t{x:x}\forall x A$ (\T{VS}).
  \item $x=y\not=z$.\; $\t{x:x}\forall z A$ \emph{is} equivalent to
    $\forall z \t{x:x} A$.
  \item $x=z\not=y$.\; $\t{y:x}\forall x A$ \emph{is not} equivalent
    to $\forall x\t{y:x}A$. Rather, it is equivalent to $\forall x A$
    (and provably so, by \T{VS}), while $\forall x \t{y:x}A$ is
    equivalent to $\t{y:x}A$ (and provably so, by \T{VQ}, \T{FUI_s}
    and \T{VS}).
  \item $x\not=y=z$.\; $\t{y:x}\forall y A$ \emph{is not} equivalent
    to $\forall y\t{y:x}A$. The former says that $A$ holds under all
    $x,y$-variants $V'$ that map $y$ into $D_w$ and $x$ to the
    original value $V(y)$ of $y$. The latter says that $A$ holds under
    all $x,y$-variants $V'$ that map $x$ and $y$ to the same member of
    $D_w$.
  \end{compactenum}

}

\cmnt{

  \T{SS} is a bit more complicated. $\t{y:x}$ obviously commutes with
  $\t{y_2:z}$ if all four variables are distinct. Moreover, it
  wouldn't matter if $x=y$ or $y_2=z$. Potential problems only arise
  if the two substitution terms share a variable. Then again, it
  wouldn't matter if the unbound variables $y$ and $y_2$ were
  identical: $\t{y:x}\t{y:z}A \leftrightarrow \t{y:z}\t{y:x}A$. So the
  following condition is sufficient for two substitutions to commute:
  none of $x,y$ is identical to any of $z,y_2$ except perhaps for $y$
  and $y_2$. Equivalently: $z\not\in\{x,y\}$ and $y_2\not=x$
  (equivalently: $x\not\in \{z,y_2\}$ and $y\not=z$). Note that under
  this condition, the LTR direction of the principle would be enough,
  since the RTL direction is just an instance of the LTR direction.

  Among the remaining cases, it is clear that $\t{y:x}\t{y_2:z}A
  \leftrightarrow \t{y:z}\t{y_2:x}A$ is generally invalid if the two
  bound variable $x$ and $z$ are the same, since the second quantifier
  would trump the first concerning the interpretation of $x/z$. The
  only exceptions are if $y=y_2$, or either $y=x$ or $y_2=x$. In the
  first case, the two sides of the biconditional are identical, so the
  principle is an instance of \T{Taut}. In the second two cases, one
  of the two substitution terms is the trivial substitution $\t{x:x}$,
  which does indeed commute with everything.

  This leaves the case where the bound variable in one term is
  identical to the unbound variable in the other term, as in
  $\t{y:x}\t{x:z}$ or $\t{z:x}\t{y_2:z}$. Clearly, we cannot go from
  $\t{y:x}\t{x:z}A$ (which says that $A$ holds if $x$ and $z$ are
  mapped to $y$) to $\t{x:z}\t{y:x}A$ (which says that $A$ holds if
  $x$ is mapped to $y$ but $z$ is mapped to the original $x$), unless
  $x=y$. Nor can we go in the other direction from $\t{x:z}\t{y:x}A$
  (which is of the form $\t{z:x}\t{y_2:z}A$) to $\t{y:x}\t{x:z}A$
  unless $x=y$. In the special case where $x=y$, one of the two
  substitution terms becomes trivial; the two directions reduce to
  $\t{x:x}\t{x:z}A \leftrightarrow \t{x:z}\t{x:x}A$.

  Here then is the necessary and sufficient proviso for
  $\t{y:x}\t{y_2:z}A \then \t{y_2:z}\t{y:x}A$ to be valid:
  \begin{compactenum}
  \item[(i)] $x\not=z$ (unless $y=y_2$, in which case the principle is
    a tautology, or $y=z$ or $y_2=z$, in which case one of the two
    substitution terms is trivial), and
  \item[(ii)] $y_2\not=x$ (unless $y_2=x=y$, in which case the first
    substitution term on the left is trivial), and
  \item[(iii)] $y\not=z$ (unless $y=z=y_2$, in which case the other
    substitution term is trivial).
  \end{compactenum}
  Unsurprisingly, these conditions are symmetrical: if they are
  fulfilled for $\t{y:x}\t{y_2:z}A \then \t{y_2:z}\t{y:x}A$, then they
  are also fulfilled for its converse.

  Ignoring the parentheses, we are back to the sufficient condition
  above: $z\not\in\{x,y\}$ and $y_2\not=x$ (equivalently: $x\not\in
  \{z,y_2\}$ and $y\not=z$).

  However, this principle can't be enough. In our language, free
  variables can occur at two places: as predicate arguments in atomic
  formulas, or in the first position of a substitution
  operator. \T{SA} tells us that $\t{y:x}$ behaves like substitution
  on atomic formulas. We need something that tells us it behaves like
  this also on free variables in substitution operators. 

  So now consider $\t{x:z}A$ as analogous to $Fx$. We want to say that
  $\t{y:x}\t{x:z}A$ says the same things as $\t{y:z}A$ -- or rather,
  because $x$ may still occur freely in $A$, as
  $\t{y:z}\t{y:x}A$. This amounts to a special kind of substitution
  commutation, with exchange of free variables: $\t{y:x}\t{y_2:z}A
  \leftrightarrow \t{[y/x]y_2:z}\t{y:x}A$. This is an asymmetrical
  principle, so we might regard it as two principles, one from LTR,
  the other from RTL. If $y_2\not=x$, then the two directions
  coincide, and we're back to the simple commutation principle
  above. Hence the version with substitution entails the simple
  commutation version. -- Recall that $y_2\not=x$ was one of the
  preconditions for the simple commutation principle, so our new
  principle merely adds something to the old one that covers this
  previously excluded case. (Strictly speaking, the precondition was
  that $y_2\not=x$ unless $y_2=x=y$; if $y_2=x=y$, then $[y/x]y_2 =
  y_2$, so the new version won't contradict the old one here.)

  We still need something like provisos (i) and (iii). If the two
  bound variables $x$ and $z$ are the same, we get $\t{y:x}\t{y_2:x}A
  \leftrightarrow \t{[y/x]y_2:x}\t{y:x}A$. The antecedent says that
  $A$ is true if $x$ is mapped to $[y/x]y_2$ (i.e. to $y$ if $y_2=x$,
  else to $y_2$). The consequent says that $A$ is true if $x$ is
  mapped to $[[y/x]y_2/x]y$ (i.e. to $y$ if $y=x$ and $y_2=x$, or to
  $y_2$ if $y=x$ and $y_2\not=x$, or else to $y$ if $y\not=x$ -- more
  simply: to $y_2$ if $y=x$, else to $y$). The two are equivalent iff
  $[y/x]y_2 = [[y/x]y_2/x]y$, i.e. iff $(y_2\!=\!x \;?\; y : y_2) =
  (y\!=\!x \;?\; y_2 : y)$, i.e. iff either $y_2=x$ and $y=x$ (and,
  trivially, $y=y_2$), or $y_2=x$ and $y\not=x$ (and $y_2 = y_2$), or
  $y_2\not=x$ and $y=x$ (and $y_2=y_2$), or $y_2\not=x$ and $y\not=x$
  and $y_2=y$, i.e. iff $y_2=x$ or $y_2=y$ or $x=y$. These three cases
  are, respectively, $\t{y:x}\t{x:x}A \leftrightarrow
  \t{y:x}\t{y:x}A$, $\t{y:x}\t{y:x}A \leftrightarrow \t{y:x}\t{y:x}A$,
  and $\t{x:x}\t{y_2:x}A \leftrightarrow \t{y_2:x}\t{x:x}A$.

  As to cases where the bound variable in one term is identical to the
  unbound variable in the other term, we have several cases, depending
  on whether we look at the terms on the left or on the right. The
  first case is where $x=y_2$. We then have $\t{y:x}\t{x:z}A
  \leftrightarrow \t{[y/x]x:z}\t{y:x}A$. Both sides say that $A$ is
  true if $x$ and $z$ are mapped to $y$, so this is now valid. The
  next case is where $y=z$. We then have $\t{y:x}\t{y_2:y}A
  \leftrightarrow \t{[y/x]y_2:y}\t{y:x}A$. The left-hand side says
  that $A$ is true if $y$ is mapped to $[y/x]y_2$ and $x$ to the
  original $y$ (unless $x=y$). The right-hand side says that $A$ is
  true if $x$ and $y$ are mapped to $[y/x]y_2$. The two coincide iff
  $y=[y/x]y_2$, i.e. iff $y_2=y$ or $y_2=x$. So we note: if $y=z$,
  then $y_2=y$ or $y_2=x$. Finally, there's the case where $[y/x]y_2 =
  x$. Then $y_2=x=y$. This is a subtype of the first case above.

  So here's the complete proviso for \T{SS}:
  \begin{compactenum}
  \item[(i)] $x\not=z$ (unless $y_2=y$, in which case the principle is
    a tautology, or $y_2=x$, in which case it says that
    $\t{y:x}\t{x:x}A \leftrightarrow \t{y:x}\t{y:x}A$, or $x=y$, in
    which case it says that $\t{x:x}\t{y_2:x}A \leftrightarrow
    \t{y_2:x}\t{x:x}A$), and
  \item[(ii)] $y\not=z$ (unless $y_2=y$, in which case the principle
    says that $\t{y:x}\t{y:y}A \leftrightarrow \t{y:y}\t{y:x}A$, or
    $y_2=x$, in which case it says that $\t{y:x}\t{x:y}A
    \leftrightarrow \t{y:y}\t{y:x}A$).
  \end{compactenum}
  Ignoring the parentheses, we have $z\not\in\{x,y\}$. (This is
  asymmetrical, because the principle itself is asymmetrical.) But
  some of the parenthetical cases have to be added, as we'll see
  later. Note that the two parenthetical cases in (ii) also occur in
  (i). So we can pull them out:
  \begin{compactenum}
  \item $z\not\in\{x,y\}$, \emph{or}
  \item $y_2\in\{x,y\}$, \emph{or}
  \item $z=x=y$.
  \end{compactenum}
  Equivalently,
  \begin{compactenum}
  \item $z\not\in\{x,y\}$, \emph{or}
  \item $y_2\in \{x,z\}$, \emph{or}
  \item $z=x=y$.
  \end{compactenum}

}


Substitution does not commute with the box. Roughly speaking, this is
because $\t{y:x}\Box A(x,y)$ says that at all accessible worlds, all
counterparts $x'$ and $y'$ of $y$ are $A(x',y')$, while $\Box
\t{y:x}A(x,y)$ says that at all accessible worlds, every counterpart
$x'=y'$ of $y$ is such that $A(x',y')$. In the first case, $x'$ and
$y'$ may be different counterparts of $y$, while in the second case,
they must be the same. Thus $\t{y:x}\Box A$ entails $\Box \t{y:x}A$,
but the other direction holds only if either $y$ does not have
multiple counterparts at accessible worlds (relative to the same
counterpart relation), or at most one of $x$ and $y$ occurs freely in
$A$ (including the special case where $x$ and $y$ are the same
variable).
\begin{semantics}
  \itemT{S\Box} $\t{y:x}\Box A \then \Box \t{y:x}A$,
  \itemT{S\Diamond} $\t{y:x}\Diamond A \then \Diamond\t{y:x}A$,
    provided at most one of $x,y$ is free in $A$.
\end{semantics}

These principles largely make \T{SC1} and \T{SC2} redundant. We only
need to add the special case for substituting free variables in atomic
formulas and in substitution operators, as well as a principle for
vacuous substitutions:
\begin{semantics}
  \itemT{SAt} $\t{y:x}P x_1\ldots x_n \leftrightarrow P[y/x]x_1\ldots[y/x]x_n$.
  \itemT{SS2} $\t{y:x}\t{x:z}A \leftrightarrow \t{y:z}\t{y:x}A$.
  \itemT{VS} $A \leftrightarrow \t{y:x}A$, provided $x$ is not free in $A$.
\end{semantics}

\cmnt{
  Apart from the box axiom, my axioms are also valid for lambda
  substitution, but their necessitation isn't.
}  

\begin{lemma}[Soundness of the substitution axioms]\label{soundness-sub}
  If $\Sc{L}_s$ is a language of quantified modal logic with
  substitution, then every $\Sc{L}_s$-instance of \T{S\neg},
  \T{S\!\then}, \T{S\forall}, \T{SS1}, \T{S\Box}, \T{S\Diamond},
  \T{SAt}, \T{SS2}, and \T{VS} is valid in every (positive or negative)
  counterpart model.
\end{lemma}

\begin{proof}
  \quad

  \begin{enumerate}
  \item \T{S\neg}.\; $w,V \SAT \t{y:x}\neg A$ iff $w,V^{[y/x]} \SAT
    \neg A$ by definition \ref{!SATG}, iff $w,V^{[y/x]} \not\SAT A$ by
    definition \ref{!SAT}, iff $w,V \not\SAT \t{y:x}A$ by definition
    \ref{!SATG}, iff $w,V \SAT \neg\t{y:x}A$ by definition \ref{!SAT}.

  \item \T{S\!\then}.\; $w,V \SAT \t{y:x}(A\then B)$ iff $w,V^{[y/x]}
    \SAT A\then B$ by definition \ref{!SATG}, iff $w,V^{[y/x]}
    \not\SAT A$ or $w,V^{[y/x]} \SAT B$ by definition \ref{!SAT}, iff
    $w,V \not\SAT \t{y:x}A$ or $w,V \SAT \t{y:x}B$ by definition
    \ref{!SATG}, iff $w,V \SAT \t{y:x}A \then \t{y:x}B$ by definition
    \ref{!SAT}.

  \item \T{S\forall}.\; Assume $z \not\in \{x,y\}$. Then the
    existential $z$-variants $V'$ of $V^{[y/x]}$ on $w$ coincide at
    $w$ with the functions $(V^*)^{[y/x]}$ where $V^*$ is an
    existential $z$-variant $V^*$ of $V$ on $w$. And so $w,V \SAT
    \t{y:x}\forall z A$ iff $w,V^{[y/x]} \SAT \forall z A$ by
    definition \ref{!SATG}, iff $w,V' \SAT A$ for all existential
    $z$-variants $V'$ of $V^{[y/x]}$ on $w$ by definition \ref{!SAT},
    iff $w,(V^*)^{[y/x]} \SAT A$ for all existential $z$-variants
    $V^*$ of $V$ on $w$, iff $w,V^* \SAT \t{y:x} A$ for all
    existential $z$-variants $V^*$ of $V$ on $w$ by definition
    \ref{!SATG}, iff $w,V \SAT \forall z \t{y:x} A$ by definition
    \ref{!SAT}. 

  \item \T{SS1}.\; Assume $z \not\in \{x,y\}$ and $y_2\not=x$. Then
    the function $[y/x]\cdot [y_2/z]$ is identical to the function
    $[y_2/z]\cdot [y/x]$. So $w,V \SAT \t{y:x}\t{y_2:z} A$ iff
    $w,V^{[y/x] \cdot [y_2/z]} \SAT A$ by definition \ref{!SATG}, iff
    $w,V^{[y_2/z]\cdot [y/x]} \SAT A$, iff $w,V \SAT
    \t{y_2:z} \t{y:x} A$ by definition \ref{!SATG}.

  \item \T{S\Box}.\; Assume $w,V \not\SAT \Box \t{y:x} A$.  By
    definitions \ref{!SAT} and \ref{!SATG}, this means that
    $w',V^{\prime [y/x]} \not\SAT A$ for some $w',V'$ such that $wRw'$
    and $V_w\Img V'_{w'}$, i.e.\ there is a $C\in K_{w,w'}$ for which
    $V'_{w'}$ assigns to every variable $z$ a $C$-counterpart of its
    value under $V_w$ (or nothing if there is none). Then for all $z$,
    $V^{\prime[y/x]}_{w'}(z)$ is a $C$-counterpart of $V^{[y/x]}_w(z)$
    (or undefined if there is none), since $V^{\prime [y/x]}_{w'}(x) =
    V'_{w'}(y)$ is a $C$-counterpart of $V_w(y) = V^{[y/x]}_w(x)$ (or
    undefined if there is none). So $V^{[y/x]}_w\Img V_{w'}^{\prime
      [y/x]}$. And so $w',V^* \not\SAT A$ for some $w',V^*$ such that
    $wRw'$ and $V^{[y/x]}_w \Img V^*_{w'}$. So $w,V \SAT \t{y:x}\Box
    A$ by definitions \ref{!SAT} and \ref{!SATG}.

  \item \T{S\Diamond}.\; Assume $w,V \SAT \t{y:x}\Diamond A$ and at
    most one of $x,y$ is free in $A$. By definitions \ref{!SAT} and
    \ref{!SATG}, $w',V^* \SAT A$ for some $w',V^*$ such that $wRw'$
    and $V_w^{[y/x]} \Img V^*_{w'}$, i.e. there is a $C\in K_{w,w'}$
    for which $V^*_{w'}$ assigns to every variable $z$ a
    $C$-counterpart of its value under $V_w$ (or nothing if there is
    none). We have to show that there is a $w'$-image $V'$ of $V$ at
    $w$ such that $w,V^{\prime [y/x]} \SAT A$, since then $w,V \SAT
    \Diamond \t{y:x}A$.

    If $x$ is the same variable as $y$, then $V^*_{w'}(x) =
    V^*_{w'}(y)$ is a $C$-counterpart at $w'$ of $V^{[y/x]}_w(x) =
    V^{[y/x]}_w(y) = V_w(x) = V_w(y)$ at $w$ (or undefined if there is
    none), so we can choose $V^*$ itself as $V'$. We then have
    $w,V^{\prime[y/x]} \SAT A$ because $V^{\prime[y/x]} = V'$.

    Else if $x$ is not free in $A$, let $V'$ be some $x$-variant of
    $V^*$ at $w'$ such that $V^*_{w'}(x)$ is some $C$-counterpart at
    $w'$ of $V_w(x)$ at $w$ (or undefined if there is none).  Since
    $V^*_{w'}(y)$ is a $C$-counterpart at $w'$ of $V^{[y/x]}_w(y) =
    V_w(y)$ at $w$ (or undefined if there is none), $V'$ is a
    $w'$-image of $V$ at $w$. Moreover, $V^{\prime [y/x]}$ and $V^*$
    agree at $w'$ about all variables other than $x$; so by the
    coincidence lemma \ref{coincidence}, $w',V^{\prime [y/x]} \SAT A$.

    Else if $y$ is not free in $A$, let $V'$ be like $V^*$ except that
    $V'_{w'}(y) = V^*_{w'}(x)$ and $V'_{w'}(x)$ is some $C$-counterpart at
    $w'$ of $V_w(x)$ at $w$ (or undefined if there is none). Since
    $V'_{w'}(y) = V^*_{w'}(x)$ is a $C$-counterpart at $w'$ of
    $V^{[y/x]}_w(x) = V_w(y)$ at $w$ (or undefined if there is none),
    $V'$ is a $w'$-image of $V$ at $w$. Moreover, $V^{\prime [y/x]}$
    and $V^*$ agree at $w'$ about all variables other than $y$; in
    particular, $V^{\prime [y/x]}_{w'}(x) = V'_{w'}(y) =
    V^*_{w'}(x)$. So by the coincidence lemma \ref{coincidence},
    $w',V^{\prime [y/x]} \SAT A$.

  \item \T{SAt}.\; $w,V \SAT \t{y:x}P x_1\ldots x_n$ iff $w,V^{[y/x]}
    \SAT Px_1\ldots x_n$ by definition \ref{!SATG}, iff $w,V \SAT
    [y/x]Px_1\ldots x_n$ by lemma \ref{rsl}.

  \item \T{SS2}.\; $w,V \SAT \t{y:x}\t{x:z} A$ iff $w,V^{[y/x] \cdot
      [x/z]} \SAT A$ by definition \ref{!SATG}, iff $w,V^{[y/z]\cdot
      [y/x]} \SAT A$ because $[y/x]\cdot [x/z] = [y/z]\cdot [y/x]$,
    iff $w,V \SAT \t{y:z} \t{y:x} A$ by definition \ref{!SATG}.

  \item \T{VS}.\; By definition \ref{!SATG}, $w,V \SAT \t{y:x}A$ iff
    $w,V^{[y/x]} \SAT A$. If $x$ is not free in $A$, then $V^{[y/x]}$
    agrees with $V$ at $w$ about all free variables in $A$. So by the
    coincidence lemma \ref{coincidence}, $w,V^{[y/x]} \SAT A$ iff $w,V
    \SAT A$. So then $w,V \SAT \t{y:x}A$ iff $w,V \SAT A$. \qed

  \end{enumerate}
\end{proof}

\begin{definition}[Positive logics with substitution]
  Given a language $\Sc{L}_s$ with substitution, a \emph{positive
    (quantified modal) logic with substitution} in $\Sc{L}_s$ is a set
  of formulas $L \subseteq \Sc{L}_s$ that contains all
  $\Sc{L}_s$-instances of the substitution axioms \T{S\neg},
  \T{S\!\then}, \T{S\forall}, \T{SS1}, \T{S\Box}, \T{S\Diamond},
  \T{SAt}, \T{SS2}, \T{VS}, as well as \T{Taut}, \T{UD}, \T{VQ},
  \T{\forall Ex}, \T{=\!R}, \T{K},
  \begin{semantics}
    \itemT{FUI_s} $\forall x A \then (Ey \then \t{y:x}A)$,
    \itemT{LL_s} $x\!=\!y \then (A \then \t{y:x}A)$,
  \end{semantics}
  and that is closed under \T{MP}, \T{UG}, \T{Nec} and 
  \begin{semantics}
    \itemT{Sub_s} if $\vdash_L A$, then $\vdash_L \t{y:x}A$.
  \end{semantics}
  Let the smallest such logic be called $\s{P}_s$.
\end{definition}

\begin{definition}[Negative logics with substitution]
  Given a language $\Sc{L}_s$ with substitution, a \emph{negative
    (quantified modal) logic with substitution} in $\Sc{L}_s$ is a set
  $L \subseteq \Sc{L}_s$ that contains all $\Sc{L}_s$-instances of the
  substitution axioms \T{S\neg}, \T{S\!\then}, \T{S\forall}, \T{SS1},
  \T{S\Box}, \T{S\Diamond}, \T{SAt}, \T{SS2}, \T{VS}, as well as
  \T{Taut}, \T{UD}, \T{VQ}, \T{Neg}, \T{NA}, \T{\forall\!=\!R}, \T{K},
  \T{FUI_s}, \T{LL_s}, and that is closed under \T{MP}, \T{UG},
  \T{Nec} and \T{Sub_s}. Let the smallest such logic be called $\s{N}_s$.
\end{definition}

\begin{theorem}[Soundness of $\s{P}_s$]\label{soundness-Ps}
  Every member of $\s{P}_s$ is valid in every positive counterpart
  model.
\end{theorem}

\begin{proof}
  We have to show that all $\s{P}_s$ axioms are valid in every model,
  and that validity is closed under \T{MP}, \T{UG}, \T{Nec} and
  \T{Sub_s}. For \T{Taut}, \T{UD}, \T{VQ}, \T{\forall Ex}, \T{=\!R},
  \T{K}, \T{MP}, \T{UG}, \T{Nec}, see the proof of theorem
  \ref{soundness-P}. For the substitution axioms, see lemma
  \ref{soundness-sub}. The remaining cases are \T{FUI_s}, \T{LL_s},
  and \T{Sub_s}.

  \begin{enumerate}

  \item \T{FUI_s}.\; Assume $w,V \SAT \forall x A$ and $w,V \SAT Ey$
    in some model. By definition \ref{!SAT}, the latter means that
    $V_w(y) \in D_w$, and the former means that $w,V' \SAT A$ for all
    existential $x$-variants $V'$ of $V$ on $w$. So in particular,
    $w,V' \SAT A$, where $V'$ is the $x$-variant of $V$ on $w$ with
    $V_w(x)=V_w(y)$. So $w,V \SAT \t{y:x}A$ by definition \ref{!SATG}.

  \item \T{LL_s}.\; Assume $w,V \SAT x\!=\!y$ and $w,V \SAT A$. By
    definitions \ref{!SAT} and \ref{!INT}, then $V_w(x) = V_w(y)$. So
    $w,V \SAT \t{y:x}A$ by definition \ref{!SATG}.

  \item \T{Sub_s}.\; Assume $w,V \not\SAT \t{y:x} A$ in some model
    $\Fr{M} = \t{\Fr{S},V}$. By definition \ref{!SATG}, then $w, V'
    \not\SAT A$, where $V'$ is the $x$-variant of $V$ on $w$ with
    $V'(x)=V(y)$. So $A$ is invalid in the model $\t{\Fr{S},
      V'}$. Hence if $A$ is valid in all positive models, then so is
    $\t{y:x}A$. \qed

  \end{enumerate}
\end{proof}

\begin{theorem}[Soundness of $\s{N}_s$]\label{soundness-Ns}
  Every member of $\s{N}_s$ is valid in every negative counterpart
  model.
\end{theorem}

\begin{proof}
  All the cases needed here are covered in the proofs of theorem
  \ref{soundness-N} and \ref{soundness-Ps}. \qed
\end{proof}

To derive some further properties of these systems, let $\Sc{L}$ range
over languages of quantified modal logic with substitution, and $L$
over positive or negative logics in $\Sc{L}$.

Closure under propositional consequence and the validity of \T{\forall
  Ex} and \T{\forall\!=\!R} are proved just as for substitution-free
logics (see lemmas \ref{pc} and \ref{redax}). So we move on
immediately to more interesting properties.

\begin{lemma}[Substitution expansion]
  If $A$ is an $\Sc{L}$-formula and $x,y,z$ $\Sc{L}$-variables,
  then
  \begin{semantics}
    \itemT{SE1} $\vdash_{L} A \leftrightarrow \t{x:x}A$;
    \itemT{SE2} $\vdash_{L} \t{y:x}A \leftrightarrow \t{y:z}\t{z:x}A$, provided
                $z$ is not free in $A$.
  \end{semantics}
\end{lemma}

\begin{proof} \T{SE1} is proved by induction on $A$.

  \begin{enumerate}

  \item $A$ is atomic.\; Then $\vdash_L \t{x:x}A \leftrightarrow
    [x/x]A$ by \T{SAt}, and so $\vdash_L \t{x:x}A \leftrightarrow A$
    because $[x/x]A = A$.

  \item $A$ is $\neg B$.\; By induction hypothesis, $\vdash_L B
    \leftrightarrow \t{x:x}B$. So by \T{PC}, $\vdash_L \neg B
    \leftrightarrow \neg \t{x:x}B$. And by $\t{S\neg}$, $\vdash_L
    \t{x:x}\neg B \leftrightarrow \neg \t{x:x}B$.

  \item $A$ is $B \then C$. By induction hypothesis, $\vdash_L B
    \leftrightarrow \t{x:x}B$ and $\vdash_L C \leftrightarrow
    \t{x:x}C$. So $\vdash_L (B\then C) \leftrightarrow (\t{x:x}B \then
    \t{x:x}C)$. And by $\t{S\!\then}$, $\vdash_L \t{x:x}(B\then C)
    \leftrightarrow (\t{x:x}B \then \t{x:x}C)$.

  \item $A$ is $\forall z B$.\; If $z=x$, then $\vdash_L \forall x B
    \leftrightarrow \t{x:x} \forall x B$ by \T{VS}. If $z\not=x$, then
    by induction hypothesis, $\vdash_L B \leftrightarrow \t{x:x}B$; by
    \T{UG} and \T{UD}, $\vdash_L \forall z B \leftrightarrow \forall z
    \t{x:x}B$; and $\vdash_L \t{x:x}\forall z B \leftrightarrow
    \forall z \t{x:x}B$ by \T{S\forall}.

  \item $A$ is $\t{y:z}B$.\; If $z=x$, then $\vdash_L \t{y:x}B
    \leftrightarrow \t{x:x} \t{y:x}B$ by \T{VS}. If $z\not=x$, then
    by induction hypothesis, $\vdash_L B \leftrightarrow \t{x:x}B$; by
    \T{Sub_s} and \T{S\!\then}, $\vdash_L \t{y:z} B \leftrightarrow \t{y:z}
    \t{x:x}B$; and $\vdash_L \t{x:x}\t{y:z} B \leftrightarrow
    \t{y:z}\t{x:x}B$ by \T{SS1} (if $y\not=x$) or \T{SS2} (if $y=x$).

  \item $A$ is $\Box B$.\; By \T{S\Box}, $\vdash_L \t{x:x}\Box B \then
    \Box \t{x:x}B$. Conversely, since at most one of $x,x$ is free in
    $\neg B$, by \T{S\Diamond}, $\vdash_L \t{x:x}\Diamond \neg B \then
    \Diamond \t{x:x} \neg B$.  Contraposing and unraveling the
    definition of the diamond, we have $\vdash_L \Box \neg \t{x:x}\neg
    B \then \neg\t{x:x}\neg\Box \neg\neg B$. Since $\vdash_L \Box \neg
    \t{x:x}\neg B \leftrightarrow \Box \t{x:x}B$ and $\vdash_L
    \neg\t{x:x}\neg\Box \neg\neg B \leftrightarrow \t{x:x}B$ (by
    \T{S\neg}, \T{Sub_s}, \T{S\!\then}, \T{Nec} and \T{K}), this means
    that $\vdash_L \Box \t{x:x}B \then \t{x:x}\Box B$.
  \end{enumerate}
  
  As for \T{SE2}: by \T{VQ}, $\vdash_L \t{y:x}A \leftrightarrow
  \t{y:z}\t{y:x}A.$ And $\vdash_L \t{y:x}\t{y:z}A \leftrightarrow
  \t{y:z}\t{y:x}A$ by \T{SS1} (if $y\not=x$) or \T{SS2} (if
  $y=x$). Moreover, by \T{SS2}, $\vdash_L \t{y:z}\t{z:x}A
  \leftrightarrow \t{y:x}\t{y:z}A$. So by \T{PC}, $\vdash_L \t{y:x}A
  \leftrightarrow \t{y:z}\t{z:x}A$. \qed

\end{proof}

\begin{lemma}[Substituting bound variables]
  For any \Sc{L}-sentence $A$ and variables $x,y$,
  \begin{semantics}
    \itemT{SBV} $\vdash_L \forall x A \leftrightarrow \forall y \t{y:x}A$,
    provided $y$ is not free in $A$.
  \end{semantics}
\end{lemma}
\begin{proof}
  \begin{alignat*}{2}
  1.\quad& \vdash_L \forall y\t{y:x}A \then Ex \then \t{x:y}\t{y:x}A. &\quad&\text{\T{FUI_s}}\\
  2.\quad& \vdash_L \t{x:y}\t{y:x}A \leftrightarrow A. &&\text{(\T{SE1}, \T{SE2})}\\
  3.\quad& \vdash_L \forall x\forall y \t{y:x}A \then \forall x Ex \then \forall x A.
    &&\text{(1, 2, \T{UG}, \T{UD})}\\
  4.\quad& \vdash_L \forall x\forall y \t{y:x}A \then \forall x A.
    &&\text{(3, \T{\forall Ex})}\\
  5.\quad& \vdash_L \forall y\t{y:x}A \then \forall x \forall y \t{y:x}A. &&\text{\T{VQ}}\\
  6.\quad& \vdash_L \forall y\t{y:x}A \then \forall x A. &&\text{(4, 5)}\\
  7.\quad& \vdash_L \forall x A \then Ey \then \t{y:x}A. &&\text{\T{FUI_s}}\\
  8.\quad& \vdash_L \forall y\forall x A \then \forall y \t{y:x}A.
    &&\text{(7, \T{UG}, \T{UD}, \T{\forall Ex})}\\
  9.\quad& \vdash_L \forall x A \then \forall y \forall x A. 
    &&\text{(\T{VQ}, $y$ not free in $A$)}\\
  10.\quad& \vdash_L \forall x A \then \forall y \t{y:x}A. &&\text{(8, 9)}\\
  11.\quad& \vdash_L \forall x A \leftrightarrow \forall y \t{y:x}A. &&\text{(6, 10)}
  \end{alignat*}
  \qed
\end{proof}
 
\begin{lemma}[Substituting empty variables]
  For any \Sc{L}-sentence $A$ and variables $x,y$,
  \begin{semantics}
    \itemT{SEV} $\vdash_L x\!\not=\!x \land y\!\not=\!y 
                   \then (A \leftrightarrow \t{y:x}A)$.
  \end{semantics}
\end{lemma}

\begin{proof}
  \T{SEV} is trivial if $L$ is positive, in which case $\vdash_L
  x\!=\!x$. For negative $L$, it is proved by induction on $A$.
  \begin{enumerate}
  \item $A$ is atomic.\; If $x \not\in \var(A)$, then $\vdash_L A
    \leftrightarrow \t{y:x} A$ by \T{VS}, and so $\vdash_L x\!\not=\!x
    \land y\!\not=\!y \then (A \leftrightarrow \t{y:x}A)$ by
    \T{PC}. If $x \in \var(A)$, then by \T{Neg}
    \begin{equation}\tag{1}
      \vdash_L x\!\not=x \land y\!\not=\!y \then \neg A.
    \end{equation}
    Also by \T{Neg}, $\vdash_L x\!\not=\!x \land y\!\not=\!y \then
    \neg [y/x]A$. By \T{SAt}, $\vdash_L [y/x]A \leftrightarrow
    \t{y:x}A$, and so $\vdash_L \neg [y/x] A \leftrightarrow \neg
    \t{y:x} A$. So
    \begin{equation}\tag{2}
      \vdash_L x\!\not=\!x \land y\!\not=\!y \then \neg \t{y:x}A.
    \end{equation}
    Combining (1) and (2) yields $\vdash_L x\!\not=\!x \land
    y\!\not=\!y \then (A \leftrightarrow \t{y:x}A)$.

  \item $A$ is $\neg B$.\; By induction hypothesis, $\vdash_L
    x\!\not=\!x \land y\!\not=\!y \then (B \leftrightarrow \t{y:x}B)$.
    So by \T{PC}, $\vdash_L x\!\not=\!x \land y\!\not=\!y \then (\neg
    B \leftrightarrow \neg \t{y:x}B)$, and by \T{S\neg}, $\vdash_L
    x\!\not=\!x \land y\!\not=\!y \then (\neg B \leftrightarrow
    \t{y:x}\neg B)$.

  \item $A$ is $B \then C$.\; By induction hypothesis, $\vdash_L
    x\!\not=\!x \land y\!\not=\!y \then (B \leftrightarrow \t{y:x}B)$
    and $\vdash_L x\!\not=\!x \land y\!\not=\!y \then (C
    \leftrightarrow \t{y:x}C)$. So by \T{PC}, $\vdash_L x\!\not=\!x
    \land y\!\not=\!y \then ((B \then C) \leftrightarrow (\t{y:x}B
    \then \t{y:x}C))$, and by \T{S\!\then}, $\vdash_L x\!\not=\!x
    \land y\!\not=\!y \then ((B \then C) \leftrightarrow \t{y:x}(B
    \then C))$.

  \item $A$ is $\forall z B$.\; We distinguish three cases.
    \begin{enumerate}
    \item $z \not\in \{x,y\}$.\; Then
      % \setlength{\mathindent}{0.3\leftmargini}
      \begin{alignat*}{2}
        1.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (B \leftrightarrow \t{y:x}B) &\quad&\text{(ind.~hyp.)}\\
        2.\quad& \vdash_L \forall z\, x\!\not=\!x \land \forall z\,
        y\!\not=\!y \then
        (\forall z B \leftrightarrow \forall z \t{y:x}B) &&\text{(1, UG, UD)}\\
        3.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\forall z B \leftrightarrow \forall z \t{y:x}B) &&\text{(2, VQ)}\\
        4.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\forall z B \leftrightarrow \t{y:x}\forall z B). 
        &&\text{(3, \T{S\forall})}
      \end{alignat*}
    \item $z=x$.\; Then $A$ is $\forall x B$, and $\vdash_L \forall x
      B \leftrightarrow \t{y:x}\forall x B$ by \T{VS}. So
      $\vdash_L x\!\not=\!x \land y\!\not=\!y \then (\forall x B
      \leftrightarrow \t{y:x}\forall x B)$ by \T{PC}.
    \item $z=y\not=x$.\; Then $A$ is $\forall y B$. Let $v$ be a
      variable not in $\var(A),x,y$.
      \begin{alignat*}{2}
        1.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then
          (B \leftrightarrow \t{v:x}B). &\quad&\text{(ind.~hyp.)}\\
        2.\quad& \vdash_L \forall y x\!\not=\!x \land \forall y
          v\!\not=\!v \then (\forall y B \leftrightarrow \forall y \t{v:x}B).
          &&\text{(1, UG, UD)}\\
        3.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then 
          (\forall y B \leftrightarrow \forall y \t{v:x}B).
          &&\text{(2, VQ)}\\
        4.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then 
          (\forall y B \leftrightarrow \t{v:x}\forall y B).
          &&\text{(3, \T{S\forall})}\\
        5.\quad& \vdash_L \t{y:v}x\!\not=\!x \land \t{y:v}v\!\not=\!v \then 
          (\t{y:v}\forall y B \leftrightarrow \t{y:v}\t{v:x}\forall y B).
          &&\text{(4, \T{Sub_s}, \T{S\!\then})}\\
        6.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then 
          (\t{y:v}\forall y B \leftrightarrow \t{y:v}\t{v:x}\forall y B).
          &&\text{(5, \T{VS}, \T{SAt})}\\
        7.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then 
          (\forall y B \leftrightarrow \t{y:v}\t{v:x}\forall y B).
          &&\text{(6, \T{VS})}\\
        8.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then 
          (\forall y B \leftrightarrow \t{y:x}\forall y B).
          &&\text{(7, \T{SE2})}
      \end{alignat*}
    \end{enumerate}

  \item $A$ is $\t{y_2:z} B$.\; We have four cases.
    \begin{enumerate}
    \item $z \not\in \{x,y\}$ and $y_2 \not= x$.\; Then
      % \setlength{\mathindent}{0.3\leftmargini}
      \begin{alignat*}{2}
        1.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (B \leftrightarrow \t{y:x}B) &\quad&\text{(ind.~hyp.)}\\
        2.\quad& \vdash_L \t{y_2:z} x\!\not=\!x \land \t{y_2:z}
        y\!\not=\!y \then (\t{y_2:z} B \leftrightarrow \t{y_2:z} \t{y:x}B)
        &&\text{(1, \T{Sub_s}, \T{S\!\then})}\\
        3.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{y_2:z} B \leftrightarrow \t{y_2:z} \t{y:x}B) &&\text{(2, \T{VS})}\\
        4.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{y_2:z} B \leftrightarrow \t{y:x}\t{y_2:z} B). 
        &&\text{(3, \T{SS1})}
      \end{alignat*}
    \item $z\not=x$ and $y_2=x$.\; Then $A$ is $\t{x:z}B$. \cmnt{(This
        case is surprisingly tough.)}
      \begin{alignat*}{2}
        1.\quad& \vdash_L x\!\not=\!x \land z\!\not=\!z \then (B
        \leftrightarrow \t{x:z}B) &\quad&\text{(ind.~hyp.)}\\
        2.\quad& \vdash_L \t{y:z}x\!\not=\!x \land \t{y:z}z\!\not=\!z
        \then (\t{y:z}B \leftrightarrow \t{y:z}\t{x:z}B)
        &&\text{(1, \T{Sub_s}, \T{S\!\then})}\\
        3.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{y:z}B \leftrightarrow \t{y:z}\t{x:z}B) &&\text{(2,
          \T{SAt}, $z\not=x$)}\\
        4.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{y:z}B \leftrightarrow \t{x:z}B) &&\text{(3, \T{VS}, $z\not=x$)}\\
        5.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (B \leftrightarrow \t{y:x}B) &&\text{(ind.~hyp.)}\\
        6.\quad& \vdash_L \t{y:z}x\!\not=\!x \land \t{y:z}y\!\not=\!y
        \then (\t{y:z}B \leftrightarrow \t{y:z}\t{y:x}B)
        &&\text{(5, \T{Sub_s},\T{S\!\then})}\\
        7.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{y:z}B \leftrightarrow \t{y:z}\t{y:x}B)
        &&\text{(6, \T{SAt}, $z \not=x$)}\\
        8.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{x:z}B \leftrightarrow \t{y:z}\t{y:x}B)
        &&\text{(4, 7)}\\
        9.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
        (\t{x:z}B \leftrightarrow \t{y:x}\t{x:z}B).  &&\text{(8,
          \T{SS2})}
      \end{alignat*}
    \item $z=x$.\; Then $A$ is $\t{y_2:x} B$, and $\vdash_L \t{y_2:x}
      B \leftrightarrow \t{y:x}\t{y_2:x} B$ by \T{VS}. So
      $\vdash_L x\!\not=\!x \land y\!\not=\!y \then (\t{y_2:x} B
      \leftrightarrow \t{y:x}\t{y_2:x} B)$ by \T{PC}.
    \item $z=y\not=x$ and $y_2\not=x$.\; Then $A$ is $\t{y_2:y}
      B$. Let $v$ be a variable not in $\var(A),x,y,y_2$.
      \begin{alignat*}{2}
        1.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then
          (B \leftrightarrow \t{v:x}B). &\quad&\text{(ind.~hyp.)}\\
        2.\quad& \vdash_L \t{y_2:y} x\!\not=\!x \land \t{y_2:y}
          v\!\not=\!v \then (\t{y_2:y} B \leftrightarrow \t{y_2:y} \t{v:x}B).
          &&\text{(1, \T{Sub_s}, \T{S\!\then})}\\
        3.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then 
          (\t{y_2:y} B \leftrightarrow \t{y_2:y} \t{v:x}B).
          &&\text{(2, \T{VS})}\\
        4.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then 
          (\t{y_2:y} B \leftrightarrow \t{v:x}\t{y_2:y} B).
          &&\text{(3, \T{SS1}, $y_2\not=x$)}\\
        5.\quad& \vdash_L \t{y:v}x\!\not=\!x \land \t{y:v}v\!\not=\!v \then 
          (\t{y:v}\t{y_2:y} B \leftrightarrow \t{y:v}\t{v:x}\t{y_2:y} B).
          &&\text{(4, \T{Sub_s}, \T{S\!\then})}\\
        6.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then 
          (\t{y:v}\t{y_2:y} B \leftrightarrow \t{y:v}\t{v:x}\t{y_2:y} B).
          &&\text{(5, \T{VS}, \T{SAt})}\\
        7.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then 
          (\t{y_2:y} B \leftrightarrow \t{y:v}\t{v:x}\t{y_2:y} B).
          &&\text{(6, \T{VS})}\\
        8.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then 
          (\t{y_2:y} B \leftrightarrow \t{y:x}\t{y_2:y} B).
          &&\text{(7, \T{SE2})}
      \end{alignat*}
    \end{enumerate}

  \item $A$ is $\Box B$.\; Let $v$ be a variable not in $\var(B)$.
    \begin{alignat*}{2}
      1.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then
      (B \leftrightarrow \t{v:x}B). &\quad&\text{(ind.~hyp.)}\\
      2.\quad& \vdash_L \Box(x\!\not=\!x \land v\!\not=\!v) \then
      (\Box B \leftrightarrow \Box \t{v:x}B). &&\text{(1, \T{Nec}, \T{K})}\\
      3.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then
      \Box(x\!\not=\!x \land v\!\not=\!v) &&\text{(\T{NA}, \T{EI}, \T{Nec}, \T{K})}\\
      4.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then
      (\Box B \leftrightarrow \Box \t{v:x}B). &&\text{(2, 3)}\\
      5.\quad& \vdash_L x\!\not=\!x \land v\!\not=\!v \then
      (\Box B \leftrightarrow \t{v:x}\Box B). 
      &&\text{(4, \T{S\Box}, \T{S\Diamond}, $v\not\in \var(B)$)}\\
      6.\quad& \vdash_L \t{y:v}x\!\not=\!x \land \t{y:v}v\!\not=\!v \then
      (\t{y:v}\Box B \leftrightarrow \t{y:v}\t{v:x}\Box B).
      &&\text{(5, \T{Sub_s}, \T{S\!\then})}\\
      7.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
      (\t{y:v}\Box B \leftrightarrow \t{y:v}\t{v:x}\Box B).
      &&\text{(6, \T{SAt})}\\
      8.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
      (\Box B \leftrightarrow \t{y:v}\t{v:x}\Box B).
      &&\text{(7, \T{VS})}\\
      9.\quad& \vdash_L x\!\not=\!x \land y\!\not=\!y \then
      (\Box B \leftrightarrow \t{y:x}\Box B).
      &&\text{(8, \T{SE2})}
    \end{alignat*}

  \end{enumerate}
\end{proof}

Now we can prove \T{SC1} and \T{SC2}. I will also prove that
$\t{y:x}A$ and $[y/x]A$ are provably equivalent conditional on
$y\!\not=\!y$. Compare lemma \ref{rsl} for a (slightly stronger)
semantic version of this lemma. %
\cmnt{%
  Condition (i).(b) of lemma \ref{rsl} says that $y$ does not have
  multiple counterparts at any accessible world. This can be expressed
  as $\neg \t{y:x} \Diamond (x\!=\!x \land y\!=\!y \land
  y\!\not=\!x)$. To completely mirror lemma \ref{rsl}, we should
  replace the antecedent $y\!\not=\!y$ in \T{SCN} by this
  condition. \T{SCN} would then be derivable, because $y\!\not=\!y$
  entails $\neg\t{y:x} \Diamond (x\!=\!x \land y\!=\!y \land
  y\!\not=\!x)$ (interestingly in negative logic, trivially in
  positive logic.)  Maybe I should prove the stronger version of
  \T{SCN} for neatness, even if I don't really use it.%
} %

\begin{lemma}[Substitution conversion]\label{srl}
  For any \Sc{L}-formula $A$ and variables $x,y$,
  \begin{semantics}
    \itemT{SC1} $\vdash_{L} \t{y:x}A \leftrightarrow [y/x]A$, provided
      $y$ and $x$ are modally separated in $A$.  
    \itemT{SC2} $\vdash_{L}
      \t{y:x}A \then [y/x]A$, provided $y$ is modally free for $x$ in $A$.
    \itemT{SCN} $\vdash_{L} y\!\not=\!y \then (\t{y:x}A \leftrightarrow [y/x]A)$.
  \end{semantics}
\end{lemma}

\begin{proof}
  If $x$ and $y$ are the same variable, then by \T{SE1}, $\vdash_L
  \t{x:x}A \leftrightarrow [x/x]A$.  Assume then that $x$ and $y$ are
  different variables. We first prove \T{SC1} and \T{SC2}, by
  induction on $A$. Observe that if $A$ is not a box formula $\Box B$,
  then by definition \ref{!MF}, $y$ is modally free for $x$ in $A$ iff
  $y$ and $x$ are modally separated in $A$, in which case $y$ and $x$
  are also modally separated in any subformula of $A$.

  \begin{enumerate}

  \item $A$ is atomic.\; By \T{SAt}, $\vdash_{L} \t{y:x}A
    \leftrightarrow [y/x]A$ holds without any restrictions.

  \item $A$ is $\neg B$.\; If $y$ and $x$ are modally separated
    in $A$, then by induction hypothesis, $\vdash_{L} \t{y:x}B
    \leftrightarrow [y/x]B$. So by \T{PC}, $\vdash_L \neg \t{y:x}B
    \leftrightarrow \neg [y/x]B$. By \T{S\neg} and definition
    \ref{!SUB}, it follows that $\vdash_L \t{y:x} \neg B
    \leftrightarrow [y/x]\neg B$.

  \item $A$ is $B\then C$.\; If $y$ and $x$ are modally separated in
    $A$, then by induction hypothesis, $\vdash_L \t{y:x}B
    \leftrightarrow [y/x]B$ and $\vdash_L \t{y:x}C \leftrightarrow
    [y/x]C$. By \T{S\!\then}, $\vdash_L \t{y:x}(B \then C)
    \leftrightarrow (\t{y:x}B \then \t{y:x}C)$. So $\vdash_L \t{y:x}(B
    \then C) \leftrightarrow ([y/x]B \then [y/x]C)$, and so $\vdash_L
    \t{y:x}(B \then C) \leftrightarrow [y/x](B \then C)$ by definition
    \ref{!SUB}.

  \item $A$ is $\forall z B$.\; We have to distinguish four cases,
    assuming each time that $y$ and $x$ are modally separated in $A$.
    \begin{enumerate}
    \item $z \not\in \{x,y\}$.\; By induction hypothesis, $\vdash_{L}
      \t{y:x}B \leftrightarrow [y/x]B$. So by \T{UG} and \T{UD},
      $\vdash_{L} \forall z\t{y:x}B \leftrightarrow \forall
      z[y/x]B$. Since $z\not\in \{x,y\}$, $\vdash_{L} \t{y:x}\forall z
      B \leftrightarrow \forall z \t{y:x}B$ by \T{S\forall}, and
      $\forall z[y/x]B$ is $[y/x]\forall zB$ by definition \ref{!SUB};
      so $\vdash_{L} \t{y:x}\forall zB \leftrightarrow [y/x]\forall
      zB$.
    \item $z=y$ and $x\not\in \fvar(B)$.\; By definition \ref{!SUB},
      then $[y/x]\forall z B$ is $\forall y[y/x]B$.
      \begin{alignat*}{2}
        1.\quad& \vdash_L \t{y:x}B \leftrightarrow [y/x]B. &\quad&\text{(induction hypothesis)}\\
        2.\quad& \vdash_L \forall y\t{y:x}B \leftrightarrow \forall y[y/x]B.
               &&\text{(1, \T{UG}, \T{UD})}\\
        3.\quad& \vdash_L B \leftrightarrow \t{y:x}B. &&\text{(\T{VS}, $x \not\in \fvar(B)$)}\\
        4.\quad& \vdash_L \forall y B \leftrightarrow \forall y\t{y:x}B.
               &&\text{(3, \T{UG}, \T{UD})}\\
        5.\quad& \vdash_L \forall y B \leftrightarrow \t{y:x}\forall y B.
               &&\text{(\T{VS}, $x \not\in \fvar(B)$)}\\
        6.\quad& \vdash_L \t{y:x} \forall y B \leftrightarrow \forall y [y/x]B. 
               &&\text{(2, 4, 5)}
      \end{alignat*}
    \item $z=x$ and $y\not\in \fvar(B)$.\; By definition \ref{!SUB},
      then $[y/x]\forall z B$ is $\forall y[y/x]B$.
      \begin{alignat*}{2}
        1.\quad& \vdash_L \t{y:x}B \leftrightarrow [y/x]B. &\quad&\text{(induction hypothesis)}\\
        2.\quad& \vdash_L \forall y\t{y:x}B \leftrightarrow \forall y[y/x]B.
               &&\text{(1, \T{UG}, \T{UD})}\\
        3.\quad& \vdash_L \forall x B \leftrightarrow \forall y \t{y:x}B.
               &&\text{(\T{SBV}, $y\not\in \fvar(B)$)}\\
        4.\quad& \vdash_L \forall x B \leftrightarrow \t{y:x}\forall x B.
               &&\text{\T{VS}}\\
        5.\quad& \vdash_L \t{y:x}\forall x B \leftrightarrow \forall y[y/x]B.
               &&\text{(2, 3, 4)}
      \end{alignat*}
    \item $z=x$ and $y\in \fvar(B)$, or $z=y$ and $x\in \fvar(B)$.\;
      By definition \ref{!SUB}, then $[y/x]\forall zB$ is $\forall v
      [y/x][v/z]B$ for some variable $v \not\in \var(B) \cup
      \{x,y\}$. Since $v$ and $z$ are modally separated in $B$, by
      induction hypothesis $\vdash_{L} \t{v:z}B \leftrightarrow
      [v/z]B$. So by \T{UG} and \T{UD}, $\vdash_{L} \forall v\t{v:z}B
      \leftrightarrow \forall v[v/z]B$. By \T{SBV}, $\vdash_{L} \forall
      z B \leftrightarrow \forall v\t{v:z}B$. So $\vdash_{L} \forall z
      B \leftrightarrow \forall v[v/z]B$.  Moreover, as $z \in
      \{x,y\}$, $y$ and $x$ are modally separated in $[v/z]B$. So by
      induction hypothesis, $\vdash_{L} \t{y:x}[v/z]B \leftrightarrow
      [y/x][v/z]B$. Then
      \begin{alignat*}{2}
      1.\quad& \vdash_{L} \forall z B \leftrightarrow \forall v [v/z]B 
         &\quad& \text{(as just shown)}\\
      2.\quad& \vdash_{L} \t{y:x}\forall z B \leftrightarrow \t{y:x}\forall v [v/z]B
         && \text{(1, \T{Sub^s}, \T{S\neg}, \T{S\!\then})}\\
      3.\quad& \vdash_{L} \t{y:x}\forall v [v/z]B \leftrightarrow \forall v\t{y:x}[v/z]B.
         && \text{\T{S\forall}}\\
      4.\quad& \vdash_{L} \t{y:x}\forall z B \leftrightarrow \forall v\t{y:x}[v/z]B.
         && \text{(2, 3)}\\
      5.\quad& \vdash_{L} \t{y:x}[v/z]B \leftrightarrow [y/x][v/z]B.
         && \text{(induction hypothesis)}\\
      6.\quad& \vdash_{L} \forall v\t{y:x}[v/z]B \leftrightarrow \forall v [y/x][v/z]B.
         && \text{(5, \T{UG}, \T{UD})}\\
      7.\quad& \vdash_{L} \t{y:x}\forall z B \leftrightarrow \forall v [y/x][v/z]B.
         && \text{(4, 6)}
      \end{alignat*}
    \end{enumerate}

  \item $A$ is $\t{y_2:z}B$.\; Again we have four cases, assuming $x$
    and $y$ are modally separated in $A$.
    \begin{enumerate}
    \item $z \not\in \{x,y\}$.\; By definition \ref{!SUB}, then
      $[y/x]\t{y_2:z}B$ is $\t{[y/x]y_2:z}[y/x]B$. 
      \begin{alignat*}{2}
      1.\quad&\vdash \t{y:x}\t{y_2:z}B \leftrightarrow \t{[y/x]y_2:z}\t{y:x}B
         &\quad&\text{(\T{SS1} or \T{SS2})}\\
      2.\quad&\vdash \t{y:x}B \leftrightarrow [y/x]B
         &\quad&\text{(induction hypothesis)}\\
      3.\quad&\vdash \t{[y/x]y_2:z}(\t{y:x}B \leftrightarrow [y/x]B)
         &\quad&\text{(2, \T{Sub_s})}\\
      4.\quad&\vdash \t{[y/x]y_2:z}\t{y:x}B \leftrightarrow \t{[y/x]y_2:z}[y/x]B
         &\quad&\text{(3, \T{S\!\then}, \T{S\neg})}\\
      5.\quad&\vdash \t{y:x}\t{y_2:z}B \leftrightarrow \t{[y/x]y_2:z}[y/x]B.
         &\quad&\text{(1, 4)}
      \end{alignat*}

    \item $z=y$ and $x\not\in \fvar(B)$.\; By definition \ref{!SUB},
      then $[y/x]\t{y_2:z} B$ is $\t{[y/x]y_2:y}[y/x]B$. By induction
      hypothesis, $\vdash_L \t{y:x}B \leftrightarrow [y/x]B$. So by
      \T{Sub_s} and \T{S\!\then}, $\vdash_L \t{[y/x]y_2:y}\t{y:x}B
      \leftrightarrow \t{[y/x]y_2:y}[y/x]B$. If $y_2=x$, then
      $\vdash_L \t{y:x}\t{y_2:y}B \leftrightarrow
      \t{[y/x]y_2:y}\t{y:x}B$ by \T{SS2}. \cmnt{I.e. $\vdash_L
        \t{y:x}\t{x:y}B \leftrightarrow \t{y:y}\t{y:x}B$.} If
      $y_2\not=x$, then
      \begin{alignat*}{2}
        1.\quad& \vdash_L \t{y_2:y}B \leftrightarrow \t{y:x}\t{y_2:y}B
               &\quad&\text{(\T{VS}, $x\not\in \fvar(\t{y_2:y}B)$)}\\
        2.\quad& \vdash_L B \leftrightarrow \t{y:x}B
               &&\text{(\T{VS}, $x\not\in \fvar(B)$)}\\
        3.\quad& \vdash_L \t{y_2:y}B \leftrightarrow \t{y_2:y}\t{y:x}B
               &&\text{(1, \T{Sub_s}, \T{S\!\then})}\\
        4.\quad& \vdash_L \t{y:x}\t{y_2:y}B \leftrightarrow \t{[y/x]y_2:y}\t{y:x}B
               &&\text{(1, 3)}
      \end{alignat*}
      So either way $\vdash_L \t{y:x}\t{y_2:y}B \leftrightarrow
      \t{[y/x]y_2:y}\t{y:x}B$. So $\vdash_L \t{y:x}\t{y_2:y}B
      \leftrightarrow \t{[y/x]y_2:y}[y/x]B$.
 
    \item $z=x$ and $y\not\in \fvar(B)$.\; By definition \ref{!SUB},
      then $[y/x]\t{y_2:z}B$ is $\T{[y/x]y_2:y}[y/x]B$. By induction
      hypothesis, $\vdash_L \t{y:x}B \leftrightarrow [y/x]B$. So by
      \T{Sub_s} and \T{S\!\then}, $\vdash_L \t{[y/x]y_2:y}\t{y:x}B
      \leftrightarrow \t{[y/x]y_2:y}[y/x]B$. Since $y\not\in
      \fvar(B)$, by \T{SE2}, $\vdash_L \t{[y/x]y_2:y}\t{y:x}B
      \leftrightarrow \t{[y/x]y_2:x}B$. Moreover, $\vdash_L
      \t{[y/x]y_2:x}B \leftrightarrow \t{y:x}\t{y_2:x}B$ by either
      \T{VS} (if $x\not=y_2$) or by \T{SE1}, \T{Sub_s} and
      \T{S\!\then} (if $x=y_2$). So $\vdash_L \t{y:x}\t{y_2:x}B
      \leftrightarrow \t{[y/x]y_2:y}\t{y:x}B$.
    
    \item $z=x$ and $y\in \fvar(B)$, or $z=y$ and $x\in \fvar(B)$.\;
      By definition \ref{!SUB}, then $[y/x]\t{y_2:z}B$ is
      $\t{[y/x]y_2:v}[y/x][v/z]B$, where $v \not\in \var(B) \cup
      \{x,y,y_2\}$.
      \begin{alignat*}{2}
      1.\quad& \vdash \t{v:z}B \leftrightarrow [v/z]B 
         &\quad&\text{(induction hypothesis)}\\
      2.\quad& \vdash \t{y_2:v}\t{v:z}B \leftrightarrow \t{y_2:v}[v/z]B 
         &\quad&\text{(1, \T{Sub_s}, \T{S\!\then}, \T{S\!\neg})}\\
      3.\quad& \vdash \t{y_2:z}B \leftrightarrow \t{y_2:v}\t{v:z}B
         &\quad& \text{\T{SE2}}\\
      4.\quad& \vdash \t{y_2:z}B \leftrightarrow \t{y_2:v}[v/z]B 
         &\quad&\text{(2, 3)}
      \end{alignat*}
      Since $z\in\{x,y\}$, $x$ and $y$ are modally separated in
      $[v/z]B$. So:
      \begin{alignat*}{2}
      5.\quad& \vdash \t{y:x}[v/z]B \leftrightarrow [y/x][v/z]B
         && \text{(ind. hyp.)}\\
      6.\quad& \vdash \t{[y/x]y_2:v}\t{y:x}[v/z]B \leftrightarrow \t{[y/x]y_2:v}[y/x][v/z]B
         && \text{(5, \T{Sub_s}, \T{S\!\then})}\\
      7.\quad& \vdash \t{y:x}\t{y_2:z}B \leftrightarrow \t{y:x}\t{y_2:v}[v/z]B 
         &\quad& \text{(4, \T{Sub_s}, \T{S\!\then})}\\
      8.\quad& \vdash \t{y:x}\t{y_2:v}[v/z]B \leftrightarrow \t{[y/x]y_2:v}\t{y:x}[v/z]B
         &\quad& \text{(\T{SS1} or \T{SS2})}\\
      9.\quad& \vdash \t{y:x}\t{y_2:z}B \leftrightarrow \t{[y/x]y_2:v}\t{y:x}[v/z]B
         &\quad& \text{(7, 8)}\\
      10.\quad& \vdash \t{y:x}\t{y_2:z}B \leftrightarrow \t{[y/x]y_2:v}[y/x][v/z]B
         && \text{(6, 9)}
       \end{alignat*}
     \end{enumerate}

   \item $A$ is $\Box B$.\; For \T{SC1}, assume $x$ and $y$ are
     modally separated in $A$. Then they are also modally separated in
     $B$, so by induction hypothesis, $\vdash_L \t{y:x}B
     \leftrightarrow [y/x]B$. By \T{Nec} and \T{K}, then $\vdash_L
     \Box\t{y:x}B \leftrightarrow \Box[y/x]B$. By \T{S\Box}, $\vdash_L
     \t{y:x}\Box B \then \Box \t{y:x}B$. Since at most one of $x,y$ is
     free in $B$, by \T{S\Diamond}, $\vdash_L \t{y:x}\Diamond \neg B
     \then \Diamond \t{y:x}\neg B$; so $\vdash_L \Box\t{y:x}B \then
     \t{y:x}\Box B$ (by \T{S\neg}, \T{Sub_s}, \T{S\!\then}, \T{Nec},
     \T{K}). So $\vdash_L \t{y:x}\Box B \leftrightarrow
     \Box[y/x]B$. Since $\Box[y/x]B$ is $[y/x]\Box B$ by definition
     \ref{!SUB}, this means that $\vdash_L \t{y:x}\Box B
     \leftrightarrow [y/x]\Box B$.

     For \T{SC2}, assume $y$ is modally free for $x$ in $\Box B$. Then
     $y$ is modally free for $x$ in $B$, so by induction hypothesis,
     $\vdash \t{y:x}B \then [y/x]B$. By \T{Nec} and \T{K}, then
     $\vdash \Box\t{y:x}B \then \Box[y/x]B$. By \T{S\Box}, $\vdash
     \t{y:x}\Box B \then \Box \t{y:x}B$. So $\vdash \t{y:x}\Box B
     \then \Box[y/x]B$. 
   
   \end{enumerate}

   Here is the proof for \T{SCN}. The first three clauses are very
   similar.

   \begin{enumerate}
     
   \item $A$ is atomic.\; Then $\vdash_L \t{y:x}A \leftrightarrow
    [y/x]A$ as we've seen above, and so $\vdash_L y\!\not=\!y \then
    (\t{y:x}A \leftrightarrow [y/x]A)$ by \T{PC}.
    
  \item $A$ is $\neg B$.\; By induction hypothesis, $\vdash_{L}
    y\!\not=\!y \then (\t{y:x}B \leftrightarrow [y/x]B)$. So by
    \T{PC}, $\vdash_L y\!\not=\!y \then (\neg \t{y:x}B \leftrightarrow
    \neg [y/x]B)$. By \T{S\neg} and definition \ref{!SUB}, it follows
    that $\vdash_L y\!\not=\!y \then (\t{y:x} \neg B \leftrightarrow
    [y/x]\neg B)$.
    
  \item $A$ is $B\then C$.\; By induction hypothesis, $\vdash_L
    y\!\not=\!y \then (\t{y:x}B \leftrightarrow [y/x]B)$ and $\vdash_L
    y\!\not=\!y \then (\t{y:x}C \leftrightarrow [y/x]C)$. By
    \T{S\!\then}, $\vdash_L y\!\not=\!y \then (\t{y:x}(B \then C)
    \leftrightarrow (\t{y:x}B \then \t{y:x}C))$. So $\vdash_L
    y\!\not=\!y \then (\t{y:x}(B \then C) \leftrightarrow ([y/x]B
    \then [y/x]C))$, and so $\vdash_L y\!\not=\!y \then (\t{y:x}(B
    \then C) \leftrightarrow [y/x](B \then C))$ by definition
    \ref{!SUB}.

  \item $A$ is $\forall z B$. If $z \not\in \{x,y\}$, then by
    induction hypothesis, $\vdash_{L} y\!\not=\!y \then (\t{y:x}B
    \leftrightarrow [y/x]B)$. So by \T{UG} and \T{UD}, $\vdash_{L}
    \forall z \, y\!\not=\!y \then (\forall z\t{y:x}B \leftrightarrow
    \forall z[y/x]B)$. Since $z\not\in \{x,y\}$, $\vdash_{L}
    \t{y:x}\forall z B \leftrightarrow \forall z \t{y:x}B$ by
    \T{S\forall}, and $\vdash_L y\!\not=\!y \then \forall z\,
    y\!\not=\!y$ by \T{VQ}, and $\forall z[y/x]B$ is $[y/x]\forall zB$
    by definition \ref{!SUB}; so $\vdash_{L} y\!\not=\!y \then
    (\t{y:x}\forall zB \leftrightarrow [y/x]\forall zB)$.

    Alternatively, if $z \in \{x,y\}$, then either $x$ or $y$ is not
    free in $A$, and thus $x$ and $y$ are modally separated in $A$.
    By \T{SC2}, then $\vdash_L \t{y:x}\forall z B \leftrightarrow
    [y/x]\forall z B$, and so by \T{PC}, $\vdash_L y\!\not=\!y \then
    (\t{y:x}\forall z B \leftrightarrow [y/x]\forall z B)$.

  \item $A$ is $\t{y_2:z}B$.\; If $z \not\in \{x,y\}$, then by
    induction hypothesis, $\vdash_L y\!\not=\!y \then (\t{y:x}B
    \leftrightarrow [y/x]B)$. So by \T{Sub_s} and \T{S\!\then},
    $\vdash_L \t{[y/x]y_2:z}y\!\not=\!y \then (\t{[y/x]y_2:z}\t{y:x}B
    \leftrightarrow \t{[y/x]y_2:z}[y/x]B)$. By \T{VS},
    $\t{[y/x]y_2:z}y\!\not=\!y \leftrightarrow y\!\not=\!y$. And by
    \T{SS1} or \T{SS2}, $\t{y:x}\t{y_2:z}B \leftrightarrow
    \t{[y/x]y_2:z}\t{y:x}B$. So $\vdash_L y\!\not=\!y \then
    (\t{y:x}\t{y_2:z}B \leftrightarrow \t{[y/x]y_2:z}[y/x]B)$. But by
    definition \ref{!SUB}, $[y/x]\t{y_2:z} B$ is
    $\t{[y/x]y_2:y}[y/x]B$.

    Alternatively, if $z \in \{x,y\}$, then either $x$ or $y$ is not
    free in $A$, and thus $x$ and $y$ are modally separated in $A$.
    By \T{SC2}, then $\vdash_L \t{y:x}\t{y_2:z} B \leftrightarrow
    [y/x]\t{y_2:z} B$, and so by \T{PC}, $\vdash_L y\!\not=\!y \then
    (\t{y:x}\t{y_2:z} B \leftrightarrow [y/x]\t{y_2:z} B)$.

  \item $A$ is $\Box B$.\; Then
     \begin{alignat*}{2}
       1.\quad& \vdash_L y\!\not=\!y \then (\t{y:x}B \leftrightarrow [y/x]B).
       &\quad&\text{(ind.~hyp.)}\\
       2.\quad& \vdash_L \Box y\!\not=\!y \then (\Box\t{y:x}B \leftrightarrow
       \Box [y/x]B). && \text{(1, \T{Nec}, \T{K})}\\
       3.\quad& \vdash_L y\!\not=\!y \then \Box y\!\not=\!y.
       && \text{(\T{=\!R} or \T{NA}, \T{EI} and \T{Nec})}\\
       4.\quad& \vdash_L y\!\not=\!y \then (\Box\t{y:x}B \leftrightarrow
       \Box [y/x]B). && \text{(2, 3)}\\
       5.\quad& \vdash_L y\!\not=\!y \then \t{y:x}(x\!\not=\!x \land y\!\not=\!y)
       && \text{(\T{SAt}, \T{S\!\then}, \T{S\!\neg})}\\
       6.\quad& \vdash_L (x\!\not=\!x \land y\!\not=\!y) \then 
       \Box(x\!\not=\!x \land y\!\not=\!y). && \text{(\T{=\!R} or \T{NA}, \T{EI}, \T{Nec} and \T{K})}\\
       7.\quad& \vdash_L \Box(x\!\not=\!x \land y\!\not=\!y) 
       \then (\Box B \leftrightarrow \Box \t{y:x}B).
       && \text{(\T{SEV}, \T{Nec}, \T{K})}\\
       8.\quad& \vdash_L (x\!\not=\!x \land y\!\not=\!y) \then
       (\Box B \leftrightarrow \Box \t{y:x}B). && \text{(6, 7)}\\
       9.\quad& \vdash_L \t{y:x}(x\!\not=\!x \land y\!\not=\!y) \then 
       (\t{y:x}\Box B \leftrightarrow \t{y:x} \Box \t{y:x}B). 
       && \text{(8, \T{Sub_s}, \T{S\!\then})}\\
       10.\quad& \vdash_L \t{y:x}(x\!\not=\!x \land y\!\not=\!y) \then 
       (\t{y:x}\Box B \leftrightarrow \Box \t{y:x}B). 
       && \text{(9, \T{VS})}\\
       11.\quad& \vdash_L y\!\not=\!y \then
       (\t{y:x}\Box B \leftrightarrow \Box \t{y:x}B). && \text{(7, 10)}\\
       12.\quad& \vdash_L y\!\not=\!y \then (\t{y:x} \Box B \leftrightarrow
       [y/x]\Box B). && \text{(4, 13, def.~\ref{!SUB})}
    \end{alignat*}
   \end{enumerate}
   
   \qed

\end{proof}

\begin{lemma}[Syntactic alpha-conversion]\label{alphasyn-s}
  If $A,A'$ are $\Sc{L}$-formulas, and $A'$ is an alphabetic variant of
  $A$, then
  \begin{semantics}
    \itemT{AC} $\vdash_{L} A \leftrightarrow A'$.
  \end{semantics}
\end{lemma}

\begin{proof} by induction on $A$.

  \begin{enumerate}

  \item $A$ is atomic.\; Then $A=A'$ and $\vdash_L A \leftrightarrow
    A'$ by \T{Taut}.

  \item $A$ is $\neg B$.\; Then $A'$ is $\neg B'$ with $B'$ an
    alphabetic variant of $B$. By induction hypothesis, $\vdash_{L} B
    \leftrightarrow B'$. By \T{PC}, $\vdash_{L} \neg B \leftrightarrow
    \neg B'$.

  \item $A$ is $B \then C$.\; Then $A'$ is $B' \then C'$ with $B',C'$
    alphabetic variants of $B,C$, respectively. By induction
    hypothesis, $\vdash_{L} B \leftrightarrow B'$ and $\vdash_{s{C}} C
    \leftrightarrow C'$. By \T{PC}, then $\vdash_{L} (B \then C)
    \leftrightarrow (B' \then C')$.

  \item $A$ is $\forall x B$.\; Then $A'$ is either $\forall x B'$ or
    $\forall z [z/x]B'$, where $B'$ is an alphabetic variant of $B$
    and $z\not\in \var(B')$.  Assume first that $A'$ is $\forall x
    B'$. By induction hypothesis, $\vdash_{L} B \leftrightarrow
    B'$. So by \T{UG} and \T{UD}, $\vdash_L \forall x B
    \leftrightarrow \forall x B'$.

    Alternatively, assume $A'$ is $\forall z [z/x]B'$ and $z\not\in
    \var(B')$. Since $B'$ differs from $B$ at most in renaming bound
    variables, if $z$ were free in $B$, then $z \in \var(B')$. So $z$
    is not free in $B$. Then
    \begin{alignat*}{2}
      1.\quad&\vdash_{L} B \leftrightarrow B'. &\quad&\text{induction hypothesis}\\
      2.\quad&\vdash_{L} \t{z:x}B \leftrightarrow \t{z:x}B'. 
         &\quad&\text{(1, \T{Sub_s}, \T{S\!\neg})}\\
      3.\quad&\vdash_{L} \t{z:x}B' \leftrightarrow [z/x]B'.
         &\quad&\text{(\T{SC1}, $z \not\in \var(B')$)}\\
      4.\quad&\vdash_{L} \t{z:x}B \leftrightarrow [z/x]B'.
         &\quad&\text{(2, 3)}\\
      5.\quad&\vdash_{L} \forall z\t{z:x}B \leftrightarrow \forall z[z/x]B'. 
         &&\text{(4, \T{UG}, \T{UD})}\\
      6.\quad&\vdash_{L} \forall x B \leftrightarrow \forall z\t{z:x}B. 
         &&\text{(\T{SBV}, $z$ not free in $B$)}\\
      7.\quad&\vdash_{L} \forall x B \leftrightarrow \forall z[z/x]B'. 
         &&\text{(5, 6)}
    \end{alignat*}

  \item $A$ is $\t{y:x} B$.\; Then $A'$ is either $\t{y:x} B'$ or
    $\t{y:z} [z/x]B'$, where $B'$ is an alphabetic variant of $B$ and
    $z\not\in \var(B)$. Assume first that $A'$ is $\t{y:x} B'$. By
    induction hypothesis, $\vdash_{L} B \leftrightarrow B'$. So by
    \T{Sub_s} and \T{S\!\then}, $\vdash_{L} \t{y:x} B \leftrightarrow
    \t{y:x} B'$.

    Alternatively, assume $A'$ is $\t{y:z} [z/x]B'$ and $z \not\in
    \var(B')$. Again, it follows that $z$ is not free in $B$. So
    \begin{alignat*}{2}
      1.\quad&\vdash_{L} B \leftrightarrow B'. &\quad&\text{induction hypothesis}\\
      2.\quad&\vdash_{L} \t{z:x}B \leftrightarrow \t{z:x}B'. 
         &\quad&\text{(1, \T{Sub_s}, \T{S\!\then})}\\
      3.\quad&\vdash_{L} \t{z:x}B' \leftrightarrow [z/x]B'.
         &\quad&\text{(\T{SC1}, $z \not\in \var(B')$)}\\
      4.\quad&\vdash_{L} \t{z:x}B \leftrightarrow [z/x]B'.
         &\quad&\text{(2, 3)}\\
      5.\quad&\vdash_{L} \t{y:z}\t{z:x}B \leftrightarrow \t{y:z}[z/x]B'. 
         &&\text{(4, \T{Sub_s}, \T{S\!\then})}\\
      6.\quad&\vdash_{L} \t{y:z}\t{z:x} B \leftrightarrow \t{y:x} B. 
         &&\text{(\T{SE2}, $z$ not free in $B$)}\\
      7.\quad&\vdash_{L} \t{y:x} B \leftrightarrow \t{y:z}[z/x]B'. 
         &&\text{(5, 6)}
    \end{alignat*}

  \item $A$ is $\Box A'$.\; Then $B$ is $\Box B'$ with $B'$ an
    alphabetic variant of $A'$. By induction hypothesis, $\vdash_{L}
    A' \leftrightarrow B'$. Then by \T{Nec}, $\vdash_{L} \Box(A'
    \leftrightarrow B')$, and by \T{K}, $\vdash_{L} \Box A'
    \leftrightarrow \Box B'$. \qed
  \end{enumerate}
\end{proof}


\begin{theorem}[Substitution and non-substitution logics]\label{logred}
  For any \Sc{L}-formula $A$ and variables $x,y$,
  \begin{semantics}
    \itemT{FUI^*} $\vdash_L \forall x A \then (Ey \then [y/x]A)$,
      provided $y$ is modally free for $x$ in $A$, 
    \itemT{LL^*} $\vdash_L x\!=\!y \then A \then [y/x]A$, 
      provided $y$ is modally free for $x$ in $A$,
    \itemT{Sub^*} if $\vdash_L A$, then $\vdash_L [y/x]A$, 
     provided $y$ is modally free for $x$ in $A$.  
  \end{semantics}
  It follows that $\s{P} \subseteq \s{P}_s$ and $\s{N} \subseteq
  \s{N}_s$.
\end{theorem}
\begin{proof}
  Assume $y$ is modally free for $x$ in $A$. Then by \T{SC2},
  $\vdash_L \t{y:x}A \then [y/x]A$. By \T{FUI_s}, $\vdash_L \forall x
  A \then (Ey \then \t{y:x}A)$, so by \T{PC}, $\vdash_L \forall x A
  \then (Ey \then [y/x]A)$. Similarly, by \T{LL_s}, $\vdash_L x\!=\!y
  \then A \then \t{y:x}A$, so by \T{PC}, $\vdash_L x\!=\!y \then A
  \then [y/x]A$. Finally, by \T{Sub_s}, if $\vdash_L A$, then
  $\vdash_L \t{y:x}A$, so then $\vdash_L [y/x]A$ by \T{PC}. \qed
\end{proof}

\begin{lemma}[Symmetry and transitivity of identity]\label{symtrans-s}
  For any \Sc{L}-variables $x,y,z$,
  \begin{semantics}
    \itemT{=\!S} $\vdash_L x\!=\!y \then y\!=\!x$;
    \itemT{=\!T} $\vdash_L x\!=\!y \then y\!=\!z \then x\!=\!z$.
  \end{semantics}
\end{lemma}  

\begin{proof}
  Immediate from lemma \ref{logred} and lemma \ref{symtrans}. \qed

  \cmnt{%
  For \T{=S}, let $v$ be some variable $\not\in \{x,y\}$. Then
  \begin{alignat*}{2}
    1.\quad&\vdash_L v\!=\!y \then v\!=\!x \then \t{y:v}v\!=\!x. &\quad& \text{\T{LL_s}}\\
    2.\quad&\vdash_L v\!=\!y \then v\!=\!x \then y\!=\!x. && \text{(1, \T{SAt})}\\
    3.\quad&\vdash_L \t{x:v} (v\!=\!y \then v\!=\!x \then y\!=\!x). && \text{\T{Sub_s}}\\
    4.\quad&\vdash_L x\!=\!y \then x\!=\!x \then y\!=\!x. && \text{(3, \T{S\!\then}, \T{SAt})}\\
    5.\quad&\vdash_L x\!=\!y \then x\!=\!x. 
        && \text{(\T{=\!R}, or \T{Neg} and \T{\forall\!=\!R})}\\
    6.\quad& \vdash_L x\!=\!y \then y\!=\!x. && \text{(4, 5)}
  \end{alignat*}

  For \T{=T},
  \begin{alignat*}{2}
    1.\quad& \vdash_L x\!=\!y \then y\!=\!x. &\quad& \text{\T{=\!S}}\\
    2.\quad& \vdash_L y\!=\!x \then y\!=\!z \then x\!=\!z. && \text{(\T{LL_s}, \T{SAt})}\\
    3.\quad& \vdash_L x\!=\!y \then y\!=\!z \then x\!=\!z. && \text{(1, 2)}
  \end{alignat*}
  \qed
  }%
\end{proof}

\begin{lemma}[Variations on Leibniz' Law]\label{varLL}
  If $A$ is an \Sc{L}-formula and $x,y,y'$ are \Sc{L}-variables, then
  \begin{semantics}
    \itemT{LV1} $\vdash_L x\!=\!y \then \t{y:x}A \then A$.
    \itemT{LV2} $\vdash_L y\!=\!y' \then \t{y:x}A \then [y'/x]A$, provided $y'$ is modally free for $x$ in $A$.
  \end{semantics}
\end{lemma}

\cmnt{%
  \T{LV1} (formerly \T{LL_i}) seems to be never used. Is it
  interesting enough to list on its own?
} %

\begin{proof}
  \T{LV1}. Let $z$ be an $\Sc{L}$-variable not in $\var(A)$. Then
  \begin{alignat*}{2}
    1.\quad& \vdash_L x\!=\!z \then \t{z:x}A \then \t{x:z}\t{z:x}A.
    &\quad&\text{\T{LL_s}}\\
    2.\quad& \vdash_L x\!=\!z \then \t{z:x}A \then \t{x:x}A.
    &&\text{(1, \T{SE2}, $z \not\in \var(A)$)}\\
    3.\quad& \vdash_L x\!=\!z \then \t{z:x}A \then A.
    &&\text{(2, \T{SE1})}\\
    4.\quad& \vdash_L \t{y:z}x\!=\!z \then \t{y:z}\t{z:x}A \then \t{y:z}A.
    &&\text{(3, \T{VS}, \T{S\!\then})}\\
    5.\quad& \vdash_L x\!=\!z \then  \t{y:z}\t{z:x}A \then \t{y:z}A.
    &&\text{(4, \T{SAt})}\\
    6.\quad& \vdash_L x\!=\!z \then  \t{y:x}A \then \t{y:z}A.
    &&\text{(5, \T{SE2}, $z \not\in \var(A)$)}\\
    7.\quad& \vdash_L x\!=\!z \then  \t{y:x}A \then A.
    &&\text{(6, \T{VS}, $z \not\in \var(A)$)}. 
  \end{alignat*}

  \T{LV2}.
  \begin{alignat*}{2}
    1.\quad& \vdash_L x\!=\!y \land y\!=\!y' \then x\!=\!y'. 
    &\quad&\text{\T{=\!T}}\\
    2.\quad& \vdash_L A \land x\!=\!y' \then [y'/x]A.
    &\quad&\text{(\T{LL^*}, $y'$ m.f.\ in $A$)}\\
    3.\quad& \vdash_L A \land x\!=\!y \land y\!=\!y' \then [y'/x]A.
    &\quad&\text{(1, 2)}\\
    4.\quad& \vdash_L \t{y:x}A \land \t{y:x}x\!=\!y \land \t{y:x}y\!=\!y' \then \t{y:x}[y'/x]A.
    &\quad&\text{(3, \T{Sub_s}, \T{S\neg}, \T{S\!\then})}\\
    5.\quad& \vdash_L y\!=\!y \then \t{y:x}x\!=\!y.
    &\quad&\text{\T{SAt}}\\
    6.\quad& \vdash_L y\!=\!y' \then y\!=\!y.
    &\quad&\text{(\T{LL^*}, \T{=\!S})}\\
    7.\quad& \vdash_L y\!=\!y' \then \t{y:x}y\!=\!y'.
    &\quad&\text{\T{VS}}\\
    8.\quad& \vdash_L \t{y:x}A \land y\!=\!y' \then \t{y:x}[y'/x]A.
    &\quad&\text{(4, 5, 6, 7)}\\
    9.\quad& \vdash_L \t{y:x}[y'/x]A \then [y'/x]A.
    &\quad&\text{\T{VS}}\\
    10.\quad& \vdash_L \t{y:x}A \land y\!=\!y' \then [y'/x]A.
    &\quad&\text{(8, 9)}
  \end{alignat*}
  \qed
\end{proof}

\begin{lemma}[Leibniz' Law with sequences]
  For any \Sc{L}-formula $A$ and variables
  $x_1,\ldots,x_n,y_1,\ldots,y_n$ such that the $x_1,\ldots,x_n$ are
  pairwise distinct,
  \begin{semantics}
    \itemT{LL_n} $\vdash_L x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n 
                 \then A \then \t{y_1,\ldots,y_n : x_1,\ldots,x_n}A$.
  \end{semantics}
\end{lemma}
\begin{proof} For $n=1$, \T{LL_n} is \T{LL_s}. Assume then that $n >
  1$. To keep formulas in the following proof at a managable length,
  let $\vec{\phi(i)}$ abbreviate the sequence
  $\phi(1),\ldots,\phi(n-1)$. For example, $\t{\vec{y_i}:\vec{x_i}}$ is
  $\t{y_1,\ldots,y_{n-1} : x_1,\ldots, x_{n-1}}$. Let $z$ be the
  alphabetically first variable not in $A$ or $x_1,\ldots,x_n$. Now
  % \setlength{\mathindent}{0.3\leftmargini}
  \begin{alignat*}{2}
    1.\quad& \vdash_L x_n\!=\!y_n \then \t{\vec{y_i} : \vec{x_i}}A
             \then \t{y_n:x_n}\t{\vec{y_i} : \vec{x_i}}A.
      &\quad& \text{\T{LL_s}}\\
    2.\quad& \vdash_L \t{y_n:x_n}\t{\vec{y_i} : \vec{x_i}}A
             \then \t{y_n:z}\t{z:x_n}\t{\vec{y_i} : \vec{x_i}}A.
      && \text{\T{SE1}}\\
    3.\quad& \vdash_L \t{z:x_n}\t{\vec{y_i} : \vec{x_i}}A 
             \then \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{(\T{SS1} or \T{SS2})}\\
    4.\quad& \vdash_L \t{y_n:z}\t{z:x_n}\t{\vec{y_i} : \vec{x_i}}A &&\\[-0.2ex] 
           & \quad\quad \then \t{y_n:z}\t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{(3, \T{Sub_s}, \T{S\!\then})}\\
    5.\quad& \vdash_L x_n\!=\!y_n \then \t{\vec{y_i} : \vec{x_i}}A 
             \then \t{y_n:z}\t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{(1, 2, 4)}\\
    6.\quad& \vdash_L x_n\!=\!z \then
             \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A &&\\[-0.2ex]
           & \quad\quad \then 
             \t{z:x_n}\t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{\T{LL_s}}\\
    7.\quad& \vdash_L x_n\!=\!z \then
             \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A &&\\[-0.2ex]
           & \quad\quad \then 
             \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}\t{z:x_n}A.
       && \text{(6, \T{SS1})}\\
    8.\quad& \vdash_L z\!=\!x_n \then
             \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}\t{z:x_n}A&&\\[-0.2ex]
           & \quad\quad \then 
             \t{x_n:z}\t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}\t{z:x_n}A.
       && \text{\T{LL_s}}\\
    9.\quad& \vdash_L z\!=\!x_n \then
             \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}\t{z:x_n}A&&\\[-0.2ex]
           & \quad\quad \then 
             \t{\vec{y_i} : \vec{x_i}}\t{x_n:z}\t{z:x_n}\t{z:x_n}A.
       && \text{(8, \T{SS1}, \T{SS2})}\\
   10.\quad& \vdash_L \t{x_n:z}\t{z:x_n}\t{z:x_n}A \leftrightarrow \t{z:x_n}A 
       && \text{(\T{SE1}, \T{SE2})}\\
   11.\quad& \vdash_L \t{\vec{y_i} : \vec{x_i}}\t{x_n:z}\t{z:x_n}\t{z:x_n}A
             \then \t{\vec{y_i} : \vec{x_i}}\t{z:x_n}A
       && \text{(10, \T{Sub_s}, \T{S\!\then})}\\
   12.\quad& \vdash_L z\!=\!x_n \then x_n\!=\!z && \text{\T{=\!S}}\\
   13.\quad& \vdash_L z\!=\!x_n \then \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A
            \then \t{\vec{y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{(7, 9, 11, 12)}\\
   14.\quad& \vdash_L x_n\!=\!y_n \then \t{y_n:z}z\!=\!x_n && \text{(\T{=\!S}, \T{SAt})}\\
   15.\quad& \vdash_L x_n\!=\!y_n \then \t{y_n:z} 
              \t{\vec{[z/x_n]y_i} : \vec{x_i}}\t{z:x_n}A &&\\[-0.2ex]
           & \quad\quad \then \t{y_n:z}\t{\vec{y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{13, 14, \T{Sub_s}, \T{S\!\then}}\\
   16.\quad& \vdash_L x_n\!=\!y_n \then \t{\vec{y_i} : \vec{x_i}}A
           \then \t{y_n:z}\t{\vec{y_i} : \vec{x_i}}\t{z:x_n}A.
       && \text{5, 15}\\
   17.\quad& \vdash_L x_1\!=\!y_1 \land \ldots \land x_{n-1}\!=\!y_{n-1} \then A
           \then \t{\vec{y_i} : \vec{x_i}}A.
      &\quad& \text{(induction hypothesis)}\\
   18.\quad& \vdash_L x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \then A
            \then \t{y_n:z}\t{\vec{y_i} : \vec{x_i}}\t{z:x_n}A.
      &\quad& \text{(16, 17)}\\
   19.\quad& \vdash_L x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \then A 
            \then \t{y_1,\ldots,y_{n} : x_1,\ldots,x_{n}}A.
      &\quad& \text{(18, def.~\ref{!SEQ})}
 \end{alignat*}
 \qed
\end{proof}

\begin{lemma}[Closure under transformations]\label{subtranss}
  For any $\Sc{L}$-formula $A$ and transformation $\tau$ on $\Sc{L}$,
  \begin{semantics}
    \itemT{Sub^\tau} $\vdash_L A$ iff $\vdash_L A^\tau$.
  \end{semantics}
\end{lemma}

\begin{proof}

  The proof is exactly as in lemma \ref{subtrans}. 
  \cmnt{%
    Assume $\vdash_{L} A$. Let $x_1,\ldots,x_n$ be the variables in
    $A$. If $n=0$, then $A = A^\tau$ and the result is trivial. If
    $n=1$, then $A^\tau$ is $[x_1^\tau/x_1]A$, and $x_1^\tau$ is
    either $x_1$ itself or does not occur in $A$. In the first case,
    $[x_1^\tau/x_1]A = A$ and the result is again trivial. In the
    second case, $x_1^\tau$ is modally free for $x_1$ in $A$, and thus
    $\vdash_L [x_1^\tau/x_1]A$ by \T{Sub^*}. -- More explicitly, we
    have $\vdash_L \t{x_1^\tau:x_1}A$ by \T{Sub_s}, and so $\vdash_L
    [x_1^\tau/x_1]A$ by \T{SC2}.

    Assume then that $n > 1$. Note first that $A =
    [x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$,
    where $v_2,\ldots,v_n$ are distinct variables not in $A$ or
    $A^\tau$ (compare definition \ref{!SEQ}; this is easily shown by
    induction on the subformulas $B$ of $A$): let $\Sigma$ abbreviate
    $[x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]$.
    \begin{enumerate}
    \item $B$ is $Px_j\ldots x_k$.\; Then $x_j,\ldots, x_k$ are
      variables from $x_1,\ldots,x_n$, and $\Sigma B = Px_j^\tau\ldots
      x_k^\tau = B^\tau$.
    \item $B$ is $\neg C$.\; By induction hypothesis, $\Sigma C =
      C^\tau$, hence $\neg \Sigma C = \neg C^\tau$. By definitions
      \ref{SUB} and \ref{!SUBS}, $\Sigma \neg C$ is $\neg \Sigma C$, and
      $(\neg C)^\tau$ is $\neg C^\tau$.
    \item $B$ is $C \then D$.\; Similar.
    \item $B$ is $\forall z C$.\; By induction hypothesis, $\Sigma C =
      C^\tau$. Since $\tau$ is injective, by definitions \ref{!SUB} and
      \ref{!SUBS}, $\Sigma \forall z C$ is $\forall \Sigma z \Sigma C$,
      and $(\forall z C)^\tau$ is $\forall z^\tau C^\tau$. \cmnt{(Here
        things would get a lot more complicated if we had defined
        substitution differently, so that $[y/x]\forall x Fx \not=
        \forall y Fy$.)} And it is easy to verify that $\Sigma z =
      z^\tau$.
    \item $B$ is $\t{y:z} C$.\; By induction hypothesis, $\Sigma C =
      C^\tau$. Since $\tau$ is injective, by definitions \ref{!SUB}
      and \ref{!SUBS}, $\Sigma \t{y:z} C$ is $\t{\Sigma y: \Sigma z}
      \Sigma C$, and $(\t{y:z} C)^\tau$ is $\t{y^\tau:z^\tau}
      C^\tau$. And it is easy to verify that $\Sigma y = y^\tau$ and
      $\Sigma z = z^\tau$.
    \item $B$ is $\Box C$.\; By induction hypothesis, $\Sigma C$ is
      $C^\tau$, hence $\Box \Sigma C$ is $\Box C^\tau$. By definitions
      \ref{!SUB} and \ref{!SUBS}, $\Sigma \Box C$ is $\Box \Sigma C$,
      and $(\Box C)^\tau$ is $\Box C^\tau$.
    \end{enumerate}
    
    Since $v_n$ is modally free for $x_n$ in $A$, by \T{Sub^*},
    $\vdash_{L} [v_n/x_n]A$. -- More precisely, by \T{Sub_s},
    $\vdash_L \t{v_n:x_n}A$, and by \T{SC2}, $\vdash_L
    [v_n/x_n]A$. Likewise, for each $1 < i < n$, $v_i$ is modally free
    for $x_i$ in $[v_{i+1}/x_{i+1}]\ldots [v_n/x_n]A$. So $\vdash_{L}
    [v_2/x_2]\ldots[v_n/x_n]A$.

    With respect to $[x_1^\tau/x_1]$, we distinguish three cases. First,
    if $x_1 = x_1^\tau$, then $\vdash_L
    [x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$, because
    $[x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$ is
    $[v_2/x_2]\ldots[v_n/x_n]A$. Second, if $x_1 \not= x_1^\tau$ and
    $x_1^\tau \not\in \var(A)$, then $x_1^\tau \not\in
    \var([v_2/x_2]\ldots[v_n/x_n]A)$, since the $v_1,\ldots,v_n$ are not
    in $\var(A)$ or $\var(A^\tau)$\cmnt{ (in particular, thus no new
      variables are introduced in $[v_2/x_2]\ldots[v_n/x_n]A$)}. So
    $x_1^\tau$ is modally free for $x_1$ in $[v_2/x_2]\ldots[v_n/x_n]A$,
    and by \T{Sub^*}, $\vdash_L
    [x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$. Third, if $x_1 \not=
    x_1^\tau$ and $x_1^\tau \in \var(A)$, then $x_1^\tau$ must be one of
    $x_2,\ldots,x_n$. Then again $x_1^\tau \not\in
    \var([v_2/x_2]\ldots[v_n/x_n]A)$, and so $\vdash_L
    [x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$ by \T{Sub^*}.
    
    Finally, $x_2^\tau$ is modally free for $v_2$ in
    $[x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$, because $\tau$ is
    injective and hence $x_2^\tau \not= x_1^\tau$, so $x_2^\tau$ does
    not occur in $[x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$. Hence
    $\vdash_{L}
    [x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$. By the same
    reasoning, for each $2 < i \leq n$, $x_i^\tau$ is modally free for
    $v_i$ in
    $[x_{i-1}^\tau/v_{i-1}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$.
    So $\vdash_{L}
    [x_{n}^\tau/v_{n}]\ldots[x_2^\tau/v_2][x_1^\tau/x_1][v_2/x_2]\ldots[v_n/x_n]A$,
    i.e. $\vdash_L A^\tau$.
  }%
  \qed

\end{proof}


\section{Correspondence}\label{sec:correspondence}

A well-known feature of Kripke semantics for propositional modal logic is that
various modal schemas correspond to conditions on the accessibility relation, in
the sense that the schema is valid in all and only those Kripke frames whose
accessibility relation satisfies the condition: $\Box A \then A$
\emph{corresponds to} (or \emph{defines}) the class of reflexive frames,
$A \then \Box\Diamond A$ the class of symmetrical frames, and so on.

In our counterpart semantics, (i) is not enough to ensure the validity of
$\Box A \then A$. Consider $\Box Fx \then Fx$. Loosely speaking, the antecedent
$\Box Fx$ is true at $w$ iff all counterparts of $x$ are $F$ at all accessible
worlds. This does not entail that $x$ is $F$ at $w$ unless (i) $w$ can see
itself and (ii) $x$ is its own counterpart at $w$.

\cmnt{%
  \begin{proof}
    Assume first that some structure $\Fr{S} =\t{W,R,U,D,K}$ does not satisfy
    (i) and (ii). If some $w\in W$ is not $R$-related to itself, then
    $w,V \not\SAT_{\Fr{S}} \Box P_0 \then P_0$, where $P_0$ is a zero-ary
    predicate with $V_w(P_0) = 0$ and $V_{w'}(P_0) = 1$ for all $w'\not=w$. If
    some individual $d \in U_w$ is not a counterpart of itself at $w$ relative
    to some $C\in K_{w,w}$, then
    $w,V \not\SAT_{\Fr{S}} \Box \neg Fx \then \neg Fx$, where $V_w(x)=d$,
    $V_w(F) = \{ d \}$, and $V_{w'}(F) = \emptyset$ for all $w' \not= w$. In the
    other direction, assume some instance of $\Box A \then A$ is false at some
    $w\in W$ in some structure $\Fr{S} =\t{W,R,U,D,K}$ under some interpretation
    $V$ on $\Fr{S}$. Then $w,V \SAT_{\Fr{S}} \Box A$ and
    $w,V \not\SAT_{\Fr{S}} A$. The former means that $w',V'\SAT_{\Fr{S}} A$
    whenever $wRw'$ and $V_w \Img V'_{w'}$. But if $R$ is reflexive, then $wRw$.
    Moreover, if there is a $C\in K_{w,w}$ for which $V_w(x) C V_{w}(x)$
    whenever $V_w(x)$ is defined, then $V_w \Img V'_{w'}$. Under these
    conditions, it therefore follows that $w,V \SAT_{\Fr{S}} A$, which refutes
    the assumption that $w,V \not\SAT_{\Fr{S}} \Box A \then A$.\qed
  \end{proof}
}

How does this observation generalise?

Let's stick to positive logics for a while.

\cmnt{%
  The relevant properties of the counterpart relation are
  easier to describe if we ignore negative models. For example, we'd
  like $A \then \Box\Diamond A$ to be valid in a structure iff both
  $R$ and $C$ are symmetrical. But in non-total structures (for
  negative models), we have to be careful because it is not enough
  that whenever $\t{d,w}C\t{d',w'}$ then $\t{d',w'}C\t{d,w}$. Assume
  $\Fr{S}$ is symmetrical and suppose for reductio that some instance
  of $A \then \Box \Diamond A$ is not valid on $\Fr{S}$, so that $w,V
  \SAT A$ and $w,V \not\SAT \Box \Diamond A$, i.e.\ $w,V \SAT
  \Diamond\Box \neg A$. The latter means that there are $w',V'$ with
  $wRw'$ and $V_w\Img V_{w'}$ such that for all $w'',V''$ with
  $w'Rw''$ and $V_{w'}\Img V_{w''}$, $w'',V'' \SAT \neg A$. But since
  $wRw'$ and $R$ is symmetrical, one such $w''$ is $w$. And since $C$
  is symmetrical, we'd like to say that $V$ is a $w$-image of $V'$ at
  $w$, so that we get $w,V \SAT \neg A$, completing the reductio. But
  if some $d$ at $w$ has no counterpart at all at $w'$, then
  $V'_{w'}(x)$ may be empty and thus not denote any counterpart of
  $V_w(x)$. So when we shift back from $w'$ to $w$ and from $V'$ to
  $V$, the empty variable $x$ turns non-empty. That is not OK by
  definition \ref{!IMG}, which says that in order for $V'_{w'}\Img
  V_w$, it must be the case that whenever $\t{V'_{w'}(x),w'}$ has a
  counterpart at $w$, then $V_w(x)$ is one of these counterparts,
  \emph{otherwise $V_w(x)$ is undefined}. So we'd somehow have to
  strengthen the definition of symmetry, or find a different line of
  proof here.%
} %

First a brief review of some definitions from propositional modal logic.

\begin{definition}[Languages of propositional modal logic]{\label{!PROPLANG}}
  A set of formulas $\Sc{L}_0$ is a \emph{(unimodal) propositional language} if
  there is a denumerable set of expressions $\emph{Prop}$ (the \emph{sentence
    letters} of $\Sc{L}_0$) distinct from $\{ \neg, \then, \Box \}$ such that
  $\Sc{L}_0$ is generated by the rule
  \[
    P \1 \neg A \1 (A \then B) \1 \Box A,
  \]
  where $P \in \emph{Prop}$.
\end{definition}

Note that the language $\Sc{L}$ of quantified modal logic is a unimodal
propositional language if we define a ``sentence letters'' as any
$\Sc{L}$-formula that isn't of the form $\neg A, A \then B$ or $\Box A$. (On
this usage, $\forall x \Box (Fx \then Gx)$, for example, is a sentence letter.)
Let's call such $\Sc{L}$-formulas \emph{quasi-atomic}.

\begin{definition}[Frames and valuations]{\label{!FRAME}}
  A \emph{frame} is a pair consisting of a non-empty set $W$ and a relation
  $R \subseteq W^2$.

  \medskip\noindent
  A \emph{valuation of} a unimodal propositional language $\Sc{L}_0$
  \emph{on} a frame $\Fr{F} = \t{W,R}$ is a function $V$ that maps
  every sentence letter of $\Sc{L}_0$ to a subset of $W$.
\end{definition}

\begin{definition}[Propositional truth]{\label{!KRIPKE}}
  For any frame $\Fr{F}=\t{W,R}$, point $w\in W$, valuation $V$ on
  $\Fr{F}$, sentence letter $P$ and $\Sc{L}_{0}$-sentences $A$ and $B$,
  \begin{semantics}
  \item[$\Fr{F},V,w \SAT_0 P$] iff $w\in V(P)$,
  \item[$\Fr{F},V,w \SAT_0 \neg A$] iff $\Fr{F},V,w \not\SAT_0 A$,
  \item[$\Fr{F},V,w \SAT_0 A \then B$] iff $\Fr{F},V,w \not\SAT_0 A$
    or $\Fr{F},V,w \SAT_0 B$,
  \item[$\Fr{F},V,w \SAT_0 \Box A$] iff $\Fr{F},V,w' \SAT_0 A$ for
    all $w'$ with $wRw'$.
  \end{semantics}
\end{definition}

\begin{definition}[Frame validity]{\label{!FRAMEVAL}}
  A formula $A$ of a unimodal propositional language is \emph{valid on
    a frame} $\Fr{F} = \t{W,R}$ if $\Fr{F},V,w \SAT_0 A$ for all
  $w\in W$ and valuation functions $V$ of the language on $\Fr{F}$.

  A set of formulas $\mathbb{A}$ is \emph{valid on a frame} $\Fr{F}$ if all
  members of $\mathbb{A}$ are valid on $\Fr{F}$.
\end{definition}

\begin{definition}[Frame correspondence]{\label{!FRAMECORR}}
  A set of formulas $\mathbb{A}$ of a unimodal propositional language
  \emph{defines} or \emph{corresponds to} a class of frames $\Fr{C}$ iff
  $\Fr{C}$ is the class of frames in which all members of $A$ are valid.
\end{definition}

In propositional modal logic, formulas are true or false relative to a world;
the box shifts the world of evaluation. In counterpart semantics, formulas are
true or false relative to a pair $\t{w,g}$ of a world and an assignment
function, and the box shifts these points of evaluation: $\Box A$ is true at
$w,g$ iff $A$ is true at all $w',g'$ such that $w,g \Img w',g'$.

This suggests that if a schema of propositional modal logic corresponds to a
certain property of the accessibility relation $R$ of Kripke frames, then it
corresponds to the same property of the relation $\Img$ in counterpart
structures. That is, if a schema $A$ is valid in all and only the Kripke frames
whose accessibility relation satisfies a certain condition, then the schema is
valid in all and only the counterpart structures whose image relation (on $w,g$
pairs) satisfies this condition.

It is, in fact, easy to show that the schema is valid in \emph{all} those
counterpart structures. But I'm not able to show that it is valid in \emph{only}
those structures.

The problem is that any $\Sc{L}$-instance of a propositional schema $A$ only
contains finitely many free variables. A formula of $\Sc{L}$ is true or false
only relative to a world $w$ and a \emph{finite fragment} of an assignment $g$
on $U_{w}$ -- a fragment that interprets the free variables in the formula.

[TODO: Give either a counterexample to correspondence transfer for $\Img$ or
show that it holds.]

\cmnt{%
  Let's try to show correspondence transfer with infinite sequences or
  assignments.

  We can regard each counterpart structure as a Kripke frame, with $\t{w,g}$
  pairs as the points (``worlds'') and $\Img$ as the accessibility relation. To
  interpret the language $\Sc{L}$ of quantified modal logic in these frames,
  note that $\Sc{L}$ is a unimodal propositional language if we define a
  ``sentence letters'' as any $\Sc{L}$-formula that isn't of the form
  $\neg A, A \then B$ or $\Box A$. (So $\forall x \Box (Fx \then Gx)$, for
  example, is a sentence letter.) Let's call such formulas \emph{quasi-atomic}.

  \begin{definition}[Opaque Propositional Guise]{\label{!OPAQUE}}
    The \emph{opaque propositional guise of a counterpart model}
    $\Fr{M}=\t{W,R,U,D,K,I}$ is the Kripke model
    $\t{W_{\Fr{M}},R_{\Fr{M}},V_{\Fr{M}}}$ where
    \begin{compactenum}
      \item[(i)] $W_{\Fr{M}} = \{ \t{w,g} : w \in W, g: \var \to U_{w} \}$,
      \item[(ii)] $\t{w,g}R_{\Fr{M}}\t{w',g'}$ iff $w,g \Img w',g'$,
      \item[(iii)] $V_{\Fr{M}}(A) = \{\t{w,g} : \Fr{M},w,g \SAT A \}$ for
      quasi-atomic $A$.
    \end{compactenum}
  \end{definition}

  \begin{lemma}[Truth-preservation under opaque guises]\label{opaque}
    For any total counterpart model $\Fr{M}=\t{W,R,U,D,K,I}$, world $w \in W$,
    assignment $g$ on $U_{w}$, and $\Sc{L}$-formula $A$,
    \[
      \Fr{M},w,g  \SAT A \text{ iff} \Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \SAT_0 A,
    \]
    where $\Fr{F} = \t{W_{\Fr{M}},R_{\Fr{M}}}$.
  \end{lemma}

  \begin{proof} by induction on $A$, where quasi-atomic formulas
    have complexity zero.
    \begin{itemize}
      \item[(i)] $A$ is quasi-atomic. By definition \ref{!OPAQUE},
            $V_{\Fr{M}}(A) = \{ \t{w,g} : \Fr{M},w,g \SAT A \}$. So
            $\Fr{M},w,g \SAT A$ iff $\t{w,g} \in V_{\Fr{M}}(A)$, iff
            $F_{\Fr{M}},V_{\Fr{M}},\t{w,g} \SAT_0 A$ by definition \ref{!KRIPKE}.
      \item[(ii)] $A$ is $\neg B$. $\Fr{M},w,g \SAT \neg B$ iff
            $\Fr{M},w,g \not\SAT B$ by definition \ref{!SAT}, iff
            $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \not\SAT_0 B$ by induction hypothesis,
            iff $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \SAT_0\neg B$ by definition
            \ref{!KRIPKE}.
      \item[(iii)] $A$ is $B \then C$. $\Fr{M},w,g \SAT B \then C$ iff
            $\Fr{M},w,g \not\SAT B$ or $\Fr{M},w,g \SAT C$ by definition
            \ref{!SAT}, iff $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \not\SAT_0 B$ or
            $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \SAT_0 C$ by induction hypothesis,
            iff $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \SAT_0 B\then C$ by definition
            \ref{!KRIPKE}.
      \item[(iv)] $A$ is $\Box B$. $\Fr{M},w,g \SAT \Box B$ iff
            $\Fr{M},w',g' \SAT B$ for all $w',g'$ such that $w,g\Img w',g'$
            definition \ref{!SAT}, iff
            $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w',g'} \SAT_0 B$ for all such $w',g'$
            by induction hypothesis, iff
            $\Fr{F}_{\Fr{M}},V_{\Fr{M}},\t{w,g} \SAT_0 \Box B$ by definition
            \ref{!KRIPKE}. \qed
    \end{itemize}
  \end{proof}

  Now suppose that $A$ is a formula of (unimodal) propositional modal logic that
  is valid in all and only the Kripke frames in some class $\mathbb{F}$. We want
  to show that the set of $\Sc{L}$-formulas that result from $A$ by uniformly
  substituting sentence letters by $\Sc{L}$-formulas is valid in all and only
  the counterpart structures $\Fr{S} = \t{W,R,U,D,K}$ whose opaque propositional
  guise is in $\mathbb{F}$.

  We can show that if the guise of $\Fr{S}$ is in $\mathbb{F}$ then any
  substitution instance of $A$ is valid in $\Fr{S}$:
  
  Let $\Fr{S} = \t{W,R,U,D,K}$ be a counterpart structure whose opaque
  propositional guise is in $F$. Suppose for reductio that some formula $A'$ is
  not valid in $\Fr{S}$ that results from $A$ by uniformly substituting the
  sentence letters $p_i$ in $A$ by $\Sc{L}$-formulas $p_i^{\Sc{L}}$. I.e., there
  is a model $\Fr{M} = \t{\Fr{S},I}$ and a world $w\in W$ such that
  $\Fr{M},w,g \not\SAT A'$. By lemma \ref{opaque}, it follows that
  $\Fr{F}_{\Fr{M}},V_{\Fr{M}}\t{w,g} \not\SAT_0 A'$. But $A'$ is a notational
  variant of $A$, with the sentence letters written as quasi-atomic
  $\Sc{L}$-formulas. And $\Fr{F}_{\Fr{M}}$ is in $F$. Contradiction.

  The problem is the converse: show that if $G(\Fr{S})$ is not in $\mathbb{F}$
  then some substitution instance of $A$ is invalid on $\Fr{S}$.

  Let $\Fr{S}$ be a structure whose guise
  $M_{\Fr{S}} = \t{W_{\Fr{S}},R_{\Fr{S}}}$ is not in $F$. We know that there is
  some valuation $V$ on $M_{S}$ and some $\t{w,g} \in W_{S}$ s.t.
  $M_S,V,w,g \not\SAT_{0} A$. $V$ can assign to the proposition letters in $A$
  arbitrary sets of $w,g$ pairs. When ask about validity on $\Fr{S}$, we have to
  mimick this valuation with a substitution of sentences for the proposition
  letters and an interpretation $I$, so that the replacements of the sentence
  letters are true precisely at the $w,g$ pairs at which the original sentence
  letters are true in the guise. But how?

  (Suppose we leave the proposition letters in place (i.e., treat them as 0-ary
  predicates). Then suppose the guise of $\Fr{S}$ is not reflexive because
  although $R$ is reflexive, some things are not their own counterparts:
  $w,d_{1}\not\Img w,d_{1}$. $A$ is $\Box p \to p$. This is valid. What's
  invalid is $\Box Fx \to Fx$.)

  The conjecture could be proved if we could show that whenever a formula is
  valid in all finite truncations of a propositional guise, then it is valid in
  the whole guise. But this isn't true. Consider the formula $\Box \bot$, which
  is valid in $\Fr{S}^*$ iff no point $\t{w,s}$ in $\Fr{S}^*$ can see any point
  $\t{w',s'}$. Assume for some $w,w'$, $wRw'$. Since $\t{w,s}\not R^*\t{w',s'}$,
  we know that there is no $C \in K_{w,w'}$ such that
  $s_1 C s'_1, s_2 C s'_2, \ldots$. In other words, for all $C\in K_{w,w'}$
  there is some $i$ such that $s_i \not C s_i'$. But (as long as $K_{w,w'}$ is
  infinite) this is compatible with the fact that for all $i$ there is a
  $C \in K_{w,w'}$ such that $s_1 C s'_1,\ldots,s_i C s'_i$. Thus the validity
  of $\Box \bot$ in $\Fr{S}^*$ is compatible with its invalidity in all
  truncated fragments of $\Fr{S}^*$.

  -- OK, but $\Box \bot$ isn't a counterexample. If the guise of $\Fr{S}$ has a
  non-blind $w,g$, then $\Box \bot$ is straightforwardly false relative to that
  $w,g$ in $\Fr{S}$.

} %

On page \pageref{p:tarski-semantics}, I mentioned that one could reformulate the
definition of satisfaction from section \ref{sec:models} in terms of infinite
sequences of individuals in place of the assignment functions. To account for
the fact that $\Sc{L}$-formulas really only constrain a finite initial segment
of such sequences, I will now reformulate the semantics in terms of finite
sequences.

\begin{definition}[Rank]{\label{!RANK}}
  Let $\rho$ be some fixed ``alphabetical'' order on the variables of $\Sc{L}$,
  i.e.\ a bijection $\emph{Var} \to \mathbb{N}^+$. I will use $v$ to denote the
  inverse of $\rho$, so that $v_1$ is the alphabetically first variable, $v_2$
  the second, and so on. The \emph{rank} of an $\Sc{L}$-formula $A$ is the
  smallest number $r \in \mathbb{N}$ such that all members of $\var(A)$ have a
  $\rho$-value less than $r$.
\end{definition}

\begin{definition}[$n$-sequential accessibility]{\label{!SEQCR}}
  Given a counterpart structure $\Fr{S} = \t{W,R,U,D,K}$ and number
  $n \in \mathbb{N}$, the \emph{$n$-sequential accessibility relation
    $R^n_{\Fr{S}}$ of $\Fr{S}$} is the binary relation such that
  $\t{w,d_1,\ldots,d_n} R^n_{\Fr{S}} \t{w',d_1',\ldots,d_n'}$ iff $wRw'$ and for
  some $C \in K_{w,w'}$, $d_1Cd_1',\ldots,d_nCd_n'$.
\end{definition}
%
(Note that $R^0_{\Fr{S}} = R$.)

[FIXME: I should use consistent terminology. Isn't this an ``image'' relation? `Image'
isn't a great label.]

\begin{definition}[Finitary satisfaction]{\label{!SATSEQ}}
  Let $A$ be an $\Sc{L}$-formula and $r$ a number greater or equal to $A$'s
  rank. Let $\Fr{M} = \t{W,R,U,D,K,I}$ be a counterpart model, $w$ a member of
  $W$, and $d_1,\ldots,d_r$ (not necessarily distinct) elements of $U_w$. Then
  \begin{semantics}
  \item[$\Fr{M},w,d_1,\ldots,d_r \SAT Px_1\ldots x_n$] iff
    $\t{d_{\rho(x_1)},\ldots,d_{\rho(x_n)}} \in I_w(P)$.
  \item[$\Fr{M},w,d_1,\ldots,d_r \SAT \neg A$] iff
    $\Fr{M},w,d_1,\ldots,d_r \not\SAT A$.
  \item[$\Fr{M},w,d_1,\ldots,d_r \SAT A \then B$] iff
    $\Fr{M},w,d_1,\ldots,d_r \not\SAT A$ or
    $\Fr{M},w,d_1,\ldots,d_r \SAT B$.
  \item[$\Fr{M},w,d_1,\ldots,d_r \SAT \forall x A$] iff
    $\Fr{M},w,d_1',\ldots,d_r' \SAT A$ for all $d_1',\ldots,d_r'$
    such that $d'_{\rho(x)} \in D_w$ and $d_i'=d_i$ for all $i
    \not= \rho(x)$.
  \item[$\Fr{M},w,d_1,\ldots,d_r \SAT \t{y:x} A$] iff
    $\Fr{M},w,d_1',\ldots,d_r' \SAT A$ for all $d_1',\ldots,d_r'$
    such that $d'_{\rho(x)} = d_{\rho(y)}$ and $d'_i = d_i$ for all
    $i\not=\rho(x)$.
  \item[$\Fr{M},w,d_1,\ldots,d_r \SAT \Box A$] iff
    $w',d_1',\ldots,d_r' \SAT A$ for all $w,d_1',\ldots,d_r'$
    such that $\t{w,d_1,\ldots,d_r} R^n_{\Fr{S}} \t{w',d_1',\ldots,d_n'}$,
  \end{semantics}
  where $R^n_{\Fr{S}}$ is the $n$-sequential counterpart relation of $\Fr{S}$.
\end{definition}

It is obvious that this definition is equivalent to that of section
\ref{sec:models}, in the sense that $\Fr{M},w,d_{1},\ldots,d_{r} \SAT A$ iff
$\Fr{M},w,g \SAT A$ whenever $g(v_{i})=d_{i}$ for $1\leq i \leq r$.

\begin{lemma}{\label{truthandsat}}
  For any counterpart model $\Fr{M} = \t{W,R,U,D,K,I}$, world $w\in W$,
  assignment $g$ on $U_{w}$, and formula $A$ of rank $\leq r$, 
  \[
  \Fr{M},w,g \SAT A \text{ iff } \Fr{M},w,g(v_{1}),\ldots,g(v_{r}) \SAT A.
  \]
\end{lemma}

\begin{proof} by induction on  $A$.
  FIXME
  \begin{itemize}

  \item[(i)] $A$ is $Px_1\ldots x_n$. $w,V \SAT_{\Fr{S}} Px_1\ldots
    x_n$ iff $\t{V_w(x_1),\ldots,V_w(x_n)} \in V_w(P)$ by definition
    \ref{!SAT}, iff $\t{d_{\rho(x_1)},\ldots,d_{\rho(x_n)}} \in
    I_w(P)$, iff $x,d_1,\ldots,d_r \SAT_{\Fr{S},I} Px_1\ldots x_n$ by
    definition \ref{!SAT2}.

  \item[(ii)] $A$ is $\neg B$. $w,V \SAT_{\Fr{S}} \neg B$ iff $w,V
    \not\SAT_{\Fr{S}} B$ by definition \ref{!SAT}, iff
    $w,d_1,\ldots,d_r \not\SAT_{\Fr{S},I} B$ by induction hypothesis
    (since $B$ has rank $\leq r$), iff $w,d_1,\ldots,d_r
    \SAT_{\Fr{S},I} \neg B$ by definition \ref{!SAT2}.

  \item[(iii)] $A$ is $B \then C$. $w,V \SAT_{\Fr{S}} B \then C$ iff
    $w,V \not\SAT_{\Fr{S}} B$ or $w,V \SAT_{\Fr{S}} C$ by definition
    \ref{!SAT}, iff $w,d_1,\ldots,d_r \not\SAT_{\Fr{S},I} B$ or
    $w,d_1,\ldots,d_r \SAT_{\Fr{S},I} C$ by induction hypothesis
    (since $B$ and $C$ have rank $\leq r$), iff $w,d_1,\ldots,d_r
    \SAT_{\Fr{S},I} B \then C$ by definition \ref{!SAT2}.

  \item[(iv)] $A$ is $\forall x B$. By definition \ref{!SAT}, $w,V
    \SAT_{\Fr{S}} \forall x B$ iff $w,V'\SAT_{\Fr{S}} B$ for all
    existential $x$-variants $V'$ of $V$ on $w$. By definition
    \ref{!VARIANT}, $V'$ is an existential $x$-variant of $V$ on $w$
    iff $V$ and $V'$ agree on all predicates, $V'_w(x) \in D_w$ and
    $V'_w(y)=V_w(y)$ for all $y\not=x$. Take any such $V'$. By
    induction hypothesis (since $B$ has rank $\leq r$), $w,V'
    \SAT_{\Fr{S}} B$ iff $w,V'_w(v_1),\ldots,V_w'(v_r) \SAT_{\Fr{S},I}
    B$. So $w,V \SAT_{\Fr{S}} \forall x B$ iff
    $w,V'_w(v_1),\ldots,V_w'(v_r) \SAT_{\Fr{S},I} B$ for all $V'$ such
    that $V'_w(x) \in D_w$ and $V'_w(y)=V_w(y)$ for all $y\not=x$. In
    other words, $w,V \SAT_{\Fr{S}} \forall x B$ iff
    $w,d_1',\ldots,d_r' \SAT_{\Fr{S},I} B$ for all $d_1',\ldots,d_r'$
    such that $d_{\rho(x)}' \in D_w$ and $d'_i=d_i$ for all
    $i\not=\rho(x)$, iff $w,d_1,\ldots,d_r \SAT_{\Fr{S},I} \forall xB$
    by definition \ref{!SAT2}.

  \item[(v)] $A$ is $\t{y:x} B$. By definition \ref{!SAT}, $w,V
    \SAT_{\Fr{S}} \t{y:x} B$ iff $w,V'\SAT_{\Fr{S}} B$ where $V'$ is
    the $x$-variant of $V$ on $w$ with $V_w'(x)=V_w(y)$. By induction
    hypothesis (since $B$ has rank $\leq r$), $w,V' \SAT_{\Fr{S}} B$
    iff $w,V_w'(v_1),\ldots,V_w'(v_r) \SAT_{\Fr{S},I} B$. So $w,V
    \SAT_{\Fr{S}} \t{y:x} B$ iff $w,d_1',\ldots,d_r' \SAT_{\Fr{S},I}
    B$ for all $d_1',\ldots,d_r'$ such that $d'_{\rho(x)} =
    d_{\rho(y)}$ and $d'_i = d_i$ for all $i\not=\rho(x)$, iff
    $w,d_1,\ldots,d_r \SAT_{\Fr{S},I} \t{y:x}B$ by definition
    \ref{!SAT2}.

  \item[(vi)] $A$ is $\Box B$. By definition \ref{!SAT}, $w,V
    \SAT_{\Fr{S}} \Box B$ iff $w',V' \SAT_{\Fr{S}} B$ for all $w',V'$
    with $wRw'$ and $V_w \Img V'_{w'}$. By definition \ref{!IMG} and
    totality of $\Fr{S}$ and $V$, the latter holds iff $V'$ and $V$
    agree on all predicates and for some $C\in K_{w,w'}$ and all
    variables $x$, $V_w(x)C V'_{w'}(x)$. Take any such $w',V'$. By
    induction hypothesis (since $B$ has rank $\leq r$), $w',V'
    \SAT_{\Fr{S}} B$ iff $w',V_w'(v_1),\ldots,V_w'(v_r)
    \SAT_{\Fr{S},I} B$. So $w,V \SAT_{\Fr{S}} \Box B$ iff
    $w',V_w'(v_1),\ldots,V_w'(v_r) \SAT_{\Fr{S},I} B$ for all $w',V'$
    with $wRw'$ and $V_w\Img V'_{w'}$, iff $w',d_1',\ldots,d_r'
    \SAT_{\Fr{S},I} B$ for all $w',d_1',\ldots,d_r'$ such that
    $\t{w,d_1,\ldots,d_r} R^n_{\Fr{S}} \t{w',d_1',\ldots,d_n'}$ by definition
    \ref{!SEQCR}, iff $w,d_1,\ldots,d_r \SAT_{\Fr{S},I} \Box B$ by
    definition \ref{!SAT2}. \qed
  \end{itemize}
\end{proof}

\cmnt{%
  We could accommodate negative structures here, but then we'd have to
  define $R^n$ to hold not between world-sequence pairs but between
  pairs of a world and a partial function from numbers to
  individuals. The proof then goes as follows.
  \begin{proof}
  By definitions \ref{!SAT} and \ref{!IMG}, $w,V \SAT_{\Fr{S}} \Box
  A(x_1,\ldots,x_n)$ iff
  \begin{itemize}
  \item[(1)] $w',V' \SAT_{\Fr{S}} A(x_1,\ldots,x_n)$ for all $w',V'$
    such that $wRw'$ and for some $C\in K_{w,w'}$ and all variables
    $x$, either $V_w(x)$ is $C$-related to $V'_{w'}(x)$ or there is no
    $d$ to which $V_w(x)$ is $C$-related in which case $V'_{w'}(x)$ is
    undefined.
  \end{itemize}
  By lemma \ref{locality}, it doesn't matter what $V'$ assigns to
  variables not in $A(x_1,\ldots,x_n)$. So (1) is equivalent to
  \begin{itemize}
  \item[(2)] $w',V' \SAT_{\Fr{S}} A(x_1,\ldots,x_n)$ for all $w',V'$
    such that $wRw'$ and for some $C\in K_{w,w'}$ and all variables
    $x_i \in x_1,\ldots,x_n$, either $V_w(x_i)$ is $C$-related to
    $V'_{w'}(x_i)$ or there is no $d$ to which $V_w(x_i)$ is
    $C$-related in which case $V'_{w'}(x_i)$ is undefined.
  \end{itemize}
  By definition \ref{!SEQCR},
  $\t{w,V_w(x_1,\ldots,x_n)}R^*\t{w',V'_{w'}(x_1,\ldots,x_n)}$ iff
  $wRw'$ and for some $C\in K_{w,w'}$ and all variables $x_i \in
  x_1,\ldots,x_n$, either $V_w(x_i)$ is $C$-related to $V'_{w'}(x_i)$
  or there is no $d$ to which $V_w(x_i)$ is $C$-related in which case
  $V'_{w'}(x_i)$ is undefined. So (2) is equivalent to
  \begin{itemize}
  \item[(3)] $w',V' \SAT_{\Fr{S}} A(x_1,\ldots,x_n)$ for all $w',V'$
    such that
    $\t{w,V_w(x_1,\ldots,x_n)}R^*\t{w',V'_{w'}(x_1,\ldots,x_n)}$. \qed
  \end{itemize}
\end{proof}
} %

\cmnt{%
  I could include the substitution operator in the language here. I wouldn't
  make any difference.

  Definition \ref{!SATSEQ} looks just like standard Kripke semantics for a
  propositional modal language with multiple box operators $\Box$,
  $\forall v_1,\ldots,\forall v_r$,
  $\t{v_1:v_1},\t{v_1:v_2},\ldots,\t{v_r:v_r}$, all governed by their own
  accessibility relation between points of the form $w,d_1,\ldots,d_r$. (As
  mentioned on p.\ \pageref{kuhn}, there is a bit of redundancy here: if we have
  substitution operators, a single box operator $\forall v_1$ would be enough.)

  Clearly the evaluation of a formula whose only box operator is $\Box$ does not
  depend on the accessibility relations associated with the quantificational box
  operators ($\forall x$, $\t{y:x}$). As we will see, the same is true if we
  consider the evaluation of modal \emph{schemas} like $\Box A \then A$, i.e.\
  the set of formulas that result from $\Box p \then p$ by uniformly
  substituting arbitrary $\Sc{L}$-formulas for $p$. In this way, every purely
  modal schema corresponds to a constraint on the sequential accessibility
  relations in counterpart structures.
} %

Now recall that $\Sc{L}$-formulas can be regarded as formulas of propositional
modal logic, with strangely complicated ``sentence letters''. In a similar way,
counterpart models for QML can be regarded as disguised Kripke models for
propositional modal logic. The ``worlds'' in these Kripke models are finite
sequences of worlds and individuals from the counterpart model.

\begin{definition}[N-ary Opaque Propositional Guise]{\label{!OPAQUE}}
  The \emph{$n$-ary opaque propositional guise of a counterpart structure}
  $\Fr{S}=\t{W,R,U,D,K}$ is the Kripke frame $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}}$
  where $W^n_{\Fr{S}}$ is the set of points $\t{w,d_1,\ldots,d_n}$ such that
  $w\in W, d_1 \in U_w, \ldots, d_n\in U_w$, and $R^n_{\Fr{S}}$ is the
  $n$-ary accessibility relation for $\Fr{S}$.

  The \emph{$n$-ary opaque propositional guise of a predicate interpretation
    $I$} on $\Fr{S}$ is the valuation function $V^n_{\Fr{S}}$ on
  $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}}$ such that for every quasi-atomic formula
  $A \in \Sc{L}$,
  $V^n_{\Fr{S}}(A) = \{ \t{w,d_1,\ldots,d_n} : w,d_1,\ldots,d_n \SAT A \}$.
\end{definition}

\begin{lemma}[Truth-preservation under opaque guises]\label{opaque}
  For any positive counterpart model $\Fr{M}=\t{W,R,U,D,K,I}$, world $w \in W$,
  individuals $d_1,\ldots,d_n \in U_w$, and $\Sc{L}$-formula $A$ with rank
  $\leq n$,
  \[
    \Fr{M},w,d_1,\ldots,d_n \SAT A \text{ iff
    } \Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \SAT_0 A,
  \]
  where $\Fr{S}^n$ and $V^n$ are the $n$-ary opaque propositional
  guises of $\Fr{S}$ and $I$ respectively.
\end{lemma}

\begin{proof} by induction on $A$, where quasi-atomic formulas all
  have complexity zero.
  FIXME:CHECK
  \begin{itemize}
  \item[(i)] $A$ is quasi-atomic. By definition \ref{!OPAQUE}, $V^n(A)
    = \{ \t{w,d_1,\ldots,d_n} : w,d_1,\ldots,d_n \SAT_{\Fr{S},I} A
    \}$. So $w,d_1,\ldots,d_n \SAT_{\Fr{S},I} A$ iff
    $\t{w,d_1,\ldots,d_n} \in V^n(A)$, iff
    $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \SAT_0 A$ by definition
    \ref{!KRIPKE}.
  \item[(ii)] $A$ is $\neg B$. $w,d_1,\ldots,d_n \SAT_{\Fr{S},I} \neg
    B$ iff $w,d_1,\ldots,d_n \not\SAT_{\Fr{S},I} B$ by definition
    \ref{!SAT2}, iff $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \not\SAT_0 B$
    by induction hypothesis, iff $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n}
    \SAT_0\neg B$ by definition \ref{!KRIPKE}.
  \item[(iii)] $A$ is $B \then C$. $w,d_1,\ldots,d_n \SAT_{\Fr{S},I} B
    \then C$ iff $w,d_1,\ldots,d_n \not\SAT_{\Fr{S},I} B$ or
    $w,d_1,\ldots,d_n \SAT_{\Fr{S},I} C$ by definition \ref{!SAT2},
    iff $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \not\SAT_0 B$ or
    $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \SAT_0 C$ by induction
    hypothesis, iff $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \SAT_0 B\then
    C$ by definition \ref{!KRIPKE}.
  \item[(iv)] $A$ is $\Box B$. $w,d_1,\ldots,d_n \SAT_{\Fr{S},I} \Box
    B$ iff $w',d_1',\ldots,d_n' \SAT_{\Fr{S},I} B$ for all
    $w,d_1',\ldots,d_r'$ such that $\t{w,d_1,\ldots,d_r} R^n_{\Fr{S}}
    \t{w',d_1',\ldots,d_n'}$ by definition \ref{!SAT2}, iff
    $\Fr{S}^*,V^*,\t{w',d_1',\ldots,d_n'} \SAT_0 B$ for all such
    $w,d_1',\ldots,d_r'$ by induction hypothesis, iff
    $\Fr{S}^*,V^*,\t{w,d_1,\ldots,d_n} \SAT_0 \Box B$ by definition
    \ref{!KRIPKE}. \qed
  \end{itemize}
\end{proof}

\begin{lemma}[Finite correspondence transfer]{\label{ncorrtrans}}
  If $A$ is a formula of (unimodal) propositional modal logic that is valid in
  all and only the Kripke frames in some class $F$, and $n \in \mathbb{N}$, then
  the set of $\Sc{L}$-formulas that result from $A$ by uniformly substituting
  sentence letters by $\Sc{L}$-formulas of rank $\leq n$ is valid in all and
  only the total counterpart structures $\Fr{S} = \t{W,R,U,D,K}$ whose $n$-ary
  opaque propositional guise is in $F$.
\end{lemma}

\begin{proof}
  FIXME:CHECK
  
  Assume $A$ is valid in all and only the Kripke frames in $F$, and let
  $p_1,\ldots,p_k$ be the sentence letters in $A$. Let $\Fr{S} = \t{W,R,U,D,K}$
  be a total counterpart structure whose $n$-ary opaque propositional guise
  $\t{W^n_{\Fr{S}}, R^n_{\Fr{S}}}$ is in $F$. Suppose for reductio that some
  formula $A'$ is not (positively) valid in $\Fr{S}$ that results from $A$ by
  uniformly substituting the sentence letters $p_i$ in $A$ by $\Sc{L}$-formulas
  $p_i^{\Sc{L}}$ of rank $\leq n$. Then there is an interpretation $V$ on
  $\Fr{S}$ and a world $w\in W$ such that $w,V \not\SAT_{\Fr{S}} A'$. By lemma
  \ref{truthandsat}, this means that $w,d_1,\ldots,d_r \not\SAT_{\Fr{S},I} A'$,
  where $I$ is $V$ restricted to predicates and
  $d_1=V_w(v_1),\ldots,d_r=V_w(v_r)$. By lemma \ref{opaque}, it follows that
  $\Fr{S}^n,V^n,\t{w,d_1,\ldots,d_n} \not\SAT_0 A'$. But then
  $\Fr{S}^n,{V^n}',\t{w,d_1,\ldots,d_n} \not\SAT_0 A$, where ${V^n}'$ is such
  that for all sentence letters $p_i$ in $A$, ${V^n}'(p_i) = V^n(p_i^{\Sc{L}})$.
  This contradicts the assumption that $A$ is valid in
  $\t{W^n_{\Fr{S}}, R^n_{\Fr{S}}}$.

  We also have to show that the relevant $\Sc{L}$-formulas are valid \emph{only}
  in structures $\Fr{S}$ whose $n$-ary opaque propositional guise is in $F$. So
  let $\Fr{S}$ be a structure whose guise $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}}$ is not
  in $F$. Since $A$ is valid only in frames in $F$, we know that there is some
  valuation $V$ on $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}}$ and some
  $\t{w,d_1,\ldots,d_n} \in W^n_{\Fr{S}}$ such that
  $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w,d_1,\ldots,d_n} \not\SAT_0 A$. Let $A'$
  result from $A$ by uniformly substituting each sentence letter $p_i$ in $A$ by
  an $n$-ary predicate $P_i$ followed by the variables $v_1\ldots v_n$, with
  distinct predicates for distinct sentence letters. Let $I$ be a predicate
  interpretation such that for all $P_i$ and $w'\in W$,
  $I_{w'}(P_i) = \{ \t{d_1',\ldots,d_n'} : \t{w',d_1',\ldots,d_n'} \in V(p_i) \}$.
  A simple induction on subformulas $B$ of $A$ shows that for all
  $\t{w',d_1',\ldots,d_n'} \in W^n_{\Fr{S}}$,
  $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'} \SAT_0 B$ iff
  $w',d_1',\ldots,d_n' \SAT B'$, where $B'$ is $B$ with all $p_i$ replaced by
  $P_i v_1\ldots v_n$. Given that
  $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w,d_1,\ldots,d_n} \not\SAT_0 A$ it follows
  that $w,d_1,\ldots,d_n \not\SAT_{\Fr{S},I} A'$.
  \begin{enumerate}
  \item[(i)] $B$ is a sentence letter $p_i$. Then $B'$ is $P_i v_1
    \ldots v_n$. $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'} \SAT_0 p_i$
    iff $\t{w',d_1',\ldots,d_n'}\in V(p_i)$ by definition \ref{!KRIPKE},
    iff $\t{d_1',\ldots,d_n'} \in I_w(P_i)$ by construction of $I$,
    iff $w',d_1',\ldots,d_n' \SAT_{\Fr{S},I} P_iv_1\ldots v_n$ by
    definition \ref{!SAT2}.
  \item[(ii)] $B$ is $\neg C$. Then $B'$ is $\neg C'$, where $C'$ is
    $C$ with all $p_i$ replaced by $P_i v_1\ldots
    v_n$. $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'} \SAT_0 \neg C$ iff
    $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'} \not\SAT_0 C$ by
    definition \ref{!KRIPKE}, iff $w',d_1',\ldots,d_n'
    \not\SAT_{\Fr{S},I} C'$ by induction hypothesis, iff
    $w',d_1',\ldots,d_n' \SAT_{\Fr{S},I} \neg C'$ by definition
    \ref{!SAT2}.
  \item[(iii)] $B$ is $C \then D$. Then $B'$ is $C' \then D'$, where
    $C'$ and $D'$ are $C$ and $D$ respectively with all $p_i$ replaced
    by $P_i v_1\ldots v_n$. $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'}
    \SAT_0 C \then D$ iff $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'}
    \not\SAT_0 C$ or $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'} \SAT_0 D$
    by definition \ref{!KRIPKE}, iff $w',d_1',\ldots,d_n'
    \not\SAT_{\Fr{S},I} C'$ or $w',d_1',\ldots,d_n' \SAT_{\Fr{S},I}
    D'$ by induction hypothesis, iff $w',d_1',\ldots,d_n'
    \SAT_{\Fr{S},I} C' \then D'$ by definition \ref{!SAT2}.
  \item[(iv)] $B$ is $\Box C$. Then $B'$ is $\Box C'$, where $C'$ is
    $C$ with all $p_i$ replaced by $P_i v_1\ldots
    v_n$. $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w',d_1',\ldots,d_n'} \SAT_0 \Box C$ iff
    $\t{W^n_{\Fr{S}},R^n_{\Fr{S}}},V,\t{w'',d_1'',\ldots,d_n''} \SAT_0 C$ for all
    $\t{w'',d_1'',\ldots,d_n''}$ with
    $\t{w',d_1',\ldots,d_n'}R^n_{\Fr{S}}\t{w'',d_1'',\ldots,d_n''}$ by
    definition \ref{!KRIPKE}, iff $w'',d_1'',\ldots,d_n''
    \not\SAT_{\Fr{S},I} C'$ for all such $\t{w'',d_1'',\ldots,d_n''}$
    by induction hypothesis, iff $w',d_1',\ldots,d_n' \SAT_{\Fr{S},I}
    \Box C'$ by definition \ref{!SAT2}. \qed
  \end{enumerate}
\end{proof}

Given that a modal schema restricted to the variables $v_1,\ldots,v_n$ defines a
constraint on the $n$-sequential accessibility relation of a counterpart
structure $\Fr{S}$, the unrestricted schema defines a constraint on all
sequential accessibility relations. Let's fold these into a single entity.

\begin{definition}[Sequential accessibility relation]{\label{!SEQR}}
  The \emph{sequential accessibility relation} $R^*_{\Fr{S}}$ of a total
  counterpart structure $\Fr{S}$ is the union of the $n$-sequential
  accessibility relations $R^n_{\Fr{S}}$ of $\Fr{S}$, i.e.
  $R^*_{\Fr{S}} = \bigcup_{n\in \mathbb{N}} R^n_{\Fr{S}}$.
\end{definition}

\begin{definition}[Opaque Propositional Guise]{\label{!OPAQUE}}
  The \emph{total opaque propositional guise of a counterpart structure}
  $\Fr{S}=\t{W,R,U,D,K}$ is the disjoint union of the $n$-ary opaque
  propositional guises of $\Fr{S}$, i.e.\ the Kripke frame
  $\t{W^*_{\Fr{S}},R^*_{\Fr{S}}}$ such that $R^*_{\Fr{S}}$ is the sequential
  accessibility relation of $\Fr{S}$ and $W^*_{\Fr{S}}$ is the set of
  points $w^*$ such that for some $n\in \mathbb{N}$, world $w\in W$ and
  individuals $d_1,\ldots,d_n \in U_w$, $w^* = \t{w,d_1,\ldots,d_n}$.
\end{definition}

\begin{theorem}[(Positive) correspondence transfer]{\label{corrtrans}}
  If $A$ is a formula of (unimodal) propositional modal logic that is valid in
  all and only the Kripke frames in some class $F$, then the set of
  $\Sc{L}$-formulas that result from $A$ by uniformly substituting sentence
  letters by $\Sc{L}$-formulas is positively valid in all and only the total
  counterpart structures $\Fr{S}$ whose opaque propositional guise is in $F$.
\end{theorem}

\begin{proof}
  FIXME:CHECK
  Since validity in propositional modal logic is preserved under
  disjoint unions, $A$ is valid in the opaque propositional guise of a
  structure $\Fr{S}$ iff $A$ is valid in each $n$-ary opaque
  propositional guise of $\Fr{S}$, with $n\in \mathbb{N}$. (See e.g.\
  \cite{blackburn01modal}, p.140, Theorem 3.14.(i).) Thus the opaque
  propositional guise of $\Fr{S}$ is in $F$ iff all $n$-ary opaque
  propositional guises of $\Fr{S}$ are in $F$.

  Assume $A$ is valid in all and only the Kripke frames in $F$. Let
  $A'$ be an $\Sc{L}$-formula that results from $A$ by uniformly
  substituting sentence letters by $\Sc{L}$-formulas. By lemma
  \ref{ncorrtrans}, $A'$ is (positively) valid in all total
  counterpart structures $\Fr{S}$ whose $n$-ary propositional guise is
  in $F$, where $n$ is the rank of $A'$. Any total structure whose
  propositional guise is in $F$ satisfies this condition.

  To show that the $A$ schema is valid \emph{only} in structures
  $\Fr{S}$ whose guise is in $F$, let $\Fr{S}$ be a structure whose
  guise is not in $F$. Then there is some $n$ such that the $n$-ary
  guise of $\Fr{S}$ is not in $F$. By lemma \ref{ncorrtrans}, there is
  an $\Sc{L}$-substitution instance $A'$ of $A$ with rank $n$ that is
  not valid in $\Fr{S}$. \qed
\end{proof}

As a union of relations of different arity, $R^*$ is a somewhat gerrymandered
entity. It may help to understand statements about $R^*$ as universal statements
about its members $R^n$. For example, the schema $\Box A \then A$ is valid iff
(0) every world can see itself and (1) every individual at every world is its
own counterpart (relative to some counterpart relation), (2) every pair of
individuals at every world is its own counterpart, and so on. Each clause ($i$)
covers instances of the schema with $i$ free variables.


Thus far, I have set aside negative counterpart models. In negative
models, variables can be undefined, so sequential accessibility
relations must be redefined to hold between pairs of a world $w$ and a
possibly \emph{gappy} sequence of individuals from $D_w$, i.e.\ a
partial function from numbers to members of $D_w$. Now we could re-run
the above arguments, but we can also cut all this short by using lemma
\ref{transpose}.

\begin{definition}[Opaque Propositional Guise of Negative Models]{\label{!OPAQUE}}
  The \emph{opaque propositional guise of a negative counterpart
    model} $\Fr{M}$ is the opaque propositional guise of its
  positive transpose $\Fr{M}^+$. Accordingly, the \emph{sequential
    accessibility relation $R^*_{\Fr{M}}$ of $\Fr{M}$} is the
  sequential accessibility relation of $\Fr{M}^+$.
\end{definition}

\begin{corollary}[Negative correspondence transfer]{\label{corrtransn}}
  If $A$ is a formula of (unimodal) propositional modal logic that is
  valid in all and only the Kripke frames in some class $F$, then the
  set of $\Sc{L}$-formulas that result from $A$ by uniformly
  substituting sentence letters by $\Sc{L}$-formulas is negatively
  valid in all and only the single-domain counterpart structures
  $\Fr{S}$ whose opaque propositional guise is in $F$.
\end{corollary}

\begin{proof}
  FIXME
  Assume $A$ is valid in all and only the Kripke frames in $F$. Let
  $A'$ be an $\Sc{L}$-formula that results from $A$ by uniformly
  substituting sentence letters by $\Sc{L}$-formulas. Let $\Fr{S}$ be
  a single-domain counterpart structure whose guise is in $F$, and let
  $w,V$ be a world from $\Fr{S}$ and a partial interpretation on
  $\Fr{S}$. By lemma \ref{transpose}, $w,V \SAT_{\Fr{S}} A'$ iff
  $w,V^+ \SAT_{S^+} A'$. By theorem \ref{corrtrans}, $w,V^+
  \SAT_{\Fr{S}^+} A'$. So $A'$ is negatively valid in $\Fr{S}$.

  Now let $\Fr{S}$ be a structure whose guise is not in $F$. By
  theorem \ref{corrtrans}, there is a substitution instance $A'$ of
  $A$, a world $w$ and a total interpretation $V'$ on $\Fr{S}^+$ such
  that $w,V' \not\SAT_{\Fr{S}^+} A'$. Define $V$ so that $V$ and $V'$
  agree on all predicates and for all worlds $w'$ and variables $x$,
  $V_{w'}(x)$ is $V'_{w'}(x)$ if $V'_{w'}(x) \in D_w$, otherwise
  $V_{w'}(x)$ is undefined. Then $V'$ is the positive transpose of
  $V$. By lemma \ref{transpose}, $w,V \SAT_{\Fr{S}} A'$ iff $w,V'
  \SAT_{S^+} A'$. So $w,V \not\SAT_{\Fr{S}} A'$. So $A'$ is not
  negatively valid in $\Fr{S}$. \qed
\end{proof}


% Here are some applications of theorems \ref{corrtrans} and
% \ref{corrtransn}.

% \begin{corollary}[Correspondence facts]{\label{correx}}
%   \begin{enumerate}
%   \item The schema $\Box A \then A$ is valid in a counterpart
%     structure $\Fr{S}$ iff $R^*_{\Fr{S}}$ is reflexive.
%   \item The schema $A \then \Box\Diamond A$ is valid in a
%     counterpart structure $\Fr{S}$ iff $R^*_{\Fr{S}}$ is symmetrical.
%   \item The schema $\Box A \then \Box\Box A$ is valid in a
%     counterpart structure $\Fr{S}$ iff $R^*_{\Fr{S}}$ is transitive.
%   \item The schema $\Diamond A \then \Box\Diamond A$ is valid in a
%     counterpart structure $\Fr{S}$ iff $R^*_{\Fr{S}}$ is euclidean.
%   \end{enumerate}
% \end{corollary}


There are of course further aspects of structures that can only be
captured in quantified modal logic.

\begin{definition}[Types of structures]
  A structure $\Fr{S} = \t{W,R,U,D,K}$ is
  \begin{itemize}
  \item[\textnormal{\emph{total}}] if every individual at every world
    has at least one counterpart at every accessible world: whenever
    $wRw'$ and $d\in U_w$ then there is a $d' \in U_{w'}$ with
    $\t{d,w}C\t{d',w'}$;
  \item[\textnormal{\emph{functional}}] if every individual at every
    world has at most one counterpart at every accessible world;
  \item[\textnormal{\emph{inversely functional}}] if no two
    individuals at any world have a common counterpart at some
    accessible world;
  \item[\textnormal{\emph{injective}}] if it is both functional and
    inversely functional.
  \end{itemize}
\end{definition}

[TODO: define a correspondence language and show some general correspondence
results with it?]

\cmnt{%

  To get clearer on exactly what it means for a given formula to be valid in a
  class of structures, let's construct a non-modal language $\Sc{L}_c$ (the
  \emph{correspondence language}) to talk about counterpart structures and
  models. The language is built in stages. Here is the first part.

\begin{definition}[Simple correspondence language]{\label{!CLSIMPLE}}
  Given a language $\Sc{L}$ of quantified modal logic, the
  \emph{simple correspondence language} $\Sc{L}_c$ is a non-modal
  first-order language with two (distinct) sorts of variables,
  $\emph{Var}$ for individuals and $\emph{Var}_\omega$ for worlds,
  both denumerable. Every non-logical predicate $P$ of $\Sc{L}$ is
  also a predicate of $\Sc{L}_c$, where it has a further argument
  place for a world. In addition, $\Sc{L}_c$ has the standard binary
  identity predicate for individuals, a binary predicate $E$
  expressing existence of an individual at a world, and, for each
  $n\geq 0$, a $(2n)+2$-ary predicates $R^n$ applying to a pair of
  worlds and $2n$ individuals: $\omega R^0\omega'$ says that $\omega'$
  is accessible from $\omega$, $\omega xR^1\omega'x'$ that $x'$ at
  $\omega'$ is a counterpart of $x$ at $\omega$, and so on.
\end{definition}

From now on, let $\Sc{L}$ be any fixed language of quantified modal
logic (with or without substitution).

\begin{definition}[Standard translation]{\label{!ST}}
  The \emph{standard translation} $\trans{\cdot}$ maps formulas of
  $\Sc{L}$ to formulas of $\Sc{L}_c$ such that
  \begin{align*}
    \trans{Px_1\ldots x_n} &= P\omega x_1\ldots x_n\\
    \trans{x\!=\!y} &= x\!=\!y\\
    \trans{\neg A} &= \neg \trans{A}\\
    \trans{A\then B} &= \trans{A} \then \trans{B}\\
    \trans{\forall x A} &= \forall x(E\omega x \then \trans{A})\\
    \trans{\t{y:x}A} &= \forall x(y\!=\!x \then \trans{A})\\
    \trans{\Box A} &= \forall \omega' \forall x_1'\ldots x_n'(\omega x_1\ldots x_n R^n \omega' x_1'\ldots x_n' \then [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n]\trans{A}),
  \end{align*}
  where $x_1,\ldots,x_n$ are the free individual variables in
  $\trans{A}$ and $\omega',x_1',\ldots,x_n'$ are (the alphabetically
  first) distinct variables not in $Var(\trans{A})$.
\end{definition}

A few examples:
\begin{align*}
  \trans{\Box Fx} &= \forall \omega' \forall x'(\omega x R \omega' x'
  \then F\omega' x').\\
  \trans{\Box x\!=\!y} &= \forall \omega' \forall x'\forall y'(\omega
  xy R \omega' x'y' \then x'\!=\!y').\\
  \trans{\Box \Box Fx} &= \forall \omega' \forall x'(\omega x R
  \omega' x' \then (\forall \omega'' \forall x''(\omega' x' R \omega''
  x''  \then F\omega' x'')).\\
  \trans{\Box Fx \then Fx} &= \forall \omega' \forall x'(\omega x R
  \omega' x' \then F\omega' x') \then F\omega x.
\end{align*}

\cmnt{%
  A few notes on existence and identity. In a counterpart structure,
  contingent identity is only ``superficial'' in the sense that an
  individual $d$ in the domain of a world $w$ never occurs as two
  individuals at another world $w'$; if $d$ has two counterparts at
  $w'$, these two members of $D_w$ are not both $d$. The
  correspondence language looks at such a structure from God's point
  of view; its quantifiers range over all individuals in all domains,
  and its statements are true or false not relative to a world but
  relative to the whole model. Since individuals can have different
  properties at different worlds, predicates carry an additional
  argument place for worlds. What about the identity predicate?
  Suppose $x=y$ is true in $\Sc{L}$ at $w$. Does it follow that $x=y$
  is true in $\Sc{L}$ fullstop, or do we have to say $\omega x=y$ to
  indicate at which world the identity holds (as we do for $Gxy$ which
  turns into $G\omega xy$)? Well, if $x=y$ is true in $\Sc{L}$ at $w$,
  then `$x$' and `$y$' denote the same individual in $D_w$, both in
  the pointed model of $\Sc{L}$ centred on $w$ and in the
  corresponding model of $\Sc{L}_c$. So $x=y$ is true absolutely. Of
  course, $x=y$ can be false at another world $w'$ considered as
  counterfactual, but this is captured by the fact that some
  counterparts of $x$ and $y$ are non-identical, at most one of which
  is identical to the original individual $d$ at $w$. (By contrast,
  $Gxy$ can be false at $w'$ and true at $w$ even though the only
  counterpart of $d$ at $w'$ is $d$ itself; so here we must add an
  additional world variable.)

  In $\Sc{L}_c$, existence of $x$ at $w$ is obviously not expressed by
  $\exists y(x\!=\!y)$, which is trivially true. We need a basic
  predicate $E$ to express existence and translate the inner
  quantifiers of $\Sc{L}$. Note that $Ex = \exists y(x\!=\!y)$
  translates into $\exists y(E \omega y \land x\!=\!y)$, which is
  equivalent to $E \omega x$.%

} %

Note that $\Sc{L}$-statements of the form $Ex$, which abbreviates
$\exists y(x\!=\!y)$, translate into $\exists y(E\omega y \land
x\!=\!y)$, which is equivalent in first-order logic to $E\omega
x$. Since the $\Sc{L}_c$-quantifiers range over all individuals in all
domains, world-relative existence has to be taken as primitive in
$\Sc{L}_c$.

A standard first-order model for $\Sc{L}_c$ consists of
\begin{enumerate}
\item[(i)] two non-empty sets $W,U$,
\item[(ii)] a predicate interpretation $I$ mapping each $P \in
  \emph{Pred}$ to a subset of $W \times U^n$, $E$ to the set of pairs
  $\t{w,d\in D_w}$, and each $R^n$ to a subset of $W \times U^n \times
  W \times U^n$,
\item[(iii)] a variable interpretation $\Sigma$ mapping each world
  variable $\omega \in \emph{Var}_\omega$ to a member of $W$ and each
  individual variable $x \in \emph{Var}$ to a member of $U$.
\end{enumerate}
A variable interpretation $\Sigma$ can be identified with a pair
$\t{v,s}$ of non-gappy sequences, one on $W$ and one on $U$. Every
positive counterpart model obviously provides a model of this
kind. (In negative models, variables can be empty, which isn't
possible in standard first-order logic, so for now we have to restrict
ourselves to positive models. I will use $W,U,I,v,s A$ to say that the
$\Sc{L}_c$-formula $A$ is true relative to $W,U,I,v,s$.

\begin{definition}[Induced Correspondence Models]{\label{!MODCORR}}
  Let $\Fr{S} = \t{W,R,U,D,K}$ be a total counterpart structure, $V$ a
  total interpretation $V = \t{I,\Sigma}$ for $\Sc{L}$ on $\Fr{S}$,
  and $w^*$ a world in $W$. Then the \emph{$\Sc{L}_c$-model
    $\t{W',U',I',\Sigma'}$ induced by $\Fr{S},V,w^*$} is defined as
  follows:
  \begin{enumerate}
  \item $W' = W$,
  \item $U' = \bigcup_w U_w$,
  \item for all $P \in \emph{Pred}$, $I'(P) = \{
    \t{w,d_1,\ldots,d_n} : \t{d_1,\ldots,d_n} \in I_w(P) \}$,
  \item for all $n \geq 0$, $I'(R^n) = \{
    \t{w,d_1,\ldots,d_n,w',d_1',\ldots,d_n'} : wRw'$ and for some $C \in
    K_{w,w'}$, $d_1Cd_1', \ldots, d_nCd_n'$ $\}$,
  \item for all $x \in \emph{Var}$, $\Sigma'(x) = V_{w^*}(x)$,
  \item for all $\omega \in \emph{Var}_\omega$, $\Sigma'(\omega) = w^*$.
  \end{enumerate}
\end{definition}

Now the crucial fact about the standard translation is that it
preserves truth:

\begin{theorem}[Local Model Correspondence]{\label{localcorr}}
  For any total counterpart structure $\Fr{S} = \t{W,R,U,D,K}$, total
  interpretation $V=\t{I,\Sigma}$ of $\Sc{L}$ on $\Fr{S}$, world $w
  \in W$, non-gappy sequence $s$ on $U_w$ and formula $A$ of $\Sc{L}$,
  \[
  \Fr{S},I,w,s \SAT A \text{ iff } W,U',I',w^\infty,s \SAT \trans{A},
  \]
  where $\t{W,U',I',\Sigma'}$ is the $\Sc{L}_c$-model induced by
  $\Fr{S},V,w$ and $w^\infty$ is the sequence on $W$ consisting
  entirely of infinitely many copies of $w$. Thus in particular
  $\Fr{S},I,w,\Sigma_w \SAT A$ iff $W,U',I',\Sigma' \SAT \trans{A}$.
\end{theorem}

\begin{proof} by induction on $A$.
  \begin{enumerate}
  \item[(i)] $A$ is $Px_1\ldots x_n$. $\Fr{S},I,w,s \SAT Px_1\ldots
    x_n$ iff $\t{s(x_1),\ldots,s(x_n)} \in I_w(P)$ by definition
    \ref{!SAT2}, iff $\t{w,s(x_1),\ldots,s(x_n)} \in I'(P)$ by
    definition \ref{!MODCORR}, iff $W,U',I',w^\infty,s \SAT P\omega
    x_1\ldots x_n$ by the semantics of $\Sc{L}_c$.
  \item[(ii)] $A$ is $x\!=\!y$. $\Fr{S},I,w,s \SAT x\!=\!y$ iff
    $s(x_1) = s(x_n)$ by definition \ref{!SAT2} and the fact that
    $I_w(=) = \{ \t{d,d} : d\in U_w\}$, iff $W,U',I',w^\infty,s \SAT
    x\!=\!y$ by the semantics of $\Sc{L}_c$.
  \item[(iii)] $A$ is $\neg B$. $\Fr{S},I,w,s \SAT \neg B$ iff
    $\Fr{S},I,w,s \not\SAT B$ by definition \ref{!SAT2}, iff
    $W,U',I',w^\infty,s \not\SAT B$ by induction hypothesis, iff
    $W,U',I',w^\infty,s \SAT \neg B$ by the semantics of $\Sc{L}_c$.
  \item[(iv)] $A$ is $B \then C$. $\Fr{S},I,w,s \SAT B \then C$ iff
    $\Fr{S},I,w,s \not\SAT B$ or $\Fr{S},I,w,s \SAT C$ by definition
    \ref{!SAT2}, iff $W,U',I',w^\infty,s \not\SAT B$ or $W,U',I',w^\infty,s
    \SAT C$ by induction hypothesis, iff $W,U',I',w^\infty,s \SAT B \then
    C$ by the semantics of $\Sc{L}_c$.
  \item[(v)] $A$ is $\forall xB$, so $\trans{A} = \forall x(E\omega x
    \then \trans{B})$.  By definition \ref{!SAT2}, $\Fr{S},I,w,s \SAT
    \forall x B$ iff $\Fr{S},I,w,s' \SAT B$ for all existential
    $x$-variants $s'$ of $s$ on $w$, i.e.\ for all sequence $s'$ on
    $w$ such that $s'_x \in D_w$ and $s'_y=s_y$ for all variables
    $y\not=x$. By induction hypothesis, $\Fr{S},I,w,s' \SAT B \text{
      iff } W,U',I',w^\infty,s' \SAT \trans{B}$, for all such $s'$. By the
    semantics of $\Sc{L}_c$, $W,U',I',w^\infty,s \SAT \forall x (E\omega x
    \then \trans{B})$ iff for all $x$-variants $s'$ of $s$,
    $W,U',I',w^\infty,s' \SAT E\omega x \then \trans{B}$, i.e.\ either
    $W,U',I',w^\infty,s' \not\SAT E\omega x$ or $W,U',I',w^\infty,s' \SAT
    \trans{B}$. Since $W,U',I',w^\infty,s' \SAT E\omega x$ iff $s'_x \in
    D_w$, this means that $W,U',I',w^\infty,s \SAT \forall x (E\omega
    x \then \trans{B})$ iff $W,U',I',w^\infty,s' \SAT \trans{B}$ for all
    existential $x$-variants of $s$ on $w$.
  \item[(vi)] $A$ is $\t{y:x}B$, so $\trans{A} = \forall y(y\!=\!x
    \then \trans{B})$.  $\Fr{S},I,w,s \SAT \t{y:x} B$ iff
    $\Fr{S},I,w,s' \SAT B$ for all $x$-variants $s'$ of $s$ with
    $s'_x=s_y$ by definition \ref{!SAT2}, iff $W,U',I',w^\infty,s' \SAT
    \trans{B}$ for all such $s'$ by induction hypothesis, iff
    $W,U',I',w^\infty,s \SAT \forall y(y\!=\!x \then \trans{B})$ by the
    fact that $W,U',I',w^\infty,s \SAT \forall y(y\!=\!x \then \trans{B})$
    iff $W,U',I',w^\infty,s' \SAT y\!=\!x \then \trans{B}$ for all
    $y$-variants $s'$ of $s$.
  \item[(vii)] $A$ is $\Box B$. Let $x_1,\ldots,x_n$ be the (distinct)
    free individual variables in $\trans{B}$, so that $\trans{A} =
    \forall \omega' \forall x_1'\ldots x_n'(\omega x_1\ldots x_n R
    \omega' x_1'\ldots x_n' \then
    [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n]\trans{B})$, where
    $\omega',x_1',\ldots,x_n'$ do not occur in $\trans{B}$.

    By definitions \ref{!SAT2} and \ref{!IMG2} and the fact that
    $\Fr{S}$ is total,
    \begin{itemize}
    \item[(1)] $\Fr{S},I,w,s \SAT \Box B$
    \end{itemize}
    iff
    \begin{itemize}
    \item[(2)] $\Fr{S},I,w',s' \SAT B$ for all $w',s'$ such that
      $wRw'$ and for some $C\in K_{w,w'}$, each $s_i$ is $C$-related
      to $s_i'$.
    \end{itemize}
    By induction hypothesis, this in turn holds iff
    \begin{itemize}
    \item[(3)] $W,U',I',{w'}^\infty,s' \SAT \trans{B}$ for all $w',s'$ such
      that $wRw'$ and for some $C\in K_{w,w'}$, each $s_i$ is
      $C$-related to $s_i'$.
    \end{itemize}
    By the substitution lemma for first-order logic,
    $W,U',I',{w'}^\infty,s' \SAT \trans{B}$ iff $W,U',I',v,s'' \SAT
    [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n] \trans{B}$, where
    $s''$ is the $x_1',\ldots,x_n'$-variant of $s'$ with $s''(x_i') =
    s'(x_i)$ and $v$ is the $\omega'$-variant of ${w'}^\infty$ with
    $v(\omega') = {w'}^\infty(\omega') = w'$. (Evidently, $v =
    {w'}^\infty$.)  Moreover, in first-order logic, the truth-value of
    a formula $X$ relative to a variable interpretation $\Sigma$ does
    not depend on what $\Sigma$ assigns to variables that aren't free
    in $X$. The only free variables in
    $[\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n] \trans{B}$ are
    $\omega',x_1',\ldots,x_n'$. Thus (3) obtains iff
    \begin{itemize}
    \item[(4)] $W,U',I',v,s' \SAT
      [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n] \trans{B}$ for
      all $\omega'$-variants $v$ of $w^\infty$ and
      $x_1',\ldots,x_n'$-variants $s'$ of $s$ such that
      $v_{\omega}Rv_{\omega'}$ and for some $C\in
      K_{v_{\omega},v_{\omega'}}$,
      $s'(x_1)Cs'(x_1'),\ldots,s'(x_n)Cs'(x_n')$.
    \end{itemize}
    Coming from the other direction, by the semantics of $\Sc{L}_c$,
    \begin{itemize}
    \item[(5)] $W,U',I',w^\infty,s \SAT \forall \omega' \forall x_1'\ldots
      x_n'(\omega x_1\ldots x_n R^n \omega' x_1'\ldots x_n' \then
      [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n]\trans{B})$
    \end{itemize}
    iff
    \begin{itemize}
    \item[(6)] $W,U',I',v,s' \SAT \omega x_1\ldots x_n R^n \omega'
      x_1'\ldots x_n' \then
      [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n]\trans{B}$ for
      all $\omega'$-variants $v$ of $w^\infty$ and
      $x_1',\ldots,x_n'$-variants $s'$ of $s$.
    \end{itemize}
    By definition \ref{!MODCORR}, $W,U',I',v,s' \SAT \omega x_1\ldots
    x_n R^n \omega' x_1'\ldots x_n'$ iff $v_{\omega}Rv_{\omega'}$ and
    for some $C\in K_{v_{\omega},v_{\omega'}}$,
    $s'(x_1)Cs'(x_1'),\ldots,s'(x_n)Cs'(x_n')$.  So (6) holds iff
    \begin{itemize}
    \item[(4)] $W,U',I',v,s' \SAT
      [\omega',x_1',\ldots,x_n'/\omega,x_1,\ldots,x_n]\trans{B}$ for
      all $\omega'$-variants $v$ of $w^\infty$ and
      $x_1',\ldots,x_n'$-variants $s'$ of $s$ such that
      $v_{\omega}Rv_{\omega'}$ and for some $C\in
      K_{v_{\omega},v_{\omega'}}$,
      $s'(x_1)Cs'(x_1'),\ldots,s'(x_n)Cs'(x_n')$,
    \end{itemize}
    which we know is equivalent to (1). \qed
  \end{enumerate}
\end{proof}

For any formula $A$ of $\Sc{L}$, the corresponding $\Sc{L}_c$-formula
$\trans{A}$ contains at most one free world variable, $\omega$, as
well as an arbitrary number of free individual variables. Universally
binding these variables gives us an $\Sc{L}_c$-sentence expressing
that $A$ holds at all points in a given model. What we're more
interested in is validity, where we abstract away not only from the
interpretation of the variables, but also of the predicates. To
express the validity of, say, $\Box Fx \then Fx$ in the correspondence
language, we have to add second-order quantifiers, so that we can say
$\forall F \forall x \forall \omega (\forall \omega' \forall x'(\omega
xR^1\omega' x' \then F\omega' x') \then F\omega x)$. A little
reflection shows that this is equivalent to $\forall \omega\forall x
(\omega x R^1 \omega x)$.%
\cmnt{%
  (Let $\xi$ range over world-individual pairs. Then $\forall F
  \forall x \forall \omega (\forall \omega' (\omega xR^1\omega' x'
  \then Fx') \then Fx)$ can be shortened to $\forall F \forall \xi
  (\forall \xi' (\xi R^1\xi' \then F\xi') \then F\xi)$, which is the
  standard translation for the validity of $\Box p \then p$ in PML.)%
} %
The validity of $\Box Fx \then Fx$ in a structure therefore
corresponds to reflexivity of $R^1$. Similarly, validity of $\Box Gxy
\then Gxy$ corresponds to reflexivity of $R^2$, and so on. (The
validity of the \emph{schema} $\Box \Phi \then \Phi$ cannot be
expressed as a single sentence of the correspondence language.)

} %

[TODO: Show some correspondence results for quantified schemas. E.g. BF, CBF,
NE, etc.]




\section{Canonical models}\label{sec:canonical-models}

We can use the canonical model technique to prove (strong) completeness. Let me
begin with an informal exposition of the key ideas.

From now on, let \Sc{L} be a language with or without substitution. Recall that
a ``logic'' is a certain kind of set of sentences. For any logic $L$,
`$\vdash_{L} A$' means $A \in L$. For any set $\Gamma$ of sentences, we read
`$\Gamma \vdash_{L} A$' as saying that there are 0 or more sentences
$B_1,\ldots,B_n \in \Gamma$ such that
$\vdash_{L} B_1\land \ldots \land B_n \then A$. (For $n=0$,
$B_1\land\ldots \land B_n \then A$ is $A$.) We say that $\Gamma$ is
\emph{$L$-consistent} iff there are no members $A_1,\ldots,A_n$ of $\Gamma$ such
that $\vdash_L \neg (A_1 \land \ldots \land A_n)$.

A logic $L$ is \emph{weakly complete} with respect to a class of
models $\mathbb{M}$ iff $L$ contains every formula valid in
$\mathbb{M}$: whenever $A$ is valid in $\mathbb{M}$, then $\vdash_L
A$. Equivalently, every formula $A \not\in L$ is false at some world
in some model in $\mathbb{M}$.  $L$ is \emph{strongly complete} with
respect to $\mathbb{M}$ iff whenever $A$ is a semantic consequence of
a set of formulas $\Gamma$ in $\mathbb{M}$, then $\Gamma \vdash_L
A$. Since $\Gamma \not\vdash_L A$ iff $\Gamma \cup \{\neg A\}$ is
$L$-consistent, and $A$ is a semantic consequence of $\Gamma$ in
$\mathbb{M}$ iff no world in any model in $\mathbb{M}$ verifies all
members of $\Gamma \cup \{\neg A\}$, this means that $L$ is strongly
complete with respect to $\mathbb{M}$ iff for every $L$-consistent set
of formulas $\Gamma$ there is a world in some model in $\mathbb{M}$ at
which all members of $\Gamma$ are true. xxx add assignment-relativity

To prove strong completeness, we can associate with each logic $L$ a
\emph{canonical model} $\Fr{M}_L$. The worlds of $\Fr{M}_L$ are construed as
maximal $L$-consistent sets of formulas. We show that for each such world $w$
there is an assignment $g$ such that a formula $A$ is true at $w$ under $g$ iff
$A \in w$. Since every $L$-consistent set of formulas can be extended to a
maximal $L$-consistent set, it follows that every $L$-consistent set of formulas
is verified at some world in $\Fr{M}_L$, relative to some assignment. It follows
that $L$ is strongly complete with respect to every model class that contains
$\Fr{M}_L$.

\cmnt{
  Since $A$ should be true at $w$ iff $A \in w$, the worlds must be
  \emph{maximal} sets: for every sentence $A$ and world $w$, either $A
  \in w$ or $\neg A \in w$. Moreover, if the logic $L$ is sound with
  respect to $\Fr{M}_L$, the worlds must be
  \emph{$L$-consistent}. Otherwise there would be sentences
  $A_1,\ldots,A_n \in w$ and hence $w,V \SAT A_1\land \ldots \land
  A_n$ while $\vdash_L \neg (A_1\land \ldots \land A_n)$. However, we
  will see that the worlds in our canonical models only have an
  $L$-consistent fragment.
}

How do we ensure that $\Fr{M}_{L},w,g \models A$ iff $A \in w$, for any formula
$A$? The usual approach is to stipulate that for any variable $x$, $g(x)$ is the
class of variables $[x]_{w} = { z: x\!=\!z \in w }$, and that the model's
interpretation function $I_{w}$ assigns to each predicate $P$ at $w$ the set of
$n$-tuples $\t{[x_1]_w,\ldots,[x_n]}$ such that $Px_1\ldots x_n \in w$.

A well-known problem now arises from the fact that first-order logic does not
require every individual to have a name. This means that there are consistent
sets $\Gamma$ that contain $\exists x Fx$ as well as $\neg Fx_i$ for every
variable $x_i$. If we extend $\Gamma$ to a maximal consistent set $w$ and apply
the construction just outlined, then $I_w(F)$ would be the empty set. We would
have $\Fr{M},w,g \SAT \neg \exists x Fx$, although $\exists x Fx \in w$. To
avoid this, we require that the worlds in a canonical model are all
\emph{witnessed}, so that whenever an existential formula $\exists x Fx$ is in
$w$, then some witnessing instance $Fy$ is in $w$ as well. We still want the
set $\Gamma$ to be verified at some world. So the worlds are construed in a
larger language $\Sc{L^*}$ that adds infinitely many new variables to the
original language $\Sc{L}$. The new variables may then serve as witnesses. (In
the new language, there are again consistent sets of sentences that are not
included in any world, but not so in the old language.)
 
In modal logic, the problem of witnesses reappears in another form. If we define
the worlds of the canonical model as maximally consistent, witnessed sets of
$\Sc{L}^{*}$-sentences, then a world $w$ might contain $\Diamond \exists x Fx$
but also $\Box \neg Fx_i$ for every $\Sc{L^*}$-variable $x_i$. For all these
sentences to be true at $w$ relative to the canonical assignment $g$, Kripke
semantics requires that there is a world $w'$ accessible from $w$ that verifies
all instances of $\neg Fx_i$ as well as $\exists x Fx$. But then $w'$ isn't
witnessed!

\cmnt{%
  One way out is to stipulate that worlds in $\Fr{M}_L$ must be \emph{modally
    witnessed} in the sense that whenever $\Diamond \exists x A \in w$, then
  $\Diamond [y/x]A \in w$ for some (possibly new) variable $y$. Metaphysically
  speaking, this means that whenever it is possible that something is so-and-so,
  then we can point at some object at the actual world which is possibly
  so-and-so. In single-domain models, this has the unfortunate consequence of
  rendering the Barcan Formula valid. In dual-domain semantics, the ``modal
  witness'' can come from the outer domain, so that $\forall x \Box Fx$ does not
  entail $\Box \forall x Fx$. However, if the relevant logic is classical rather
  than free, the Barcan Formula still comes out valid, despite the fact that it
  is not entailed by the principles of classical first-order logic and \s{K}.

  FIXME: I should expand on this advantage. What's nice is not only that we can have
  completeness for S4M etc.!
  
  (For the Barcan Formula to be invalid, there must be a world where
  $\forall x \Box Fx$ is true and $\Box \forall x Fx$ false. So
  $\Diamond \exists x \neg Fx$ is true, and modal witnessing requires
  $\Diamond \neg Fy$ for some $y$. But in classical logic, $\forall x \Box Fx$
  entails $\Box Fy$, i.e.\ $\neg \Diamond \neg Fy$.)
} %

In counterpart semantics, the truth of $\Box \neg Fx_i$ at $w$ only requires
that $\neg Fx_i$ is true at $w'$ under all $w'$-\emph{images} $g'$ of $g$ at $w$
-- i.e.\ under assignments $g'$ such that $g'(x_i)$ is some counterpart
of $g(x_i) = [x_1]_w$. Suppose, for example, that $[x_1]_w = \{x_1\}$ and each
individual $[x_i]_w$ at $w$ has $[x_{i+1}]_{w'}$ as unique counterpart at $w'$.
Then the truth of $\Box \neg Fx_1, \Box \neg Fx_2,$ etc. at $w$ only requires
that $\neg Fx_1, \neg Fx_2,$ etc. are true at $w'$ under an assignment of
$[x_2]_{w'}$ to $x_1$, $[x_3]_{w'}$ to $x_2$, etc. So
$Fx_2, Fx_3, \ldots \in w'$, but the variable $x_1$ becomes available to serve
as a witness for $\Diamond \exists x Fx$.

\cmnt{%
  Here we exploit the fact that in counterpart semantics, truth at a world
  ``considered as actual'' can come apart from truth at a world ``considered as
  counterfactual''. In the canonical model, membership in a world only coincides
  with truth at the world ``as actual'': $A \in w$ iff $w,V \SAT A$. If $w'$
  contains $Fx_1$, it follows that $w',V \SAT Fx_1$. On the other hand, when we
  look at $w'$ (``as counterfactual'') from the perspective of $w$, we evaluate
  formulas not by the original interpretation function $V$, but by an image $V'$
  of $V$. Given that $V'_{w'}(x_1) = [x_2]_{w'}$ and $Fx_2 \not\in w'$,
  $w',V'\not\SAT Fx_1$.

  Unfortunately, this creates a complication. Suppose we want to show that for
  every formula $A$ and world $w$ in $\Fr{M}_L$, 
  \begin{equation}\label{p1}
    \Box A \in w \text{ iff } w,V \SAT \Box A,
  \end{equation}
  where $V$ is the interpretation function of $\Fr{M}_L$. Proceeding by
  induction on complexity of $A$, we can assume that for all $w$,
  \begin{equation}\label{pih}
    A \in w \text{ iff } w,V \SAT A.
  \end{equation}
  In standard Kripke semantics, we now only need to stipulate that $w'$
  is accessible from $w$ iff $w'$ contains all $A$ for which $w$
  contains $\Box A$. This means that $\Box A \in w$ iff $A \in w'$ for
  all $w$-accessible $w'$; by \eqref{pih}, the latter holds iff $w',V
  \SAT A$ for all such $w'$, i.e.\ iff $w,V \SAT \Box A$ by the
  semantics of the box. In counterpart semantics, this line of thought
  no longer goes through, since $w,V \SAT \Box A$ only means that $A$ is
  true at all accessible worlds $w'$ \emph{considered as
    counterfactual}: $w',V' \SAT A$. By contrast, \eqref{pih} only
  considers worlds \emph{as actual}; it does not tell us that $A \in w$
  iff $w,V' \SAT A$.

  Below is an example.

} %

How, in general, should we define the counterpart relation in our canonical
models? Kripke semantics effectively settles the counterpart relation from the
outside: if $[x]_w = \{ x, y, \ldots\}$, then $[x']_{w'}$ is a counterpart of
$[x]_w$ iff $[x']_{w'} = \{ x,y,\ldots\}$. To allow for contingent identity, we
could relax this clause and say that $[x]_w$ has $[x']_{w'}$ as counterpart iff
there is some $z$ that occurs both in $[x]_w$ and $[x']_{w'}$. To get around the
problem of modal witnessing, we could fix a different counterpart relation. For
example, we could pick an arbitrary transformation $\tau$ whose range excludes
infinitely many variables and say that $[x]$ always has $[x^\sigma]$ as
counterpart (i.e.\ $[x]_w$ has $[x']_{w'}$ as counterpart iff there is a
$z\in [x]_w$ with $z^\sigma \in [x']_{w'}$). With this approach, one can indeed
prove completeness for all four basic logics. But we run into problems when we
look at stronger logics. For example, it is easy to see that $\s{P+T}$ is valid
in a structure iff every world can see itself and all sequences of individuals
are their own counterparts. In order to prove structure completeness for
$\s{P+T}$, we want the canonical model of $\s{P+T}$ to be ``reflexive'', in this
sense. But it won't be. (Let $\Gamma$ contain $x_1 \not= x_1^\tau$ as well as
all $\Sc{L}$-instances of $\Box A \then A$. $\Gamma$ is $\s{P+T}$-consistent. So
it is part of a world $w$ in the canonical model. If the model is reflexive,
then for all $w$, $wRw$ and for all $d$, $\t{d,w}C\t{d,w}$. The second condition
requires that $[x_1]_wC[x_1]_w$, i.e.\ there is some $z\in [x_1]_w$ with
$z^\tau \in [x_1]_w$. Obviously there are maximally consistent extensions of
$\Gamma$ that contain no identity $x_1\!=\!z^\tau$.)

It is better not to define canonical counterparthood in a fixed, external
manner. Compare accessibility: in standard propositional logic, whether $w'$ is
accessible from $w$ depends on whether it verifies all formulas $A$ for which
$w$ contains $\Box A$. By analogy, we should say that whether $[x']_{w'}$ is a
counterpart of $[x]_{w}$ is determined by whether $[x']_{w'}$ satisfies the
modal profile attributed to $[x]_w$ in $w$. The above proposal ensured that if
$\Box A(x) \in w$, then $A(x^\tau) \in w'$ for accessible $w'$, so that $w'$
verifies that the counterpart $[x^\tau]_{w'}$ of $[x]_w$ satisfies condition
$A$. But this doesn't tell us that \emph{everything} that satisfies $A(x)$ for
all $\Box A(x) \in w$ qualifies as counterpart of $[x]_w$. If we had this, it
would be easy to show that the CM of \s{P+T} is reflexive: since every $w$
contains $\Box A(x) \then A(x)$, $[x]_w$ at $w$ must be a counterpart of itself
at $w$.

So we need to define counterparthood in such a way that we can read off whether
$\t{[x]_w,w}C\t{[y]_{w'},w'}$ by comparing what $w$ says about the boxed
properties of $x$ and what $w'$ says about $y$.

Take a concrete example. Suppose $w$ and $w'$ look as follows.
\begin{gather*}
w: \{ x\!\not=\!y, \Box x\!\not=\!y, \Box Fx, \Box Fy, \ldots\}\\
w': \{ \neg Fx, Fu, Fv, u\!\not=\!y, \ldots\}
\end{gather*}
We can tell that $[x]_{w'}$ does not qualify as counterpart of $[x]_w$, since it
doesn't satisfy the ``modal profile'' that $w$ attributes to $[x]_w$: $w$
contains $\Box Fx$, so all counterparts of $[x]_w$ should satisfy $F$. Both
$[u]_{w'}$ and $[v]_{w'}$ meet this condition. So we might say that both of them
are counterparts of $[x]_w$. But then they should also be counterparts of
$[y]_w$, and we get a violation of the ``joint modal profile'' expressed by
$\Box x\!\not=\!y$, which requires that no counterpart of $[x]_w$ is identical
to any counterpart of $[y]_w$. Structurally, this is the ``problem of internal
relations'' noted in \cite{hazen79counterpart}. In response, we assume that
there can be multiple counterpart relations linking the individuals at $w$ to
those at $w'$. One relation links $[x]_w$ with $[u]_{w'}$ and $[y]_{w}$ with
$[v]_w$, another $[x]_w$ with $[v]_{w'}$ and $[y]_{w}$ with $[u]_{w'}$. So
$[x]_w$ does have both $[u]_{w'}$ and $[v]_{w'}$ as counterpart, but the pair
$\t{[x]_w,[y]_w}$ has only two rather than four counterparts.

It proves convenient to impose a further restriction on canonical counterpart
relations. We will assume that every counterpart relation $C$ in a canonical
model corresponds to a transformation $\tau$ so that $[x]_w$ at $w$ has
$[x^\tau]_{w'}$ at $w'$ as counterpart (unless $[x^\tau]_{w'}$ is empty -- see
below). This means that if an individual $[x]_w$ at $w$ has two counterparts at
$w'$ under the same counterpart relation, then there must be at least two
variables $x,y$ in $[x]_w$, so that $[x^\tau]_{w'}$ and $[y^\tau]_{w'}$ can
serve as the two counterparts.

This is, to a first approximation, how we will construct the accessibility and
counterpart relations in canonical model.

Let's say that $w'$ is \emph{accessible from $w$ via} a transformation $\tau$,
for short: $w \xrightarrow{\tau} w'$, iff $w'$ contains $A^\tau$ whenever $w$
contains $\Box A$. Define $wRw'$ to be true iff $w\xrightarrow{\tau} w'$ for
some $\tau$, and let $C$ be a counterpart relation between $w$ and $w'$ iff
$C = \{ \t{[x]_w, [y]_{w'}} : x^\tau = y \}$ for some $\tau$ such that
$w \xrightarrow{\tau} w'$.

\cmnt{%
  If $w \xrightarrow{\tau} w'$, then $[x]_w$ has $[x^\tau]_{w'}$ as counterpart.
  Since $[x^\tau]_{w'} = V_{w'}(x^\tau)$ and $V_{w'}(x^\tau) = V^\tau_{w'}(x)$,
  $V^\tau$ is a $w'$-image of $V$ at $w$. If $V^\tau$ were the only $w'$-image
  of $V$ at $w$, it would be easy to prove that $\Box A \in w$ iff
  $w,V \SAT \Box A$. Assume $\Box A \in w$. Then $A^\tau \in w'$ whenever
  $w \xrightarrow{\tau} w'$. The induction hypothesis \eqref{pih} tells us that
  $A^\tau \in w'$ iff $w',V \SAT A^\tau$. By the transformation lemma (lemma
  \ref{transl}), $w',V^\tau \SAT A$ iff $w',V \SAT A^\tau$: $A$ is true at $w'$
  as counterfactual iff $A^\tau$ is true at $w'$ as actual. So $\Box A \in w$
  iff for all accessible $w'$, there is a transformation $\tau$ such that
  $w',V^\tau \SAT A$. If $V^\tau$ is the only $w'$-image of $V_w$ at $w'$, it
  follows that $\Box A \in w$ iff $w,V \SAT \Box A$.
} %

If $w \xrightarrow{\tau} w'$, then $[x]_w$ has $[x^\tau]_{w'}$ as counterpart,
and $g^{\tau}$ is a $w'$-image of $g$ at $w$. But it might not be the only
$w'$-image of $g$ at $w$ -- and not only because there can be several $\tau$ with
$w \xrightarrow{\tau} w'$. For example, assume $w$ contains $x\!=\!y$ but not
$\Box x\!=\!y$. Then there is some world $w'$ and transformation $\tau$ such
that $w'$ contains $x^\tau\!\not=\!y^\tau$. That is, the individual
$[x]_w = [y]_w = \{ x,y,\ldots \}$ at $w$ has two $\tau$-induced counterparts at
$w'$, $[x^\tau]_{w'}$ and $[y^\tau]_{w'}$, which $g^\tau$ assigns to
$x$ and $y$, respectively. But then there will also be another $w'$-image of $g$
at $w$ which assigns, for example, $[y^\tau]_{w'}$ to both $x$ and $y$.

\cmnt{%
  Sometimes this is harmless. Assume $w$ also contains $\Box Fx$. We want to
  show that $w,V \SAT \Box Fx$ and thus that $w',V' \SAT Fx$ for all accessible
  $w'$ and $w'$-images $V'$ of $V$. In particular, at the above world $w'$, both
  $[x^\tau]_{w'}$ and $[y^\tau]_{w'}$ must fall in $V_{w'}(F)$. Since $w$
  contains $\Box Fx$, we know that $w'$ contains $Fx^\tau$, so
  $[x^\tau]_{w'} \in V_{w'}(F)$ by construction of the canonical interpretation
  $V$. What about $[y^\tau]_{w'}$? Well, since $w$ contains $\Box Fx$ and
  $x\!=\!y$, then it also contains $\Box Fy$, by \T{LL^*}. So $w'$ contains
  $Fy^\tau$ and $[y^\tau]_{w'} \in V_{w'}(F)$. The upshot is that the
  truth-value of $Fx$ at $w'$ considered as counterfactual does not vary between
  $V^\tau$ and other $w'$-images of $V$. Unfortunately, this is not always the
  case.%
} %

Here is a case where this leads to trouble. Assume we are working with a
positive logic without explicit substitution. As before, $w$ contains $x\!=\!y$
but not $\Box x\!=\!y$, so that for some $w\xrightarrow{\tau} w'$, $w'$ contains
$x^\tau\!\not=\!y^\tau$. Assume further that $w$ contains
$\Box\Diamond x\!\not=\!y$. Then $w'$ contains $\Diamond x^\tau\not=\!y^\tau$. To
verify $\Box\Diamond x\!\not=\!y$ at $w$, we need to ensure that
$w',g' \SAT \Diamond x\!\not=\!y$ for all $w'$-images $g'$ of $V$ at $w$, not
just for $g^\tau$. Consider the image $g'$ that assigns $[y^\tau]_{w'}$ to both
$x$ and $y$. To ensure that $w',g' \SAT \Diamond x\!\not=\!y$, there must be
some $w'\xrightarrow{\sigma} w''$ and $w',g'\Img w'',V''$ with
$w'',g'' \SAT x\!\not=\!y$. Here, $w',g' \Img w'',g''$ means that there is a
$\sigma$ such that $w'\xrightarrow{\sigma} w''$ and
$g'(x) C^\sigma g''(x)$ for all $x$, where $C^\sigma$ is the
counterpart relation induced by $\sigma$. In other words, we need a
transformation $\sigma$, world $w''$ and assignment $g''$ such that
$w'',g'' \SAT x\!\not=\!y$, where $w'\xrightarrow{\sigma} w''$ and $g''$ is such
that for all $x$ there is a $z \in g'(x)$ with $z^\sigma \in g''(x)$.
Since $g'(x) = g'(y) = [y^\tau]_{w'}$, this means that $[y^\tau]_{w'}$
must have two counterparts at some $w''$ relative to the same transformation
$\sigma$. So far, we have no guarantee that this is the case. There has to
be a variable $z$ other than $y^\tau$ such that $w'$ contains $z\!=\!y^\tau$ as
well as $\Diamond z\!\not=\!y^\tau$. The latter ensures that
$z^\sigma\!\not=\!(y^{\tau})^\sigma \in w''$ for some
$w \xrightarrow{\sigma} w''$; $[z^\sigma]_{w''}$ and $[(y^{\tau})^\sigma]_{w''}$
are then both counterparts at $w''$ of $[y^\tau]_{w'}$.

Hence we complicate the definition of $w \xrightarrow{\tau} w'$. We stipulate
that if $w'$ does not contain $z\!=\!y^\tau$ and $\Diamond z\!\not=\!y^\tau$ for
some suitable $z$, then $w'$ is not $\tau$-accessible from $w$. In general, if
$w$ contains $\Box A$ as well as $x\!=\!y$, and $x$ is free in $A$, then for
$w'$ to be accessible from $w$ via $\tau$, we require that it must contain not
only $A^\tau$, but also $z\!=\!y^\tau$ and $[z/x^\tau]A^\tau$, for some $z$ not
free in $A^\tau$.

This requirement might be easier to understand if we consider the same situation
in a language with substitution. Here $\Box\Diamond x\!\not=\!y$ and $x\!=\!y$
entail $\Box \t{y:x}\Diamond x\!\not=\!y$ (by \T{LL_s} and \T{S\Box}). By the
original, simple definition of $w \xrightarrow{\tau} w'$, each world $w'$
accessible from $w$ via $\tau$ must contain
$\t{y^\tau:x^\tau}\Diamond x^\tau\!\not=\!y^\tau$. This formula says that
$[y^\tau]_{w'}$ has multiple counterparts at some accessible world $w''$. Before
we worry about images other than $g^\tau$, we ought to make sure that
$\t{y^\tau:x^\tau}\Diamond x^\tau\!\not=\!y^\tau$ is true at $w'$ under
$g^\tau$. This requires that there is a variable $z$ other than $y^\tau$ such
that $w'$ contains $z\!=\!y^\tau$ and $\Diamond z\!\not=\!y^\tau$. In effect,
$z$ is a kind of witness for the substitution formula
$\t{y^\tau:x^\tau}\Diamond x^\tau\!\not=\!y^\tau$. Just as an existential
formula $\exists x A$ must be witnessed by an instance $[z/x]A$, a substitution
formula $\t{y:x}A$ must be witnessed by $[z/x]A$ together with $z\!=\!y$.
Loosely speaking, $\t{y:x}A(x)$ says that $y$ is identical to some $x$ such that
$A(x)$. In a canonical model, we want a concrete witness $z$ so that $y$ is
identical to $z$ and $A(z)$. $y$ itself may not serve that purpose, because
$\t{y:x}A(x)$ does not guarantee $A(y)$.

The requirement of substitutional witnessing entails that if $w$ contains
$\Box A$, then any $\tau$-accessible $w'$ contains not only $A^\tau$, but also
$z\!=\!y^\tau$ and $[z/x^\tau]A^\tau$ (for some suitable $z$). So we don't need
to complicate the accessibility relation. In our example, since $w'$ contains
$A^\tau$ whenever $w$ contains $\Box A$, $w'$ contains
$\t{y^\tau:x^\tau}\Diamond x^\tau\!\not=\!y^\tau$, which settles that
$[y^\tau]_{w'}$ has two counterparts at some accessible world. Without
substitution, $\t{y^\tau:x^\tau}\Diamond x^\tau\!\not=\!y^\tau$ is inexpressible
(see lemma \ref{non-elim}). So we have to limit the accessible worlds by
requiring membership of the relevant witnessing formulas in addition to
$A^\tau$.


\cmnt{%
  Wouldn't it suffice to require that if $w$ contains $x\!=\!y$ and $\Box A$,
  then $w'$ contains $z\!=\!y^\tau$ as well as $A^\tau$? Since $w$ also contains
  $y\!=\!x$, it follows that $w'$ also contains $z'\!=\!x^\tau$. By \T{LL^*},
  $w'$ then also contains $[z/y^\tau]A^\tau$ and $[z'/x^\tau]A^\tau$. -- Yes,
  but that's not enough. We get
  $\{ z=y^\tau, z'=x^\tau, \Diamond z'\not=y^\tau, \Diamond x^\tau \not= z \} \subseteq w'$.
  But this is compatible with $[x^\tau, z']$ not having two counterparts at some
  accessible world.%
} %


\cmnt{%

  We know how truth at a world as actual relates to membership: $w,V \SAT A$ iff
  $A \in w$. What about truth at a world as counterfactual? I.e. what about
  truth at a world $w'$ under some image $V'$ (of some image \ldots) of $V$.
  This becomes important when we want to prove that $\Diamond A \in w$ iff
  $w,V \SAT \Diamond A$. The latter tells us that $A$ is true at some $w'$ under
  some image $V'$. We would like to infer by induction hypothesis that $w'$
  contains some sentence(s) $A'$, and conclude by definition of counterparthood
  and accessibility that $\Diamond A$ must be in $w$.

  There are several ways to achieve this, corresponding to different choices for
  the canonical counterparthood and accessibility relations.

  The two have to work together. Roughly, the main constraint is that if $w$
  contains a formula $\Box A$ with free variables $\vec{x}$, then if $wRw'$ and
  $(\vec{[x]_{w}},w)C(\vec{[y]_{w'}},w')$, then $w'$ contains
  $\t{\vec{y}:\vec{x}}A$; and if $w$ contains $\Diamond A$, then there are $w'$
  with $wRw'$ and $y$ with $(\vec{[x]_{w}},w)C (\vec{[y]_{w'}},w')$ such that
  $w'$ contains $\t{\vec{y}:\vec{x}}A$. (That's not quite right in negative
  semantics, because $w$ can satisfy $\Diamond \neg Ex$ without $[x]_w$ having
  any counterpart at any accessible world.)

  One idea: take two worlds $w,w'$. If there is any relation $C_{w,w'}$ between
  the two domains such that whenever $\Box A \in w$ and
  $\vec{[x]_{w}} C_{w,w'} \vec{[y]_{w'}}$, then $\t{\vec{y}:\vec{x}}A \in w'$,
  then say that $wRw'$ and let $C_{w,w'}$ be the counterpart relation restricted
  to $w,w'$. But what if there are several such relations? E.g., if the only
  non-trivial box sentence in $w$ is $\Box (Fx \leftrightarrow \neg Fy)$, and
  $w'$ contains $Fz, \neg Fu$, we could map $x$ to $z$ and $z$ to $u$, or $x$ to
  $u$ and $y$ to $z$, but we can't let $x$ and $y$ have both $z$ and $u$ as
  counterparts.

  We don't have to read off the counterpart relation from the content of the
  relevant worlds. We can add it as a primitive extra ingredient into the model.
  For instance, we could stipulate that $[x_i]_w$ at $w$ always has
  $[x_{2i}]_{w'}$ at $w'$ as counterpart.

  I used to pair each world with a partial, injective substitution function
  $\tau$. The idea was that the counterparts of $[x]_w$ at $w'$ are the
  $[\tau_{w'}(y)]_{w'}$ for all $y \in [x]_w$. To allow $[x]_w = \{x \}$ to have
  no counterpart at $w'$, $\tau_{w'}$ could be undefined. One challenge is that
  in classical models, $Ex \in w$ for all $x$ and $w$. But we want
  $\Diamond \neg Ex$. So evaluating formulas at worlds as counterfactual seems
  not just to evaluate them (in the obvious way) under a variable substitution.
  I defined $(Fx)^\tau = \falsum$ if $\tau(x) = undef$, so that $\neg Ex$ could
  be true under $\tau$. This made it hard to prove the existence lemma. Also, it
  doesn't generalise to positive systems, where $x$ can have non-trivial
  properties even at worlds where it doesn't exist. Hence considered as
  counterfactual, $w'$ must say that non-existent object $x$ is $F$,
  non-existent object $y$ isn't $F$, and so on.

  \bigskip

  Take a concrete example. $w$ contains
  $\Box Fx, \Box Fy, \Diamond Gxy, \ldots$, thereby specifying a modal profile
  for $x$, $y$, etc.\ (more precisely, for $[x]_w, [y]_w$). Another Henkin set
  $w'$ may contain $Fx, Fz, Gxz, \ldots$. From the perspective of $w$ (i.e.\
  considered as counterfactual), this isn't a state at which e.g.\ $x$ is $F$.
  To say what $w'$ represent about $x$, we first have to locate $x$ at $w'$, by
  finding its counterparts.

  In Kripke semantics, that's easy: $x$ is always its unique own counterpart at
  any world; more precisely, if $[x]_w = \{ x, y, \ldots\}$, then $[x']_{w'}$ is
  a counterpart of $[x]_w$ iff $[x']_{w'} = \{ x,y,\ldots\}$. Here there is an
  externally fixed counterpart relation. To allow for contingent identity, we
  could relax this clause and say that $[x]_w$ has $[x']_{w'}$ as counterpart
  iff there is some $z$ that occurs both in $[x]_w$ and $[x']_{w'}$. (Now we can
  have $x\!=\!y \in w$ but $x\!\not=\!y\in w'$, in which case $[x]_w=[y]_w$ has
  both $[x]_{w'}$ and $[y]_{w'}$ at $w'$ as counterparts.) To help with the
  problem of modal witnessing, we could fix a different counterpart relation on
  which, for example, $v_{n}$ always has $v_{n+1}$ as counterpart. That's not
  enough because it only frees a single variable. So we better pick some
  (arbitrary) substitution $\sigma$ whose range excludes infinitely many
  variables and say that $[x]$ always has $[x^\sigma]$ as counterpart, i.e.\
  $[x]_w$ has $[x']_{w'}$ as counterpart iff there is a $z\in [x]_w$ with
  $z^\sigma \in [x']_{w'}$. It proves convenient to let $\sigma$ be a
  transformation $\tau$. This approach works to some extent: one can prove
  completeness for all four basic logics. But it runs into problems when we look
  at stronger logics. For example, it is easy to see that $\s{P+T}$ is valid in
  a structure iff every world can see itself and all things are their own
  counterparts. So to prove structure completeness for $\s{P+T}$, we want the
  canonical model of $\s{P+T}$ to be reflexive in this sense. But it won't be.
  (Let $\Gamma$ contain $x_1 \not= x_1^\tau$ as well as all $\Sc{L}$-instances
  of $\Box A \then A$. $\Gamma$ is $\s{P+T}$-consistent. So it is part of a
  world $w$ in the canonical model. If the model is reflexive, then for all $w$,
  $wRw$ and for all $d$, $\t{d,w}C\t{d,w}$. On a plausible definition of
  canonical accessibility, the first condition requires that $A^\tau \in w$
  whenever $\Box A \in w$. That already may fail, if e.g.\ we add to $\Gamma$
  the formulas $\Box Fx_1$ and $\neg F x_1^\tau$. The second condition requires
  that $[x_1]_wC[x_1]_w$, i.e.\ there is some $z\in [x_1]_w$ with
  $z^\tau \in [x_1]_w$. This is a bit harder to render false explicitly, since
  we can't add $x_1\!\not=\!z^\tau$ to $\Gamma$ for all variables $z$ as
  otherwise $\Gamma$ contains every variable. However, obviously there are max
  cons extensions of $\Gamma$ that contain no identity $x_1\!=\!z^\tau$.)

  This shows that we shouldn't define canonical counterparthood in a fixed,
  external manner. Compare accessibility: whether $w'$ is accessible from $w$
  depends on whether it verifies all formulas $A$ (or $A^\tau$) which $w$ claims
  to be true at all accessible worlds. By analogy, we should say that whether
  $[x']_{w'}$ is a counterpart of $[x]_{w}$ is determined by whether $[x']_{w'}$
  satisfies the modal profile attributed to $[x]_w$ in $w$. The above proposal
  ensured that if $\Box A(x) \in w$, then $A(x^\tau) \in w'$ for accessible
  $w'$, so that $w'$ verifies that the counterpart $[x^\tau]_{w'}$ of $[x]_w$
  satisfies condition $A$. But this doesn't tell us that \emph{everything} that
  satisfies $A(x)$ for all $\Box A(x) \in w$ qualifies as counterpart of
  $[x]_w$. If we had this, it would be easy to show that the CM of \s{P+T} is
  reflexive: since every $w$ contains $\Box A(x) \then A(x)$, $[x]_w$ at $w$
  must be a counterpart of itself at $w$.

  So we need to define counterparthood in such a way that we can read off
  whether $\t{[x]_w,w}C\t{[y]_{w'},w'}$ by comparing what $w$ says about the
  boxed properties of $x$ and what $w'$ says about $y$. It's as if $w'$,
  considered as counterfactual, were a merely qualitative description of a world
  (saying that there is some $x$, some $u$, some $v$, etc.\ satisfying
  such-and-such conditions), and now we need to figure out which of these
  $x,u,v$, etc.\ qualify as representatives of $[x]_w$, $[y]_w$, $[z]_w$, etc.
  (Although, of course, we don't stipulate that this is a matter of qualitative
  similarity: $w$ comes with built-in claims about modal profiles.)

  But now there's another problem. $w$ doesn't just constrain the modal profile
  of individuals one by one, but also in relation to one another. It might say
  that $\Box Gxy$ or $\Box x\!\not=\!y$, etc. And this matters. Suppose $w$
  contains $\Box Gxy, \Diamond \neg Gyx, \Box Fx, \Box Fy$, and no other
  interesting modal statement about $x$ and $y$. We need an accessible world
  $w'$ that verifies $Gxy, \neg Gyx, Fx, Fy$ considered as counterfactual. We
  can easily find a $w'$ containing $Gx'y', \neg Gy'x', Fx', Fy'$ for some
  variables $x',y'$. But now which of $x',y'$ is counterpart of $x,y$,
  respectively? We must not say that $x$ has both $x'$ and $y'$ as counterpart,
  and so does $y$. For then $Gyx$ comes out true at $w'$ as counterfactual.

  An alternative to counterpart relations between sequences is to go
  haecceitistic and introduce ``qualitatively indistinguishable'', haecceitistic
  worlds. A haecceitistic world is one in which every individual carries a
  marker (a ``haecceity'') which specifies which actual individual it
  represents. So the world $w'$ containing $Gx'y', \neg Gy'x', Fx', Fy'$ is
  really two worlds, one marking $x'$ as counterpart of $x$ and $y'$ for $y$,
  the other marking them the other way round. This is easily achieved by
  defining worlds in the canonical model to be pairs of an arbitrary Henkin set
  and an arbitrary variable transformation. Where previously the pair $x,y$ had
  two counterparts $x',y'$ and $y',x'$ at the relevant world, we now have two
  worlds $w,[x',y'/x,y]$ and $w',[y',x'/x,y]$ in each of which there is only one
  counterpart pair.

  Won't that rule out contingent identity and distinctness? Won't worlds with
  multiple counterparts always be turned into multiple worlds with single
  counterparts? This happens in standard (extreme) haecceitism in philosophy.
  But not here. We've already seen the reason: even if we fix a particular
  transformation $\tau$ to find the counterparts of $[x]_w$ at $w'$, we can get
  multiple counterparts.

  A third option is Kutz's...


}


\cmnt{

  The fact that we need only consider the image $V^\tau$ doesn't mean that
  there's a ``canonical counterpart'' for each object. Rather, there's a single
  such counterpart for each \emph{name} of each object. For instance,
  $w,V \SAT x\!=\!y \land \Diamond x\!\not=\!y$ iff there is an accessible world
  $w'$ with $[x^\tau]_{w'} \not= [y^\tau]_{w'}$.

}

\cmnt{%
  I never actually prove below that $w,V \SAT \Box A$ iff
  $w',V^\tau \SAT A$ for all $wRw'$. The interesting direction is the one from
  right to left, and it follows directly from the truth lemma: assume
  $w',V^\tau \SAT A$ for all $wRw'$; by the truth lemma, $A^\tau \in w'$ for all
  $w'$; by def $R$, $\Box A \in w$; by the truth lemma, $w,V \SAT \Box A$.
    
  The LTR direction requires showing that $V^\tau$ is a $w'$-image of $V$ at
  $w'$. For by def. \ref{!SAT}, $w,V \SAT \Box A$ iff $w',V' \SAT A$ for all
  $wRw'$ and $w'$-images $V'$ of $V$ at $w$, i.e. for all $V'$ such that for all
  variables $z$, $V'_{w'}(z)$ is a counterpart at $w'$ of $V_w(z)$ at $w$, or
  undefined if there is no such counterpart. By construction of canonical
  counterparthood, $V_w(z)$ at $w$ has a counterpart at $w'$ iff there is a
  $z^* \in V_w(z)$ such that $[z^{*\tau}]_{w'} \not= \emptyset$, i.e. such that
  $z^{*\tau}=z^{*\tau} \in w'$. So $V'$ is such that for all variables $z$, if
  there is a $z^* \in V_w(z)$ with $z^{*\tau}=z^{*\tau} \in w'$, then there is a
  $z^* \in V_w(z)$ with $z^{*\tau} \in V'_{w'}(z)$, else $V'_{w'}(z)$ is
  undefined. (Note that $V'_{w'}(z)$ is always undefined if $V_w(z)$ is
  undefined.)
    
  For every variable $z$, if there is a $z^* \in V_w(z)$ with
  $z^{*\tau}=z^{*\tau} \in w'$, then $V_w(z)$ is defined and hence
  $z \in [z]_w = V_w(z)$. Moreover, since by construction of $R$ things cannot
  go partly out of existence, if there is a $z^* \in V_w(z)$ with
  $z^{*\tau}=z^{*\tau} \in w'$, then this is true for all $z^* \in V_w(z)$, in
  particular for $z$. So then
  $(z)^\tau \in [z^\tau]_{w'} = V_{w'}(z^\tau) = V_{w'}^{\tau}(z)$. So
  $V^{\tau}$ is an interpretation of type $V'$. I.e. if $w,V \SAT \Box A$ then
  $w',V^\tau \SAT A$. \qed
    
}

\cmnt{%
  To a certain extent, substitution operators are redundant in canonical models.
  Recall that the point of writing $\t{y:x}\Diamond Gxy$ instead of
  $\Diamond Gyy$ is to introduce a new term $x$ as coreferring with $y$ that
  won't get captured by the other occurrence of $y$ in the scope of the diamond.
  If we already have another term $x$ that corefers with $y$, we could instead
  have said $\Diamond Gxy$. However, we can't easily get rid of the operator in
  $\Box \t{y:x}\Diamond x\!\not=\!y$.

  What we do have is a kind of total commutativity of substitution
  with the box. It's not that whenever
  $\t{\vec{x^\sigma},\vec{x}}\Diamond A \in w$, then $\Diamond
  \t{\vec{x^\sigma},\vec{x}} A \in w$, with $\vec{x} =
  \var(A)$. $\t{y,y:x,y}\Diamond x\!\not=\!y \in w$ still doesn't imply
  $\Diamond\t{y,y:x,y} x\!\not=\!y \in w$. Nor can we say
  $\t{\vec{x^\sigma},\vec{x}}\Diamond A \leftrightarrow
  \t{\vec{x^\rho},\vec{x}}\Diamond A \in w$, for some injective
  $\rho$. E.g. consider $\t{y,y:x,y}\Diamond x\!=\!y$ in a case where
  $V_w(y)$ has no dual counterparts. Or consider
  $\t{y,y:x,y}\Diamond\Diamond x\!\not=\!y$ in a case where $V_w(y)$
  has no dual counterparts, but some of its counterparts do. What we
  can say is this:

  \begin{quote}
    Let $\vec{x}$ be the free variables in $A$, and $w$ a world in a
    canonical model. If $\t{\vec{x^\sigma},\vec{x}}\Diamond A \in w$,
    then $\Diamond \t{\vec{x^\rho},\vec{x}} A \in w$ for some $\rho$
    such that for each $x \in \vec{x}$, $x^\sigma\!=\!x^\rho \in w$.
  \end{quote}

  \begin{proof}
    By substitutional witnessing, if
    $\t{\vec{x^\sigma}:\vec{x}}\Diamond A \in w$, then
    $[\vec{x^\rho},\vec{x}]\Diamond A \in w$ for some new variables
    $\vec{x^\rho}$. So $\Diamond [\vec{x^\rho},\vec{x}] A \in w$, and
    so $\Diamond \t{\vec{x^\rho}:\vec{x}} A \in w$. \qed
  \end{proof}    
  
  (This cannot be proved without substitutional witnessing.) Let's try
  it with $\t{y:x}$.

  Case 1: $A$ is compatible with $x$ being equal to $y$.
  I.e. $\t{y:x}\Diamond (A \land x\!=\!y) \in w$. Then it follows by
  \T{S8} that $\Diamond \t{y:x}A \in w$.
  
  Case 2: $A$ is compatible with $x$ being equal to some $y'$ with
  $y'=y \in w$. I.e. $\t{y:x}\Diamond (A \land x\!=\!y') \in w$.
  Since $y\!=\!y' \in w$, it follows by LL that
  $\t{y:y'}\t{y:x}\Diamond (A \land x\!=\!y') \in w$. And this somehow
  entails that $\t{y':x}\Diamond (A \land x\!=\!y') \in w$. Then by
  \T{S8}, somehow, $\Diamond \t{y':x} (A \land x\!=\!y') \in w$, and
  so $\Diamond \t{y':x}A \in w$.
  
  Case 3: $A$ is not compatible with $x$ being equal to any $y'$ with
  $y'=y \in w$. I.e. $\t{y:x}\Diamond (A \land x\!=\!y') \not\in w$
  for all those $y'$. This can happen for several reasons.
  
  Case 3a: $A$ is compatible with $y'=y''$ for some distinct $y',y''
  \in [y]_w$. I.e. $\t{y:x}\Diamond (A \land y'\!=\!y'') \in w$. (E.g.
  $A$ entails $y' = y''$ and so $\t{y:x}\Box (A \then y'\!=\!y'') \in
  w$. We have to liberate one of those terms for $[y]_w$ to make it
  free for $x$.) Since $y'\!=\!y'' \in w$, it follows by LL that
  $\t{y':y''}\t{y:x}\Diamond (A \land y'\!=\!y'') \in w$. Then by
  \T{S8}, somehow, $\t{y:x} \Diamond \t{y'':y'} A \in w$. Now take
  $\t{y'':y'}A$ as the new $A$. Since $y''$ and $y'$ are distinct,
  $y'$ does not occur free in $\t{y'':y'}A$, so $\t{y'':y'}A$ must be
  compatible with $x$ being equal to some $y'$. We continue as in case
  2 and reach $\Diamond \t{y':x}\t{y'':y'}A \in w$. And so $\Diamond
  \t{y',y'':x,y'}A \in w$.
  
  Case 3b: $A$ is not compatible with $y'=y''$ for any distinct
  $y',y'' \in [y]_w$. I.e. $\t{y:x}\Diamond (A \land y'\!=\!y'')
  \not\in w$ for all those $y',y''$. I.e., $A$ entails that all the
  $y,y',y''$ are distinct from one another, and that $x$ is distinct
  from each of them. If $y$ has any counterparts at the $A$ world, it
  would have to have more counterparts than there are members of
  $[y]_w$. This is impossible. But how do we show it?
  
  From $\t{y:x}\Diamond (A \land y'\!=\!y'') \not\in w$, we have
  $\t{y:x}\Box (A \then y'\!\not=\!y'') \in w$. By Cont, $\Box
  \t{y:x}(A \then y'\!\not=\!y'') \in w$. So for all $w'$,
  $\t{y^\tau:x^\tau}(A^\tau \then y'^\tau\!\not=\!y''^\tau) \in w$...
  
  This won't work. There's nothing inconsistent about $\{
  \t{y:x}\Diamond (x\!\not=\!y \land y\!=\!y), y\!\not=\!z : z \in Var
  \backslash \{ y \}\}$. I guess I need an extended version of the
  existence lemma: if $\t{y:x}\Diamond A \in w$, then there are
  $\sigma,w'$ s.t. $y\!=\!y^\sigma \in w$ and $\t{{y^\sigma}^\tau:x^\tau}
  A^\tau \in w'$. -- Well, that won't work either. If $\{ \t{y:x}\Diamond
  (x\!\not=\!y \land y\!=\!y), y\!\not=\!z : z \in Var \backslash \{ y
  \}\}$ is $L$-consistent, it will be contained in some Henkin
  sets. Looks like I have to restrict the worlds by another clause
  like the witnessing requirement. Like the witnessing requirement,
  this clause must not compromise the fact that every $L$-consistent
  set can be embedded in a world (so it won't do to say that all
  worlds must satisfy some formula $A$ that is not a theorem of
  $L$). What we need actually looks much like witnessing: whenever
  $\t{y:x}A(x) \in w$, there is a $y'$ such that $A(y') \in w$.)

}

On to the details. Let $\Sc{L}$ be some language with or without substitution
and $L$ a positive or strongly negative quantified modal logic in $\Sc{L}$.
Define the extended language $\Sc{L}^*$ by adding infinitely many new variables
$\emph{Var}^+$ to $\Sc{L}$.

\begin{definition}[Henkin set]

  A \emph{Henkin set} for $L$ is a set $H$ of $\Sc{L}^*$-formulas that
  is
  \begin{enumerate}

  \item \emph{$L$-consistent}: there are no $A_1,\ldots,A_n \in H$
    with $\vdash_{L(\Sc{L}^*)} \neg (A_1 \land \ldots \land A_n)$,

  \item \emph{maximal}: for every $\Sc{L}^*$-formula $A$, $H$ contains
    either $A$ or $\neg A$,

  \item \emph{witnessed}: whenever $H$ contains an existential formula
    $\exists x A$, then there is a variable $y \not\in \var(A)$ such
    that $H$ contains $[y/x]A$ as well as $Ey$, and

  \item \emph{substitutionally witnessed}: whenever $H$ contains a
    substitution formula $\t{y:x} A$ as well as $y\!=\!y$, then there
    is a variable $z \not\in \var(\t{y:x}A)$ such that $H$ contains
    $y\!=\!z$.

  \end{enumerate}

  I write $\Fr{H}_L$ for the class of Henkin sets for $L$ in $\Sc{L}^*$.
\end{definition}

If $L$ is without substitution, the fourth clause is trivial.  

Above I said that witnessing a substitution formula $\t{y:x}A$ requires
$y\!=\!z$ as well as $[z/x]A$, but in fact $y\!=\!z$ is enough, since $[z/x]A$
follows from $\t{y:x}A$ and $y\!=\!z$ by \T{LV2} (lemma \ref{varLL}). I have
also added the condition that $H$ contains $y\!=\!y$. In negative logics, a
Henkin set may contain $y\!\not=\!y$ as well as $\t{y:x}A$; adding $y\!=\!z$
would render the set inconsistent.

The requirement of substitutional witnessing generalises to substitution
sequences: if $H$ contains a substitution formula
$\t{y_1,\ldots,y_n : x_1,\ldots,x_n}A$ as well as $y_i\!=\!y_i$ for all $y_i$ in
$y_1,\ldots,y_n$, then there are (distinct) new variables $z_1,\ldots,z_n$ such
that $H$ contains $y_1\!=\!z_1, \ldots, y_n\!=\!z_n$ as well as
$[z_1,\ldots,z_n/x_1,\ldots,x_n]A$. This is easily proved by induction on $n$.
Suppose $H$ contains $\t{y_1,\ldots,y_n : x_1,\ldots,x_n}A$. By definition
\ref{!SEQ}, this is
$\t{y_n:v}\t{y_1,\ldots,y_{n-1} : x_1,\ldots,x_{n-1}}\t{v:x_n}A$, where $v$ is
new. Witnessing requires $y_n\!=\!z_n \in H$ and (hence)
$[z_n/v]\t{y_1,\ldots,y_{n-1} : x_1,\ldots,x_{n-1}}\t{v:x_n}A = \t{y_1,\ldots,y_{n-1} : x_1,\ldots,x_{n-1}}\t{z_n:x_n}A \in H$
for some new $z_n$. By induction hypothesis, the latter means that there are
(distinct) $z_1,\ldots,z_{n-1} \not\in \var(\t{z_n:x_n}A)$ such that $H$
contains $y_1\!=\!z_1, \ldots, y_{n-1}\!=\!z_{n-1}$ as well as
$[z_1,\ldots,z_{n-1}/x_1,\ldots,x_{n-1}]\t{z_n:x_n}A$. Since all the $x_i$ and
$z_i$ are pairwise distinct,
$[z_1,\ldots,z_{n-1}/x_1,\ldots,x_{n-1}]\t{z_n:x_n}A$ is
$\t{z_n:x_n}[z_1,\ldots,z_{n-1}/x_1,\ldots,x_{n-1}]A$. By \T{SC1}, it follows
that
$[z_n/x_n][z_1,\ldots,z_{n-1}/x_1,\ldots,x_{n-1}]A = [z_1,\ldots,z_{n}/x_1,\ldots,x_{n}]A \in H$.

\cmnt{%
  Perhaps a more natural definition for substitution logics would
  replace clause 3 with the condition that $H$ is
  \begin{enumerate}
  \item[3.$^\diamond$] \emph{witnessed$^\diamond$}: whenever $H$
    contains an existential formula $\exists x A$, then there is a
    variable $y \not\in\var(A)$ such that $H$ contains $\t{y:x}A$ as
    well as $Ey$.
  \end{enumerate}
  If $y\not\in\var(A)$, then $\vdash_L [y/x]A \leftrightarrow
  \t{y:x}A$ by \T{SCI}, so the two clauses are equivalent.
} %

\cmnt{%
  For substitutional witnessing, $z$ must be new so that the witnessing formulas
  $[z/x] A, y\!=\!z$ entail the original $\t{y:x} A$. E.g., $[y/x]\Box x\!=\!y$,
  which is $\Box y\!=\!y$, does not entail $\t{y:x}\Box x\!=\!y$. Novelty of
  witnesses is used in the CML.

  Clause 4 could have been restricted to \emph{non-trivial
    substitutions},\label{nontrivial} where $y$ and $x$ are different variables.
  As it stands, it says that if $H$ contains $\t{x:x}A$ and $x\!=\!x$, then $H$
  must contain $[z/x]A$ and $x\!=\!z$ for some new $z$. Since $\t{x:x}$ is an
  empty operator, this seems unnecessary. On the other hand, I don't think
  there's any harm.%
} %

\cmnt{%
  For logics without substitution, we could have added the requirement
  that $H$ is
  \begin{enumerate}
  \item[4.*] \emph{substitutionally witnessed}: whenever $H$ contains
    a formula $A$ and an identity formula $x\!=\!y$, and $y$ is not
    modally free in $A$, then there is a variable $z \not\in \var(A)$
    such that $H$ contains $y\!=\!z$. [So $y$ is m.f. in $A$, and $H$
    contains $[z/x]A$, by (LL).] 
  \end{enumerate}
  The extensibility lemma can be adjusted accordingly. But it isn't
  really necessary, and it doesn't help with the existence lemma.
} %

\begin{definition}[Variable classes]
  For any Henkin set $H$, define $\sim_H$ to be the binary relation on the
  variables of $\Sc{L}^*$ such that $x \sim_H y$ iff $x\!=\!y \in H$. For any
  variable $x$, let $[x]_H$ be $\{ y : x \sim_H y \}$.
\end{definition}

\begin{lemma}[$\sim$-Lemma]\label{siml}
  $\sim_H$ is transitive and symmetrical.
\end{lemma}
\begin{proof}
  Immediate from lemmas \ref{symtrans} and \ref{symtrans-s}.\qed
\end{proof} 

\begin{definition}[Accessibility via transformations]\label{!tauacc}
  Let $w,w'$ be Henkin sets and $\tau$ a transformation. 

  If $\Sc{L}$ is with substitution, then \emph{$w'$ is accessible from $w$ via
    $\tau$}, for short: $w\xrightarrow{\tau} w'$, iff for every $\Sc{L}$-formula
  $A$, if $\Box A \in w$, then $A^\tau \in w'$.

  If $\Sc{L}$ is without substitution, then $w\xrightarrow{\tau}w'$ iff for
  every \Sc{L}-formula $A$ and variables $x_1\ldots x_n$, $y_1,\ldots,y_n$
  ($n \geq 0$) such that the $x_1\ldots x_n$ are pairwise distinct members of
  $\fvar(A)$, if $x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box A\in w$
  and $y_1^\tau \!=\!y_1^\tau \land\ldots\land y_n^\tau\!=\!y_n^\tau \in w'$,
  then there are variables $z_1\ldots z_n \not\in \var(A^\tau)$ such that
  $z_1\!=\!y_1^\tau \land \ldots \land z_n\!=\!y_n^\tau \land [z_1\ldots z_n/x_1^\tau\ldots x_n^\tau] A^\tau \in w'$.
\end{definition}

This generalises the witnessing requirements on accessible world as explained
above to multiple variables and negative logics. (In this case, the generalised
version for $n$ variable pairs is not entailed by the requirement for a single
pair, unlike in the case of substitutional witnessing.) Note that the
$x_1,\ldots,x_n$ need not be \emph{all} the free variables in $A$. Also recall
from p.\pageref{conventions} that a conjunction of zero sentences is the
tautology $\verum$; so for $n=0$, the accessibility requirement says that if
$\verum \land \Box A\in w$ and $\verum \in w'$, then
$\verum \land A^\tau \in w'$ -- equivalently: if $\Box A \in w$, then
$A^\tau \in w'$.

\cmnt{%
  We could have required that each $x_i$ is distinct from $y_i$,
  mirroring the possible restriction of substitutional witnesses to
  non-trivial substitutions (see p.~\pageref{nontrivial} above). If
  $x_i$ is $y_i$, clause 5 says that if $x\!=\!x \land \Box A \in w$,
  and $x^\tau\!=\!x^\tau \in w'$, then $z\!=\!x^\tau \land
  [z/x^\tau]A^\tau \in w'$ for some new $z$. Again, this is pointless
  but I think it does no harm.%
} %


\cmnt{

  Why the generalisation to multiple variables? We didn't add that to
  the substitution witnesses. Previously, I had: $wRw'$ iff for all
  $x,y,A$,

  \begin{compactenum}
  \item[(i)] if $\Box A \in w$, then $A^\tau \in w'$, and
  \item[(ii)] for any two variables $x,y$, if $x\!=\!y\land \Box A
    \in w$, then there is a $z\not\in \var(A^\tau)$ such that
    $x^\tau\!=\!x^\tau \then z\!=\!x^\tau \land [z/y^\tau] A^\tau
    \in w'$. 
  \end{compactenum}

  (Note that I had $y$ and $x$ the other way round.) But this won't
  do. Suppose $x_1\!=\!y_1 \land x_2\!=\!y_2 \land \Box Fy_1y_2 \in
  w$. By (ii), then $z_1=x_1^\tau \land Fz_1y_2 \in w'$ and
  $z_2=x_2^\tau \land Fy_1z_2 \in w'$, but we also want $Fz_1z_2 \in
  w'$.

  Again, assume $\Box \Diamond (x_1\!\not=\!y_1 \land x_2
  \!\not=\!y_2) \in w$, and $[x_i]_w= \{x_i,y_i\}$. This means that at
  every $w'$, all counterparts $a, b, c, d$ of
  $[x_1],[y_1],[x_2],[y_2]$ are such that some $w''$ harbours distinct
  counterparts for $a$ and $b$ and for $c$ and $d$. The counterparts
  $a$ of $[x_1]$ at $w'$ are $[x_1^\tau]_{w'}$ and $[y_1^\tau]_{w'}$
  (which may or may not be distinct, depending on what else $w'$
  says). Similarly for $b,c,d$. So $w'$ must tell us that
  \begin{compactenum}
    \item some $w''$ harbours two counterparts for $[x_1^\tau]$ and
      $[y_1^\tau]$, and for $[x_2^\tau]$ and $[y_2^\tau]$ --
      i.e. $\Diamond (x_1^\tau \!\not=\! y_1^\tau \land x_2^\tau
      \!\not=\!y_2^\tau)$;
    \item some $w''$ harbours two counterparts for $[x_1^\tau]$, and
      for $[x_2^\tau]$ and $[y_2^\tau]$ -- i.e. $z\!=\!x_1 \land
      \Diamond (x_1^\tau \!\not=\! z \land x_2^\tau
      \!\not=\!y_2^\tau)$;
    \item some $w''$ harbours two counterparts for $[y_1^\tau]$, and
      for $[x_2^\tau]$ and $[y_2^\tau]$ -- i.e. $z\!=\!y_1 \land
      \Diamond (y_1^\tau \!\not=\! z \land x_2^\tau
      \!\not=\!y_2^\tau)$;
    \item some $w''$ harbours two counterparts for $[x_1^\tau]$ and
      $[y_1^\tau]$, and for $[x_2^\tau]$ -- similar;
    \item some $w''$ harbours two counterparts for $[x_1^\tau]$ and
      $[y_1^\tau]$, and for $[y_2^\tau]$ -- i.e. $z_1\!\not=x_1^\tau
      \land z_2\!\not=\!x_2^\tau \land \Diamond (x_1^\tau \!\not=\!  z
      \land x_2^\tau \!\not=\!z)$;
    \item some $w''$ harbours two counterparts for $[x_1^\tau]$, and
      for $[x_2^\tau]$ -- similar;
    \item some $w''$ harbours two counterparts for $[y_1^\tau]$, and
      for $[x_2^\tau]$ -- similar;
    \item some $w''$ harbours two counterparts for $[x_1^\tau]$, and
      for $[y_2^\tau]$ -- similar;
    \item some $w''$ harbours two counterparts for $[y_1^\tau]$, and
      for $[y_2^\tau]$ -- similar.
  \end{compactenum}
  Clause (i) ensures the first of these, clause (ii) gives us 2-4, but
  we also need the others. 

}

\begin{definition}[Canonical model]\label{!CM}

  The \emph{canonical model} $\t{W,R,U,D,K,V}$ for $L$ is defined as
  follows.

  \begin{enumerate}

  \item The \emph{worlds} $W$ are the Henkin sets $\Fr{H}_{L}$.

  \item For each $w \in W$, the \emph{outer domain} $U_w$ comprises
    the non-empty sets $[x]_w$, where $x$ is a $\Sc{L}^*$-variable.

  \item For each $w \in W$, the \emph{inner domain} $D_w$ comprises
    the sets $[x]_w$ for which $Ex \in w$.

  \item The \emph{accessibility relation} $R$ holds between world $w$
    and world $w'$ iff there is some transformation $\tau$ such that
    $w \xrightarrow{\tau} w'$.

  \item $C$ is a \emph{counterpart relation} $\in K_{w,w'}$ iff there
    is a transformation $\tau$ such that (i) $w \xrightarrow{\tau} w'$
    and (ii) for all $d\in U_w, d'\in U_{w'}$, $dCd'$
    iff there is an $x \in d$ such that $x^\tau \in d'$.

  \item The \emph{predicate interpretation} $I$ assigns to every non-logical
    predicate $P$ and world $w$ the set
    $I_w(P) = \{ \t{[x_1]_w,\ldots, [x_n]_w} : P x_1\ldots x_n \in w \}$.

  \end{enumerate}

\end{definition}

\begin{definition}[Canonical Assignment]\label{!CG}
  If $w$ is a world in a canonical model $\Fr{M}$ then the \emph{canonical
    variable assignment on $U_{w}$} is the function $g$ such that $g(x)$ is
  either $[x]_{w}$ or undefined if $[x]_w = \emptyset$.
\end{definition}

This takes into account the fact that in negative logics, $\neg Ex$ entails
$x \not= y$ for every variable $y$. So if $\neg Ex \in w$, then $[x]_w$ is the
empty set. However, we don't want to say that empty terms denote the empty set
(so that $\emptyset \in D_w$, and $x\!=\!x$ would have to be true). Instead, the
canonical assignment assigns to each variable $x$ at $w$ the set $[x]_w$,
\emph{unless that set is empty}, in which case $g(x)$ remains undefined.
Similarly, clause 5 in definition \ref{!CM} ensures that $[x]_w$ at $w$ has
$[x^\tau]_{w'}$ as counterpart at $w'$ only if $[x^\tau]_{w'} \not= \emptyset$.

\cmnt{

  (Note that even if $[x]_w$ at $w$ has no counterpart at $w'$, $w',V'
  \SAT Fx$ iff $Fx^\tau \in w'$. So in our canonical model, $x^\tau$
  still represents $x$, despite the fact that $V'(x) = undef \not=
  [x^\tau]_{w'}$. We could alternatively change the definition of
  $\tau$ so that $x^\tau$ can be undefined, but this complicates
  things a lot.)

}

\cmnt{

  Here we will need the strongly negative axioms \T{NA} and
  \T{TE}. \T{NA} says that $\neg Ex \then \Box \neg Ex$. This means
  that if $\neg Ex\in w$, then $\neg Ex^\tau \in w'$ for all $wRw'$,
  which guarantees that non-existent objects don't have
  counterparts. \T{TE} guarantee that individuals do not go partly out
  of existence: $x\!=\!y \then \Box (Ex \then Ey)$. So if $x\!=\!y \in
  w$ and $x^\tau\!\not=\!x^\tau \in w'$, then $y^\tau\!\not=\!y^\tau
  \in w'$.

}

The term `$\{ \t{[x_1]_w,\ldots, [x_n]_w} : P x_1\ldots x_n \in w \}$' in clause
4 is meant to denote the set of $n$-tuples $\t{d_1,\ldots,d_n}$ for which there
are variables $x_1,\ldots,x_n$ such that $d_1 = [x_1]_w$ and \ldots and
$d_n = [x_n]_w$ and $Px_1\ldots x_n \in w$. These $d_i$ are guaranteed to be
non-empty because $x_i\!=\!x_i \in w$ whenever $Px_1\ldots x_n \in w$: if $L$ is
positive, then $\vdash_L z_i\!=\!z_i$ by \T{=\!R}; if $L$ is negative, then
$\vdash_L Pz_1\ldots z_n \then Ez_i$ by \T{Neg} and hence
$\vdash_L Pz_1\ldots z_n \then z_i\!=\!z_i$ by \T{\forall\!=\!R} and
\T{FUI^*}.\label{notenonempty}



\begin{lemma}[Charge of canonical models]\label{cmfit} 
  If $L$ is positive, then the canonical model for $L$ is positive. If
  $L$ is strongly negative, then the canonical model for $L$ is
  negative.
\end{lemma}
\begin{proof}
  If $L$ is positive, then for all $\Sc{L}^*$-variables $x$, every
  Henkin set for $L$ contains $x\!=\!x$ (by \T{=\!R}). So $V_w(x) =
  [x]_w$ is never empty. Nor is $[x^\tau]_{w'}$, for any world $w'$
  with $w\xrightarrow{\tau}w'$. So everything at any world has a
  counterpart at every accessible world under every counterpart
  relation. So the canonical model for a positive logic is positive.

  If $L$ is strongly negative, then every Henkin set for $L$ contains
  $x\!=\!x \then Ex$, for all $\Sc{L}^*$-variables $x$ (by
  \T{Neg}). So $V_w(x) = [x]_w \not= \emptyset$ iff $Ex \in w$, which
  means that $D_w = U_w$ for all worlds $w$ in the model. So the
  canonical model for a strongly negative logic is negative. \qed
\end{proof}

\begin{lemma}[Extensibility Lemma]\label{extensibility}
  If $\Gamma$ is an $L$-consistent set of $\Sc{L}^*$-sentences in
  which infinitely many $\Sc{L}^*$-variables do not occur, then there
  is a Henkin set $H \in \Fr{H}_L$ such that $\Gamma \subseteq H$.
\end{lemma}

\begin{proof}
  FIXME:CHECK
  Let $S_1,S_2,\ldots$ be an enumeration of all
  $\Sc{L}^*$-sentences, and $z_1,z_2,\ldots$ an enumeration of the
  unused $\Sc{L}^*$-variables in such a way that $z_i \not\in
  \var(S_1\land\ldots\land S_i)$. Let $\Gamma_0 = \Gamma$, and define
  $\Gamma_n$ for $n \geq 1$ as follows.
  %
  \begin{enumerate}
  \item[(i)] If $\Gamma_{n-1} \cup \{ S_n \}$ is not
    $L$-consistent, then $\Gamma_n = \Gamma_{n-1}$;
  \item[(ii)] else if $S_n$ is an existential formula $\exists x A$,
    then $\Gamma_n = \Gamma_{n-1} \cup \{ \exists x A, [z_n/x] A, Ez_n
    \}$;
  \item[(iii)] else if $S_n$ is a substitution formula $\t{y:x}A$,
    then $\Gamma_n = \Gamma_{n-1} \cup \{ \t{y:x}A, y\!=\!y \then y\!=\!z_n \}$;
  \item[(iv)] else $\Gamma_n = \Gamma_{n-1} \cup \{ S_n \}$.
  \end{enumerate}
  %
  Define $w$ as the union of all $\Gamma_n$. We show that $w$ is a
  Henkin set for $L$.

  \begin{enumerate}

  \item $w$ is $L$-consistent. This is shown by proving that
    $\Gamma_0$ is $L$-consistent and that whenever $\Gamma_{n-1}$ is
    $L$-consistent, then so is $\Gamma_n$. It follows that no finite
    subset of $w$ is $L$-inconsistent, and hence that $w$ itself is
    $L$-consistent. The base step, that $\Gamma_0$ is $L$-consistent
    is given by assumption. Now assume (for $n > 0$) that
    $\Gamma_{n-1}$ is $L$-consistent. Then $\Gamma_n$ is constructed
    by applying one of (i)--(iv).

    \begin{enumerate}

    \item If case (i) in the construction applies, then $\Gamma_n =
      \Gamma_{n-1}$, and so $\Gamma_n$ is also $L$-consistent.

    \item Assume case (ii) in the construction applies, and suppose
      that $\Gamma_n = \Gamma_{n-1} \cup \{ \exists x A, [z_n/x]A, Ez
      \}$ is $L$-inconsistent. Then there is a finite subset $\{
      C_1,\ldots,C_m \} \subseteq \Gamma_{n-1}$ such that
      \begin{alignat*}{2}
        1.\quad& \vdash_{L} \neg (C_1 \land \ldots \land C_m \land
        \exists x A \land [z_n/x]A \land Ez_n). &\quad&\\
      \intertext{Let $\vec{C}$ abbreviate $C_1 \land \ldots \land C_m$. Then}
        2.\quad&\vdash_{L} \vec{C} \land \exists x
        A \then (Ez_n \then \neg [z_n/x]A) &&\text{(1)}\\
        3.\quad&\vdash_{L} \forall z_n(\vec{C} \land 
        \exists x A) \then \forall z_n Ez_n \then \forall z_n\neg [z_n/x]A
        &&\text{(2, \T{UG}, \T{UD})}\\
        4.\quad&\vdash_L \vec{C} \land \exists x A 
        \then \forall z_n(\vec{C} \land \exists x A)
        &&\text{(\T{VQ}, $z_n$ not in $\Gamma_{n-1}$)}\\
        5.\quad&\vdash_{L} \vec{C} \land \exists x A \then
        \forall z_n Ez_n \then \forall z_n\neg [z_n/x]A.
        &&\text{(3, 4)}\\
        6.\quad& \vdash_{L} \vec{C} \land \exists x A \then
        \forall z_n \neg [z_n/x]A.
        &&\text{(5, \T{\forall Ex})}\\
        7.\quad& \vdash_{L} \forall z_n \neg [z_n/x] A \leftrightarrow \forall x \neg A 
        && \text{(\T{AC}, $z_n \not\in \var(A)$)}\\
        8.\quad& \vdash_{L} \vec{C} \land \exists x A 
        \then \neg \exists x A.&& \text{(6, 7)}
      \end{alignat*}
      So $\{ C_1,\ldots C_m, \exists x A \}$ is not
      $L$-consistent, contradicting the assumption that clause
      (ii) applies.

    \item Assume case (iii) in the construction applies (hence $L$ is
      with substitution), and suppose that $\Gamma_n = \Gamma_{n-1}
      \cup \{ \t{y:x}A, y\!=\!y \then y\!=\!z_n \}$ is
      $L$-inconsistent. Then there is a finite subset $\{
      C_1,\ldots,C_m \} \subseteq \Gamma_{n-1}$ such that
      % \setlength{\mathindent}{0.3\leftmargini}
      \begin{alignat*}{2}
        1.\quad& \vdash_{L} \neg (\vec{C} \land
        \t{y:x} A \land (y\!=\!y \then y\!\not=\!z)). &\quad&\\
      \intertext{(As before, $\vec{C}$ is $C_1\land\ldots\land C_m$.) But then}
        2.\quad& \vdash_{L} \vec{C}
        \land \t{y:x}A \then y\!=\!y \land y\!\not=\!z_n
        && \text{(1)}\\
        3.\quad& \vdash_{L} \t{y:z_n} (\vec{C}
        \land \t{y:x}A \then y\!=\!y \land y\!\not=\!z_n)
        && \text{(2, \T{Sub_s})}\\
        4.\quad& \vdash_{L} \t{y:z_n} (\vec{C}
        \land \t{y:x}A) \then \t{y:z_n} y\!=\!y \land \t{y:z_n}y\!\not=\!z_n
        && \text{(3, \T{S\!\then}, \T{S\!\neg})}\\
        5.\quad& \vdash_{L} \vec{C} \land \t{y:x}A \then \t{y:z_n} (\vec{C}
        \land \t{y:x}A)
        && \text{(\T{VS}, $z_n$ not in $\Gamma_{n-1}, S_n$)}\\
        6.\quad& \vdash_{L} \vec{C}
        \land \t{y:x}A \then \t{y:z_n} y\!=\!y \land \t{y:z_n}y\!\not=\!z_n
        && \text{(4, 5)}\\
        7.\quad& \vdash_{L} \t{y:z_n} y\!\not=\!z_n \leftrightarrow y\!\not=\!y
        && \text{\T{SAt}}\\
        8.\quad& \vdash_{L} \t{y:z_n} y\!=\!y \leftrightarrow y\!=\!y
        && \text{\T{SAt}}\\
        9.\quad& \vdash_{L} \vec{C} \land \t{y:x}A 
        \then (y\!=\!y \land y\!\not=\!y).
        && \text{(6, 7, 8)}
      \end{alignat*}
      So $\{C_1,\ldots,C_m, \t{y:x}A\}$ is $L$-inconsistent,
      contradicting the assumption that clause (iii) applies.

    \item Assume case (iv) in the construction applies. Then $\Gamma_n
      = \Gamma_{n-1} \cup \{ S_n \}$ is $L$-consistent, since
      otherwise  (i) would have applied.

    \end{enumerate}

  \item $w$ is maximal. Assume some formula $S_n$ is not in $w$. Then
    case (i) applied to $S_n$, so $\Gamma_{n-1} \cup \{ S_n \}$ is not
    $L$-consistent. So there are $C_1,\ldots,C_m \in \Gamma_{n-1}$
    such that $\vdash_L C_1 \land \ldots C_m \then \neg
    S_n$. Similarly, if $S_k = \neg S_n$ is not in $w$, then there are
    $D_1,\ldots,D_l \in \Gamma_{k-1}$ such that $\vdash_L D_1 \land
    \ldots D_l \then \neg S_k$. By \T{PC}, it follows that there are
    $C_1,\ldots,C_m, D_1,\ldots D_l \in w$ such that
    \[
    \vdash_L C_1 \land \ldots \land C_m \land D_1 \land \ldots \land
    D_l \then (\neg S_n \land \neg \neg S_n).
    \]
    But then $w$ is inconsistent, contradicting what was just shown
    under 1.

  \item $w$ is witnessed. This is guaranteed by clause (ii) of the
    construction and the fact that the $z_n \not\in \var(S_n)$. 

  \item $w$ is substitutionally witnessed. This is guaranteed by
    clause (iii) and the fact that the $z_n \not\in \var(S_n)$. \qed

  \end{enumerate}

\end{proof}

\cmnt{
  Some comments.
  \begin{enumerate}

  \item I used to have two versions of clause (ii), one for
    substitution logics and one for non-substitution logics:
    \begin{enumerate}
    \item[(ii)] else if $S_n$ is an existential formula $\exists x A$
      and $L$ is with substitution, then $\Gamma_n = \Gamma_{n-1} \cup
      \{ \exists x A, \t{z_n:x} A, Ez_n \}$;
    \item[(ii$^*$)] else if $S_n$ is an existential formula $\exists x
      A$ and $L$ is without substitution, then $\Gamma_n =
      \Gamma_{n-1} \cup \{ \exists x A, [z_n/x] A, Ez_n \}$;
    \end{enumerate}
    This version of (ii) is more natural for substitution logics (and
    it immediately shows that $w$ is witnessed$^\Diamond$), but it
    isn't really necessary to distinguish the two cases; in
    particular, the proof above, for (ii*), also works in substitution
    logics. The proof for (ii) used to go as follows.
    \begin{itemize}
    \item Assume case (ii) in the construction applied, and suppose
      $\Gamma_n = \Gamma_{n-1} \cup \{ \exists x A, \t{z_n:x}A, Ez \}$
      is $L$-inconsistent. Then there is a finite subset $\{
      C_1,\ldots,C_m \} \subseteq \Gamma_{n-1}$ such that
      % \setlength{\mathindent}{0.3\leftmargini}
      \begin{alignat*}{2}
        1.\quad& \vdash_{L} \neg (C_1 \land \ldots \land C_m \land
        \exists x A \land \t{z_n:x}A \land Ez_n). &\quad&\\
      \intertext{Let $\vec{C}$ abbreviate $C_1 \land \ldots \land C_m$. Then}
        2.\quad&\vdash_{L} \vec{C} \land \exists x
        A \then (Ez_n \then \neg \t{z_n:x}A) &&\text{(1)}\\
        3.\quad&\vdash_{L} \forall z_n(\vec{C} \land 
        \exists x A) \then \forall z_n Ez_n \then \forall z_n\neg \t{z_n:x}A
        &&\text{(2, \T{UG}, \T{UD})}\\
        4.\quad&\vdash_L \vec{C} \land \exists x A 
        \then \forall z_n(\vec{C} \land \exists x A)
        &&\text{(\T{VQ}, $z_n$ not in $\Gamma_{n-1}$)}\\
        5.\quad&\vdash_{L} \vec{C} \land \exists x A \then
        \forall z_n Ez_n \then \forall z_n\neg \t{z_n:x}A.
        &&\text{(3, 4)}\\
        6.\quad& \vdash_{L} \vec{C} \land \exists x A \then
        \forall z_n \neg \t{z_n:x}A.
        &&\text{(5, \T{\forall Ex})}\\
        7.\quad& \vdash_{L} \neg \t{z_n:x} A \then  \t{z_n:x}\neg A 
        &\quad& \text{\T{S\neg}}\\
        8.\quad& \vdash_{L} \forall z_n \neg \t{z_n:x} A \then \forall z_n 
        \t{z_n:x} \neg A &\quad& \text{(7, \T{UG}, \T{UD})}\\
        9.\quad& \vdash_{L} \forall z_n \t{z_n:x}\neg A \then \forall x 
        \neg A &\quad& \text{(\T{SBV}, $z_n \not\in \var(A)$)}\\
        10.\quad& \vdash_{L} \vec{C} \land \exists x A 
        \then \neg \exists x A.&& \text{(6, 8, 9)}
      \end{alignat*}
      So $\{ C_1,\ldots C_m, \exists x A \}$ is not
      $L$-consistent, contradicting the assumption that clause
      (ii) applies.
    \end{itemize}
    
  \item With the additional constraint (4*) on Henkin sets mentioned
    above, we would need a further construction clause
    \begin{enumerate}
    \item[(ii*)] else if $S_n$ is a formula $x\!=\!y \land A$ and
      $\Sc{L}$ does not contain substitution, then $\Gamma_n =
      \Gamma_{n-1} \cup \{ x\!=\!y \land A, y\!=\!z_n \}$ (and
      perhaps, redundantly, $\cup \{ [z_n/x]A \}$);
    \end{enumerate}
    and a further clause in the proof:
    \begin{itemize}
    \item Assume case (ii*) in the construction applied, and suppose
      that $\Gamma_n = \Gamma_{n-1} \cup \{ x\!=\!y \land A, y\!=\!z_n
      \}$ is $L$-inconsistent, although $\Gamma_{n-1} \cup \{
      x\!=\!y \land A \}$ is $L$-consistent.  Then there are
      $\vec{C} \in \Gamma_{n-1}$ such that
      \[
      \vdash_{L} \vec{C} \land x\!=\!y \land A \then
      y\!\not=\!z_n.
      \]
      But since $z_n$ does not occur in $\Gamma_{n-1}, x\!=\!y \land
      A$, and thus $y$ is modally free for $z_n$ in the whole formula,
      we have by (Subs*),
      \[
      \vdash_{L} \vec{C} \land x\!=\!y \land A \then
      y\!\not=\!y.
      \]
      But since $\vdash_{L} x\!=\!y \then y\!=\!y$, then
      \[
      \vdash_{L} \vec{C} \land A \then x\!\not=\!y,
      \]
      contradicting the assumption that $\Gamma_{n-1} \cup \{
      x\!=\!y \land A \}$ is $L$-consistent.
    \end{itemize}
    
  \item Can we ensure substitutional witnessing for languages without
    substitution? I.e. can we ensure that whenever $w$ contains a
    formula $A$ and an identity formula $x\!=\!y$, and $y$ is not
    modally free in $A$, then there is a variable $z \not\in \var(A)$
    such that $H$ contains $y\!=\!z$ [so that $H$ contains $[z/x]A$,
    by (LL)]? Not obvious. Whenever we add a new formula $S_n$, we
    have to check whether $\Gamma_{n-1}$ contains some identities
    $x\!=\!y$ such that $y$ is not m.f. in $S_n$; if so, we add a
    corresponding formula $y\!=\!z_{n+i}$, increasing the $z_n$
    counter for unused new variables. But that is not enough: if we
    later add $x\!=\!y$, we have to go through all previous formulas
    again and add the required substitutional witnesses.

    It might be easier to start off by associating with each
    $\Sc{L}^*$-variable $y$ infinitely many $\Sc{L^*}$-variables
    $z,z'$ and set $\Gamma_0 = \Gamma \cup \{ y\!=\!z, y\!=\!z',
    \ldots \}$. Then whenever $x\!=\!y \in \Gamma_n$, we must
    eventually have $x\!=\!z$ etc. in $w$ as well. And because $A$
    can at most contain finitely many variables, if $A \in \Gamma_n$,
    we therefore have $y\!=\!z$ in $w$ for some $z$ that doesn't occur
    in $A$.

    Let's see how that goes.

    Divide the $\Sc{L}^*$ variables so that each $\Sc{L}^*$-variable
    $y$ gets paired with infinitely many (disjoint)
    $\Sc{L}^*$-variables $Eq(y) = \{ y',y'',\ldots \},$, leaving
    infinitely many further $\Sc{L}^*$-variables $z_1,z_2,\ldots$
    unused. (Think of an infinite 2D matrix into which the
    $\Sc{L}^*$-variables are filled diagonally, with column 1 labeled
    `unused' and the columns from 2 onwards labeled by the $\Sc{L}^*$
    variables.) Let $Id = \{ y\!=\!z : y \in \var(\Sc{L}^*), z \in
    Eq(y) \}$, and define $\Gamma_0 = \Gamma \cup Id \cup \{ Ex : x
    \in \var(\Sc{L}) \}$ if $L = [[\Lambda]_{Nec}, Ex]$, else $\Gamma_0
    = \Gamma \cup Id$. Let $S_1,S_2,\ldots$ be an enumeration of all
    $\Sc{L}^*$-sentences, and $z_1,z_2,\ldots$ an enumeration of the
    unused variables from $\Fr{L^*}$ such that $z_i \not\in
    \var(S_1\land\ldots\land S_n)$.

    Now one problem is that we no longer have $z_n \not\in
    \var(\Gamma_{n-1})$, as $\Gamma_0$ already contains all variables
    as part of $Id$. We could have left $Eq(y)$ empty for pure
    $\Sc{L}^*$-variables $y$. But then how would we ensure
    substitutional witnessing for formulas with pure
    $\Sc{L}^*$-formulas? Could we somehow fill in $Id$ incrementally,
    or would that lead us back to the starting point?

  \end{enumerate}

}


\begin{lemma}[Existence Lemma]\label{existence}
  If $w$ is a world in the canonical model for $L$, $A$ a formula with
  $\Diamond A \in w$, and $\tau$ any transformation whose range
  excludes infinitely many variables of \Sc{L}, then there is a world
  $w'$ in the model such that $w\xrightarrow{\tau}w'$ and $A^{\tau}
  \in w'$.
\end{lemma}

\begin{proof}
  FIXME:CHECK
  I first prove the lemma for logics $L$ with substitution. Let
  $\Gamma = \{ A^\tau \} \cup \{ B^\tau : \Box B \in w \}$.%
  \cmnt{%
    E.g., $\Gamma$ might be $\{ \exists x Fx \} \cup \{ Fx : x \in
    \var(\Fr{L}^*)$.%
  } %
  Suppose $\Gamma$ is not $L$-consistent. Then there are $B_1^\tau,
  \ldots, B_n^\tau$ with $\Box B_i \in w$ such that $\vdash_{L}
  B_1^\tau \land \ldots\land B_n^\tau \then \neg A^\tau$. By
  definition \ref{!SUB}, this means that $\vdash_L (B_1 \land \ldots
  B_n \then \neg A)^\tau$, and so $\vdash_L B_1\land\ldots\land B_n
  \then \neg A$ by \T{Sub^\tau}. By \T{Nec} and \T{K}, $\vdash_{L}
  \Box B_1 \land \ldots \land \Box B_n \then \Box \neg A$. But then
  $w$ contains both $\Diamond A$ and $\neg \Diamond A$, which is
  impossible because $w$ is $L$-consistent. So $\Gamma$ is
  $L$-consistent.

  Since the range of $\tau$ excludes infinitely many variables, by the
  extensibility lemma, $\Gamma \subseteq H$ for some Henkin set $H$.
  Moreover, $w\xrightarrow{\tau}w'$ because $B^\tau\in H$ whenever for
  $\Box B \in w$.

  Now for logics without substitution.

  \cmnt{ 

    We can't use the same simple construction as before, since the
    world $w'$ must satisfy the more sophisticated definition of
    accessibility. Recall that for substitution-free logics,
    $w\xrightarrow{\tau}w'$ iff for every formula $A$ and variables
    $x_1\ldots x_n$, $y_1,\ldots,y_n$ ($n \geq 0$) such that the
    $x_1\ldots x_n$ are pairwise distinct members of $\fvar(A)$, if
    $x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box A\in w$ and
    $y_1^\tau \!=\!y_1^\tau \land\ldots\land y_n^\tau\!=\!y_n^\tau \in
    w'$, then there are variables $z_1\ldots z_n \not\in \var(A^\tau)$
    such that $z_1\!=\!y_1^\tau \land \ldots \land z_n\!=\!y_n^\tau
    \land [z_1\ldots z_n/x_1^\tau\ldots x_n^\tau] A^\tau \in w'$.

    (Consider again the case where $w$ contains $x\!=\!y \land
    \Box\Diamond x\!\not=\!y$. Assuming positive models, this says
    that every counterpart of the individual denoted by $x$ and $y$
    has multiple counterparts at some further world. If $w'$ is
    $\tau$-accessible from $w$, we therefore want $[y^\tau]_{w'}$ to
    have multiple counterparts at some world $w''$. Hence we require
    that if $w$ contains $x\!=\!y \land \Box \Diamond x\!\not=\!y$,
    then there is a $z$ such that $w'$ contains $y^\tau\!=\!z \land
    \Diamond z\!\not=\!y^\tau$.)

    The first task in building $w'$ is to find suitable variables
    $z$. Since $w$ might contain $\Box x\!\not=\!z$ for all $z$
    (except $x$), and thus $w'$ might have to contain all $x^\tau
    \!\not=\!z^\tau$, $z$ must not be in the range of $\tau$. So we
    choose the ``unused'' variables for the $z$ role.

    We start constructing $w'$ by defining a set that meets the
    condition imposed by $w\xrightarrow{\tau}w'$.  Let's ignore
    negative models for now, so that we can ignore the requirement
    that $y^\tau\!=\!y^\tau \in w'$.  Let $S_1, S_2 \ldots$ enumerate
    all sentences in $w$ of the form
    \[
    x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box B,
    \]
    where $x_1,\ldots,x_n$ are zero or more distinct variables free in
    $B$, and each $y_i$ is distinct from $x_i$. For each $S_i =
    (x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box B)$, let
    $Z(S_i)$ be a set of unused variables $z_1,\ldots,z_n$ such that
    $Z(S_i) \cap \bigcup_{j<i} Z(S_j) = \emptyset$, and let $S_i^*$ be
    the sentence
    \[
    y_1^\tau\!=\!z_1 \land \ldots \land y_n^\tau\!=\!z_n \land 
    [z_1,\ldots,z_n/x_1^\tau,\ldots,x_n^\tau]B.
    \]
    Then let $\Gamma = \bigcup_i S_i^* \cup \{ A^\tau \}$.  $\Gamma$
    satisfies the accessibility condition.

    We have to show that $\Gamma$ is consistent (and that infinitely
    many variables do not occur in it). To bring out the main proof ideas,
    pretend that $\Gamma$ contains just one simple $S_i^*$, so that
    \[
    \Gamma = \{ A^\tau,  y^\tau\!=\!z \land [z/x^\tau]B \}.
    \]
    Suppose for reductio that $\Gamma$ is inconsistent. I.e.
    \begin{equation}\tag{1}
      \vdash_L \neg (A^\tau \land y^\tau\!=\!z \land [z/x^\tau]B^\tau).
    \end{equation}
    Following the proof for substitution logics, we would rephrase
    this as
    \begin{equation*}
      \vdash_L y^\tau\!=\!z \land [z/x^\tau]B^\tau \then \neg A^\tau,
    \end{equation*}
    then apply \T{Sub^\tau} to remove the $\tau$ superscripts, use
    necessitation and \T{K}, and show that the result contradicts the
    consistency of $w$. Unfortunately, $z$ is not in the range of
    $\tau$, so we can't use \T{Sub^\tau} to remove the
    superscripts. Worse, we have no guarantee that
    $\Box(y\!=\!z^{-\tau} \land [z^{-\tau}/x]B)$ is in $w$. Indeed,
    $\Box y\!=\!z^{-\tau}$ entails that $y$ has a unique counterpart
    at every accessible world, which may well be false.

    Let's apply necessitation directly to (1):
    \begin{equation}\tag{2}
      \vdash_L \Box \neg (A^\tau \land y^\tau\!=\!z \land [z/x^\tau]B^\tau).
    \end{equation}
    Pretend for a moment that $z$ is in the range of $\tau$, so that
    (2) entails
    \begin{equation}\tag{2'}
      \vdash_L \Box \neg (A \land y\!=\!z^{-\tau} \land [z^{-\tau}/x]B).
    \end{equation}
    Now consider the following application of \T{CS}:
    \begin{equation}\tag{3}
      \vdash_L x\!=\!y \land \Box B \then \Box(y\!=\!z^{-\tau} 
      \then [z^{-\tau}/x]B).
    \end{equation}
    Since $w$ contains $x\!=\!y \land \Box B$, this means that it
    contains $\Box(y\!=\!z^{-\tau} \then [z^{-\tau}/x]B)$. If we could
    show that $w$ also contains $\Diamond(A \,\land\,
    y\!=\!z^{-\tau})$, it would follow that $w$ contains $\Diamond(A
    \,\land\, y\!=\!z^{-\tau} \,\land\, [z^{-\tau}/x]B)$. But $w$ is
    consistent, so $\not\vdash_L \Box\neg(A \,\land\, y\!=\!z^{-\tau}
    \,\land\, [z^{-\tau}/x]B)$ -- in contradiction to (2').

    Now we have no guarantee that $w$ contains $\Diamond(A \land
    y\!=\!z^{-\tau})$. However, this time no untoward consequences
    would ensue if such a formula were in $w$. E.g. this would not
    entail that $y$ has a unique counterpart at some world. We could
    therefore add a new variable $z^{*}$ to the language, stipulate
    that $\tau(z^*) = z$ (so that $z^*$ is the so-far undefined
    $z^{-\tau}$), and extend $w$ by the formula $\Diamond(A \land
    y\!=\!z^*)$ without losing consistency.

    What I do instead is slightly simpler: I make room for the new
    variable $z^*$ by first applying a transformation $\sigma$ to $w$
    that leaves infinitely many variables unused. By \T{Sub^\tau},
    this preserves consistency. In fact, I use $\tau$ for this
    purpose. The new variables $\vec{z^*}$ are then the unused
    variables of $\tau$. The formula we add to $w^\tau$ becomes
    $\Diamond (A^\tau \land y^\tau\!=\!z)$, where $z$ is unused. Let
    $\Delta$ be this extension of $w^\tau$. We will see that $\Delta$
    is indeed consistent. Then we can reason as above: since $w^\tau$
    contains $x^\tau\!=\!y^\tau \land \Box B^\tau$, by \T{CS}, it
    contains $\Box(y^\tau\!=\!z \then [z/x^\tau]B)$.  So $\Delta$
    contains $\Diamond (A^\tau \land y^\tau\!=\!z \land [z/x^\tau]B)$
    -- in contradiction to (2).
  
    OK. Let's remove the simplification that $\Gamma$ contains just
    one simple $S_i^*$. If $\Gamma$ is inconsistent, there are
    $S_1^*,\ldots,S_m^*$ such that
    \begin{equation}\tag{1}
      \vdash_L \neg (A^\tau \land S_1^* \land \ldots \land S_m^*)
   \end{equation}
    By necessitation,
    \begin{equation}\tag{2}
      \vdash_L \Box \neg (A^\tau \land S_1^* \land \ldots \land S_m^*)
    \end{equation}
    Each $S_i^*$, remember, has the form
    \[
    y_1^\tau\!=\!z_1 \land \ldots \land y_n^\tau\!=\!z_n \land 
    [z_1,\ldots,z_n/x_1^\tau,\ldots,x_n^\tau]B.
    \]
    Instead of \T{CS}, we use
    \begin{semantics}
      \itemT{CS_n} $\vdash_L x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n
      \then \Box A \then \Box(y_1\!=\!z_1 \land \ldots \land y_n\!=\!z_n
      \then [z_1,\ldots,z_n/x_1,\ldots,x_n]A)$, provided
      $z_1,\ldots,z_n$ are not free in $A$.
    \end{semantics}
    The relevant applications have the form
    \begin{multline}\tag{3}
      \vdash_L x_{1}^\tau\!=\!y_{1}^\tau \land\ldots\land 
      x_{n}^\tau\!=\!y_{n}^\tau \land \Box B^\tau \then\\ 
      \Box(y_{1}^\tau\!=\!z_{1} \land\ldots\land y_{n}^\tau\!=\!z_{n}
      \then [z_{1},\ldots,z_{n}/x_{1}^\tau,\ldots,x_{n}^\tau]B).
    \end{multline}
    Since $w^\tau$ contains all the antecedents, it contains all the
    consequents. The consequents are just the formulas $S_i^*$. Let
    $\Delta = w^\tau \cup \{ \Diamond(A^\tau \land
    y_{11}^\tau\!=\!z_{11} \land \ldots) \}$. Then $\Delta$ implies
    $\Diamond (A^\tau \land S_1^* \land\ldots\land S_m^*)$. We show
    that $\Delta$ is consistent -- in contradiction to (2).

    \bigskip
  
  }


  Let $S_1, S_2 \ldots$ enumerate all sentences in $w$ of the form
  \[
  x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box B,
  \]
  where $x_1,\ldots,x_n$ are zero or more distinct variables free in
  $B$. Let $U$ be the ``unused'' $\Sc{L}$-variables that are not in
  the range of $\tau$. Let $Z$ be an infinite subset of $U$
  such that $Z \backslash U$ is also infinite. For each $S_i =
  (x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box B)$, let
  $Z_{S_i}$ be a set of distinct variables $z_1,\ldots,z_n \in Z$ such
  that $Z_{S_i} \cap \bigcup_{j<i} Z_{S_j} = \emptyset$ (i.e. none of
  the $z_i$ has been used for any earlier $S_j$). Abbreviate
  \begin{align*}
    B_i &\df [z_1,\ldots,z_n/x_1^\tau,\ldots,x_n^\tau]B^\tau;\\
    X_i &\df x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n;\\
    Y_i &\df y_1^\tau\!=\!y_1^\tau \land \ldots \land y_n^\tau\!=\!y_n^\tau;\\
    Z_i &\df y_1^\tau\!=\!z_1 \land \ldots \land y_n^\tau\!=\!z_n.
  \end{align*}
  \cmnt{($S^*_i$ is $Y_i \then Z_i \land B_i$).} (For $n=0$, $X_i,Y_i$
  and $Z_i$ are the tautology $\verum$, and $B_i$ is $B^\tau$.)
  
  Let $\Gamma^- = \{ (Y_i \then Z_i \land B_i) : S_i \in
  S_1,S_2,\ldots \}$, and let $\Gamma = \Gamma^- \cup \{ A^\tau
  \}$.

  Suppose for reductio that $\Gamma$ is inconsistent. Then there are
  sentences $(Y_1 \then Z_1 \land B_1), \ldots, (Y_m \then Z_m \land
  B_m) \in \Gamma^-$ such that
  \begin{equation}\tag{1}
    \vdash_L \neg (A^\tau \land (Y_1 \then Z_1 \land B_1)
    \land\ldots\land (Y_m \then Z_m \land B_m)).
  \end{equation}
  By \T{Nec},
  \begin{equation}\tag{2}
    \vdash_L \Box \neg (A^\tau \land (Y_1 \then Z_1 \land B_1)
    \land\ldots\land (Y_m \then Z_m \land B_m)).
  \end{equation}
  Any member $(Y_i \then Z_i \land B_i)$ of $\Gamma^-$ has
  the form
  \[
  y_1^\tau\!=\!y_1^\tau \land \ldots \land y_n^\tau\!=\!y_n^\tau \then
  y_1^\tau\!=\!z_1 \land \ldots \land y_n^\tau\!=\!z_n \land
  [z_{1},\ldots,z_{n}/x_{1}^\tau,\ldots,x_{n}^\tau]B^\tau.
  \]
  By \T{CS_n},
  \begin{multline}\tag{3}
    \vdash_L x_{1}^\tau\!=\!y_{1}^\tau \land\ldots\land 
    x_{n}^\tau\!=\!y_{n}^\tau \land \Box B^\tau \then\\ 
    \Box(y_{1}^\tau\!=\!z_{1} \land\ldots\land y_{n}^\tau\!=\!z_{n}
    \then [z_{1},\ldots,z_{n}/x_{1}^\tau,\ldots,x_{n}^\tau]B^\tau).
  \end{multline}
  Now $w$ contains $x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land
  \Box B$. So $w^\tau$ contains $x_{1}^\tau\!=\!y_{1}^\tau
  \land\ldots\land x_{n}^\tau\!=\!y_{n}^\tau \land \Box B^\tau$, which
  is the antecedent of (3). The consequent of (3) is $\Box(Z_i \then
  B_i)$. Thus
  \begin{equation}\tag{4}
    w^\tau \vdash_L \Box (Z_1 \then B_1) \land \ldots \land 
    \Box (Z_m \then B_m).
  \end{equation}
  Let $\Delta = w^\tau \cup \{ \Diamond(A^\tau \land (Y_1 \then
  Z_1)\land \ldots\land (Y_m \then Z_m)) \}.$
  So
  \begin{gather}
    \Delta \vdash_L \Box (Z_1 \then B_1) \land \ldots \land 
    \Box (Z_m \then B_m); \tag{5}\\
    \Delta \vdash_L \Diamond(A^\tau \land (Y_1 \then Z_1)
    \land\ldots\land (Y_m \then Z_m)). \tag{6}
  \end{gather}
  By \T{K} and \T{Nec}, (5) and (6) yield 
  \begin{equation}\tag{7}
    \Delta \vdash_L \Diamond(A^\tau \land (Y_1 \then Z_1 \land B_1)
    \land\ldots\land (Y_m \then Z_m \land B_m)).
  \end{equation}
  By (2), it follows that $\Delta$ is inconsistent.  This means that
  \begin{equation}\tag{8}
    w^\tau \vdash_L \neg  \Diamond(A^\tau \land (Y_1 \then
    Z_1)\land \ldots\land (Y_m \then Z_m)).
  \end{equation}
  Now consider $Z_1 = (y_1^\tau\!=\!z_1 \land \ldots \land
  y_n^\tau\!=\!z_n)$. By \T{LL_n^*} (or repeated application of $\T{LL^*}$),
  \begin{multline}\tag{9}
    \vdash_L y_1^\tau\!=\!z_1 \land \ldots \land y_n^\tau\!=\!z_n
    \then \Box\neg (A^\tau \land (y_1^\tau\!=\!y_1^\tau \land\ldots\land
    y_n^\tau\!=\!y_n^\tau \then y_1^\tau\!=\!z_1 \land\ldots\land y_n^\tau\!=\!z_n))\\
    \then \Box\neg (A^\tau \land (y_1^\tau\!=\!y_1^\tau \land\ldots\land
    y_n^\tau\!=\!y_n^\tau \then y_1^\tau\!=\!y_1^\tau \land\ldots\land y_n^\tau\!=\!y_n^\tau)),
  \end{multline}
  because the $z_i$ are not free in $A^\tau$. In other words (and
  dropping the tautologous conjunct at the end),
  \begin{equation}\tag{10}
    \vdash_L Z_1 \then \Box \neg (A^\tau \land (Y_1 \then Z_1)) 
    \then \Box \neg A^\tau .
  \end{equation}
  By the same reasoning,
  \begin{equation}\tag{11}
    \vdash_L Z_1 \land \ldots\land Z_m \then 
    \Box \neg (A^\tau \land (Y_1 \then Z_1) \land \ldots\land (Y_m \then Z_m)) 
    \then \Box \neg A^\tau .
  \end{equation}
  By \T{PC}, \T{Nec} and \T{K}, this means
  \begin{equation}\tag{12}
    \vdash_L Z_1\land\ldots\land Z_m \then \Diamond A^\tau \then
    \Diamond (A^\tau \land (Y_1 \then Z_1) \land\ldots\land (Y_m\then Z_m)).
  \end{equation}
  Since $w^\tau \vdash_L \Diamond A^\tau$, (8) and (12) together entail
  \begin{equation}\tag{13}
    w^\tau \vdash_L \neg (Z_1 \land\ldots\land Z_m).
  \end{equation}
  So there are $C_1,\ldots,C_k \in w$ such that
  \begin{equation}\tag{14}
    \vdash_L C_1^\tau \land \ldots \land C_k^\tau \then \neg 
    (Z_1 \land \ldots \land Z_m).
  \end{equation}
  Each $Z_i$ has the form $y_1^\tau\!=\!z_1 \land \ldots \land
  y_n^\tau\!=\!z_n$. All the $z_i$ are pairwise distinct, and none of
  them occur in $C_1^\tau \land \ldots \land C_k^\tau$ (because the
  $z_i$ are not in the range of $\tau$) nor in any other $Z_i$. By
  \T{Sub^*}, we can therefore replace each $z_i$ in (14) by the
  corresponding $y_i^\tau$, turning $Z_i$ into $Y_i$:
  \begin{equation}\tag{15}
   \vdash_L C_1^\tau \land \ldots \land C_k^\tau \then \neg 
   (Y_1 \land\ldots\land Y_m).
  \end{equation}
  For any $Y_i = (y_1^\tau\!=\!y_1^\tau \land \ldots \land
  y_n^\tau\!=\!y_n^\tau)$, $X_i$ is a sentence of the form
  $x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n$. So $X_i^\tau$ is
  $x_1^\tau\!=\!y_1^\tau \land \ldots \land x_n^\tau\!=\!y_n^\tau$,
  and $\vdash_L X_i^\tau \then Y_i$ by either \T{=\!R} or \T{Neg} and
  \T{\forall\!=\!R}. So (15) entails
  \begin{equation}\tag{16}
    \vdash_L C_1^\tau \land \ldots \land C_k^\tau \then \neg 
    (X_1^\tau \land\ldots\land X_m^\tau).
  \end{equation}
  Thus by \T{Sub^\tau}, 
  \begin{equation}\tag{17}
    \vdash_L C_1 \land \ldots \land C_k \then \neg 
    (X_1 \land\ldots\land X_m).
  \end{equation}
  Since $\{ C_1,\ldots,C_k, X_1,\ldots,X_m \} \subseteq w$, it follows
  that $w$ is inconsistent. Which it isn't. This completes the
  reductio. 

  So $\Gamma$ is consistent. Since the infinitely many variables in
  $U\backslash Z$ do not occur in $\Gamma$, lemma \ref{extensibility}
  guarantees that $\Gamma \subseteq w'$ for some world $w'$ in the
  canonical model for $L$. And of course, $\Gamma$ was constructed so
  that $w'$ satisfies the condition in definition \ref{!tauacc} for
  $w\xrightarrow{\tau}w'$. This requires that for every formula $B$
  and variables $x_1\ldots x_n$, $y_1,\ldots,y_n$ such that the
  $x_1\ldots x_n$ are zero or more pairwise distinct members of
  $\fvar(B)$, if $x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land
  \Box B\in w$ and $y_1^\tau \!=\!y_1^\tau \land\ldots\land
  y_n^\tau\!=\!y_n^\tau \in w'$, then there are variables $z_1\ldots
  z_n \not\in \var(B^\tau)$ such that $z_1\!=\!y_1^\tau \land \ldots
  \land z_n\!=\!y_n^\tau \land [z_1\ldots z_n/x_1^\tau\ldots x_n^\tau]
  B^\tau \in w'$. By construction of $\Gamma$, whenever $x_1\!=\!y_1
  \land \ldots \land x_n\!=\!y_n \land \Box B\in w$, then there are
  suitable $z_1,\ldots,z_n$ such that $y_1^\tau\!=\!y_1^\tau \land
  \ldots \land y_n^\tau\!=\!y_n^\tau \then y_1^\tau\!=\!z_1 \land
  \ldots \land y_n^\tau\!=\!z_n \land
  [z_1,\ldots,z_n/x_1^\tau,\ldots,x_n^\tau]B^\tau \in w'$. So if
  $y_1^\tau\!=\!y_1^\tau \land \ldots \land y_n^\tau\!=\!y_n^\tau \in
  w'$, then $y_1^\tau\!=\!z_1 \land \ldots \land y_n^\tau\!=\!z_n
  \land [z_1,\ldots,z_n/x_1^\tau,\ldots,x_n^\tau]B^\tau \in w'$. \qed
 
\end{proof}

\begin{lemma}[Truth Lemma]\label{cml}
  If $\Fr{M} = \t{W,R,U,D,K,V}$ is the canonical model for $L$, $w\in W$, and
  $g$ is the canonical assignment on $U_{w}$, then for any \Sc{L}-sentence $A$,
  \[
  \Fr{M}w,g \SAT A \text{ iff } A \in w.
  \]
\end{lemma}

\begin{proof}
  FIXME
  by induction on $A$.

  \begin{enumerate}

  \item $A$ is $Px_1\ldots x_n$.\; $w,V \SAT Px_1\ldots x_n$ iff
    $\t{V_w(x_1), \ldots, V_w(x_n)} \in V_w(P)$ by definition
    \ref{!SAT}. By construction of $V_w$ (definition \ref{!CM}),
    $V_w(x_i)$ is $[x_i]_w$ or undefined if $[x_i]_w = \emptyset$, and
    $V_w(P) = \{ \t{[z_1]_w,\ldots,[z_n]_w} : Pz_1\ldots z_n \in w
    \}$. (For non-logical $P$, this is directly given by definition
    \ref{!CM}; for the identity predicate, $V_w(=)$ is $\{ \t{d,d} : d
    \in U_w \}$ by definition \ref{!SAT}, which equals $\{
    \t{[z]_w,[z]_w} : z\!=\!z \in w \} = \{ \t{[z_1]_w,[z_2]_w}:
    z_1\!=\!z_2 \in w \}$ because the members of $U_w$ are precisely
    the non-empty sets $[z]_w$.)%
    \cmnt{%
      (For the last step: every $\t{[z_1]_w,[z_2]_w}$ with
      $z_1\!=\!z_2 \in w$ is a $\t{[z]_w,[z]_w}$ with $z\!=\!z \in w$,
      and every $\t{[z]_w,[z]_w}$ with $z\!=\!z \in w$ is a
      $\t{[z_1]_w,[z_2]_w}$ with $z_1\!=\!z_2 \in w$.)%
    } %

    Now if $\t{V_w(x_1), \ldots, V_w(x_n)} \in V_w(P)$, then
    $\t{[x_1]_w, \ldots, [x_n]_w} \in \{ \t{[z_1]_w,\ldots,[z_n]_w} :
    Pz_1\ldots z_n \in w \}$, where all the $[x_i]_w$ are non-empty
    (for $V_w(x_i)$ is defined). This means that there are variables
    $z_1,\ldots,z_n$ such that $\{ x_1\!=\!z_1,\ldots,x_n\!=\!z_n,
    Pz_1\ldots z_n \} \subseteq w$. Then $Px_1\ldots x_n \in w$ by
    \T{LL^*}.

    In the other direction, if $Px_1\ldots x_n \in w$, then
    $x_i\!=\!x_i \in w$ for all $x_i$ in $x_1\ldots x_n$ (see
    p.~\pageref{notenonempty}). Hence $\t{[x_1]_w, \ldots, [x_n]_w}
    \in \{ \t{[z_1]_w,\ldots,[z_n]_w} : Pz_1\ldots z_n \in w \}$,
    i.e.\ $\t{V_w(x_1), \ldots, V_w(x_n)} \in V_w(P)$.

  \item $A$ is $\neg B$.\; $w,V \SAT \neg B$ iff $w,V \not\SAT B$ by
    definition \ref{!SAT}, iff $B \not\in w$ by induction hypothesis,
    iff $\neg B \in w$ by maximality of $w$.

  \item $A$ is $B \then C$.\; $w,V \SAT B \then C$ iff $w,V \not\SAT
    B$ or $w,V \SAT C$ by definition \ref{!SAT}, iff $B \not\in w$ or
    $C \in w$ by induction hypothesis, iff $B \then C \in w$ by
    maximality and consistency of $w$ and the fact that $\vdash_L \neg
    B \then (B \then C)$ and $\vdash_L C \then (B \then C)$.
 
  \item $A$ is $\t{y:x}B$.\; Assume first that $w,V \SAT
    y\!\not=\!y$. So $V_w(y)$ is undefined, and it is not the case
    that $V_w(y)$ has multiple counterparts at any world. And then
    $w,V \SAT \t{y:x}B$ iff $w,V^{[y/x]} \SAT B$ by definition
    \ref{!SATG}, iff $w,V \SAT [y/x]B$ by lemma \ref{rsl}, iff $[y/x]B
    \in w$ by induction hypothesis. Also by induction hypothesis,
    $y\!\not=\!y \in w$. By \T{SCN}, $\vdash_L y\!\not=\!y \then
    ([y/x]B \leftrightarrow \t{y:x}B)$. So $[y/x]B \in w$ iff
    $\t{y:x}B \in w$.

    Next, assume that $w,V \SAT y\!=\!y$; so by induction hypothesis
    $y\!=\!y \in w$. Assume further that $\t{y:x}B \not\in w$. Then
    $\neg\t{y:x}B \in w$ by maximality of $w$, and $\t{y:x}\neg B \in
    w$ by \T{S\neg}.  Since $w$ is substitutionally witnessed and
    $y\!=\!y \in w$, there is a variable $z \not\in \var(\t{y:x}\neg
    B)$ such that $y\!=\!z \in w$ and $[z/x] \neg B \in w$. By
    induction hypothesis, $w,V \SAT y\!=\!z$. Moreover, by definition
    \ref{!SUB}, $\neg [z/x]B \in w$, and so $[z/x]B \not\in w$ by
    consistency of $w$. By induction hypothesis, $w,V \not\SAT
    [z/x]B$. By definition \ref{!SAT}, then $w,V \SAT \neg [z/x]B$,
    i.e.\ $w,V \SAT [z/x]\neg B$. Since $z$ and $x$ are modally
    separated in $B$, then $w,V^{[z/x]} \SAT \neg B$ by lemma
    \ref{rsl}. But $V^{[z/x]}$ and $V^{[y/x]}$ agree on all variables
    at $w$, because $w,V \SAT y\!=\!z$. So $w,V^{[y/x]} \SAT \neg B$
    by the locality lemma \ref{locality}. So $w,V^{[y/x]} \not\SAT B$
    by definition \ref{!SAT}, and $w,V \not\SAT \t{y:x} B$ by
    definition \ref{!SATG}.

    In the other direction, assume $\t{y:x}B \in w$. Since $w$ is
    substitutionally witnessed and $y\!=\!y \in w$, there is a new
    variable $z$ such that $y\!=\!z \in w$ and $[z/x] B \in w$. By
    induction hypothesis, $w,V \SAT y\!=\!z$ and $w,V \SAT
    [z/x]B$. Since $z$ and $x$ are modally separated in $B$,
    $w,V^{[z/x]} \SAT B$ by lemma \ref{rsl}. As before $V^{[z/x]}$ and
    $V^{[y/x]}$ agree on all variables at $w$, because $w,V \SAT
    y\!=\!z$; so $w,V^{[y/x]} \SAT B$ by lemma \ref{locality} and $w,V
    \SAT \t{y:x} B$ by definition \ref{!SATG}.

  \item $A$ is $\forall x B$.\; We first show that for any variable
    $x$, $w,V \SAT Ex$ iff $Ex \in w$: $w,V \SAT Ex$ iff $V_w(x) \in
    D_w$ by definition \ref{!SUB}, iff $[x]_w \in D_w$ by definition
    \ref{!CM}, iff $Ex \in w$ by definition \ref{!CM}.

    Now assume $\forall x B \in w$, and let $y$ be any variable such
    that $Ey \in w$. As just shown, $w,V \SAT Ey$. By \T{FUI^{**}},
    $\exists x(x\!=\!y \land B) \in w$. By witnessing, there is a $z
    \not\in \var(B)$ such that $z\!=\!y \land [z/x]B \in w$, and thus
    $z\!=\!y \in w$ and $[z/x]B \in w$. By induction hypothesis, $w,V
    \SAT z\!=\!y$ and $w,V \SAT [z/x]B$. By lemma \ref{rsl}, then
    $w,V^{[z/x]} \SAT B$. And since $V_w(z) = V_w(y)$, it follows by
    lemma \ref{locality} that $w,V^{[y/x]} \SAT B$. So if $\forall x B
    \in w$, then $w,V^{[y/x]} \SAT B$ for all variables $y$ with $Ey
    \in w$, i.e. with $V_w(y) \in D_w$. Since every member $[y]_w$ of
    $D_w$ is denoted by some variable $y$ under $V_w$, this means that
    $w,V' \SAT B$ for all existential $x$-variants $V'$ of $V$ on
    $w$. So $w,V \SAT \forall x B$.%
    \cmnt{%
      (The last steps are only valid if $V$ is the original
      interpretation function, not if it is an image: with images,
      members of $D_w$ can be unnamed.)%
    } %

    Conversely, assume $\forall x B \not\in w$. Then $\exists x \neg B
    \in w$; so by witnessing, $[y/x]\neg B \in w$ for some $y \not\in
    \var(B)$ with $Ey \in w$. Then $\neg [y/x]B \in w$ and so $[y/x] B
    \not\in w$. As shown above, $w,V \SAT Ey$. Moreover, by induction
    hypothesis, $w,V \not\SAT [y/x]B$. By lemma \ref{rsl}, then
    $w,V^{[y/x]} \not\SAT B$. Let $V'$ be the (existential)
    $x$-variant of $V$ on $w$ with $V'_w(x) = V^{[y/x]}_w(x)$. By the
    locality lemma, $w,V' \not\SAT B$. So $w,V \not\SAT \forall x B$.

    \cmnt{

      \T{FUI^{**}} here gives us a kind of witnessing for universal
      formulas, which amounts to something like \T{FUI}: whenever
      $\forall x B \in w$, then for each $[y]_w \in D_w$ there is a
      $z$ s.t. $z\!=\!y \in w$ and $[z/x]B \in w$. Compare
      \T{FUI_s}, which ensures that whenever $\forall x B \in w$ then
      for each $[y]_w \in D_w$, $\t{y:x}B \in w$ and so by
      substitutional witnessing, for each $[y]_w \in D_w$ there is a
      $z$ s.t. $z\!=\!y \in w$ and $[z/x]B \in w$.

    }

  \item $A$ is $\Box B$.\; Assume $w,V \SAT \Box B$. Then $w',V' \SAT
    B$ for all $w',V'$ with $wRw'$ and $V_w \Img V'_{w'}$. We first
    show that if $w\xrightarrow{\tau}w'$, then $V_w \Img
    V^\tau_{w'}$. %
    \cmnt{%
      Recall that by definition \ref{!IMG}, $V_w \Img V^\tau_{w'}$ if
      there is a counterpart relation between $w$ and $w'$ such that
      for every variable $x$, if $V_w(x)$ has a counterpart at
      $w'$, then $V^\tau_{w'}(x)$ is one of these counterparts,
      otherwise it is undefined. Moreover, by definition \ref{!CM},
      every $\tau$ with $w\xrightarrow{\tau}w'$ determines a
      counterpart relation that holds between $V_w(x)$ at $w$ and $d'
      \in U_{w'}$ at $w'$ iff there is a variable $z$ with $z\in
      V_w(x)$ and $z^\tau \in d'$. Taken together, $V_w \Img
      V^\tau_{w'}$ iff there is a transformation $\sigma$ such that
      $w\xrightarrow{\sigma}w'$ and for every variable $x$, if there
      is a $z \in V_w(x)$ such that $[z^\sigma]_{w'} \in U_{w'}$, then
      there is a $z \in V_w(x)$ such that $z^\sigma_{w'} \in
      V^\tau_{w'}(x)$.%
    } %
    By definitions \ref{!IMG} and \ref{!CM}, $V_w \Img V^\tau_{w'}$
    means that there is a transformation $\sigma$ such that
    $w\xrightarrow{\sigma}w'$ and for every variable $y$, if there is
    a $z \in V_w(y)$ such that $[z^\sigma]_{w'} \in U_{w'}$ (i.e., if
    $V_w(y)$ has any $\sigma$-counterpart at $w'$), then there is a $z
    \in V_w(y)$ with $z^\sigma \in V^\tau_{w'}(y)$ (i.e., then
    $V^\tau_{w'}(y)$ is such a counterpart), otherwise
    $V^\tau_{w'}(y)$ is undefined. The relevant transformation
    $\sigma$ will be $\tau$. So what we'll show is this: for every
    variable $y$, if there is a $z \in V_w(y)$ such that
    $[z^\tau]_{w'} \in U_{w'}$, then there is a $z \in V_w(y)$ with
    $z^\tau \in V^\tau_{w'}(y)$, otherwise
    $V^\tau_{w'}(y)$ is undefined. 

    Let $y$ be any variable. Assume first that there is a $z \in
    V_w(y)$ such that $[z^\tau]_{w'} \in U_{w'}$. Then $z\!=\!y \in w$
    and $z^{\tau}\!=\!z^{\tau} \in w'$. By either \T{Neg} and \T{EI}
    or \T{=\!R}, $\vdash_L z\!=\!y \then y\!=\!y$; so $y\!=\!y \in
    w$. Moreover, by either \T{TE}, \T{EI}, \T{Nec} and \T{K} or
    \T{=\!R} and \T{Nec}, $\vdash_L z\!=\!y \then \Box(z\!=\!z \then
    y\!=\!y)$; so $\Box(z\!=\!z \then y\!=\!y) \in w$. By definition
    of $w\xrightarrow{\tau}w'$, then $z^\tau\!=\!z^\tau \then
    y^\tau\!=\!y^\tau \in w'$. So $y^\tau\!=y^\tau \in w'$. Hence $y
    \in V_w(y)$ and $y^\tau \in [y^\tau]_{w'} = V_{w'}(y^\tau) =
    V^\tau_{w'}(y)$.  Alternatively, assume there is no $z \in V_w(y)$
    with $z^{\tau}\!=\!z^{\tau} \in w'$. Then either $V_w(y) =
    \emptyset$, in which case $y\!\not=\!y \in w$, and so
    $\Box(y\!\not=\!y) \in w$ by \T{NA}, \T{EI}, \T{Nec} and \T{K},
    and $y^\tau\!\not=\!y^\tau \in w'$ by definition of
    $w\xrightarrow{\tau}w'$, or else $V_w(y) \not= \emptyset$, but
    $z^{\tau}\!\not=\!z^{\tau} \in w'$ for all $z \in V_w(y)$, in
    which case, too, $y^\tau\!\not=\!y^\tau \in w'$ since $y \in
    V_w(y)$. Either way, $V_{w'}(y^\tau) = V^\tau_{w'}(y)$ is
    undefined.

    We've shown that if $w,V \SAT \Box B$, then for every $w'$ and
    $\tau$ with $w\xrightarrow{\tau} w'$, $w',V^{\tau} \SAT B$. By the
    transformation lemma, then $w',V \SAT B^\tau$. By induction
    hypothesis, $B^{\tau} \in w'$. Now suppose $\Box B \not\in
    w$. Then $\Diamond \neg B \in w$ by maximality of $w$. By the
    existence lemma, there is then a world $w'$ and transformation
    $\tau$ with $w\xrightarrow{\tau}w'$ and $\neg B^{\tau} \in
    w'$. (Any transformation whose range excludes infinitely many
    variables will do.) But we've just seen that if
    $w\xrightarrow{\tau}w'$, then $B^\tau \in w'$. So if $w,V \SAT
    \Box B$, then $\Box B \in w$.

    For the other direction, assume $w,V \not\SAT \Box B$. So $w',V'
    \not\SAT B$ for some $w',V'$ with $wRw'$ and $V_w \Img V'_{w'}$.%
    \cmnt{%

      It may help to run through a simplified version of the proof
      first, assuming that $B$ contains a single free variable $x$ and
      ignoring negative logics. So we assume that $w,V \SAT \Diamond
      \neg B(x)$, and hence $w',V' \SAT \neg B(x)$ for suitable
      $w',V'$. If $V'$ were $V^\tau$ for $\tau: w \xrightarrow{\tau}
      w'$, things would be easy: suppose for reductio that
      $\Diamond\neg B(x) \not\in w$ and so $\Box B(x) \in w$; then
      $B(x^\tau)\in w'$ for all $w': w\xrightarrow{\tau} w'$, and by
      i.h., $w',V^\tau \SAT B(x)$ -- contradiction. But $V'$ may not
      be $V^\tau$, i.e.\ $V'_{w'}(x)$ may not be
      $V^\tau_{w'}(x)$. What we do know is that there is some
      ``guise'' of $x$ at $w$, i.e.\ some variable $y$ with $x\!=\!y
      \in w$ for which $V'_{w'}(x) = [y^\tau]_{w'}$. Moreover,
      $[y^\tau]_{w'} = V_{w'}(y^\tau) = V_{w'}^\tau(y) = V^{\tau \cdot
        [y/x]}_{w'}(x)$. So we can think of $V'$ as $V^{\tau\cdot
        [y/x]}$.
      
      Thus our assumption is that $w',V^{\tau\cdot [y/x]} \SAT \neg
      B(x)$. We suppose for reductio that $\Box B(x) \in w$. Since
      $x\!=\!y\in w$, it follows that $\t{y:x}\Box B(x) \in w$ and so
      $\Box \t{y:x} B(x) \in w$. By construction of $R$, then
      $\t{y^\tau: x^\tau}B(x^\tau) \in w'$. By witnessing, there is a
      new variable $z$ such that $z\!=\!y^\tau \in w'$ and
      $[z/x^\tau]B(x^\tau) \in w'$. By induction hypothesis, $w',V
      \SAT z\!=\!y^\tau$ and $w',V \SAT [z/x^\tau]B(x^\tau)$. Since
      $z$ is new, $w',V^{[z/x^\tau]} \SAT B(x^\tau)$ by lemma
      \ref{rsl}. By the transformation lemma, $w',V^{[z/x^\tau]\cdot
        \tau} \SAT B(x)$.  But $V^{[z/x^\tau]\cdot\tau}_{w'}(x) =
      V^{[z/x^\tau]}_{w'}(x^\tau) = V_{w'}(z) = V_{w'}(y^\tau)$ (because
      $w',V \SAT y^\tau\!=\!z$) $ = V_{w'}^\tau(y) =
      V_{w'}^{\tau\cdot[y/x]}(x)$. Hence by the locality lemma,
      $w',V^{\tau\cdot[y/x]} \SAT B(x)$ -- contradiction.

      Without substitution, we don't have $\t{y:x}B(x) \in w$ and
      hence $\t{y^\tau: x^\tau}B(x^\tau) \in w'$. Instead we get the
      witnessing consequence -- that there is a new variable $z$ such
      that $z\!=\!y^\tau \in w'$ and $[z/x^\tau]B(x^\tau) \in w'$ --
      by definition of accessibility.

    } %
    As before, $V_w \Img V'_{w'}$ means that there is a transformation
    $\tau$ with $w\xrightarrow{\tau}w'$ such that for every variable
    $x$, either there is a $y \in V_w(x)$ with $y^\tau \in
    V'_{w'}(x)$, or there is no $y\in V_w(x)$ with $y^\tau\!=\!y^\tau
    \in w'$, in which case $V'_{w'}(x)$ is undefined. Let $\tau$ be
    any transformation with $w\xrightarrow{\tau} w'$, and let $*$ be a
    substitution that maps each variable $x$ in $B$ to some member $y$
    of $V_w(x)$ with $y^\tau \in V'_{w'}(x)$, or to itself if there is
    no such $y$. Thus if $x \in \var(B)$ and $V'_{w'}(x)$ is defined,
    then $(*x)^\tau \in V'_{w'}(x)$, and so $V'_{w'}(x) =
    [(*x)^\tau]_{w'} = V^{\tau\cdot *}_{w'}(x)$. Alternatively, if
    $V'_{w'}(x)$ is undefined (so $*x=x$), then $V^{\tau\cdot
      *}_{w'}(x) = V^{\tau}_{w'}(x)$ is also undefined. The reason is
    that otherwise $V^{\tau}_{w'}(x) = [x^\tau]_{w'} \not= \emptyset$
    and $x^\tau\!=\!x^\tau \in w'$; by definition of accessibility,
    then $\Box x\!\not=\!x \not\in w$ and hence $x\!=\!x \in w$, as
    $\vdash_L x\!\not=\!x \then \Box x\!\not=\!x$; so there is a $y
    \in V_w(x)$, namely $x$, such that $y^\tau\!=\!y^\tau \in w'$, in
    which case $V'_{w'}(x)$ cannot be undefined (by definition
    \ref{!IMG}). So $V'$ and $V^{\tau\cdot *}$ agree at $w'$ on all
    variables in $B$. By lemma \ref{coincidence}, $w',V^{\tau\cdot *}
    \not\SAT B$.

    Now suppose for reductio that $\Box B \in w$. Let $x_1,\ldots,x_n$
    be the variables $x$ in $\var(B)$ with $(*x)^\tau \in V'_{w'}(x)$
    (thus excluding empty variables as well as variables denoting
    individuals without $\tau$-counterparts at $w'$). For each such $x_i$,
    $*x_i \in V_w(x_i)$, and so $x_i\!=\!*x_i \in w$. If $L$ is with
    substitution, then by \T{LL_n}, $\t{*x_1,\ldots,*x_n : x_1,\ldots,
      x_n}\Box B \in w$; so $\Box\t{*x_1,\ldots,*x_n : x_1,\ldots,
      x_n} B \in w$ by \T{S\Box}. By definition of
    $w\xrightarrow{\tau}w'$, then $\t{(*x_1)^\tau,\ldots,(*x_n)^\tau :
      x_1^\tau,\ldots, x_n^\tau} B^\tau \in w'$. By substitutional
    witnessing, it follows that there are new variables
    $z_1,\ldots,z_n$ such that $z_i\!=\!(*x_i)^\tau \in w'$ and
    (hence) $[z_1,\ldots,z_n / x_1^\tau,\ldots,x_n^\tau]B^\tau \in
    w'$. If $L$ is without substitution, this fact -- that there are
    new variables $z_1,\ldots,z_n$ such that $z_i\!=\!(*x_i)^\tau \in
    w'$ and $[z_1,\ldots,z_n / x_1^\tau,\ldots,x_n^\tau]B^\tau \in w'$
    -- is guaranteed directly by definition of $w\xrightarrow{\tau}w'$
    and the fact that $\Box B \in w$.

    By induction hypothesis, $w',V \SAT z_i\!=\!(*x_i)^\tau$ and $w',V
    \SAT [z_1,\ldots,z_n / x_1^\tau,\ldots,x_n^\tau]B^\tau$. Since the
    $z_i$ are new, $w',V^{[z_1,\ldots,z_n / x_1^\tau,\ldots,x_n^\tau]}
    \SAT B^\tau$ by lemma \ref{rsl}. By the transformation lemma
    \ref{transl}, then $w',V^{[z_1,\ldots,z_n /
      x_1^\tau,\ldots,x_n^\tau]\cdot\tau} \SAT B$. However, for each $x_i$,
    $V^{[z_1,\ldots,z_n /
      x_1^\tau,\ldots,x_n^\tau]\cdot\tau}_{w'}(x_i) =
    V^{[z_1,\ldots,z_n / x_1^\tau,\ldots,x_n^\tau]}_{w'}(x_i^\tau) =
    V_{w'}(z_i) = V_{w'}((*x_i)^\tau)$ (because $w',V \SAT
    (*x_i)^\tau\!=\!z_i$) $ = V_{w'}^\tau(*x_i) =
    V_{w'}^{\tau\cdot[*x_1,\ldots,*x_n/x_1,\ldots,x_n]}(x_i) =
    V_{w'}^{\tau\cdot *}(x_i)$. Similarly, if $x \in \var(B)$ is none
    of the $x_1,\ldots,x_n$, so $(*x)^\tau \not\in V'_{w'}(x)$, then
    $*x$ is $x$ by definition of $*$, and so $V^{[z_1,\ldots,z_n /
      x_1^\tau,\ldots,x_n^\tau]\cdot\tau}_{w'}(x) = V^\tau_{w'}(x) =
    V^\tau_{w'}(*x) = V_{w'}^{\tau\cdot *}(x)$. So $V^{[z_1,\ldots,z_n
      / x_1^\tau,\ldots,x_n^\tau]\cdot\tau}$ and $V_{w'}^{\tau\cdot
      *}$ agree at $w'$ on all variables in $B$. By lemma
    \ref{locality}, then $w',V^{\tau\cdot *} \SAT B$ -- contradiction.
    \qed

  \end{enumerate}

\end{proof}


\cmnt{
  Where do I need the strong form of (LL) that allows $x=y \then \Box
  Fx \then \Box Fy$? Suppose we remove it from the logic. Then $\{
  x\!=\!y, \Box Fx, \neg \Box Fy = \Diamond \neg Fy \}$ is consistent,
  and can be extended to a Henkin set $w$. The existence lemma
  requires that $\{ \neg Fy^\tau, Fx^\tau \}$ can be extended to a
  Henkin set $w'$. That's fine. But it also requires that $wRw'$,
  which by clause (x) of $R$ means that there is a new variable $z$
  s.t. $\{ z\!=\!y^\tau, Fz \} \subseteq w'$. But then $w'$ is
  inconsistent. So the strong form of (LL) is needed in the existence
  lemma to ensure $wRw'$.
}

\section{Completeness}\label{sec:completeness}

FIXME: This whole section

Recall that a logic $L$ in some language of quantified modal logic is
\emph{(strongly) complete with respect to a class of models}
$\mathbb{M}$ if every $L$-consistent set of formulas $\Gamma$ is
verified at some world in some model in $\mathbb{M}$. $L$ is
\emph{characterised by} $\mathbb{M}$ if $L$ is sound and complete with
respect to $\mathbb{M}$.

The minimal positive and negative logics from sections
\ref{sec.logics} and \ref{sec.sublogics} were designed to be complete
with respect to the class of all positive and negative models,
respectively. Let's confirm that this is the case.

\begin{theorem}[Completeness of \s{P} and $\s{P}_s$]
  The logics \s{P} and $\s{P}_s$ are (strongly) complete with respect
  to the class of positive counterpart models.
\end{theorem}
\begin{proof}
  Let $L$ range over \s{P} and $\s{P}_s$.  We have to show that
  whenever a set of $\Sc{L}$-formulas $\Gamma$ is $L$-consistent, then
  there is some world in some positive counterpart model that verifies
  all members of $\Gamma$. By lemma \ref{cmfit}, the canonical model
  $\Fr{M}_L = \t{\Fr{S}_L, V_L}$ for $L$ is a positive model. By the
  Extensibility Lemma, $\Gamma \subseteq w$ for some world $w$ in
  $\Fr{M}_{L}$, since none of the infinitely many variables
  $\emph{Var}^+$ occur in $\Gamma$. By the truth lemma, then $w,V_L
  \SAT_{\Fr{S}_L} A$ for each $A \in \Gamma$. \qed
\end{proof}

\begin{theorem}[Completeness of \s{N} and $\s{N}_s$]
  The logics \s{N} and $\s{N}_s$ are (strongly) complete with respect
  to the class of negative counterpart models.
\end{theorem}
\begin{proof}
  Let $L$ range over \s{N} and $\s{N}_s$, and let $\Gamma$ be an
  $L$-consistent set of $\Sc{L}$-formulas. By lemma \ref{cmfit}, the
  canonical model $\Fr{M}_L = \t{\Fr{S}_L, V_L}$ for $L$ is a negative
  model. By the Extensibility Lemma, $\Gamma \subseteq w$ for some
  world $w$ in $\Fr{M}_{L}$, since none of the infinitely many
  variables $\emph{Var}^+$ occur in $\Gamma$. By the truth lemma, then
  $w,V_L \SAT_{\Fr{S}_L} A$ for each $A \in \Gamma$. \qed
\end{proof}

Together with the soundness theorems \ref{soundness-P},
\ref{soundness-N}, \ref{soundness-Ps} and \ref{soundness-Ns}, it
follows that $\s{P}$ and $\s{P}_s$ are characterized by the class of
positive models, and $\s{N}$ and $\s{N}_s$ by the class of negative
models.

In footnote \ref{fn-multicr} (on page \pageref{fn-multicr}) I
mentioned that the introduction of multiple counterpart relations
makes little difference to the base logic. Let's call a counterpart
structure in which any two worlds are linked by at most one
counterpart relation \emph{unirelational}. As it turns out, $\s{P}$
and $\s{P}_s$ are also characterized by the class of unirelational
positive models, and $\s{N}$ and $\s{N}_s$ by the class of
unirelational negative models. The easiest way to see this is perhaps
to note that all the lemmas in the previous section still go through
if we define accessibility and counterparthood in canonical models by
a fixed transformation $\tau$ whose range excludes infinitely many
variables. The extensibility lemma \ref{extensibility} and existence
lemma \ref{existence} are unaffected by this change; the only part
that needs adjusting is the clause for $\Box B$ in the proof of the
truth lemma \ref{cml}, but the adjustments are straightforward.

\cmnt{%
  Assume $w,V \SAT \Box B$. Then $w',V' \SAT B$ for all $w',V'$ with
  $wRw'$ and $V_w \Img V'_{w'}$. We first show that $V_w \Img
  V^\tau_{w'}$. By definitions \ref{!IMG} and \ref{!CM}, this means
  that for every variable $y$, either there is a $z \in V_w(y)$ with
  $z^{\tau} \in V^\tau_{w'}(y)$, or there is no $z\in V_w(y)$ with
  $z^\tau\!=\!z^\tau \in w'$, in which case $V^\tau_{w'}(y)$ is
  undefined. So let $y$ be any variable. Assume there is a $z \in
  V_w(y)$ with $z^{\tau}\!=\!z^{\tau} \in w'$. Then all $z \in V_w(y)$
  are such that $z^{\tau}\!=\!z^{\tau} \in w'$, since $\vdash_L
  x\!=\!y \then \Box(x\!=\!x \then y\!=\!y)$, by either \T{TE} and
  \T{Neg} or \T{=\!R}. Moreover, then $y \in V_w(y)$. So $y^\tau \in
  [y^\tau]_{w'} = V_{w'}(y^\tau) = V_{w'}^{\tau}(y)$. Alternatively,
  assume there is no $z \in V_w(y)$ with $z^{\tau}\!=\!z^{\tau} \in
  w'$. Then either $V_w(y) = \emptyset$, in which case $y\!\not=\!y
  \in w$, and so $\Box(y\!\not=\!y) \in w$ by \T{NA} and
  $y^\tau\!\not=\!y^\tau \in w'$ by definition of $R$, or else $V_w(y)
  \not= \emptyset$, but $z^{\tau}\!\not=\!z^{\tau} \in w'$ for all $z
  \in V_w(y)$, in which case, too, $y^\tau\!\not=\!y^\tau \in w'$
  since $y \in V_w(y)$. Either way, $V_{w'}(y^\tau) = V^\tau_{w'}(y)$
  is undefined. So $V_w\Img V^\tau_{w'}$.

  We've shown that if $w,V \SAT \Box B$, then for every $w'$ with
  $wRw'$, $w',V^{\tau} \SAT B$. By the transformation lemma, then
  $w',V \SAT B^\tau$, and by induction hypothesis, $B^{\tau} \in
  w'$. Now suppose $\Box B \not\in w$. Then $\Diamond \neg B \in w$ by
  maximality of $w$. By the existence lemma, there is then a world
  $w'$ with $wRw'$ and $\neg B^{\tau} \in w'$. But we've just seen
  that if $wRw'$, then $B^\tau \in w'$. So if $w,V \SAT \Box B$, then
  $\Box B \in w$.

  For the other direction, assume $w,V \not\SAT \Box B$. So $w',V'
  \not\SAT B$ for some $w',V'$ with $wRw'$ and $V_w \Img V'_{w'}$. As
  before, $V_w \Img V'_{w'}$ means that for every variable $y$, either
  there is a $z \in V_w(y)$ with $z^\tau \in V'_{w'}(y)$, or there is
  no $z\in V_w(y)$ with $z^\tau\!=\!z^\tau \in w'$, in which case
  $V'_{w'}(y)$ is undefined.  Let $*$ be a substitution that maps each
  variable $y$ in $B$ to some member $z$ of $V_w(y)$ with $z^\tau \in
  V'_{w'}(y)$, or to itself if there is no such $z$. Thus if $y \in
  \var(B)$ and $V'_{w'}(y)$ is defined, then $(*y)^\tau \in
  V'_{w'}(y)$, and so $V'_{w'}(y) = [(*y)^\tau]_{w'} = V^{\tau\cdot
    *}_{w'}(y)$. If $V'_{w'}(y)$ is undefined, then $V^{\tau\cdot
    *}_{w'}(y) = V^{\tau}_{w'}(y)$ is undefined, as otherwise
  $V^{\tau}_{w'}(y) = [y^\tau]_{w'} \not= \emptyset$ and
  $y^\tau\!=\!y^\tau \in w'$. So $V'$ and $V^{\tau\cdot *}$ agree at
  $w'$ on all variables in $B$. By the coincidence lemma,
  $w',V^{\tau\cdot *} \not\SAT B$.

  Now we have to distinguish logics with and without substitution.

  First, with substitution.  Suppose for reductio that $\Box B \in
  w$. Let $y_1,\ldots,y_n$ be the variables $y$ in $B$ with $(*y)^\tau
  \in V'_{w'}(y)$. \cmnt{(Note that this excludes all empty variables,
    as well as variables denoting things without counterparts.)} For
  each such $y$, $*y \in V_w(y)$, and so $y\!=\!*y \in w$. By
  \T{LL_n}, $\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n}\Box B \in w$. By
  \T{S\Box}, $\Box\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n} B \in w$. By
  construction of $R$, then $(\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n}
  B)^\tau \in w'$. By induction hypothesis, it follows that $w', V
  \SAT (\t{*y_1,\ldots,*y_n : y_1,\ldots, y_n} B)^\tau$. By the
  transformation lemma \ref{transl}, then $w', V^\tau \SAT
  \t{*y_1,\ldots,*y_n : y_1,\ldots, y_n} B$. So $w', V^{\tau \cdot
    [*y_1,\ldots,*y_n / y_1,\ldots, y_n]} \SAT B$ by lemma
  \ref{seq}. But $[*y_1,\ldots,*y_n : y_1,\ldots, y_n]$ is
  $*$. \cmnt{(If $(*y)^\tau \not\in V'_{w'}(y)$, then $V'_{w'}(y)$ is
    undefined, and there is no $z \in V_w(y)$ with $z^\tau \in
    V'_{w'}(y)$, so then $*y = y$.)} So $w',V^{\tau\cdot *} \SAT
  B$. Contradiction.

  Next, without substitution. \cmnt{(Remember: $wRw'$ iff for every
    formula $B$ and variables $x_1\ldots x_n$, $y_1,\ldots,y_n$ such
    that the $x_1\ldots x_n$ are zero or more pairwise distinct
    members of $\fvar(B)$ and each $x_i$ is distinct from $y_i$ (xxx
    check!), if $x_1\!=\!y_1 \land \ldots \land x_n\!=\!y_n \land \Box
    B\in w$ and $y_1^\tau \!=\!y_1^\tau \land\ldots\land
    y_n^\tau\!=\!y_n^\tau \in w'$, then there are variables $z_1\ldots
    z_n \not\in \var(B^\tau)$ such that $z_1\!=\!y_1^\tau \land \ldots
    \land z_n\!=\!y_n^\tau \land [z_1\ldots z_n/x_1^\tau\ldots
    x_n^\tau] B^\tau \in w'$.)} %
  Let $x_1,\ldots,x_n$ be the free variables $x$ in $B$ such that $*x$
  is not $x$ and $(*x)^\tau \in V'_{w'}(x)$ \cmnt{xxx that's
    redundant?!}, and suppose for reductio that $\Box B \in w$. By
  definition of $*$, for any $x_i$ in $x_1,\ldots,x_n$, $*x_i$ is a
  member of $V_w(x_i)$, so $x_i\!=\!*x_i \in w$. By definition of $R$
  (definition \ref{!CM}), there are variables $z_1,\ldots,z_n \not\in
  \var(B^\tau)$ such that $z_1\!=\!(*x_1)^\tau \land \ldots \land
  z_n\!=\!(*x_n)^\tau \land [z_1\ldots z_n/x_1^\tau\ldots
  x_n^\tau]B^\tau \in w'$. So for all $i$, $z_i\!=\!(*x_i)^\tau \in
  w'$ and $[z_1\ldots z_n/x_1^\tau\ldots x_n^\tau]B^\tau \in w'$. By
  induction hypothesis, $w',V \SAT z_i\!=\!(x_i^*)^\tau$ and $w',V
  \SAT [z_1\ldots z_n/x_1^\tau\ldots x_n^\tau]B^\tau$. Since $z_i
  \not\in \var(B^\tau)$, $[z_1\ldots z_n/x_1^\tau\ldots x_n^\tau]$ is
  $[z_1/x_1^\tau]\cdot \ldots \cdot[z_n/x_n^\tau]$ \cmnt{XXXX?}, and
  so $w',V^{[z_1\ldots z_n/x_1^\tau\ldots x_n^\tau]} \SAT B^\tau$ by
  part (i) of lemma \ref{rsl}. And as $V_{w'}(z_i) =
  V_{w'}((*x_i)^\tau)$, this means that $w',V^{[(*x_1)^\tau\ldots
    (*x_n)^\tau/x_1^\tau\ldots x_n^\tau]} \SAT B^\tau$. So
  $w',V^{[(*x_1)^\tau\ldots (*x_n)^\tau/x_1^\tau\ldots x_n^\tau]\cdot
    \tau} \SAT B$ by the transformation lemma \ref{transl}. But
  $V^{[(*x_1)^\tau\ldots (*x_n)^\tau/x_1^\tau\ldots x_n^\tau]\cdot
    \tau}$ coincides at $w'$ with $V^{\tau \cdot *}$: for any variable
  $z$, $V^{[(*x_1)^\tau\ldots (*x_n)^\tau/x_1^\tau\ldots
    x_n^\tau]\cdot \tau}_{w'}(z) = V^{[(*x_1)^\tau\ldots
    (*x_n)^\tau/x_1^\tau\ldots x_n^\tau]}_{w'}(z^\tau) =
  V_{w'}([(*x_1)^\tau\ldots (*x_n)^\tau/x_1^\tau\ldots
  x_n^\tau]z^\tau) = V^\tau_{w'}([*x_1\ldots *x_n/x_1\ldots x_n]z) =
  V^{\tau\cdot *}_{w'}(z)$. So $w',V^{\tau\cdot *} \SAT
  B$. Contradiction.  

} %

\cmnt{%

  On the other hand, fixing the counterpart relation in this way gets
  inconvenient when we want to characterise stronger logics. Recall
  from section \ref{sec:correspondence} that the schema $\s{T} = \Box
  A \then A$ is valid in a structure $\Fr{S}$ iff (i) every world in
  $\Fr{S}$ can see itself and (ii) every finite sequence of
  individuals at every world is its own counterpart at that world. We
  can check that the canonical model of $\s{P+T}$ satisfies (i) and
  (ii), and therefore that \s{P+T} is characterized by the class of
  positive counterpart models satisfying (i) and (ii).  As for (i),
  suppose there is some world $w$ in the model that can't see
  itself. By definition of canonical models in section \ref{sec:canonical-models},
  this means that there is no transformation $\tau$ such that $A^\tau
  \in w$ whenever $\Box A \in w$. But if $w$ contains all instances of
  $\Box A \then A$, then there is such a transformation, namely the
  identity transformation. Similarly for (ii). Suppose some sequence
  $\t{[x_1]_w,\ldots,[x_n]_w} \in U_w$ is not its own counterpart at
  $w$, i.e.\ there is no $C\in K_{w,w'}$ such that $[x_i]_w C [x_i]_w$
  for all $1 \leq i \leq n$. In the canonical model, this means that
  there is no transformation $\tau$ such that (a) $A^\tau \in w$
  whenever $\Box A \in w$, and (b) for all $1 \leq i \leq n$, there is
  a $y \in [x_i]_w$ with $y^\tau \in [x_i]_w$. (See definition
  \ref{!CM}.) But if $w$ contains all instances of $\Box A \then A$,
  then again the identity transformation satisfies (a) and (b).

} %

Every quantified modal logic is strongly complete with respect to every class of
models that contains its canonical model. However, on the traditional idea that
logical truths should be true on any interpretation of the non-logical terms, an
arguably more important kind of completeness is completeness with respect to all
models with a certain type of \emph{structure}.

Strictly speaking, we have two such notions, one for positive and one for
negative logics.

\begin{definition}[Positive completeness and
  characterisation]{\label{completeness}}
    A logic $L$ in some language of quantified modal logic is
    \emph{(strongly) positively complete with respect to a class of
      structures} $\mathbb{S}$ if every $L$-consistent set of formulas
    $\Gamma$ is verified at some world in some positive model
    $\t{\Fr{S},V}$ with $\Fr{S}\in \mathbb{S}$. $L$ is
    \emph{positively characterised by $\mathbb{S}$} if it is sound and
    positively complete with respect to $\mathbb{S}$.
\end{definition}

Now we might try to show, first, that if a PML is canonical, then so is its
quantified counterpart. Then we could try to show that the canonical model of
the PML is in a class of frames $F$ iff the opaque propositional guise of the
canonical model of the quantified counterpart is in $F$. Then we'd have
completeness transfer for all canonical logics.


\begin{theorem}[(Positive) completeness transfer]{\label{comptrans}}
  If $L$ is a (unimodal) propositional modal logic that is complete
  with respect to the Kripke frames in some class $F$, then the $PL$
  is positively complete with respect to the total counterpart
  structures whose opaque propositional guise is in $F$.
\end{theorem}

[To be continued...]


\cmnt{%
  (Here we also see that we need multiple counterpart relations: if we
  only had the identity transformation from $w$ to $w$, we would
  validate more principles than P+T?)%
} %


[TODO: What is the minimal logic of functional structures? What kind of
structures provides models for the minimal classical (non-free) QML? etc.]

\cmnt{%
  Consider the class of $C$-functional structures. By lemma \ref{rsl}, in those
  models $\t{y/x}A$ can be replaced by $[y/x]A$, and thus the unmodified
  versions of (LL) and (FUI) from non-modal logic are sound. So is, therefore,
  the necessity of identity, but not the necessity of non-identity. Thus
  functional models provide a general semantics for naive (extensions of)
  mixtures of F with K. And functional models in which things don't go out of
  existence provide the semantics for naive (extensions of) mixtures of Q with
  K.
}%

[TODO: look at an example where we can prove completeness but classical Kripke
semantics can't. S4M?]

\cmnt{%
  
Let's look at (free) quantified S4M, i.e. $\s{P}$ combined with
\begin{semantics}
\itemT{T} $\Box A \then A$,
\itemT{4} $\Box A \then \Box\Box A$,
\itemT{M} $\Box\Diamond A \then \Diamond\Box A$.
\end{semantics}
$\s{S4M}$ implies the following rule:
\begin{semantics}
  \itemT{R_{S4M}} if $\vdash_{S4M} \Diamond A$ and $\vdash_{S4M}
  \Diamond B$, then $\vdash_{S4M} \Diamond (A \land B)$.
\end{semantics}
Propositional S4M is characterised by the class of reflexive,
transitive and final frames, where a frame is \emph{final} if every
world can see an ``end'' world that can only see itself.%
\cmnt{%
  (S4M is also characterised by other sets of frames, e.g. by the
  frames in which every chain of accessible worlds is finite.  This is
  not quite the same as saying that each world can see an ``end''
  world: finality entails that $R$ is anti-symmetrical, since
  otherwise there would be an infinite chain going back and forth
  between two worlds. But the ``end'' requirement does not entail
  anti-symmetry; e.g., we could have three worlds $w_1,w_2,w_3$ such
  that $w_2$ and $w_3$ can see everyone and $w_1$ can only see
  itself.)%
} %

To show this, we first show that \s{S4M} is sound wrt.\ reflexive,
transitive and final frames. We know soundness of \T{T} and \T{4}, so
we only need to establish that $\t{W,R,V}, w \SAT \Box\Diamond A \then
\Diamond\Box A$ whenever $\t{W,R}$ is final. So suppose for reductio
that $\t{W,R}$ is reflexive, transitive and final but (i) $\t{W,R,V},
w \SAT \Box\Diamond A$ and (ii) $\t{W,R,V}, w \not\SAT \Diamond \Box
A$, i.e.\ $\t{W,R,V}, w \SAT \Box\Diamond \neg A$. (i) means that all
worlds accessible from $w$ can see a world where $A$ is true. (ii)
means that all worlds accessible from $w$ can see a world where $A$ is
false. But any world that can be seen from any accessible world is
itself accessible. So that world $w_1$ required by (i) where $A$ is
true is accessible from $w$ and hence by (ii) it can see a world $w_2
\not= w_1$ where $A$ is false; $w_2$ is also accessible from $w$ so by
(i) it can see a world $w_3 \not= w_2$ where $A$ is true, and so
on. So we never reach a world that can only see itself, contradicting
the finality of \t{W,R}.

To show that \s{S4M} is complete wrt.\ this class, we have to show
that its canonical model is reflexive, transitive and final. We know
that every world in the canonical model contains $\Box\Diamond A \then
\Diamond \Box A$, and that $wRw'$ iff $A \in w'$ whenever $\Box A \in
w$. What does the frame of this model look like? Let $w$ be an
arbitrary world, and let $\Box(w) = \{ A : \Box A \in w \}$. A world
is accessible from $w$ iff it contains $\Box(w)$. We want to show that
some such world can only see itself. Let $Fin = \{ A \then \Box A : A
\in \Sc{L} \}$. Evidently, $Fin \in w$ iff $w$ can only see
itself. (LTR because if $w' \not= w$, then there is some $A$ false at
$w'$ and true at $w$, so if $wRw'$ then $\Box A \not\in w$; RTL
because $A \land \neg \Box A$ requires that $wRw'$ for some
$w'\not=w$.) So all we have to show is that $\Box(w) \cup Fin$ is
S4M-consistent. Suppose it is not. Then there are some
$\vec{A},\vec{B}$ such that $\vec{\Box A} \in w$ and
\[
\vdash_{S4M} \neg (\vec{A} \land (\vec{B  \then \Box B})).
\]
So
\[
\vdash_{S4M} \vec{A} \then \neg(\vec{B  \then \Box B}).
\]
So by \T{Nec} and \T{K}
\[
\vdash_{S4M} \vec{\Box A} \then \neg\Diamond(\vec{B  \then \Box B}).
\]
Since $\vec{\Box A} \in w$, it follows that $\neg\Diamond(\vec{B \then
  \Box B}) \in w$. But by \T{T}, $\vdash_{S4M} \Box \neg B \then \neg
B$, so $\vdash_{S4M} B \then \Diamond B$. And so by \T{R_{S4M}},
$\vdash_{S4M} \Diamond (\vec{B \then \Box B})$. So $w$ contains 
$\Diamond (\vec{B \then \Box B})$, contradicting its consistency. 

Now what happens with quantified S4M in Kripke semantics? Consider
constant domain semantics, where we must add the Barcan Formula to
QS4M. The first part of the above proof goes through as before:
QS4M+BF is valid in every RTF frame. (This follows from a general
\emph{frame transfer theorem}: if $S$ is any normal propositional
logic, then the frames for $S$ are exactly the frames for the
corresponding quantified system Q$S$+BF.) For the second part, we have
to show that the canonical model of QS4M+BF has an RTF frame. The
problem arises when we want to prove finality. In canonical models of
Kripke semantics, $wRw'$ iff $A \in w'$ whenever $\Box A \in w$; so we
want to show that for any given world $w$, some world $w'$ with
$\Box(w) \subseteq w'$ can only see itself. Now $Fin = \{ A \then \Box
A : A \in \Sc{L}^* \} \in w'$ iff $w'$ is final. But even if $\Box(w)
\cup Fin$ is QS4M+BF-consistent, we cannot directly conclude that
there is a world $w'$ with $\Box(w) \cup Fin \subseteq w'$, as
$\Box(w)$ and $Fin$ are not restricted to formulas in $\Sc{L}$, so the
extensibility lemma doesn't apply. (Why does it help to add $\Box
\exists x Ax \then \Diamond \exists x\Box Ax$?)

By contrast, in counterpart semantics (for substitution logics),
$wRw'$ iff $A^\tau \in w'$ whenever $\Box A \in w$. So we need to show
that for any given world $w$, some world $w'$ with $\Box^\tau(w) = \{
A^\tau : \Box A \in w \} \in w'$ can only see itself. Note that the
infinitely many variables of $\Sc{L}$ do not occur in $\Box^\tau(w)$!
We still have a problem with $Fin$, which can't just contain all
instances of $A^\tau \then \Box A^\tau$, otherwise some $w'$ might
contain $Fin$ and yet see another world that only differs from $w'$
wrt formulas in $\Sc{L}$. (Can we extend $\Box^\tau(w) \cup Fin$ to a
Henkin set, despite the fact that $Fin$ contains all variables
(although that doesn't look like a very general solution)? $Fin$
itself is obviously not $\omega$-inconsistent, i.e.\ it doesn't
contain $\Phi(x)$ for all $x$ but also $\exists x \neg\Phi(x)$, for no
formula in $Fin$ is equivalent to an existential formula. However,
what if $\Box^\tau(w)$ contains $\exists x \neg(\Phi(x) \then \Box
\Phi(x))$, for some $\Phi$? Then $\Box^\tau(w) \cup Fin$ is
$\omega$-inconsistent. $\exists x \neg (\Phi(x) \then \Box \Phi(x))$
is equivalent to $\exists x (\Phi(x) \land \Diamond \neg \Phi(x))$...)
(Note that if $A^\tau \in w'$, then $\t{x_1^\tau,\ldots,x_n^\tau :
  x_1, \ldots, x_n}A \in w'$ for $x_1,\ldots,x_n = \var(A)$. By
substitutional witnessing, there are new variables $z_i$ such that
$w'$ contains $z_i\!=\!x_i^\tau$ as well as $[z_i/x_i]A$...)

We can easily show that every counterpart structure for S4M must be
reflexive, transitive and final. (Let $\Fr{S}$ be a non-reflexive
structure in which $w$ cannot see itself, and let $V$ be such that
$w,V \not\SAT \exists x Fx$ and $w',V \SAT \exists x Fx$ for all
$w'\not=w$. Since $\exists x Fx$ has no free variables, its
truth-value at a world $w'$ does not vary between $V$ and any image
$V'$ of $V$. So $w,V \SAT \Box \exists x Fx$, and $w,V \not\SAT
\exists x Fx$. So \T{T} is not valid in $\Fr{S}$. Similarly for
\T{4}. As to \T{M}, let $\Fr{S}$ be a reflexive, transitive, non-final
structure in which $w$ cannot see an end world. Then $w$ can see some
other world $w'$ which (by transitivity) itself cannot see an end
world, i.e. $w'$ can see some other world $w''$ (possibly $w$),
etc. Let $V$ be such that $w,V \SAT \exists x Fx$, $w',V \not\SAT
\exists x Fx$, $w'',V \SAT \exists x Fx$, etc., with alternating
truth-values for $\exists x Fx$ on the whole chain (though not
necessarily consecutively alternating truth-values). Then $w,V \SAT
\Box\Diamond\exists x Fx$, but $w,V \not\SAT \Diamond\Box\exists x
Fx$. So \T{M} is not valid in $\Fr{S}$.)

So every structure for \s{P}+S4M is reflexive, transitive and
final. I.e., \s{P}+S4M is not sound with respect to any class of
structures with non-reflexive, non-reflexive or non-final members:
some theorems of \s{P}+S4M will be invalid in those structures. So if
\s{P}+S4M is sound and complete with respect to some class of
structures $\mathbb{S}$, then these structures are all reflexive,
transitive and final.

All this holds also in Kripke semantics. But in Kripke semantics,
\begin{equation}\label{s4minc}
  \Box\exists x A \then \Diamond \exists x\Box A
\end{equation}
is also valid in every reflexive, transitive and final structure. But
it is not a theorem of \s{P}+S4M (see \cite[266--270]{hughes96new} for
a proof). Why is \eqref{s4minc} valid in reflexive, transitive and
final structures? We have to show that $w,V \SAT \Box\exists x A$
entails $w,V \SAT \Diamond\exists x\Box A$. So assume $w,V\SAT
\Box\exists x A$. Then $w',V \SAT \exists x A$ at some final world
$w'$ accessible from $w$. Then $w',V' \SAT A$ for some existential
$V'$-variant $V'$ of $V$ at $w'$. Since $w'$ can only see itself, then
$w',V' \SAT \Box A$. And then $w',V \SAT \exists x \Box A$. But then
$w,V \SAT \Diamond \exists x \Box A$. (See
\cite[266,283]{hughes96new}).

This reasoning does not go through in counterpart semantics. Assuming
$w,V\SAT \Box\exists x A$, we know that $w',V' \SAT \exists x A$ for
some final $w'$ accessible from $w$ and some $w'$-image $V'$ of $V$ at
$w$. Then $w',V'' \SAT A$ for some existential $x$-variant $V''$ of
$V'$ at $w'$. Now $w',V'' \SAT \Box A$ would require (given that $w'$
can only see itself) that $w',V''' \SAT A$ for all $V'''$ with
$V''_{w'} \Img V'''_{w'}$. This may fail if some individual at $w'$
has some other individual at $w'$ as a counterpart (perhaps in
addition to itself). Suppose this is not so, and we have $w',V'' \SAT
\Box A$. Next, $w',V'\SAT \exists x \Box A$ requires that $w',V'^*
\SAT \Box A$ for some existential $x$-variant $V'^*$ of $V'$ at
$w'$. Since $V''$ is some such $x$-variant, this step goes
through. Finally, $w,V \SAT \Diamond \exists x \Box A$ requires that
$w^*,V^* \SAT \exists x \Box A$ for some $wRw^*$ and $V_w \Img
V^*_{w^*}$. Since $w'$ and $V'$ fit that condition, this step also
goes through.

So to regain the incompleteness result, one would have to show that if
\s{P}+S4M is valid in a structure $\Fr{S}$, then no individual at any
world in $\Fr{S}$ has a different individual at the same world as its
counterpart. But while \T{T} forces every individual to have itself as
a counterpart, nothing in \s{P}+S4M rules out further counterparts at
the same world. E.g. let $\Fr{S}$ consist of $W=\{w\}$, $R =
\{\t{w,w}\}$, $D_w = \{x,y\}$, $C = \{ \t{\t{w,x},\t{w,x}},
\t{\t{w,x},\t{w,y}}, \t{\t{w,y},\t{w,y}} \}$. Note that any
interpretation $V$ on this structure is an image of itself (at
$w$). $V$ may also have other images $V'$ that assign $y$ to some
variables previously assigned $x$. Each such image $V'$ still has
itself as an image, but may have further images that re-assign more
variables from $x$ to $y$. Any such further image $V''$ of $V'$ is
also directly an image of $V$.  Then \T{T} is valid: if $w,V \SAT \Box
A$, then $w,V' \SAT A$ for all $V_w \Img V'_{w'}$, and since any $V$
on $\Fr{S}$ is one of its own images at $w$, then $w,V \SAT A$. \T{4}
is also valid: if $w,V' \SAT A$ for all $V_w\Img V'_{w'}$, then
$w',V'' \SAT A$ for all $V''$ such that for some $V'_w$, $V_w \Img
V'_w \Img V''_w$, because each such $V''$ is also an image of
$V$. Lastly, \T{M} is valid: if $w,V \SAT \Box\Diamond A$, then for
every image $V'$ of $V$ there is an image $V''$ of $V'$ with $w,V''
\SAT A$. Let $V'$ be the image of $V$ that maps all variables to $y$
that were previously mapped to $x$. $V'$ is its only image. So $w,V'
\SAT A$. Moreover, $V'$ is an image of $V$ such that $w,V'' \SAT A$
for every image $V''$ of $V'$. So there is an image $V'$ of $V$ such
that $w,V'' \SAT A$ for every image $V''$ of $V'$. So $w,V \SAT
\Diamond \Box A$.

Can I prove completeness of $s{P}+\T{S4M}$, using canonical models?
Isn't it enough to show that the canonical model of that logic is
final, transitive and reflexive, and that the logic is sound on that
model? 

}%

[TODO: discuss need for multiple counterpart relations]

\cmnt{%
  
In section 7 of \cite{kracht05semantics}, Kracht and Kutz present a
logic that is essentially \s{P} together with

\begin{semantics}

\itemT{T} $\Box A \then A$.

\itemT{4} $\Box A \then \Box\Box A$.

\itemT{alt_2} $\Diamond A \land \Diamond B \land \Diamond C \then 
\Diamond (A \land B) \lor \Diamond (A \land C) \lor \Diamond (B \land C)$.

\itemT{D2} $\exists x \exists y(x\!\not=\!y \land \forall z (z\!=\!x
\lor z\!=\!y))$.

\itemT{W1} $\forall x \forall y (Fx \land \neg Fy \then \Box (Fx \land
\neg Fy \lor \neg Fx \land Fy))$.

\itemT{C2} $\forall x \forall y (Fx \land \neg Fy \then \Diamond(\neg
Fx \land Fy))$.

\end{semantics}
%
(The main difference between this and their logic is that they have
outer quantifiers in place of our inner quantifiers. But this won't
matter in what follows.)  Suppose that this logic is complete with
respect to some structure $\Fr{S}$. If there is a world $w$ in
$\Fr{S}$ that can see three worlds $w_1,w_2,w_3$, then we can find an
interpretation such that three sentences $A,B,C$ (e.g. $\exists x
F_ix$, for three predicates $F_i$) are true at exactly one of
$w_1,w_2,w_3$ each, and so \T{alt_2} is false at $w$. Hence no world
in $\Fr{S}$ can see more than two worlds. By \T{T}, each world can see
itself. By \T{4}, each world can therefore reach at most one world
besides itself.

\T{D2} ensures that each world contains exactly two individuals (in
the inner domain). \T{W1} says that if two (inner) individuals differ
in a certain respect $F$, then all their counterparts at accessible
worlds also differ in that respect. Thus let $x,y$ be distinct (inner)
individuals at $w$, so that we can let them differ w.r.t $F$. Suppose
there is a world $w'$ accessible from $w$. Since \Fr{S} is positive,
$x$ and $y$ must have counterparts $x',y'$ at $w'$. This is OK as long
as $w'=w$, and $x',y'$ are $x$ and $y$ themselves (in some order). But
if $w'\not=w$, or $w'=w$ and $x',y'$ are the same individual, or
$w'=w$ and at one or both of $x',y'$ is not $x$ or $y$, then there
will be an interpretation under which $x'$ and $y'$ agree with respect
to $F$, in contradiction to \T{W1}. So all worlds in $w$ can only see
themselves, and their two inhabitants $x,y$ must have either $x,y$ or
$y,x$ or both as counterparts. (Note that we don't need the extra
axioms \T{NI} and \T{NNI} that Kutz includes. Can we also get rid of
T, 4, alt?)

For \T{C2}, choose an interpretation on which $x$ is $F$ and $y$
isn't. Then \T{C2} says that, first, there are counterparts $x',y'$ of
$x$ and $y$ at some $w'$ such that $x'$ is $F$ and $y'$ isn't, and
second, that there are also counterparts $x',y'$ at some $w'$ such
that $y'$ is $F$ and $x'$ isn't. This means that $x,y$ must have both
$x,y$ and $y,x$ as counterparts.

So this is a logic that requires non-trivial intra-world
counterparts. It therefore presents trouble for ``conceptual'' rivals
to counterparts semantics (e.g. the ``coherence models'' of
\cite{kracht05semantics}). But there is no problem for our own account
here.

} %

\cmnt{%
  Since $CP$ and $CN$ are just strengthened versions of \s{P} and \s{N}, I might
  drop them from the base logics at this point, and talk about them later, when
  I look at extensions of the base logics. At that point, I could also point out
  that substitution is fully definable in $CC$, and that lambda substitution
  might do in FUI and LL in $CN$ (and perhaps in $CP$).
}

\cmnt{%

\section{Roots and comparisons}

\subsection{Ghilardi: Functor Semantics}

(The following is mostly drawn from \cite{skvortsov93maximal} and
\cite{benthem93beyond}. The latter gives an accessible overview of
`functional' and `categorical' alternatives to standard Kripke
semantics, proposed by Ohlbach and Ghilardi
\citey{ghilardi91incompleteness}. \cite{skvortsov93maximal} is much
harder, but still easier than Ghilardi's own presentation.)  Following
\cite{benthem93beyond}, I will translate Ghilardi's account from
category theory into set theory. 

A \emph{functional frame} (or \emph{\Fr{C}-set}) is a family of
domains $\Fr{D} = \{ D_w : w\in W \}$ together with a family $\Fr{F} =
\{ f_{\mu} : D_w \xrightarrow{\mu} D_{w'} \}$ of maps between such
domains, indexed by morphisms between objects in $\Fr{D}$.

An \emph{interpretation} $V$ is a function that assigns an extension
to predicates and function symbols relative to points $w\in W$. In the
recursive definition of truth, the clause for the box says that $\Box
\Phi$ is true at $w$ under assignment $\sigma$, for short $\Fr{M},w
\SAT \Box\Phi [\sigma]$, iff for all maps $f$ from $D_w$ to $D_{w'}$,
$\Fr{M},w' \SAT \Phi [f \circ \sigma]$.

Van Benthem mentions a few correspondence results. For example, $\Box
Ax \then Ax$ is valid iff for each $w\in W$ and $d\in D_w$ there is a
map $f: D_w\to D_w$ with $f(d)=d$. Similarly, $\Box Ax \then \Box\Box
Ax$ is valid iff for all $d\in D_w$ and maps $f:D_w \to D_{w'},
g:D_{w'}\to D_{w''}$ there is a map $h:D_w\to D_{w''}$ with $g(f(d)) =
h(d)$. These are \emph{local} conditions insofar as different maps $f$
or $h$ may be chosen for different individuals. The stronger global
conditions cannot be expressed in the language, but they could be
enforced by stipulating that the mappings in frame must be closed
under `patching', to the effect that all consistent unions of
functions in $\Fr{F}$ must themselves be in $\Fr{F}$. The Converse
Barcan Formula is valid in all frames as long as the functions in
$\Fr{F}$ are total. The Barcan Formula defines a kind of surjectivity:
for all $d\in D_w, d'\in D_{w'}$, if $w \xrightarrow{f} w'$ then there
is a $g:D_w \to D_{w'}$ with $g(d) = d'$.

Ghilardi notes an interesting connection between functional models and
standard propositional models: Given a functional model $\Fr{M}$, let
$F(\Fr{M}) = \t{W,R}$ be the propositional Kripke frame whose points
$W$ are mappings in $\Fr{M}$, ordered by the relation $R$ defined by
$Rfg$ iff there is a map $h$ such that $g = h \circ f$. It turns out
that $F(\Fr{M}) \SAT \Phi$ for a propositional formula $\Phi$ iff
$\Fr{M} \SAT \Phi'$ for every predicate logical substitution instance
$\Phi'$ of $\Phi$. Ghilardi uses this fact to show that in the
standard semantics, all modal predicate logics between S4.3 and S5 are
incomplete.


Our counterpart models are obvious generalizations of Ghilardi's
models. Instead of a family of functions we have a family of relations
linking individual domains. This does complicate the semantics because
$[R \circ \sigma]$ is a \emph{set} of assignment functions, rather
than a single function.

\subsection{Metaframes: Skvortsov and Shehtman}




\subsection{Kutz 2000 and Kracht and Kutz 2002}

\cite{kutz00kripke} describes a model theory similar to mine. The main
ideas and results are summarized in \cite{kracht02semantics}.

\begin{enumerate}

\item Kutz's language excludes individual constants. He presents this
  as a limitation that is announced to be lifted at some other point
  [35] (\citey[3]{kracht02semantics}).

\item Non-modal (positive) free logic is axiomatised by \T{Taut},
  \T{VQ}, \T{UD}, \T{\forall Ex}, \T{=\!R},
  \begin{semantics}
    \itemT{FUI^K} $\forall x \Phi(x,\bar{z}) \then (Ey \then
      \Phi(y,\bar{z})$, provided $y$ is free for $x$ in
      $\Phi(x,\bar{z})$ and $y \not\in \bar{z}$;

      \itemT{LL^{K-}} $x\!=\!y \then (\Phi \then \Phi(y//x))$, provided
      $x$ is free in $\Phi$ and $y$ is free for $x$ in $\Phi(x)$.
  \end{semantics}
  with the rules \T{MP} and \T{UG}. [39] The requirement that
  $y\not\in \bar{z}$ means that (unless $y$ is $x$) $y$ is not free in
  $\Phi$ at all.

  When free logic is merged with the basic modal logic \s{K} into
  \s{FK} (``Free \s{K}''), \T{LL^{K-}} is revised as follows:
  \begin{semantics}
    \itemT{LL^{K}} $x\!=\!y \then (\Phi \then \Phi(y//x))$, provided
    $x$ is free in $\Phi$, $y$ is free for $x$ in $\Phi$, $y$ does not
    occur freely in the scope of a modal operator in $\Phi$, and
    $\Phi(y//x)$ is $\Phi$ with some free occurrences of $x$ replaced
    by $x$ such that in the scope of a modal operator, either all or
    no occurrences of $x$ are replaced. [43]
  \end{semantics}

  Arbitrary modal predicate logics are defined as sets $\s{FK}
  \subseteq L \subseteq \Sc{L}$ closed under \T{Nec}, \T{UG}, \T{MP}
  and closed under first and second-order substitution,
  \begin{semantics}
    \itemT{Sub^{K}} if $\vdash_L \Phi(x,\bar{z})$, then
    $\vdash_L\Phi(y, \bar{z})$, provided $x$ is free in $\Phi$ and $y$
    free for $x$; 

    \itemT{Sub2^{K}} if $\vdash_L \Phi(P(\bar{y}))$, then $\vdash_L
    \Phi(\Psi(\bar{x}))$,
  \end{semantics}
  where the latter ``may require some restrictions'' e.g.\ to avoid
  turning $x\!=\!y \then Gxx \then Gxy$ into $x\!=\!y \then
  \Box(x\!=\!x) \then \Box (x\!=\!y)$ [43f.]. In
  \citey[6f.]{kracht02semantics}, first-order closed modal predicate
  logics are explicitly distinguished from second-order closed logics,
  and the latter is not generally assumed.

  Note that \T{FUI^K} and \T{LL^K} are too restrictive (too weak),
  while \T{Sub^{K}} is not restrictive enough (too strong). This last
  fact is not noticed because the soundness proof for \s{FK} doesn't
  consider \T{Sub^K}.

\item A \emph{modal structure} is defined as a pair
  $\t{\Fr{W},\Fr{C}}$, where $\Fr{W}$ is a set of free logic models
  $\t{U,D,I}$ and $\Fr{C}$ is a set of relations between pairs $U_1,
  U_2$ of individual domains in $\Fr{W}$ such that all things in $U_2$
  are related to something in $U_2$. (This is analogous to the common
  requirement of increasing domains.) Accessibility is defined so that
  $wRw'$ iff at least one member $C$ of $\Fr{C}$ links $w$ and $w'$;
  in this case it is said that $w$ ``sees'' $w'$ via $C$, for short:
  $w \xrightarrow{C} w'$. [46f.]
  
  Observe that a structure, for Kutz, includes an interpretation
  function for each world (but not an assignment function). Structures
  without interpretations are called \emph{frames}.

  The fact that structures include a \emph{set} of counterpart
  relations, each defined only for a given pair of domains, means that
  e.g.\ $x$ at $w$ can be its own counterpart at $w$, but not at $w'$,
  because $\Fr{C}$ contains the identity relation on $U_w$ as well as
  some other relation between $U_w$ and $U_{w'}$. (Kutz explicitly
  allows for numerical identity across worlds [37, fn.47].) OTOH, if
  $U_{w'} = U_{w''}$, then it looks like individuals at $w$ cannot
  have different counterparts at $w'$ than at $w''$. My models allow
  for this by having the relations in $\Fr{C}$ tagged by the relevant
  structures (e.g., $w$ and $w'$). It might be worth checking if this
  creates problems in Kutz's completeness proofs.

  There can be several counterpart relations between two given
  structures. As \cite[11]{kracht02semantics} remark, ``this feature
  is not eliminable and actually one of the basic ingredients of all
  generalizations of standard Kripke-semantics. This is underlined by
  the fact that one can easily construct second-order closed modal
  predicate logics that are frame-complete only with respect to frames
  having at least two counterpart-relations between any two worlds''.

\item A \emph{modal model} is defined as a pair of a structure and an
  assignment function mapping each variable at each world to a member
  of the domain of that world. (So variables are local and non-rigid.)
  [47]

\item Satisfaction relative to a structure, an assignment function and
  a world is defined in the obvious way. The clause for the box is
  \begin{semantics}
  \item[$S,w,v \SAT \Box A(\bar{y})$] iff $S,w',v' \SAT A$ for all
    $w',v'$ such that there is a $C$ with $w\xrightarrow{C} w'$ and $v'$ is a
    $\bar{y}$-variant of $v$ with $C(v_w(y_i), v'_w(y_i))$. [48]
  \end{semantics}
  So $\Box A$ requires that $A$ is true at all accessible worlds $w'$
  under all $w'$-images of $v$, via all counterpart relations linking
  the two worlds. (To make real use of the different counterpart
  relations, one could subscript the box by the relevant (type of)
  relation.) 

  Kutz's rule is effectively the same as mine, and determines a
  uniform interpretation of variables in the scope of modal formulas,
  so that $x\!=\!x \land \Diamond x\!\not=\!x$ is unsatisfiable (see [37,
  fn.46]).

\item In the construction of canonical models for arbitrary logics
  $L$, worlds (``Freie Henkin Typen'') are defined as sets $H$ of
  formulas which are maximal, consistent, and witnessed (i.e.\
  whenever $H$ contains $\exists x \Phi(x) \in H$, then it contains
  both $\Phi(y)$ and $Ey$ for some $y$ free for $x$ in $\Phi(x)$.)
  [57] The language is not extended by new variables.

\item For transformations $\tau$ (called ``faithful substitutions''),
  $\Phi^\tau$ is defined as $\Phi$ with all variables, including bound
  ones, replaced according to $\tau$. [57]

  The extensibility lemma is then expressed as follows: if $\Delta$ is
  consistent and $\bar{y}, \bar{z}$ are two lists of $m$ pairwise
  distinct variables, then there is a transformation $\tau$ with
  $\tau(y_i) = z_i$ and a free Henkin set $H$ such that $\Delta^\tau
  \subseteq H$. [60] The main use of $\tau$ is to make sure that
  infinitely many variables do not occur in $\Delta^\tau$, which can
  then be used as witnesses. (In fact, $\tau$ is fixed so that for
  $x_i \not\in \bar{y}$, $\tau(x_i) = x_{k+2i+i}$, where $k$ is a
  sufficiently large index.) Our extensibility lemma, that $\Delta$
  itself can be extended to a Henkin set provided infinitely many
  variables do not occur in $\Delta$, is stated as corollary 7.1. [64]

\item To define the canonical model, each Henkin set $H$ must be
  turned into a structure $\t{U_H, D_H, I_H}$, in the obvious way:
  $U_H = \{ [x]_H : x \in \emph{Var} \}$, $D_H = \{ [x]_H : Ex \in H
  \}$, and $I_H(P) = \{ \bar{[x]_H} : P\bar{x} \in H \}$. [66f.]
  Moreover, the canonical assignment function obviously maps each $x$
  at $w$ to $[x]_w$. [67f.]

  The counterpart relations for a canonical model are defined in two
  steps. First, for any Henkin sets $w,w'$ and transformation $\tau$,
  let $C_\tau$ be the relation on $U_w \times U_{w'}$ such that
  $C_\tau([x]_w, [y]_{w'})$ iff $\tau(x)=y$. Relations of this kind
  are called \emph{pseudo-canonical counterpart relations} for $w$ and
  $w'$. [68] Some of these relations are functional or injective
  (e.g.\ the ones induced by the identity transformation), others are
  not. [69f.]

  Not all pseudo-canonical counterpart relations $C_\tau$ between $w$
  and $w'$ are actual links $w \xrightarrow{C_\tau} w'$ in the
  canonical model. To qualify as such a link, $w'$ must contain
  $\Phi^\tau$ whenever $w$ contains $\Box \Phi$. [70] Finally, the
  class $\Fr{C}$ of canonical counterpart relations is defined as $\{
  C_\tau : \exists w \exists w', w \xrightarrow{C_\tau} w' \}$.

  Here the worry arises that $\Fr{C}$ might contain a counterpart
  relation $C$ such that $w \xrightarrow{C_\tau} w'$ although $w'$
  does \emph{not} contain $\Phi^\tau$ whenever $w$ contains $\Box
  \Phi$, where $C_\tau$ got into $\Fr{C}$ by linking some other worlds
  $v,v'$ with the same individuals.

\item Kutz shows that whenever a Henkin set $w$ in a canonical model
  contains $\Diamond \Phi$, then there is a canonical counterpart
  relation $C_\tau$ such that some other set $w'$ in the model
  contains $\Phi^\tau$. [71f.]

\item The proof of the truth lemma (``Fundamentallemma'', or
  ``Fundamental Theorem''), however, is invalid.

  Here is part (vi) of the induction ((ii) in
  \citey[14]{kracht02semantics}), for formulas of type $\Diamond
  A(\bar{x})$. Assume that $w,V \SAT \Diamond A(\bar{x})$. Then there
  is a set $w'$ and an assignment $V'$ such that $S',V' \SAT
  A(\bar{x})$, where $V'(x_i)$ is a counterpart of $V(x_i)$, i.e.\
  there is a counterpart substitution $\tau$ and variables $u_i, v_i$
  such that $u_i \in V(x_i)$, $v_i \in V'(x_i)$ and $\tau(u_i) =
  v_i$. In the following argument, it is implicitly assumed that the
  $\bar{u}$ and $\bar{v}$ are pairwise distinct. But that is not
  guaranteed. Suppose the individual $\{x_1, x_2\}$ at $w$ has
  multiple $\tau$-counterparts $\{v_1\}, \{ v_2 \}$ at $w'$, with
  $\tau(x_i)=v_i$. Then $w,V \SAT \Diamond(x_1\!\not=\!x_2)$ as well
  as $w,V \SAT \Diamond(x_1 = x_2)$. For the latter, one relevant $V'$
  is such that $V'_{w'}(x_1) = V'_{w'}(x_2) = \{ v_1 \}$. In this
  case, $u_1 = u_2 = x_1$. Hence there is no transformation $h$ (or
  $g$ in \citey[14]{kracht02semantics}) with $h(x_i) = u_i$, and one
  cannot infer via Lemma 7.11 that
  \[
  \Diamond A(\bar{x}) \in w \text{ iff } \Diamond A^\tau(\bar{u}) \in w.
  \]
  In the example, that would be
  \[
  \Diamond(x_1 = x_2) \in w \text{ iff } \Diamond(x_1 = x_1) \in w.
  \]
  What is needed here is a strengthening of \T{LL^K} so that
  \[
  \vdash x_1 = x_2 \then \Diamond(x_1 = x_1) \then \Diamond(x_1 = x_2).
  \]

  (The coincidence lemma 7.3 is not my coincidence lemma; rather it is
  a lemma about substitution: it says that if $\bar{z}$ are pairwise
  distinct and free for $\bar{y}$ in $\Phi(\bar{y})$, and
  $v(y_i)=v^*(z_i)$, then $w,v \SAT \Phi(\bar{y})$ iff $w,v^* \SAT
  \Phi(\bar{z})$. It is crucial that the $\bar{z}$ are pairwise
  distinct. For instance $w,v \SAT \Diamond x\!\not=\!y$ does not
  entail $w,v' \Diamond y\!\not=\!y$ even if $v(x)=v'(y)$. (Here
  $\bar{y} = \t{x,y}$ and $\bar{z}$ = $\t{y,y}$.) Hence the step from
  3 to 4 is only valid if $z \not\in \bar{y}$. For example, if
  $\exists x \Phi(x,\bar{y})$ is $\exists x\Diamond x\!\not=\!y$, and
  the only member of the domain is $[y]_w = \{ x,y,\ldots \}$, then it
  is true that $w,v^{x\mapsto [y]_w} \SAT \Diamond x\!\not=\!y$, but
  we can't infer that $w,v \SAT \Diamond y\!\not=\!y$.)

  In part (v) there is a similar problem. Consider the formula
  $\exists x \Box x\!=\!y$. The argument goes as follows.
  \begin{align*}
      & w,V  \SAT \exists \Box(x\!=\!y)\\
   \Leftrightarrow\quad &  w,V' \SAT \Box(x\!=\!y) \text{ for some exist.\ $x$-var.\ $V'$ of $V$}\\
   \Leftrightarrow\quad &  w,V^{x\mapsto[z]} \SAT \Box(x\!=\!y) \text{ for some $[z] \in D_w$}\\
   \Leftrightarrow\quad &  w,V \SAT \Box(z\!=\!y) \text{ for some $[z] \in D_w$ (Lemma 7.3)}\\
   \Leftrightarrow\quad &  Ez \in w \text{ and } \Box (z\!=\!y) \in w \text{ for some $[z] \in D_w$ (induction)}\\
   \Rightarrow\quad & \exists z \Box(z\!=\!y) \in w \text{ by \T{FUI^K}}\\
   \Leftrightarrow\quad &  \exists x \Box(x\!=\!y) \in w \text{ by Lemma 7.11}.
 \end{align*}
 This assumes that the variable $z$ is distinct from $y$. Otherwise
 neither Lemma 7.3 nor \T{FUI^K} nor Lemma 7.11 applies. But $z$ and
 $y$ may well coincide. For instance, assume $V_w(y) = \{ y \}$. Then
 $V_w(y)$ has a unique counterpart at every accessible $w'$ and we
 have $w,V \SAT \exists x \Box (x=y)$. The relevant individual $[z]
 \in D_w$ is $\{ y \}$.  In the third step, we'd then need e.g.\
 \[
 w,V^{x\mapsto [y]} \SAT \Box(x=y)  \Leftrightarrow  w,V \SAT \Box(y=y)
 \]
 which is not an application of Lemma 7.3 and also not generally
 valid. What's actually needed here is a strengthening of \T{FUI^K}
 so that e.g.\
 \[
 \vdash \forall x\Box (Fxy \then Ey \then \Box Fyy)
 \]
 Or, to stay in the example: if $V(y) = \{ y \} \in D_w$, then $w,V
 \SAT \exists x\Box (x=y)$; i.e., if $w$ contains $\forall x\Diamond(x
 \not= y)$ and $Ey$, then $V(y)$ must not be $\{ y \}$. This should be
 verified by the fact that $\exists v (v\!=\!y \land
 \Diamond(v\!\not=y)) \in w$. But this isn't derivable from $\forall x
 \Diamond (x\!\not=\!y)$ by \T{FUI^K}.

 But the problem isn't just that the logic \s{FK} is too
 weak. Consider the case where $w$ contains $x\!=\!y$, $\Diamond
 x\!\not=\!y$ and $\Box\Diamond x\!\not=\!y$. So $[x]_w =
 \{x,y,\ldots\}$ and there is a $\tau$ such that for some accessible
 $w'$, $[x^\tau]_{w'} \not= [y^\tau]_{w'}$; in addition, $w'$ contains
 $\Diamond x^\tau\!\not=\!y^\tau$ (for every $\tau$). (Note that both
 $[x^\tau]_{w'}$ and $[y^\tau]_{w'}$ are $\tau$-counterparts of
 $[x]_w$, since for each of them, there is some member of $[x]_w$ that
 is $\tau$-mapped to one of their members.) To verify that $w,V \SAT
 \Box\Diamond x\!\not=\!y$, we need to ensure that $w', V' \SAT
 \Diamond x\!\not=\!y$ for all $V'$. Consider the $V'$ that assigns
 $[y^\tau]_{w'}$ to both $x$ and $y$. Now $w', V' \SAT \Diamond
 x\!\not=\!y$ requires that $[y^\tau]_{w'}$ has two counterparts at
 some world $w$ accessible from $w$ -- and we have no guarantee for
 that.

\item The canonical model lemma entails that every \emph{categorical}
  logic (i.e.\ every logic that is valid on the frame of its canonical
  model) is frame-complete. Kutz gives some examples of logics and
  corresponding classes of frames. For example, he shows that the
  canonical frame of $FK+NI$ is \emph{functional} in the sense that
  all $C \in \Fr{C}$ are functional, and thus that $FK+NI$ is
  frame-complete wrt.\ the class of functional frames. (It is easy to
  show that $NI$ is also valid on such frames.) [78f.] Similarly,
  $FK+NNI$ is frame-complete wrt.\ the class of \emph{injective}
  frames where all $C\in \Fr{C}$ are injective. [79] Next, $FK+CBF$
  and $FK+NE$ are shown to be frame-complete wrt.\ the class of
  \emph{existentially faithful} frames such that whenever $a \in D_w$,
  $w \xrightarrow{C} w'$ and $aCb$, then $b \in D_{w'}$. [79f.] 

  A frame is \emph{locally reflexive} if for every $w$ and tuple
  $\t{a_1,\ldots,a_n} \in U_w$ there is a $w \xrightarrow{C} w$ that
  contains $\t{a_1,a_1}, \ldots, \t{a_n,a_n}$ (i.e., if all finite
  sequences at all worlds are their own counterparts at that world). A
  frame is \emph{reflexive} if the same relation can be chosen for all
  tuples, so that for all $w$ there is a $w\xrightarrow{C} w$ such
  that $aCa$ for all $a\in U_w$. (This corresponds to reflexivity of
  $R^\omega$.) Kutz shows that the T-schema is valid in locally
  reflexivity frames, and that FK+T is complete wrt.\ this
  class. [80f.] Similarly, FK+4 is proved complete wrt.\ the class of
  locally transitive frames, and FK+B wrt.\ the class of locally
  symmetrical frames [81ff.]

\item Kutz points out that by an argument similar to one in
  [Skvortsov/Shehtman 1993, p.92] one can show in general that
  whenever $L$ is a canonical propositional modal logic, then $FK+L$
  is also canonical. [83]

\item Finally, Kutz presents a notion of \emph{generalized frames} to
  prove (generalized) frame-completeness of all modal predicate
  logics.

\end{enumerate}

}





\bibliographystyle{../../wobib2en}
\bibliography{../../bib}



\end{document}
